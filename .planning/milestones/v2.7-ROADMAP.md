# Milestone v2.7: Availability Tracking Bugfix

**Status:** SHIPPED 2026-02-12
**Phases:** 99-99.1
**Total Plans:** 5

## Overview

Bugfix milestone to complete the availability tracking feature from v2.5. Fixed the persistence pipeline so unavailable_at timestamps are actually saved to the database, added reconciliation for events dropped from platform discovery, and implemented consistent unavailable styling across all pages.

## Phases

### Phase 99: Availability Tracking Fix

**Goal**: Wire availability detection through to database persistence
**Depends on**: Phase 87-92 (v2.5 availability tracking infrastructure)
**Plans**: 1 plan + 2 FIX plans

Plans:

- [x] 99-01: Add unavailable_at to MarketWriteData and wire to DB persistence
- [x] 99-01-FIX: Fix UnboundLocalError and add reconciliation for dropped events
- [x] 99-01-FIX2: Fix Odds Comparison page unavailable styling

**Details:**
- Added `unavailable_at` field to `MarketWriteData` dataclass
- Created `UnavailableMarketUpdate` dataclass for UPDATE operations
- Extended `WriteBatch` with unavailable market tracking
- Added reconciliation pass at end of each scrape cycle
- Fixed UAT-001: UnboundLocalError from shadowed import
- Fixed UAT-002: Stale odds showing as available
- Fixed UAT-003/004: Consistent unavailable styling on Odds Comparison

### Phase 99.1: Availability Filters (INSERTED)

**Goal**: Add filter to show events with unavailable markets
**Depends on**: Phase 99
**Plans**: 1 plan + 1 FIX plan

Plans:

- [x] 99.1-01: Add Alerts toggle filtering events with unavailable markets
- [x] 99.1-01-FIX2: Fix alerts filter to query only latest snapshot

**Details:**
- Added `/api/events/alerts/count` endpoint
- Added `availability='alerts'` filter to events API
- Added "Alerts" toggle button with count badge
- Fixed to query only latest snapshot per event (not historical)

---

## Milestone Summary

**Key Decisions:**

- Use UPDATE queries for existing rows rather than INSERT replacement
- Wire both async and sync paths for complete coverage
- Query DB for event_id->sr_id mapping during reconciliation rather than storing in cache
- Update cache immediately after DB UPDATE for instant API effect
- Show stale odds with strikethrough rather than hiding them (more informative)

**Issues Resolved:**

- UAT-001: UnboundLocalError from shadowed import in write_handler.py
- UAT-002: Stale odds showing as available for events dropped from discovery
- UAT-003: Odds Comparison page inconsistent unavailable styling
- UAT-004: Margin showing when market unavailable

**Issues Deferred:**

None

**Technical Debt Incurred:**

None

---

_For current project status, see .planning/ROADMAP.md_
