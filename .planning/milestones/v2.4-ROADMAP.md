# Milestone v2.4: Historical Analytics

**Status:** SHIPPED 2026-02-11
**Phases:** 79-86
**Total Plans:** 19 (15 original + 4 FIX)

## Overview

Historical Analysis page with tournament-level margin analytics, interactive charts, time-to-kickoff analysis, and multi-bookmaker competitive comparison views. Fixed specifier bug in history API and added comprehensive analytics tooling.

## Phases

### Phase 79: Investigation

**Goal**: Identify root cause of mixed data in history charts
**Depends on**: v2.3 complete
**Plans**: 1 plan

Plans:
- [x] 79-01: Investigate specifier bug in history API

**Details:**
Root cause identified: History API filters by market_id only, missing line parameter. Over/Under and Handicap markets mix 5-8 different line values in chart data.

### Phase 80: Specifier Bug Fix

**Goal**: Add line parameter to history API and frontend
**Depends on**: Phase 79
**Plans**: 2 plans

Plans:
- [x] 80-01: Add line parameter to backend API endpoints
- [x] 80-02: Update frontend to pass line value through stack

**Details:**
Added optional line query parameter to backend, updated HistoryDialog, hooks, and API client to propagate line value.

### Phase 81: Interactive Chart

**Goal**: Make charts interactive with click-through drill-down
**Depends on**: Phase 80
**Plans**: 1 + 1 FIX plan

Plans:
- [x] 81-01: Interactive chart with click handling
- [x] 81-FIX: Fix click handler debouncing

**Details:**
Ref-based state for stable callbacks, click handler debounce to prevent rapid double-fire issues.

### Phase 82: Comparison Table

**Goal**: Add odds comparison table with highlighting
**Depends on**: Phase 81
**Plans**: 1 plan

Plans:
- [x] 82-01: ComparisonTable with best/worst highlighting

**Details:**
oddsDataByOutcome prop for multi-outcome comparison, green for best odds per row, red for >3% worse than Betpawa.

### Phase 83: Historical Analysis Page Foundation

**Goal**: Create Historical Analysis page structure
**Depends on**: Phase 82
**Plans**: 1 plan

Plans:
- [x] 83-01: Page route, navigation, date filters, tournament list

**Details:**
New feature folder, /historical-analysis route, FilterBar with date range picker, useTournaments hook, responsive card grid.

### Phase 84: Tournament Summary Metrics

**Goal**: Add tournament-level metrics cards
**Depends on**: Phase 83
**Plans**: 1 + 1 FIX plan

Plans:
- [x] 84-01: Tournament summary metrics with coverage bars
- [x] 84-FIX: Fix pagination for API with limits

**Details:**
TournamentAccumulator pattern for metric aggregation, coverage bar with proportional bookmaker segments, pagination loop for events API.

### Phase 84.1: Fix Tournament Metrics Design (INSERTED)

**Goal**: Simplify confusing UX in tournament metrics
**Depends on**: Phase 84
**Plans**: 1 + 1 FIX plan

Plans:
- [x] 84.1-01: Simplify tournament card metrics
- [x] 84.1-FIX: Per-market accumulator refinement

**Details:**
Per-market accumulator with Record<marketId, data> structure, TRACKED_MARKETS constant for shared configuration, simplify over explain pattern.

### Phase 84.2: Tournament Detail Page (INSERTED)

**Goal**: Add tournament drill-down page with all markets
**Depends on**: Phase 84.1
**Plans**: 1 + 1 FIX plan

Plans:
- [x] 84.2-01: Tournament detail route and market cards
- [x] 84.2-FIX: Fix market key identification

**Details:**
getMarketKey(id, line) pattern for unique market identification, useTournamentMarkets hook extracting ALL unique markets, timeline chart per market.

### Phase 85: Time-to-Kickoff Charts

**Goal**: Add time-to-kickoff analysis with buckets
**Depends on**: Phase 84.2
**Plans**: 2 plans

Plans:
- [x] 85-01: Time-to-kickoff bucket calculation
- [x] 85-02: Bucket breakdown dialog with chart

**Details:**
Dialog-based timeline pattern for on-demand visualization, bucket breakdown showing 24h+, 12-24h, 6-12h, 3-6h, 1-3h, <1h.

### Phase 85.1: Historical Analysis Card Margins (INSERTED)

**Goal**: Add opening/closing margins to tournament cards
**Depends on**: Phase 85
**Plans**: 1 plan

Plans:
- [x] 85.1-01: Opening/closing margin cards for tracked markets

**Details:**
TRACKED_MARKET_IDS Set for card display, only show for main 4 markets (1X2, O/U 2.5, BTTS, DC).

### Phase 86: Betpawa vs Competitor Comparison

**Goal**: Multi-bookmaker competitive analysis
**Depends on**: Phase 85.1
**Plans**: 4 plans

Plans:
- [x] 86-01: Bookmaker filter and multi-column cards
- [x] 86-02: Per-bookmaker margin data in hook
- [x] 86-03: Multi-bookmaker chart overlay
- [x] 86-04: Difference bar chart toggle

**Details:**
BOOKMAKER_COLORS constant for brand styling, CompetitiveBadge for margin comparison, MergedDataPoint for multi-bookmaker charts, DifferenceBarChart for margin gap visualization.

---

## Milestone Summary

**Decimal Phases:**
- Phase 84.1: Fix Tournament Metrics Design (inserted after Phase 84 for UX improvements)
- Phase 84.2: Tournament Detail Page (inserted after Phase 84.1 for drill-down feature)
- Phase 85.1: Historical Analysis Card Margins (inserted after Phase 85 for card enhancements)

**Key Decisions:**
- Decision: Line parameter as optional query param (Rationale: Backward compatibility)
- Decision: Extract ALL unique markets from Betpawa inline_odds (Rationale: Full visibility)
- Decision: Market key uses id:line combination (Rationale: Distinguish specifier variants)
- Decision: Simplify over explain pattern (Rationale: Remove complexity vs add tooltips)

**Issues Resolved:**
- Fixed specifier bug mixing different line values in history charts
- Fixed click handler double-fire with debouncing
- Fixed API pagination for large tournament queries

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
