# Milestone v2.8: Storage Optimization

**Status:** ✅ SHIPPED 2026-02-17
**Phases:** 100-104
**Total Plans:** 7

## Overview

Reduce database from 63+ GB to under 15 GB through schema optimization, compression, and proper retention policies while preserving all current features.

## Phases

### Phase 100: Investigation & Analysis

**Goal**: Profile all tables to measure sizes and growth patterns, identify growth drivers, design optimized schema strategy
**Depends on**: Previous milestone complete
**Plans**: 1 plan

Plans:
- [x] 100-01: Database profiling and storage analysis (2026-02-17)

**Details:**
- Database profiled: 63 GB total, 22 tables analyzed
- Top storage driver: raw_response columns consuming 53% (33 GB)
- Verified raw_response is UNUSED after scraping (no API or feature reads)
- Designed optimization strategy with expected 78% reduction

### Phase 101: Schema Implementation

**Goal**: Remove raw_response columns from snapshot tables to reclaim 33 GB (53% of database) based on Phase 100 findings
**Depends on**: Phase 100
**Plans**: 1 plan

Plans:
- [x] 101-01: Remove raw_response columns from models, DTOs, scraping code, and database (2026-02-17)

**Details:**
- Removed raw_response from scraping code (competitor_events.py, event_coordinator.py)
- Removed raw_response column from OddsSnapshot and CompetitorOddsSnapshot models
- Removed raw_response field from SnapshotWriteData and CompetitorSnapshotWriteData DTOs
- Created and applied Alembic migration m9n5o1p7q3r9 to drop columns from database

### Phase 102: Scraping Verification & Testing

**Goal**: Verify scraping still works correctly after raw_response removal, add any necessary tests, run end-to-end validation
**Depends on**: Phase 101
**Plans**: 1 plan

Plans:
- [x] 102-01: Scraping verification (2026-02-17)

**Details:**
- Created verification script that runs end-to-end scrape cycle
- Verified scrape completes successfully: 1186 events scraped, 0 failures
- Confirmed raw_response columns removed from both snapshot tables
- Validated data integrity: 3198 recent snapshots, 549137 market_odds with outcomes

### Phase 103: Data Migration & Validation

**Goal**: Reclaim disk space from dropped columns and apply 7-day retention to reduce database from 63 GB to under 15 GB
**Depends on**: Phase 102
**Plans**: 1 plan

Plans:
- [x] 103-01: Space reclamation and retention cleanup (2026-02-17)

**Details:**
- Reclaimed ~35 GB from dropped raw_response columns via VACUUM FULL
- Applied 7-day retention policy, deleted 60M+ market_odds records
- Final database size: 11.94 GB (target was <15 GB)

| Table | Before | After | Reduction |
|-------|--------|-------|-----------|
| odds_snapshots_default | 24 GB | 33 MB | 99.9% |
| competitor_odds_snapshots | 11 GB | 9.5 MB | 99.9% |
| market_odds | 22 GB | 10 GB | 55% |
| competitor_market_odds | 5.7 GB | 1.5 GB | 74% |
| **TOTAL** | **63.25 GB** | **11.94 GB** | **81%** |

### Phase 104: Monitoring & Prevention

**Goal**: Add database size tracking dashboard, implement automated retention policies, set up alerts for abnormal growth to prevent future issues
**Depends on**: Phase 103
**Plans**: 3 plans

Plans:
- [x] 104-01: Storage size API & history tracking (backend) — 2026-02-17
- [x] 104-02: Storage dashboard (frontend) — 2026-02-17
- [x] 104-03: Growth alerting (full-stack) — 2026-02-17

**Details:**
- GET /api/storage/sizes endpoint returning real disk usage from PostgreSQL system tables
- StorageSample model with daily sampling job for historical tracking
- Storage dashboard with database size cards, trend chart, and cleanup history table
- Automatic growth detection (>20% triggers warning, >50 GB triggers critical)
- AlertsBanner component with dismiss functionality

---

## Milestone Summary

**Key Decisions:**
- raw_response columns are UNUSED after scraping — safe to remove, saves 33 GB (53% of database)
- Combined optimization strategy: remove raw_response + 7-day retention = 78% reduction
- Hold raw API data in memory during scrape only, don't persist to database
- VACUUM FULL required after column drop to reclaim space — just dropping column doesn't free disk
- BigInteger for total_bytes to handle databases >2GB
- 90 sample retention (3 months of daily samples)
- Daily sampling at 3 AM UTC (1 hour after cleanup)
- Growth threshold at 20% per sample triggers warning
- Critical size threshold at 50 GB

**Issues Resolved:**
- Database bloat from unused raw_response columns (33 GB)
- No visibility into database size or growth trends
- No automated alerting for abnormal growth

**Issues Deferred:**
None

**Technical Debt Incurred:**
None

---

_For current project status, see .planning/ROADMAP.md_
