# Milestone v2.0: Real-Time Scraping Pipeline

**Status:** SHIPPED 2026-02-06
**Phases:** 53-59 + 55.1
**Total Plans:** 17

## Overview

Eliminate DB storage bottleneck, add in-memory caching, and deliver real-time odds updates via WebSocket for the fastest possible competitive comparison.

## Phases

### Phase 53: Investigation & Benchmarking

**Goal**: Measure current bottlenecks (scrape time vs DB write time vs API response time), establish baseline metrics
**Depends on**: Previous milestone complete
**Plans**: 1 plan

Plans:
- [x] 53-01: Pipeline timing instrumentation + benchmark baseline report

**Details:**
- Instrumented EventCoordinator with 21 perf_counter timing sites
- Baseline: 24.4 min total pipeline, scraping 61.3%, storage 37.4%
- Event list API p50=903ms (justifies cache layer)
- Bet9ja identified as slowest platform

### Phase 54: In-Memory Cache Layer

**Goal**: Implement always-on cache for latest odds, modify API to serve from cache, scope to active/upcoming events
**Depends on**: Phase 53
**Plans**: 3 plans

Plans:
- [x] 54-01: Cache module & data structures + startup warmup
- [x] 54-02: Scrape pipeline cache population + eviction
- [x] 54-03: API cache integration & latency verification

**Details:**
- OddsCache with frozen dataclass entries (duck-type compatible with ORM)
- Startup warmup loads all upcoming events from DB
- Cache-first API serving with DB fallback for misses
- API latency reduced 97.3% (903ms → 24ms)
- Eviction 2-hour grace period for recently started matches

### Phase 55: Async Write Pipeline + Incremental Upserts

**Goal**: Decouple scraping from storage via write queue, only persist changed odds, retry with backoff
**Depends on**: Phase 54
**Plans**: 4 plans

Plans:
- [x] 55-01: last_confirmed_at column & change detection module
- [x] 55-02: async write queue infrastructure & write handler
- [x] 55-03: pipeline integration & verification
- [x] 55-03-FIX: timezone fix + performance investigation

**Details:**
- Normalized outcome comparison for order-independent change detection
- AsyncWriteQueue with bounded queue (maxsize=50) for backpressure
- 3 retry attempts with exponential backoff (1s, 2s, 4s)
- Dual-path persistence: async for scheduled, sync for on-demand
- Cache updated immediately for all data before queue enqueue

### Phase 55.1: Fix Phase 55 Bugs (INSERTED)

**Goal**: Fix 3 bugs discovered during Phase 55 re-verification: BUG-005 write_ms duplicate keyword (blocker), BUG-006 stale detection timezone mismatch, BUG-007 on-demand scrapes bypass cache/write queue
**Depends on**: Phase 55
**Plans**: 1 plan

Plans:
- [x] 55.1-01: Fix BUG-005/006/007 (write_ms duplicate, timezone mismatch, cache bypass)

**Details:**
- Fixed write_ms duplicate keyword argument in store_batch_results
- Fixed timezone mismatch in stale detection (UTC comparison)
- Fixed on-demand scrapes to use cache and write queue

### Phase 56: Concurrency Tuning

**Goal**: Increase parallelism limits, optimize per-event scraping now that storage isn't blocking
**Depends on**: Phase 55.1
**Plans**: 1 plan

Plans:
- [x] 56-01: Intra-batch concurrent event scraping + HTTP pool tuning + benchmark

**Details:**
- Event-level semaphore (max_concurrent_events=10) + asyncio.gather
- HTTP pool increased to 200/100 for concurrent headroom
- Batch scrape time reduced 67.1% (35s → 11.5s)
- Total pipeline reduced 65.2% (24 min → 8.5 min)
- All 6 concurrency parameters exposed via Settings API

### Phase 57: WebSocket Infrastructure

**Goal**: WebSocket server setup, connection management, event broadcasting system
**Depends on**: Phase 56
**Plans**: 3 plans

Plans:
- [x] 57-01: WebSocket connection manager and endpoint
- [x] 57-02: WebSocket message protocol and scrape progress bridge
- [x] 57-03: Odds change notifications via WebSocket

**Details:**
- ConnectionManager with dual-dict topic tracking (ws→topics, topic→ws)
- WebSocket endpoint at /api/ws running alongside SSE
- Message envelope pattern: {type, timestamp, data}
- ProgressBroadcaster-to-WebSocket bridge for scrape progress
- OddsCache on_update callback for real-time odds change notifications

### Phase 58: WebSocket UI Migration

**Goal**: Migrate dashboard pages from SSE polling to WebSocket, run alongside SSE initially
**Depends on**: Phase 57
**Plans**: 2 plans

Plans:
- [x] 58-01: WebSocket hooks (useWebSocket + useWebSocketScrapeProgress)
- [x] 58-02: Dashboard and scrape-runs WebSocket migration with SSE fallback

**Details:**
- useWebSocket core hook with reconnection and topic subscriptions
- useWebSocketScrapeProgress as primary with SSE fallback (3 failures)
- Transport indicator exposed for debugging

### Phase 59: SSE Removal & Cleanup

**Goal**: Remove SSE infrastructure after WebSocket is stable, final validation
**Depends on**: Phase 58
**Plans**: 2 plans

Plans:
- [x] 59-01: Remove SSE endpoints from backend and delete SSE-only frontend files
- [x] 59-02: Frontend simplification (remove SSE fallback, cleanup)

**Details:**
- Removed useObserveScrape hook (SSE-only)
- Simplified all progress hooks to WebSocket-only
- Manual scrapes via POST /api/scrape + WebSocket observation
- Deleted SSE generator functions and endpoints

---

## Milestone Summary

**Decimal Phases:**
- Phase 55.1: Fix Phase 55 Bugs (inserted after Phase 55 for urgent blocker fixes)

**Key Decisions:**
- Frozen dataclasses for cache entries — avoids detached ORM instance issues
- Cache-before-persist pattern — API always serves fresh data regardless of write queue latency
- asyncio.gather over TaskGroup — partial failure tolerance, no cascading cancellation
- Dual-layer semaphore design — event-level + platform-level throttling
- WebSocket endpoint at /api/ws — runs alongside SSE during migration, then SSE removed

**Issues Resolved:**
- BUG-005: write_ms duplicate keyword argument in store_batch_results (blocker)
- BUG-006: Stale detection timezone mismatch (UTC comparison)
- BUG-007: On-demand scrapes bypassing cache/write queue

**Issues Deferred:**
- Historical trend visualization (data stored, UI deferred)

**Technical Debt Incurred:**
- None — clean implementation with comprehensive patterns established

---

_For current project status, see .planning/ROADMAP.md_
