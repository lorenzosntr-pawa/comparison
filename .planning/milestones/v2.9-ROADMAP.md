# Milestone v2.9: Market-Level Storage Architecture

**Status:** ✅ SHIPPED 2026-02-24
**Phases:** 105-110.1
**Total Plans:** 8

## Overview

Reduce market_odds storage from ~8GB/day to <200MB/day through market-level change detection, enabling sustainable operation on 75GB disk. Replaced snapshot-level storage with market_odds_current (upsert) + market_odds_history (append-only) tables for 95% row reduction.

## Phases

### Phase 105: Investigation & Schema Design

**Goal**: Study codebase data flow, design new table schemas (market_odds_current, market_odds_history), understand API query patterns
**Depends on**: v2.8 Storage Optimization complete
**Plans**: 1/1 complete

Plans:
- [x] 105-01: Codebase investigation and schema design (2026-02-24)

**Details:**
- Root cause: snapshot-level change detection writes ALL markets when ANY changes
- Schema design: market_odds_current (upsert) + market_odds_history (append)
- Storage reduction: 95% (7.2M → 360K rows/day)
- Unified BetPawa + competitor storage via bookmaker_slug

### Phase 106: Schema Migration

**Goal**: Create market_odds_current and market_odds_history tables with Alembic, plan data migration strategy
**Depends on**: Phase 105
**Plans**: 1/1 complete

Plans:
- [x] 106-01: Create Alembic migration and SQLAlchemy ORM models (2026-02-24)

**Details:**
- Created MarketOddsCurrent model with UNIQUE constraint on (event_id, bookmaker_slug, market_id, COALESCE(line, 0))
- Created MarketOddsHistory model with monthly partitioning on captured_at
- Composite PK for partitioned table: (id, captured_at)

### Phase 107: Write Path Changes

**Goal**: Update change_detection.py and write_handler.py for market-level detection, apply to both BetPawa and competitor paths
**Depends on**: Phase 106
**Plans**: 2/2 complete

Plans:
- [x] 107-01: Data Structures & Change Detection (DTOs, classify_market_changes) — 2026-02-24
- [x] 107-02: Write Handler & Integration (UPSERT/INSERT, event_coordinator) — 2026-02-24

**Details:**
- Created MarketWriteBatch, MarketOddsData, MarketHistoryRecord DTOs
- Implemented classify_market_changes() for market-level detection
- Added handle_market_write_batch() with raw SQL ON CONFLICT for expression index
- Updated event_coordinator to use market-level write path

### Phase 108: Read Path & Cache

**Goal**: Update API routes (events.py, palimpsest.py) and OddsCache to work with new schema
**Depends on**: Phase 107
**Plans**: 1/1 complete

Plans:
- [x] 108-01: Cache warmup and API DB fallback queries (2026-02-24)

**Details:**
- Updated cache warmup to load from market_odds_current
- Updated events.py DB fallback to query market_odds_current
- Palimpsest API already uses cache, no changes needed

### Phase 109: Historical API

**Goal**: Build point-in-time reconstruction queries for Historical Analysis page charts and time-to-kickoff analysis
**Depends on**: Phase 108
**Plans**: 1/1 complete

Plans:
- [x] 109-01: Migrate history API to market_odds_history (2026-02-24)

**Details:**
- Updated get_odds_history and get_margin_history to query MarketOddsHistory
- Removed deprecated get_snapshot_history endpoint (unused)
- Simplified from 518 to 301 lines (-42%)

### Phase 110: Retention, Cleanup & Storage Page Fix

**Goal**: Update retention from 7-day to 14 days, fix cleanup jobs for new schema, debug and fix blank Storage page
**Depends on**: Phase 109
**Plans**: 1/1 complete

Plans:
- [x] 110-01: Fix timezone bug, add market_odds_history cleanup, 14-day retention (2026-02-24)

**Details:**
- Fixed cleanup timezone bug (naive vs aware datetime mismatch)
- Added market_odds_history cleanup for v2.9 schema
- Updated retention setting to 14 days via Alembic migration

### Phase 110.1: History API Dual-Query Fix (INSERTED) — BUG-028

**Goal**: Fix historical data regression by updating history API to query BOTH new market_odds_history AND legacy odds_snapshots/market_odds tables
**Depends on**: Phase 110
**Plans**: 1/1 complete

Plans:
- [x] 110.1-01: Dual-query history API to include legacy data (2026-02-24)

**Details:**
- Added _query_legacy_betpawa_history() and _query_legacy_competitor_history() helpers
- Updated get_odds_history() and get_margin_history() to query both sources
- Results combined and sorted by captured_at for continuous timeline
- No data migration required - legacy tables preserved for historical queries

---

## Milestone Summary

**Decimal Phases:**
- Phase 110.1: History API Dual-Query Fix (inserted after Phase 110 for BUG-028 regression fix)

**Key Decisions:**
- Market-level upsert schema: market_odds_current (UNIQUE on event+bookmaker+market+line) replaces snapshot-level storage
- COALESCE in unique constraint: `COALESCE(line, 0)` allows NULL line values
- Composite PK for partitioned tables: PostgreSQL requires partition key in primary key
- Expression index ON CONFLICT requires raw SQL: SQLAlchemy on_conflict_do_update doesn't support expression indexes
- Dual-query history API: Query both new and legacy tables for complete historical data

**Issues Resolved:**
- BUG-028: Historical data regression (empty charts for pre-v2.9 events)
- BUG-029: Expression index constraint requires raw SQL
- Storage page blank due to CleanupRun schema mismatch (BUG-032)
- Cleanup timezone mismatch (naive vs aware datetime)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- Dual-query history API adds complexity but preserves legacy data without migration
- Legacy snapshot tables retained for backward compatibility

---

_For current project status, see .planning/ROADMAP.md_
