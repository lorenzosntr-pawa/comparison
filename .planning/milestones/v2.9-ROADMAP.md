# Milestone v2.9: Risk Monitoring

**Status:** SHIPPED 2026-02-20
**Phases:** 105-111 (8 phases including 109.1)
**Total Plans:** 11

## Overview

Real-time odds movement alerting with dedicated Risk Monitoring page, cross-page indicators, and configurable detection thresholds. Enables Betpawa to proactively identify significant odds movements and competitive positioning changes.

## Phases

### Phase 105: Investigation & Schema Design

**Goal**: Analyze detection patterns, design alerts table schema, plan detection algorithms
**Depends on**: v2.8 complete
**Plans**: 1/1 complete

Plans:
- [x] 105-01: Investigation & Schema Design — 2026-02-19

**Details:**
- Analyzed existing cache structure for detection integration points
- Designed RiskAlert model with event/market/outcome FKs
- Identified 3 detection types: price_change, direction_disagreement, availability_change
- Planned severity thresholds (warning 7%, elevated 10%, critical 15%)
- Integration point: store_batch_results() after classify_batch_changes()

### Phase 106: Backend Alert Detection

**Goal**: Implement detection engine for % changes, direction disagreement, availability changes
**Depends on**: Phase 105
**Plans**: 1/1 complete

Plans:
- [x] 106-01: Backend Alert Detection — 2026-02-19

**Details:**
- Created risk_detection.py module with detect_risk_alerts() orchestrator
- Implemented 3 specialized detection functions
- AlertThresholds NamedTuple for configurable percentages
- Integration into scraping pipeline via write_handler

### Phase 107: Alert Storage & API

**Goal**: Database schema, alert CRUD operations, API endpoints for alerts
**Depends on**: Phase 106
**Plans**: 2/2 complete

Plans:
- [x] 107-01: RiskAlert Model & Settings — 2026-02-19
- [x] 107-02: API Endpoints & Write Handler — 2026-02-19

**Details:**
- RiskAlert SQLAlchemy model with status workflow (new→acknowledged→past)
- Pydantic schemas for API responses
- GET /api/alerts with status/type filters
- PATCH /api/alerts/{id}/acknowledge endpoint
- WriteBatch alerts tuple for atomic persistence

### Phase 108: Risk Monitoring Page

**Goal**: Core table with expandable rows, tabs (New/Acknowledged/Past), filters
**Depends on**: Phase 107
**Plans**: 1/1 complete

Plans:
- [x] 108-01: Risk Monitoring Page — 2026-02-19

**Details:**
- RiskMonitoringPage component at /risk-monitoring
- Event-grouped alert table with max severity propagation
- Expandable rows showing alert details per event
- Status tabs for workflow management
- Alert type and severity filters
- Direction disagreement dual display (arrows showing movements)
- Matched market filtering

### Phase 109: Real-Time Updates

**Goal**: WebSocket alert broadcasting, live table updates, sidebar badge
**Depends on**: Phase 108
**Plans**: 2/2 complete

Plans:
- [x] 109-01: WebSocket Alert Broadcasting — 2026-02-19
- [x] 109-02: Frontend Real-Time Updates — 2026-02-19

**Details:**
- risk_alerts WebSocket topic added to connection manager
- build_risk_alerts_message() for message envelope
- AsyncWriteQueue broadcast integration via ws_manager injection
- useRiskAlertUpdates hook for query invalidation
- Sidebar badge showing unacknowledged alert count

### Phase 109.1: Limit Alert Detection to Primary Markets (INSERTED)

**Goal**: Filter alert detection to only primary markets: 1X2, Double Chance, BTTS, Asian Handicaps, Over/Under
**Depends on**: Phase 109
**Plans**: 1/1 complete

Plans:
- [x] 109.1-01: Primary Market Filter — 2026-02-19

**Details:**
- PRIMARY_MARKET_IDS frozenset constant
- is_primary_market() helper for O(1) filtering
- Filter applied at end of detect_risk_alerts()
- DELETE /api/alerts endpoint for cleanup

### Phase 110: Cross-Page Integration

**Goal**: Alert indicators on Odds Comparison/Event Details, navigation links
**Depends on**: Phase 109.1
**Plans**: 1/1 complete

Plans:
- [x] 110-01: Cross-Page Integration — 2026-02-19

**Details:**
- AlertIndicator component for consistent display
- useEventAlerts hook for event-specific alert fetching
- Alert banner on Event Details page header
- Row indicators on Odds Comparison table
- Navigation links to Risk Monitoring page

### Phase 111: Settings & Configuration

**Goal**: Alert thresholds, severity bands, retention settings, quick settings UI
**Depends on**: Phase 110
**Plans**: 1/1 complete

Plans:
- [x] 111-01: Settings & Configuration — 2026-02-20

**Details:**
- Alert fields added to Pydantic settings schemas
- event_coordinator reads thresholds from settings
- Settings page alert configuration card
- Color-coded threshold inputs (yellow/orange/red borders)
- Enable toggle and retention days configuration

---

## Milestone Summary

**Key Decisions:**
- Alert detection integration point: store_batch_results() after classify_batch_changes()
- Alert per outcome, not per market for granular tracking
- Direction disagreement always ELEVATED severity
- Separate alert_retention_days from odds_retention_days
- Alert persistence in same transaction as snapshots
- Cannot acknowledge PAST alerts (prevents workflow actions on started events)
- ws_manager injection to AsyncWriteQueue for post-persistence broadcast
- PRIMARY_MARKET_IDS filter at end of detect_risk_alerts()

**Key Patterns:**
- detect_risk_alerts orchestrator pattern
- AlertThresholds NamedTuple for configurable thresholds
- Alerts on WriteBatch pattern for atomic persistence
- Status workflow: new → acknowledged → past
- Event grouping in alert table with max severity propagation
- ws_manager injection to AsyncWriteQueue
- PRIMARY_MARKET_IDS filter with is_primary_market() helper
- getattr with defaults for settings migration
- Color-coded threshold inputs for visual severity indication

**Issues Resolved:**
- None (greenfield feature)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None identified

---

_For current project status, see .planning/ROADMAP.md_
