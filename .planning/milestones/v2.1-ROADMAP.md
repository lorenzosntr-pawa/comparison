# Milestone v2.1: Historical Odds Tracking

**Status:** SHIPPED 2026-02-08
**Phases:** 60-68
**Total Plans:** 12 (10 original + 2 FIX plans)

## Overview

Add historical odds and margin tracking with interactive visualization, enabling users to view price movements over time through clickable popup dialogs. Users can compare odds history across multiple bookmakers with overlay charts and view complete market history with small-multiples layout.

## Phases

### Phase 60: Investigation & Schema Design

**Goal**: Analyze current snapshot lifecycle, design historical data retention model
**Depends on**: v2.0 complete
**Plans**: 1/1 complete

Plans:

- [x] 60-01: SQL analysis of snapshot lifecycle + schema design recommendation

**Details:**
SQL analysis discovered existing schema already stores ~52 snapshots/event on average. Change-based retention (Option C) selected — no major schema overhaul needed. Documented storage budget: 500 events × 90 days = ~139 GB (acceptable with existing partitioning).

### Phase 61: Historical Snapshot Retention (SKIPPED)

**Goal**: Keep historical snapshots with configurable retention policy instead of overwriting
**Status**: SKIPPED — Existing `odds_retention_days` setting already provides this functionality
**Decision**: Users can configure retention via existing settings (default 30, max 365 days)

### Phase 62: Historical Data API

**Goal**: Create API endpoints for querying outcome, margin, and market history
**Depends on**: Phase 60
**Plans**: 2/2 complete

Plans:

- [x] 62-01: Pydantic schemas + composite index migration
- [x] 62-02: History router with snapshot, odds, and margin endpoints

**Details:**
Created FastAPI history router with 3 endpoints:
- GET /events/{event_id}/history - paginated snapshot list with market counts
- GET /events/{event_id}/markets/{market_id}/history - full odds time-series with outcomes
- GET /events/{event_id}/markets/{market_id}/margin-history - lightweight margin-only time-series

### Phase 63: Freshness Timestamps

**Goal**: Add "last updated" timestamps to odds display in Odds Comparison and Event Details pages
**Depends on**: Phase 62
**Plans**: 1/1 complete

Plans:

- [x] 63-01: Add snapshot_time to BookmakerOdds schema + display in frontend

**Details:**
Added snapshot_time field to BookmakerOdds Pydantic schema. Frontend displays relative timestamps ("5 min ago") with tooltip showing absolute time on hover.

### Phase 64: Chart Library Integration

**Goal**: Add recharts library and create base chart components for historical visualization
**Depends on**: Phase 63
**Plans**: 1/1 complete

Plans:

- [x] 64-01: TypeScript types, API methods, hooks, OddsLineChart and MarginLineChart components

**Details:**
Created 4 TypeScript interfaces matching backend schemas. Added getOddsHistory/getMarginHistory API methods with URL encoding. Built useOddsHistory/useMarginHistory hooks with TanStack Query patterns. Created OddsLineChart (multi-outcome lines with optional margin overlay) and MarginLineChart (with reference line support).

### Phase 65: History Dialog Component

**Goal**: Create reusable popup dialog with price/margin chart visualization
**Depends on**: Phase 64
**Plans**: 1/1 complete

Plans:

- [x] 65-01: HistoryDialog component with tabbed Odds/Margin views

**Details:**
Created HistoryDialog component using shadcn Dialog + Tabs. Implements conditional data fetching (only fetch when dialog open AND specific tab active) for optimal performance.

### Phase 66: Odds Comparison History

**Goal**: Add click handlers on odds/margins in Odds Comparison page to open history dialog
**Depends on**: Phase 65
**Plans**: 2/2 complete

Plans:

- [x] 66-01: Add HistoryDialog state, click handlers on OddsValue/MarginValue, render dialog
- [x] 66-02-FIX: Fix BUG-010 (competitor history), BUG-011 (margin redundancy), BUG-012 (multi-bookmaker comparison)

**Details:**
Added clickable cells in Odds Comparison table that open HistoryDialog with market context. Fixed 3 bugs: backend competitor history via CompetitorEvent tables, removed redundant margin line from Odds tab, added multi-bookmaker comparison mode with useQueries parallel fetch and overlay charts.

### Phase 67: Event Details History

**Goal**: Add click handlers on odds/margins in Event Details page to open history dialog
**Depends on**: Phase 66
**Plans**: 2/2 complete (1 original + 1 FIX)

Plans:

- [x] 67-01: Add onClick to OddsBadge/MarginIndicator, wire up HistoryDialog in MarketGrid
- [x] 67-01-FIX: Fix UAT issues (chart smoothness)

**Details:**
Added optional onClick prop to OddsBadge and MarginIndicator components for reusability across any page. Wired up MarketRow to pass click handlers, added HistoryDialog state to MarketGrid. Fixed chart tooltip and animation smoothness issues.

### Phase 68: Market-Level History View

**Goal**: View complete market history with all outcomes on synchronized timeline
**Depends on**: Phase 67
**Plans**: 1/1 complete

Plans:

- [x] 68-01: MarketHistoryPanel with small-multiples layout + Full Market View toggle

**Details:**
Created MarketHistoryPanel component with small-multiples chart layout (one mini-chart per outcome). Added "Full Market View" toggle in HistoryDialog comparison mode. Responsive grid (1/2/3 columns) adapts to viewport width. Shared legend at bottom shows bookmaker colors consistently.

---

## Milestone Summary

**Decimal Phases:**

- None (standard phase numbering 60-68)

**Key Decisions:**

- Decision: No major schema changes required (Rationale: Current architecture with odds_snapshots + market_odds already stores history)
- Decision: Phase 61 skipped (Rationale: Existing odds_retention_days setting already provides configurable retention)
- Decision: Small-multiples over single dense chart (Rationale: One mini-chart per outcome cleaner than one chart with 9 lines)
- Decision: Tab-conditional data fetching (Rationale: enabled=open && activeTab prevents API calls for inactive tabs)
- Decision: Reusable onClick on value components (Rationale: OddsBadge/MarginIndicator work across any page)

**Issues Resolved:**

- BUG-010: Competitor history API queries (SportyBet/Bet9ja) now work via CompetitorEvent tables
- BUG-011: Removed redundant margin line from Odds tab (separate Margin tab exists)
- BUG-012: Multi-bookmaker comparison mode with overlay charts

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md_
