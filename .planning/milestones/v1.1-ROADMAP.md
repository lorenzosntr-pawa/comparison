# Milestone v1.1: Palimpsest Comparison

**Status:** SHIPPED 2026-01-24
**Phases:** 13-19
**Total Plans:** 11

## Overview

Enable full competitor palimpsest comparison by scraping all tournaments/events from competitors, matching across platforms by SportRadar ID, and displaying availability differences alongside odds comparison.

## Phases

### Phase 13: Database Schema Extension

**Goal**: Add tables for competitor tournaments/events with source tracking and metadata priority
**Depends on**: v1.0 MVP complete
**Plans**: 2 plans

Plans:
- [x] 13-01: Competitor Models (CompetitorSource, CompetitorTournament, CompetitorEvent, odds snapshots)
- [x] 13-02: Migration (ScrapeBatch model, Alembic migration for all tables)

**Details:**
Created 5 new tables: scrape_batches, competitor_tournaments, competitor_events, competitor_odds_snapshots, competitor_market_odds. ScrapeBatch enables grouping platform runs for batch visibility.

### Phase 14: Tournament Discovery Scraping

**Goal**: Scrape full tournament lists from SportyBet and Bet9ja APIs
**Depends on**: Phase 13
**Plans**: 1 plan

Plans:
- [x] 14-01: Tournament Discovery Service (SportyBet/Bet9ja tournament scraping, API endpoint)

**Details:**
Added fetch_tournaments() to SportyBetClient. Created TournamentDiscoveryService with upsert logic. POST /api/scheduler/discover-tournaments endpoint with partial failure handling. ~200+ tournaments per platform discovered.

### Phase 15: Full Event Scraping

**Goal**: Get all events from competitor tournaments, not limited to betpawa-matched events
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 15-01: Competitor Event Scraping Service (SportyBet/Bet9ja event scraping, API endpoint)
- [x] 15-02: Orchestrator Integration (Parallel competitor scraping in ScrapingOrchestrator)

**Details:**
Created CompetitorEventScrapingService with two-phase fetch-then-store pattern. Integrated parallel competitor scraping into ScrapingOrchestrator. BetPawa scrapes to events table, competitors to competitor_events table.

### Phase 16: Cross-Platform Matching Enhancement

**Goal**: Match events by SR ID across all three platforms
**Depends on**: Phase 15
**Plans**: 0 plans (verified complete via research)

**Details:**
Research verified that matching already works at storage layer. SportRadar ID matching is automatic during competitor scraping. 75% match rate verified. ~954 competitor-only events identified.

### Phase 17: Palimpsest API Endpoints

**Goal**: Create API endpoints for matched/competitor-only event queries with coverage stats
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:
- [x] 17-01: Pydantic schemas + Coverage Stats endpoint
- [x] 17-02: Events Query endpoint with filters and grouping

**Details:**
GET /api/palimpsest/coverage returns overall stats. GET /api/palimpsest/events with availability filter (all|matched|betpawa-only|competitor-only), platform filter, search, sorting, and tournament grouping.

### Phase 18: Matches Page Filter + Metadata Priority

**Goal**: Add filter to show BetPawa-only, Competitor-only, or Both events. Use metadata priority (sportybet > bet9ja) for competitor-only display.
**Depends on**: Phase 17
**Plans**: 1 plan

Plans:
- [x] 18-01: Event Mode Toggle (toggle UI, extended API, competitor events in table)

**Details:**
Extended /api/events with availability filter. Mode toggle on Matches page. Competitor-only events display with subtle visual indicator. Negative IDs distinguish competitor events.

### Phase 19: Palimpsest Comparison Page

**Goal**: New page showing tournament and event coverage comparison across platforms
**Depends on**: Phase 18
**Plans**: 3 plans

Plans:
- [x] 19-01: Coverage Page Foundation (TypeScript types, feature folder, navigation)
- [x] 19-02: Summary Stats & Filtering (stat cards, availability/search/country filters)
- [x] 19-03: Tournament Table (tournament list with event counts, expandable rows)

**Details:**
Created coverage feature folder with API hooks. Stats cards show total events, matched events, BetPawa-only, competitor-only. Filter bar with availability, search, and country dropdowns. Tournament table with three-column platform layout and expandable event rows.

---

## Milestone Summary

**Key Decisions:**

- Metadata priority: sportybet > bet9ja for competitor-only events
- Negative IDs (-competitor_event.id) distinguish competitor-only from BetPawa events
- Two-phase fetch-then-store pattern for competitor scraping (API parallel, DB sequential)
- Tournament grouping by tournament_name|sport_name as unique key

**Issues Resolved:**

- AsyncSession cannot be shared across concurrent asyncio tasks - fixed with explicit commits between phases
- Timezone-aware/naive datetime comparison errors - fixed with get_kickoff_naive helper
- Missing shadcn/ui Tabs component - created custom button group toggle

**Issues Deferred:**

- WebSocket real-time updates (still using SSE + polling)
- Historical trend visualization
- Competitor event detail views

**Technical Debt Incurred:**

- None significant

---

_For current project status, see .planning/ROADMAP.md_
