# Milestone v1.7: Scraping Architecture Overhaul

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 36-42
**Total Plans:** 16 (7 original + 9 FIX plans)

## Overview

Redesign scraping to capture odds simultaneously across all bookmakers for reliable trader comparison. The new event-centric architecture scrapes all platforms in parallel per event (vs sequential platform-by-platform), reducing timing gaps from minutes to milliseconds.

## Phases

### Phase 36: Investigation & Architecture Design

**Goal**: Profile current bottlenecks, design new coordination layer
**Depends on**: v1.6 complete
**Plans**: 1/1

Plans:
- [x] 36-01: Profile bottlenecks, investigate rate limits, design EventCoordinator — 2026-01-29

**Details:**
- Profiled current scraping architecture identifying 4 bottlenecks (sequential platform execution being CRITICAL)
- Investigated rate limits for all 3 platforms - no explicit headers, documented safe concurrency limits (50/50/15)
- Designed EventCoordinator class with complete interface for event-centric scraping
- Created priority queue algorithm prioritizing kickoff urgency and bookmaker coverage
- Designed SSE observability schema with 7 event types for per-event progress tracking

### Phase 37: Event Coordination Layer

**Goal**: New EventCoordinator with SR ID collection and priority queue
**Depends on**: Phase 36
**Plans**: 1/1

Plans:
- [x] 37-01: Create EventCoordinator with discovery and priority queue — 2026-01-29

**Details:**
- Created ScrapeStatus StrEnum, EventTarget dataclass, ScrapeBatch TypedDict
- Implemented EventCoordinator with parallel discovery (BetPawa, SportyBet, Bet9ja)
- Priority queue with kickoff urgency tiers (imminent <30min, soon 30-120min, future >2hr)
- Platform semaphores: BetPawa 5, SportyBet 10, Bet9ja 15+25ms delay

### Phase 38: SR ID Parallel Scraping

**Goal**: Simultaneous multi-bookmaker scraping with batch processing
**Depends on**: Phase 37
**Plans**: 1/1

Plans:
- [x] 38-01: Extend EventTarget and implement parallel scraping — 2026-01-29

**Details:**
- Extended EventTarget with platform_ids dict for platform-specific event IDs
- Implemented _scrape_event_all_platforms() with per-platform semaphore control
- Implemented scrape_batch() async generator yielding progress events
- Added PLATFORM_SEMAPHORES (50/50/15) and BET9JA_DELAY_MS (25ms) constants

### Phase 39: Batch DB Storage

**Goal**: Bulk inserts, per-event status tracking table
**Depends on**: Phase 38
**Plans**: 1/1

Plans:
- [x] 39-01: EventScrapeStatus model, store_batch_results(), run_full_cycle() — 2026-01-29

**Details:**
- Created EventScrapeStatus model for per-event scrape observability
- Implemented store_batch_results() with bulk insert patterns
- Added run_full_cycle() async generator orchestrating complete scrape cycle

### Phase 40: Concurrency Tuning & Metrics

**Goal**: Optimize semaphores, add performance tracking
**Depends on**: Phase 39
**Plans**: 1/1

Plans:
- [x] 40-01: Configurable tuning settings, EventCoordinator integration, event metrics API — 2026-01-29

**Details:**
- Added 5 scraping tuning settings to Settings model
- EventCoordinator.from_settings() factory method for configurable initialization
- GET /api/scrape/event-metrics endpoint for per-platform analytics

### Phase 41: On-Demand API

**Goal**: Single-event refresh endpoint POST /api/scrape/{sr_id}
**Depends on**: Phase 40
**Plans**: 1/1

Plans:
- [x] 41-01: POST /api/scrape/event/{sr_id} endpoint with parallel platform scraping — 2026-01-29

**Details:**
- Added SingleEventPlatformResult and SingleEventScrapeResponse schemas
- Implemented POST /api/scrape/event/{sr_id} with parallel platform scraping
- Platform ID lookup from Event and CompetitorEvent tables

### Phase 42: Validation & Cleanup

**Goal**: Integrate EventCoordinator, remove legacy ScrapingOrchestrator
**Depends on**: Phase 41
**Plans**: 1/1 + 9 FIX plans

Plans:
- [x] 42-01: Update scheduler and API to use EventCoordinator, delete orchestrator.py — 2026-01-29
- [x] 42-01-FIX: Fix ScrapeProgress error, BetPawa discovery, batch performance — 2026-01-29
- [x] 42-01-FIX2: Fix BetPawa event list response parsing — 2026-01-29
- [x] 42-01-FIX3: Fix BetPawa SR ID extraction (widget.id) — 2026-01-29
- [x] 42-01-FIX4: Confirm widget.id, add competitor tournament extraction — 2026-02-02
- [x] 42-01-FIX5: Fix bookmaker auto-creation, competitor tournament fields — 2026-02-02
- [x] 42-01-FIX6: Add betpawa_event_id linking to CompetitorEvent — 2026-02-02
- [x] 42-01-FIX7: Load competitor odds in events API — 2026-02-02
- [x] 42-01-FIX8: Create EventBookmaker links for competitors — 2026-02-02
- [x] 42-01-FIX9: Add competitor odds to event detail page — 2026-02-02

**Details:**
- Scheduler and API migrated to EventCoordinator.from_settings()
- Legacy ScrapingOrchestrator deleted (~1,884 lines removed)
- SSE progress events mapped to ScrapeProgress for broadcaster compatibility
- 9 FIX plans resolved UAT bugs discovered during validation

---

## Milestone Summary

**Key Decisions:**

- Event-centric parallel scraping (all platforms per event vs sequential by platform)
- Priority queue composite key: (urgency_tier, kickoff, -coverage, not_has_betpawa)
- EventCoordinator.from_settings() factory method for configurable initialization
- Single-flush batch insert pattern (100x fewer DB round trips)
- BetPawa widget.id contains SR ID (8-digit numeric string)
- Competitor tournament extraction from raw API responses

**Issues Resolved:**

- Sequential platform scraping causing timing gaps (CRITICAL bottleneck)
- BetPawa discovery API structure changed (withRegions[0].regions)
- BetPawa SR ID extraction (widget.id not widget.data.matchId)
- Competitor tournaments created with fallback instead of real data
- Bookmaker table not seeded (auto-create on first run)
- CompetitorEvent missing betpawa_event_id link
- Event detail page missing competitor odds

**Issues Deferred:**

- API-002: Event detail uses legacy odds tables, missing ~50% competitor data (partial fix in FIX9)

**Technical Debt Incurred:**

- None - architecture is clean and extensible

---

_For current project status, see .planning/ROADMAP.md_
