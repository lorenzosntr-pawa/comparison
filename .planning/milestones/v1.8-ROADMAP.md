# Milestone v1.8: Market Matching Accuracy

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 43-47
**Total Plans:** 9 (7 main + 2 FIX)

## Overview

Systematically discover and fix ALL market mapping issues through comprehensive data audit, then targeted fixes based on actual findings. This milestone focused on improving the market mapping success rates for competitor platforms (SportyBet and Bet9ja) to enable more accurate odds comparison.

## Phases

### Phase 43: Comprehensive Market Mapping Audit

**Goal**: Analyze 50+ events across various tournaments, compare raw API data from all 3 bookmakers vs stored data, categorize all unmapped/wrong market mappings
**Depends on**: Phase 42 (v1.7 complete)
**Plans**: 1/1 complete

Plans:
- [x] 43-01: Market Mapping Audit (100 events, 380 unmapped market types identified)

**Details:**
- Created comprehensive audit script analyzing 100 events across 46 tournaments
- Identified 380 unique unmapped market types
- Categorized by error type: UNKNOWN_MARKET, NO_MATCHING_OUTCOMES, UNKNOWN_PARAM_MARKET
- Prioritized by frequency for targeted fixes

### Phase 44: High-Priority Market Mappings

**Goal**: Fix HIGH priority market mapping issues identified in Phase 43 audit, organized by error type
**Depends on**: Phase 43 (audit complete)
**Plans**: 3/3 complete + 2 FIX plans

Plans:
- [x] 44-01: NO_MATCHING_OUTCOMES fixes (TMGHO/TMGAW 100% success, HAOU improved classification)
- [x] 44-02: UNKNOWN_MARKET fixes (20 new mappings, ~1,800 occurrences)
- [x] 44-03: UNKNOWN_PARAM_MARKET fixes (combo market parameter handling, ~1,500 occurrences)

**Details:**
- Fixed TMGHO (Home Team Multigoals) and TMGAW (Away Team Multigoals) outcome structure
- Added 20 new market mappings for previously unknown markets
- Added combo market keys (1X2OU, DCOU, etc.) to O/U parameter handling
- Eliminated UNKNOWN_PARAM_MARKET category entirely

### Phase 45: Market Mapping Improvement Audit

**Goal**: Analyze improvements from Phase 44 fixes and discover next steps
**Depends on**: Phase 44 (complete)
**Plans**: 1/1 complete

Plans:
- [x] 45-01: Market Mapping Improvement Audit (SportyBet: 47.3%→52.2%, Bet9ja: 36.1%→40.5%)

**Details:**
- Re-ran audit on 199 events for comprehensive coverage
- Verified all Phase 44 fixes successful
- UNKNOWN_PARAM_MARKET category eliminated
- Identified remaining gaps for future phases

### Phase 46: Handicap Market Mapping Fix

**Goal**: Fix handicap markets (3-Way and Asian) so competitor odds display correctly
**Depends on**: Phase 45 (complete)
**Plans**: 1/1 complete

Plans:
- [x] 46-01: Handicap Market Line Fix (line field populated from handicap_home)

**Details:**
- Root cause: competitor handicap markets stored `line=null` while BetPawa stores `line=-1`
- Fix: populate `line` field from `handicap_home` in event_coordinator.py
- Markets fixed: 3-Way Handicap (4724, 4716, 4720), Asian Handicap (3774, 3747, 3756)

### Phase 47: Combo Market Display Fix

**Goal**: Fix frontend bug where combo markets show margins but no odds
**Depends on**: Phase 46 (complete)
**Plans**: 1/1 complete

Plans:
- [x] 47-01: Combo Market Margin/Odds Display Fix

**Details:**
- Root cause: `getUnifiedOutcomes()` checked market existence but not `outcomes.length > 0`
- Additional issue: outcome name mismatch (" - " vs " & " separators)
- Fix: Added `normalizeOutcomeName()` function and outcomes.length checks
- Margin now only displays when outcomes exist

---

## Milestone Summary

**Key Decisions:**
- Audit-driven approach: comprehensive data audit before any fixes
- Fix at storage time for handicap line field (vs mapping or frontend)
- Normalize outcome names at match time (keeps raw data intact)
- Focus on UNKNOWN_MARKET gaps, skip UNSUPPORTED_PLATFORM (correctly classified)

**Issues Resolved:**
- BUG-004: Combo markets showing margins but no odds
- Handicap markets not displaying competitor odds
- ~1,500 UNKNOWN_PARAM_MARKET errors eliminated
- ~1,800 previously unknown markets now mapped

**Issues Deferred:**
- ISS-002: Full comprehensive market mapping (Bet9ja at 40.5%, below 50% target)
- Remaining gaps: OUA, CHANCEMIX, CAH markets

**Technical Debt Incurred:**
- None significant

**Stats:**
- Files modified: 44
- Lines changed: +13,290 / -57
- Total LOC: ~30,647
- Timeline: 2 days (2026-02-02 → 2026-02-03)

---

_For current project status, see .planning/ROADMAP.md_
