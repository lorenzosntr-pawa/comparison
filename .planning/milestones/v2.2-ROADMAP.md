# Milestone v2.2: Odds Freshness

**Status:** SHIPPED 2026-02-09
**Phases:** 69-71
**Total Plans:** 3

## Overview

Ensure the most updated odds are always shown per bookmaker with accurate timestamps that update in real-time. Investigated and fixed timestamp staleness issues across the entire data flow from scraping through cache to API to frontend.

## Phases

### Phase 69: Investigation & Freshness Audit

**Goal**: Trace data flow from scrape to display, identify all staleness sources
**Depends on**: v2.1 complete
**Plans**: 1/1 complete

Plans:

- [x] 69-01: Data flow tracing and freshness audit — 2026-02-09

**Details:**
Complete audit identified 7 staleness sources across backend and frontend (2 CRITICAL, 2 HIGH, 2 MEDIUM, 1 LOW). Root cause found: API returned `captured_at` (when odds changed) instead of `last_confirmed_at` (when last verified). Frontend also missing WebSocket odds_updates subscription.

### Phase 70: Backend Freshness Fixes

**Goal**: Fix storage, cache, and API timestamp issues found in investigation
**Depends on**: Phase 69
**Plans**: 1/1 complete

Plans:

- [x] 70-01: Add last_confirmed_at to cache and API — 2026-02-09

**Details:**
Added `last_confirmed_at` field to CachedSnapshot frozen dataclass. Updated all 3 cache helper functions and 4 EventCoordinator call sites. Created `_get_snapshot_time()` helper function for consistent timestamp handling across 7 API locations with fallback to `captured_at` for backward compatibility.

### Phase 71: Frontend Freshness Fixes

**Goal**: Fix WebSocket handlers and UI reactivity for real-time timestamp updates
**Depends on**: Phase 70
**Plans**: 1/1 complete

Plans:

- [x] 71-01: Subscribe to odds_updates and invalidate queries — 2026-02-09

**Details:**
Created `useOddsUpdates` hook that subscribes to WebSocket `odds_updates` topic. Query invalidation triggers on `odds_update` messages for both `['events']` and `['event', event_id]`. Integrated hook globally in App component via inner `AppContent` component (required for useQueryClient context).

---

## Milestone Summary

**Decimal Phases:**

- None (standard phase numbering 69-71)

**Key Decisions:**

- Decision: `captured_at` vs `last_confirmed_at` distinction (Rationale: `captured_at` = when odds changed, `last_confirmed_at` = when last verified; use latter for freshness)
- Decision: `_get_snapshot_time()` helper pattern (Rationale: consistent timestamp extraction with fallback for backward compatibility)
- Decision: Global WebSocket subscription via App hook (Rationale: useOddsUpdates in App root for automatic query invalidation)
- Decision: Inner component for QueryClient context (Rationale: hooks requiring useQueryClient must be inside QueryClientProvider children)

**Issues Resolved:**

- CRITICAL: API used wrong timestamp field (`captured_at` instead of `last_confirmed_at`)
- CRITICAL: Frontend missing WebSocket odds_updates subscription
- HIGH: No query invalidation on odds_update messages
- HIGH: Cache/DB timestamp inconsistency after restart

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md_
