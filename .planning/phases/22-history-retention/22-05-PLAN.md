---
phase: 22-history-retention
plan: 05
type: execute
---

<objective>
Create Manage Data dialog with full data overview, cleanup history, and manual cleanup controls with preview.

Purpose: Give users visibility into stored data and control over manual cleanup operations.
Output: ManageDataDialog component with data stats, history, and cleanup functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-history-retention/22-CONTEXT.md
@.planning/phases/22-history-retention/22-03-PLAN.md
@.planning/phases/22-history-retention/22-04-PLAN.md

# Key files - API endpoints from Plan 03
# GET /api/cleanup/stats - data breakdown
# GET /api/cleanup/preview - deletion preview
# POST /api/cleanup/execute - manual cleanup
# GET /api/cleanup/history - past runs

**From 22-CONTEXT.md - Manage Data Dialog:**
- Full data overview (breakdown by platform, dates, counts)
- Manual cleanup controls with date/range selection
- Preview before delete showing exactly what will be removed
- Cleanup history log with detailed breakdown
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManageDataDialog with data overview and history</name>
  <files>web/src/features/settings/components/manage-data-dialog.tsx, web/src/lib/api.ts, web/src/types/api.ts</files>
  <action>
Add API functions to web/src/lib/api.ts:
```typescript
export async function getCleanupStats(): Promise<CleanupStats> {
  const res = await fetch('/api/cleanup/stats')
  return res.json()
}

export async function getCleanupPreview(oddsdays?: number, matchDays?: number): Promise<CleanupPreview> {
  const params = new URLSearchParams()
  if (oddsDays) params.set('odds_days', String(oddsDays))
  if (matchDays) params.set('match_days', String(matchDays))
  const res = await fetch(`/api/cleanup/preview?${params}`)
  return res.json()
}

export async function executeCleanup(oddsDays?: number, matchDays?: number): Promise<CleanupResult> {
  const res = await fetch('/api/cleanup/execute', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ oddsRetentionDays: oddsDays, matchRetentionDays: matchDays })
  })
  return res.json()
}

export async function getCleanupHistory(limit = 10): Promise<CleanupRun[]> {
  const res = await fetch(`/api/cleanup/history?limit=${limit}`)
  return res.json()
}
```

Add types to web/src/types/api.ts:
- CleanupStats, CleanupPreview, CleanupResult, CleanupRun interfaces

Create web/src/features/settings/components/manage-data-dialog.tsx:
```tsx
export function ManageDataDialog({ open, onOpenChange }) {
  const [activeTab, setActiveTab] = useState<'overview' | 'cleanup' | 'history'>('overview')

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Manage Data</DialogTitle>
          <DialogDescription>View storage usage and manage data retention</DialogDescription>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="cleanup">Clean Up</TabsTrigger>
            <TabsTrigger value="history">History</TabsTrigger>
          </TabsList>

          <TabsContent value="overview">
            <DataOverviewTab />
          </TabsContent>

          <TabsContent value="cleanup">
            <CleanupTab onClose={() => onOpenChange(false)} />
          </TabsContent>

          <TabsContent value="history">
            <CleanupHistoryTab />
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  )
}
```

Create DataOverviewTab component:
- Use useQuery to fetch cleanup stats
- Display breakdown: total records, by platform, date ranges
- Show oldest/newest data dates
- Format numbers with thousands separators
  </action>
  <verify>cd web && npx tsc --noEmit</verify>
  <done>ManageDataDialog created with Overview and History tabs. API functions and types added.</done>
</task>

<task type="auto">
  <name>Task 2: Add manual cleanup controls with preview</name>
  <files>web/src/features/settings/components/manage-data-dialog.tsx</files>
  <action>
Complete the CleanupTab component within manage-data-dialog.tsx:

```tsx
function CleanupTab({ onClose }) {
  const { settings } = useSettings()
  const [oddsDays, setOddsDays] = useState(settings?.oddsRetentionDays ?? 30)
  const [matchDays, setMatchDays] = useState(settings?.matchRetentionDays ?? 30)
  const [showPreview, setShowPreview] = useState(false)
  const queryClient = useQueryClient()

  const previewQuery = useQuery({
    queryKey: ['cleanup-preview', oddsDays, matchDays],
    queryFn: () => getCleanupPreview(oddsDays, matchDays),
    enabled: showPreview,
  })

  const cleanupMutation = useMutation({
    mutationFn: () => executeCleanup(oddsDays, matchDays),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cleanup'] })
      toast.success('Cleanup completed successfully')
      onClose()
    }
  })

  return (
    <div className="space-y-4 py-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label>Delete odds older than</Label>
          <Select value={String(oddsDays)} onValueChange={(v) => setOddsDays(Number(v))}>
            {/* Same options as retention selector */}
          </Select>
        </div>
        <div>
          <Label>Delete matches older than</Label>
          <Select value={String(matchDays)} onValueChange={(v) => setMatchDays(Number(v))}>
            {/* Same options as retention selector */}
          </Select>
        </div>
      </div>

      {!showPreview ? (
        <Button variant="outline" onClick={() => setShowPreview(true)}>
          Preview Cleanup
        </Button>
      ) : previewQuery.isLoading ? (
        <div>Loading preview...</div>
      ) : previewQuery.data ? (
        <div className="space-y-4">
          <Alert>
            <AlertTitle>Cleanup Preview</AlertTitle>
            <AlertDescription>
              <ul className="list-disc list-inside">
                <li>{previewQuery.data.oddsCount.toLocaleString()} odds snapshots</li>
                <li>{previewQuery.data.scrapeRunsCount.toLocaleString()} scrape runs</li>
                <li>{previewQuery.data.matchesCount.toLocaleString()} matches</li>
                <li>{previewQuery.data.tournamentsCount.toLocaleString()} empty tournaments</li>
              </ul>
            </AlertDescription>
          </Alert>

          <div className="flex gap-2">
            <Button
              variant="destructive"
              onClick={() => cleanupMutation.mutate()}
              disabled={cleanupMutation.isPending}
            >
              {cleanupMutation.isPending ? 'Cleaning...' : 'Delete Now'}
            </Button>
            <Button variant="outline" onClick={() => setShowPreview(false)}>
              Cancel
            </Button>
          </div>
        </div>
      ) : null}
    </div>
  )
}
```

Complete CleanupHistoryTab:
- Fetch cleanup history with useQuery
- Display as table: date, trigger type, records deleted, status
- Show error message for failed runs
- Format dates relative (e.g., "2 hours ago")
  </action>
  <verify>cd web && npx tsc --noEmit</verify>
  <done>Cleanup tab with preview and execute. History tab shows past cleanup runs.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Manage Data dialog with data overview, manual cleanup with preview, and history</what-built>
  <how-to-verify>
    1. Run backend: cd src && python -m uvicorn api.app:app --reload
    2. Run frontend: cd web && npm run dev
    3. Visit: http://localhost:5173/settings
    4. Click "Manage Data" button
    5. Test Overview tab:
       - Should show data breakdown (counts by table)
       - Should show date ranges of stored data
    6. Test Cleanup tab:
       - Select retention days
       - Click "Preview Cleanup"
       - Should show what will be deleted
       - Click "Delete Now" (only if safe to do so)
    7. Test History tab:
       - Should show past cleanup runs (may be empty initially)
       - After manual cleanup, should show the new run
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ManageDataDialog opens from Settings page
- [ ] Overview tab shows data statistics
- [ ] Cleanup tab allows custom retention selection
- [ ] Preview shows what will be deleted before execution
- [ ] Execute cleanup works and shows success message
- [ ] History tab shows past cleanup runs
- [ ] No TypeScript errors
- [ ] Human verified all tabs work correctly
</verification>

<success_criteria>

- Full data visibility through Overview tab
- Safe cleanup workflow with preview before delete
- History tracking of all cleanup operations
- Smooth user experience with loading states
- Human verified functionality works end-to-end
- Phase 22 complete
</success_criteria>

<output>
After completion, create `.planning/phases/22-history-retention/22-05-SUMMARY.md`
</output>
