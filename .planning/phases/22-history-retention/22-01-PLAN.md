---
phase: 22-history-retention
plan: 01
type: execute
---

<objective>
Extend settings model with retention configuration fields replacing single history_retention_days with specific odds and match retention settings.

Purpose: Enable separate retention policies for odds snapshots (by timestamp) and matches (by kickoff time), plus configurable cleanup frequency.
Output: Updated Settings model with migration, Pydantic schemas, and frontend types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-history-retention/22-CONTEXT.md

# Prior phase context
@.planning/phases/20-settings-schema-api/20-01-SUMMARY.md
@.planning/phases/21-settings-persistence-integration/21-01-SUMMARY.md

# Key files
@src/db/models/settings.py
@src/api/schemas/settings.py
@src/api/routes/settings.py
@web/src/types/api.ts

**Constraining decisions:**
- Phase 20: history_retention_days added with default 7, validation 1-90
- Phase 21: Settings sync pattern established at startup

**From 22-CONTEXT.md:**
- Replace history_retention_days concept with two specific settings
- odds_retention_days: Delete odds snapshots older than X days (by snapshot timestamp)
- match_retention_days: Delete matches older than Y days (by kickoff time)
- Default values: 30 days for both
- Add cleanup_frequency_hours for scheduled cleanup interval
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Settings model and create migration</name>
  <files>src/db/models/settings.py, alembic/versions/xxxx_add_retention_settings.py</files>
  <action>
Modify Settings model:
1. Rename history_retention_days â†’ odds_retention_days (default=30)
2. Add match_retention_days: Mapped[int] = mapped_column(default=30)
3. Add cleanup_frequency_hours: Mapped[int] = mapped_column(default=24)

Create Alembic migration manually (database may not be running):
- Rename column history_retention_days to odds_retention_days
- Add match_retention_days column with server_default='30'
- Add cleanup_frequency_hours column with server_default='24'
- Update existing row's odds_retention_days default from 7 to 30

Use descriptive migration name like `update_retention_settings.py`
  </action>
  <verify>Python syntax check: python -m py_compile src/db/models/settings.py</verify>
  <done>Settings model has odds_retention_days, match_retention_days, cleanup_frequency_hours fields. Migration file created.</done>
</task>

<task type="auto">
  <name>Task 2: Update Pydantic schemas, routes, and frontend types</name>
  <files>src/api/schemas/settings.py, src/api/routes/settings.py, web/src/types/api.ts</files>
  <action>
Update src/api/schemas/settings.py:
1. Replace history_retention_days with odds_retention_days in SettingsResponse and SettingsUpdate
2. Add match_retention_days: int (response) / int | None (update) with Field(ge=1, le=365)
3. Add cleanup_frequency_hours: int (response) / int | None (update) with Field(ge=1, le=168)
   - 168 hours = 7 days max cleanup frequency

Update src/api/routes/settings.py:
- Add handlers for the new fields in the update endpoint (follow existing pattern for history_retention_days)

Update web/src/types/api.ts:
1. Replace historyRetentionDays with oddsRetentionDays in SettingsResponse and SettingsUpdate
2. Add matchRetentionDays: number (response) / number? (update)
3. Add cleanupFrequencyHours: number (response) / number? (update)
  </action>
  <verify>TypeScript check: cd web && npx tsc --noEmit</verify>
  <done>All schemas updated with new retention fields. Frontend types match backend.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Settings model has all three new fields with correct defaults
- [ ] Migration file exists with proper column operations
- [ ] Pydantic schemas expose all fields with validation
- [ ] Routes handle updates for all new fields
- [ ] TypeScript types match Python schemas (camelCase)
- [ ] No TypeScript errors in frontend
</verification>

<success_criteria>

- Settings model extended with odds_retention_days, match_retention_days, cleanup_frequency_hours
- Migration ready to apply
- API schemas and routes updated
- Frontend types updated
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-history-retention/22-01-SUMMARY.md`
</output>
