---
phase: 101-backend-foundation
plan: 01
type: execute
---

<objective>
Create database schema for market mapping utility with 3 tables.

Purpose: Establish persistent storage for user-defined mappings, audit history, and unmapped market discovery.
Output: Alembic migration and SQLAlchemy ORM models for user_market_mappings, mapping_audit_log, unmapped_market_log.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/100-investigation-design/DESIGN.md
@.planning/phases/100-investigation-design/100-01-SUMMARY.md
@src/api/models.py

**From Phase 100 DESIGN.md:**
- 3 tables: user_market_mappings, mapping_audit_log, unmapped_market_log
- Complete SQL DDL with indexes provided
- JSONB columns for outcome_mapping and sample_outcomes
- Soft delete pattern via is_active flag
- Status enum for unmapped_market_log: NEW, ACKNOWLEDGED, MAPPED, IGNORED

**Established patterns:**
- SQLAlchemy 2.0 async with Mapped[] column annotations
- ConfigDict(from_attributes=True) for Pydantic compatibility
- TIMESTAMPTZ for all timestamp columns
- Partial indexes for filtered queries (WHERE is_active = TRUE)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration for 3 tables</name>
  <files>src/api/alembic/versions/{timestamp}_add_market_mapping_tables.py</files>
  <action>
Create Alembic migration with:

**Table 1: user_market_mappings**
- id: Integer primary key
- canonical_id: VARCHAR(100) UNIQUE NOT NULL
- name: VARCHAR(255) NOT NULL
- betpawa_id: VARCHAR(50) nullable
- sportybet_id: VARCHAR(50) nullable
- bet9ja_key: VARCHAR(50) nullable
- outcome_mapping: JSONB NOT NULL
- priority: INTEGER default 0
- is_active: BOOLEAN default TRUE
- created_at: TIMESTAMPTZ default NOW()
- updated_at: TIMESTAMPTZ default NOW()
- created_by: VARCHAR(100) nullable

Indexes:
- idx_user_mappings_active: (is_active) WHERE is_active = TRUE
- idx_user_mappings_betpawa: (betpawa_id) WHERE betpawa_id IS NOT NULL
- idx_user_mappings_sportybet: (sportybet_id) WHERE sportybet_id IS NOT NULL
- idx_user_mappings_bet9ja: (bet9ja_key) WHERE bet9ja_key IS NOT NULL

**Table 2: mapping_audit_log**
- id: Integer primary key
- mapping_id: INTEGER FK to user_market_mappings(id) ON DELETE SET NULL
- canonical_id: VARCHAR(100) NOT NULL
- action: VARCHAR(20) NOT NULL (CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE)
- old_value: JSONB nullable
- new_value: JSONB nullable
- reason: TEXT nullable
- created_at: TIMESTAMPTZ default NOW()
- created_by: VARCHAR(100) nullable

Indexes:
- idx_audit_log_mapping: (mapping_id)
- idx_audit_log_canonical: (canonical_id)
- idx_audit_log_action: (action)
- idx_audit_log_created: (created_at)

**Table 3: unmapped_market_log**
- id: Integer primary key
- source: VARCHAR(20) NOT NULL ("sportybet" or "bet9ja")
- external_market_id: VARCHAR(100) NOT NULL
- market_name: VARCHAR(255) nullable
- sample_outcomes: JSONB nullable
- first_seen_at: TIMESTAMPTZ default NOW()
- last_seen_at: TIMESTAMPTZ default NOW()
- occurrence_count: INTEGER default 1
- status: VARCHAR(20) default 'NEW'
- notes: TEXT nullable
- UNIQUE(source, external_market_id)

Indexes:
- idx_unmapped_source: (source)
- idx_unmapped_status: (status)
- idx_unmapped_occurrences: (occurrence_count DESC)
- idx_unmapped_last_seen: (last_seen_at DESC)

Use op.create_table() with sa.Column() - do NOT use raw SQL for table creation.
Use op.create_index() with postgresql_where for partial indexes.
  </action>
  <verify>cd src/api && alembic upgrade head && alembic check</verify>
  <done>All 3 tables created with indexes, migration applies cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create SQLAlchemy ORM models</name>
  <files>src/api/models.py</files>
  <action>
Add 3 new model classes following existing patterns in models.py:

**class UserMarketMapping(Base):**
```python
__tablename__ = "user_market_mappings"

id: Mapped[int] = mapped_column(Integer, primary_key=True)
canonical_id: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
name: Mapped[str] = mapped_column(String(255), nullable=False)
betpawa_id: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)
sportybet_id: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)
bet9ja_key: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)
outcome_mapping: Mapped[list] = mapped_column(JSONB, nullable=False)
priority: Mapped[int] = mapped_column(Integer, default=0)
is_active: Mapped[bool] = mapped_column(Boolean, default=True)
created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
created_by: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)

# Relationship
audit_logs: Mapped[list["MappingAuditLog"]] = relationship(back_populates="mapping")
```

**class MappingAuditLog(Base):**
```python
__tablename__ = "mapping_audit_log"

id: Mapped[int] = mapped_column(Integer, primary_key=True)
mapping_id: Mapped[Optional[int]] = mapped_column(Integer, ForeignKey("user_market_mappings.id", ondelete="SET NULL"), nullable=True)
canonical_id: Mapped[str] = mapped_column(String(100), nullable=False)
action: Mapped[str] = mapped_column(String(20), nullable=False)
old_value: Mapped[Optional[dict]] = mapped_column(JSONB, nullable=True)
new_value: Mapped[Optional[dict]] = mapped_column(JSONB, nullable=True)
reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
created_by: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)

# Relationship
mapping: Mapped[Optional["UserMarketMapping"]] = relationship(back_populates="audit_logs")
```

**class UnmappedMarketLog(Base):**
```python
__tablename__ = "unmapped_market_log"
__table_args__ = (UniqueConstraint("source", "external_market_id", name="uq_unmapped_source_market"),)

id: Mapped[int] = mapped_column(Integer, primary_key=True)
source: Mapped[str] = mapped_column(String(20), nullable=False)
external_market_id: Mapped[str] = mapped_column(String(100), nullable=False)
market_name: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
sample_outcomes: Mapped[Optional[dict]] = mapped_column(JSONB, nullable=True)
first_seen_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
last_seen_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
occurrence_count: Mapped[int] = mapped_column(Integer, default=1)
status: Mapped[str] = mapped_column(String(20), default="NEW")
notes: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
```

Add imports at top: UniqueConstraint, Text, JSONB (from sqlalchemy.dialects.postgresql).
Models must be after existing imports and before any existing model definitions to maintain file organization.
  </action>
  <verify>cd src/api && python -c "from models import UserMarketMapping, MappingAuditLog, UnmappedMarketLog; print('Models imported successfully')"</verify>
  <done>All 3 models defined with correct types, relationships, and constraints</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd src/api && alembic upgrade head` succeeds
- [ ] `cd src/api && alembic check` shows no pending changes
- [ ] All 3 models import without errors
- [ ] Relationships between UserMarketMapping and MappingAuditLog work
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript/Python errors
- Database has 3 new tables with correct indexes
- ORM models match table schema exactly
</success_criteria>

<output>
After completion, create `.planning/phases/101-backend-foundation/101-01-SUMMARY.md`
</output>
