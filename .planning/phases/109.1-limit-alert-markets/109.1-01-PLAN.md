---
phase: 109.1-limit-alert-markets
plan: 01
type: execute
---

<objective>
Limit risk alert detection to primary markets only: 1X2, Double Chance, BTTS, Asian Handicaps (all spreads), Over/Under (all spreads).

Purpose: Reduce alert noise by filtering out obscure markets that aren't operationally significant for risk monitoring.
Output: Modified risk_detection.py that only generates alerts for the 5 primary market types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase dependencies
@.planning/phases/106-backend-alert-detection/106-01-SUMMARY.md

# Source files
@src/caching/risk_detection.py

**Primary Market IDs (from market_ids.py):**
- `3743` = 1X2 - Full Time
- `4693` = Double Chance - Full Time
- `3795` = BTTS - Full Time
- `5000` = Over/Under - Full Time (all line values)
- `3774` = Asian Handicap - Full Time (all line values)

**"All spreads" means:** All line values within these market types are included. The filter checks market_id only, not the line value. A market with id=5000 and line=2.5 is included, as is line=0.5, line=3.5, etc.

**Current behavior:** detect_risk_alerts() generates alerts for ALL markets that have competitor coverage.

**Desired behavior:** Only generate alerts for markets where market_id is in PRIMARY_MARKET_IDS.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PRIMARY_MARKET_IDS constant and filter helper</name>
  <files>src/caching/risk_detection.py</files>
  <action>
Add after the AlertThresholds class (around line 92):

1. Create a frozenset constant:
```python
# Primary markets for alert detection (filter out obscure markets)
# Only these market types generate risk alerts
PRIMARY_MARKET_IDS: frozenset[str] = frozenset({
    "3743",  # 1X2 - Full Time
    "4693",  # Double Chance - Full Time
    "3795",  # BTTS - Full Time
    "5000",  # Over/Under - Full Time (all lines)
    "3774",  # Asian Handicap - Full Time (all lines)
})
```

2. Add helper function after the constant:
```python
def is_primary_market(market_id: str) -> bool:
    """Check if market is a primary market for alert detection.

    Primary markets are the core betting markets that risk monitors
    care about: 1X2, Double Chance, BTTS, Over/Under, Asian Handicap.

    Parameters
    ----------
    market_id:
        BetPawa market type ID (e.g., "3743" for 1X2).

    Returns
    -------
    bool
        True if market is a primary market.
    """
    return market_id in PRIMARY_MARKET_IDS
```

Use frozenset for O(1) membership testing. Place constants before helper functions section.
  </action>
  <verify>grep -n "PRIMARY_MARKET_IDS" src/caching/risk_detection.py shows constant defined</verify>
  <done>PRIMARY_MARKET_IDS frozenset and is_primary_market() function exist in risk_detection.py</done>
</task>

<task type="auto">
  <name>Task 2: Filter alerts to primary markets in detect_risk_alerts</name>
  <files>src/caching/risk_detection.py</files>
  <action>
Modify the end of detect_risk_alerts() function (after all alerts are collected, before the logger.debug call):

Add a filter step that removes non-primary market alerts:

```python
# Filter to primary markets only
all_alerts = [a for a in all_alerts if is_primary_market(a.market_id)]
```

This single filter at the end is cleaner than filtering in each detection function:
- Central location for the filter logic
- Easy to modify or remove later
- Doesn't complicate individual detection functions

The filter should go AFTER all 5 alert collection steps (Betpawa price, competitor price, direction disagreement, Betpawa availability, competitor availability) and BEFORE the logger.debug call.

Also update the docstring of detect_risk_alerts() to mention primary market filtering:
Add to the docstring after "Calls:" section:
```
Note: Only alerts for primary markets are returned (1X2, Double Chance, BTTS,
Over/Under, Asian Handicap). Other markets are filtered out to reduce noise.
```
  </action>
  <verify>grep -A5 "Filter to primary markets" src/caching/risk_detection.py shows filter logic</verify>
  <done>detect_risk_alerts() filters alerts to primary markets only before returning</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] PRIMARY_MARKET_IDS contains exactly 5 market IDs
- [ ] is_primary_market() helper function exists
- [ ] detect_risk_alerts() filters alerts at the end
- [ ] Backend starts without errors: `cd src && python -c "from caching.risk_detection import detect_risk_alerts, PRIMARY_MARKET_IDS; print(f'Markets: {PRIMARY_MARKET_IDS}')"`
</verification>

<success_criteria>

- PRIMARY_MARKET_IDS frozenset defined with 5 market IDs
- is_primary_market() helper function implemented
- detect_risk_alerts() returns only primary market alerts
- No syntax errors in risk_detection.py
  </success_criteria>

<output>
After completion, create `.planning/phases/109.1-limit-alert-markets/109.1-01-SUMMARY.md`:

# Phase 109.1 Plan 01: Limit Alert Detection Summary

**[One-liner about what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/caching/risk_detection.py` - Added PRIMARY_MARKET_IDS and filtering

## Decisions Made

[Any decisions or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Ready for Phase 110: Cross-Page Integration
</output>
