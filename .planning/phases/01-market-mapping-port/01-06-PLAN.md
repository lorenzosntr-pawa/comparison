---
phase: 01-market-mapping-port
plan: 06
type: execute
---

<objective>
Port the unified multi-platform API and add pytest tests.

Purpose: Provide a single entry point for mapping from any competitor platform, with test coverage.
Output: Complete unified mapper and pytest test suite validating all functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-market-mapping-port/01-RESEARCH.md

# Prior plan summaries:
@.planning/phases/01-market-mapping-port/01-01-SUMMARY.md
@.planning/phases/01-market-mapping-port/01-02-SUMMARY.md
@.planning/phases/01-market-mapping-port/01-03-SUMMARY.md
@.planning/phases/01-market-mapping-port/01-04-SUMMARY.md
@.planning/phases/01-market-mapping-port/01-05-SUMMARY.md

# TypeScript source to port:
@mapping_markets/src/mappers/unified.ts
@mapping_markets/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port unified mapper and package exports</name>
  <files>src/market_mapping/mappers/unified.py, src/market_mapping/__init__.py</files>
  <action>
Create `unified.py` with the multi-platform entry point:

```python
from ..types.competitors import CompetitorInput, SportybetInput, Bet9jaInput
from ..types.mapped import MappedMarket
from .sportybet import map_sportybet_to_betpawa
from .bet9ja import map_bet9ja_market_to_betpawa

def map_to_betpawa(input_data: CompetitorInput) -> MappedMarket:
    """
    Map competitor market data to Betpawa format.

    Uses Pydantic's discriminated union to automatically route
    to the correct mapper based on the source field.

    Args:
        input_data: Either SportybetInput or Bet9jaInput

    Returns:
        MappedMarket in Betpawa's format

    Raises:
        MappingError: If the market cannot be mapped
    """
    if input_data.source == "sportybet":
        return map_sportybet_to_betpawa(input_data.market)
    elif input_data.source == "bet9ja":
        return map_bet9ja_market_to_betpawa(
            input_data.market_key,
            input_data.param,
            input_data.outcomes,
        )
    else:
        # Should never happen due to Pydantic validation
        raise ValueError(f"Unknown source: {input_data.source}")
```

Update `src/market_mapping/__init__.py` to export the public API:
```python
# Types
from .types.errors import MappingError, MappingErrorCode
from .types.mapped import MappedMarket, MappedOutcome, MappedHandicap
from .types.competitors import CompetitorInput, SportybetInput, Bet9jaInput

# Mappers
from .mappers.unified import map_to_betpawa
from .mappers.sportybet import map_sportybet_to_betpawa
from .mappers.bet9ja import map_bet9ja_market_to_betpawa, map_bet9ja_odds_to_betpawa

# Registry
from .mappings import (
    MARKET_MAPPINGS,
    find_by_betpawa_id,
    find_by_sportybet_id,
    find_by_canonical_id,
    find_by_bet9ja_key,
)

__all__ = [
    # Types
    "MappingError",
    "MappingErrorCode",
    "MappedMarket",
    "MappedOutcome",
    "MappedHandicap",
    "CompetitorInput",
    "SportybetInput",
    "Bet9jaInput",
    # Mappers
    "map_to_betpawa",
    "map_sportybet_to_betpawa",
    "map_bet9ja_market_to_betpawa",
    "map_bet9ja_odds_to_betpawa",
    # Registry
    "MARKET_MAPPINGS",
    "find_by_betpawa_id",
    "find_by_sportybet_id",
    "find_by_canonical_id",
    "find_by_bet9ja_key",
]
```

Update `mappers/__init__.py` to export `map_to_betpawa`.
  </action>
  <verify>python -c "from market_mapping import map_to_betpawa, MappedMarket, MappingError; print('Public API ready')"</verify>
  <done>Unified mapper works with discriminated union, all public API exported from market_mapping package</done>
</task>

<task type="auto">
  <name>Task 2: Set up pytest and write unit tests</name>
  <files>pyproject.toml, tests/__init__.py, tests/test_parsers.py, tests/test_mappings.py, tests/test_sportybet_mapper.py, tests/test_bet9ja_mapper.py</files>
  <action>
1. Update `pyproject.toml` to add pytest:
```toml
[project]
name = "market-mapping"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = [
    "pydantic>=2.10",
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0",
]

[tool.pytest.ini_options]
testpaths = ["tests"]
pythonpath = ["src"]
```

2. Create `tests/__init__.py` (empty)

3. Create `tests/test_parsers.py`:
- Test `parse_specifier` with various inputs (total, hcp, variant, goalnr)
- Test `parse_handicap` with positive and negative handicaps
- Test `parse_bet9ja_key` with all key formats
- Test edge cases (empty strings, very long strings, malformed input)

4. Create `tests/test_mappings.py`:
- Test `MARKET_MAPPINGS` contains expected count (100+)
- Test `find_by_sportybet_id("1")` returns 1X2 FT
- Test `find_by_betpawa_id("3743")` returns 1X2 FT
- Test `find_by_bet9ja_key("S_1X2")` returns 1X2 FT
- Test classification sets (is_over_under_market, etc.)

5. Create `tests/test_sportybet_mapper.py`:
- Test simple market mapping (1X2)
- Test Over/Under with line extraction
- Test Handicap with handicap extraction
- Test error cases (unknown market, unsupported platform)

6. Create `tests/test_bet9ja_mapper.py`:
- Test single market mapping
- Test batch mapping with mixed success/failure
- Test parameterized markets (O/U with line)
- Test error cases

Each test file should follow pytest conventions with descriptive test names.
  </action>
  <verify>cd src && python -m pytest ../tests -v --tb=short</verify>
  <done>All tests pass, pytest configured correctly, test coverage for parsers, mappings, and both mappers</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete market_mapping Python library with all types, mappings, parsers, mappers, and tests</what-built>
  <how-to-verify>
    1. Run: cd c:/Users/loren/Desktop/betpawa/comparison/mvp && pip install -e "./src[dev]"
    2. Run: python -m pytest tests -v
    3. Verify: All tests pass
    4. Run: python -c "from market_mapping import map_sportybet_to_betpawa, MARKET_MAPPINGS; print(f'{len(MARKET_MAPPINGS)} markets available')"
    5. Verify: Shows 100+ markets
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e "./src[dev]"` succeeds
- [ ] `python -m pytest tests -v` shows all tests passing
- [ ] Public API importable from `market_mapping`
- [ ] Unified mapper correctly routes Sportybet and Bet9ja inputs
</verification>

<success_criteria>

- Unified mapper dispatches correctly based on source
- All public API exported from package root
- Pytest configured and all tests pass
- Phase 1 complete with full market mapping library
</success_criteria>

<output>
After completion, create `.planning/phases/01-market-mapping-port/01-06-SUMMARY.md` with:

# Phase 1 Plan 6: Unified API & Tests Summary

**[Summary of what was accomplished]**

## Accomplishments

- Unified mapper entry point
- Public API exports
- Pytest test suite

## Files Created/Modified

- src/market_mapping/mappers/unified.py
- src/market_mapping/__init__.py
- pyproject.toml
- tests/test_*.py

## Decisions Made

[Any decisions]

## Issues Encountered

[Any issues]

## Next Step

Phase 1 complete. Ready for Phase 2: Database Schema.
</output>
