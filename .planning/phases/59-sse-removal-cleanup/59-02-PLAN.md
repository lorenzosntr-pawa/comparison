---
phase: 59-sse-removal-cleanup
plan: 02
type: execute
domain: ui
---

<objective>
Simplify frontend hooks to WebSocket-only and migrate remaining SSE usage.

Purpose: Remove SSE fallback logic from hooks, update components to use WebSocket exclusively.
Output: Clean WebSocket-only frontend with no SSE code paths.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-sse-removal-cleanup/59-01-SUMMARY.md

**Key files:**
@web/src/features/dashboard/hooks/use-observe-scrape.ts
@web/src/features/scrape-runs/hooks/use-scrape-progress.ts
@web/src/features/dashboard/components/recent-runs.tsx
@web/src/hooks/use-websocket-scrape-progress.ts

**Prior decisions:**
- Phase 58: WS_FAIL_THRESHOLD = 3 before SSE fallback (now being removed)
- Phase 57: WebSocket connection manager and message protocol established

**Current state after 59-01:**
- Backend SSE endpoints removed
- SSE-only files deleted (dashboard/use-scrape-progress.ts, scrape-runs/live-progress.tsx)

**Remaining SSE code to remove:**
1. use-observe-scrape.ts: useObserveScrape (SSE) and SSE fallback in useActiveScrapesObserver
2. use-scrape-progress.ts (scrape-runs): useSseProgress internal function and SSE fallback
3. recent-runs.tsx: startScrape function uses EventSource directly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify use-observe-scrape.ts to WebSocket-only</name>
  <files>web/src/features/dashboard/hooks/use-observe-scrape.ts, web/src/features/dashboard/hooks/index.ts</files>
  <action>
Simplify use-observe-scrape.ts to remove all SSE code:

1. Remove the `useObserveScrape` hook entirely (lines ~27-91):
   - This is SSE-only, uses EventSource to /api/scrape/runs/{id}/progress
   - Not needed now that WebSocket handles progress

2. Simplify `useActiveScrapesObserver` hook:
   - Remove: WS_FAIL_THRESHOLD constant
   - Remove: wsFailCount state
   - Remove: wsEnabled derived state (just use true)
   - Remove: prevWsPhase ref for tracking WebSocket errors
   - Remove: useEffect that tracks ws.overallPhase for fallback
   - Remove: sseObservation = useObserveScrape(...) call
   - Simplify return values to only use WebSocket state (no SSE fallback)
   - Remove: transport field (no longer relevant with single transport)
   - Remove: observe and cleanup from return (SSE-specific)

3. Update index.ts:
   - Remove: `useObserveScrape` from exports (hook deleted)
   - Keep: `useActiveScrapesObserver` export

4. Final hook should:
   - Always use WebSocket via useWebSocketScrapeProgress
   - Return: activeScrapeId, isChecking, isObserving (from WS), progress, platformProgress, overallPhase, error, stopChecking
  </action>
  <verify>
- `grep -c "EventSource" web/src/features/dashboard/hooks/use-observe-scrape.ts` returns 0
- `grep -c "WS_FAIL_THRESHOLD" web/src/features/dashboard/hooks/use-observe-scrape.ts` returns 0
- `grep -c "useSse" web/src/features/dashboard/hooks/use-observe-scrape.ts` returns 0
- `grep -c "useObserveScrape" web/src/features/dashboard/hooks/index.ts` returns 0
  </verify>
  <done>use-observe-scrape.ts simplified to WebSocket-only, no SSE references</done>
</task>

<task type="auto">
  <name>Task 2: Simplify use-scrape-progress.ts (scrape-runs) to WebSocket-only</name>
  <files>web/src/features/scrape-runs/hooks/use-scrape-progress.ts</files>
  <action>
Simplify use-scrape-progress.ts to remove all SSE code:

1. Remove the `useSseProgress` internal function entirely (lines ~111-241):
   - This is the SSE fallback implementation
   - Uses EventSource to /api/scrape/runs/{id}/progress

2. Remove SSE-related code from `useScrapeProgress`:
   - Remove: WS_FAIL_THRESHOLD constant
   - Remove: wsFailCount state
   - Remove: wsEnabled derived state (just use isRunning)
   - Remove: prevWsPhase ref for error tracking
   - Remove: useEffect that tracks ws.overallPhase for fallback
   - Remove: sseEnabled derived state
   - Remove: sse = useSseProgress(...) call
   - Remove: SSE fallback logic in return values
   - Remove: transport field (or keep as always 'websocket')

3. Remove unused imports:
   - EventSource-related types (if any)
   - Unused React hooks after simplification

4. Simplify the hook to:
   - Use useWebSocketScrapeProgress directly
   - Pass through isRunning as enabled
   - Return WebSocket state only

5. Keep progressReducer and related types if still used, otherwise remove
  </action>
  <verify>
- `grep -c "EventSource" web/src/features/scrape-runs/hooks/use-scrape-progress.ts` returns 0
- `grep -c "useSseProgress" web/src/features/scrape-runs/hooks/use-scrape-progress.ts` returns 0
- `grep -c "WS_FAIL_THRESHOLD" web/src/features/scrape-runs/hooks/use-scrape-progress.ts` returns 0
- `grep -c "sseEnabled" web/src/features/scrape-runs/hooks/use-scrape-progress.ts` returns 0
  </verify>
  <done>use-scrape-progress.ts (scrape-runs) simplified to WebSocket-only</done>
</task>

<task type="auto">
  <name>Task 3: Update recent-runs.tsx to use WebSocket instead of SSE</name>
  <files>web/src/features/dashboard/components/recent-runs.tsx</files>
  <action>
Replace SSE-based startScrape with WebSocket + POST API approach:

1. Remove EventSource code from startScrape callback:
   - Remove eventSourceRef
   - Remove EventSource instantiation to /api/scrape/stream
   - Remove onmessage, onerror handlers

2. Replace with POST /api/scrape trigger + WebSocket observation:
   - The startScrape function should:
     a. POST to /api/scrape to trigger the scrape (returns scrape_run_id)
     b. WebSocket already observes via useActiveScrapesObserver
   - The progress will come through the existing WebSocket subscription

3. Update the component to use api.post for scrape trigger:
   ```typescript
   const startScrape = useCallback(async () => {
     stopChecking()
     setScrapeError(null)
     setManualProgress(null)
     setCompletedPlatforms(0)
     setIsManualStreaming(true)

     try {
       await api.post('/scrape')
       // WebSocket will pick up progress automatically
     } catch (error) {
       setScrapeError('Failed to start scrape')
       setIsManualStreaming(false)
     }
   }, [stopChecking])
   ```

4. Integrate with WebSocket progress from useActiveScrapesObserver:
   - The hook already provides: progress, overallPhase, platformProgress
   - Use these instead of local SSE state
   - Update cleanup logic

5. Remove SSE-specific state and refs:
   - eventSourceRef
   - Related cleanup code

6. Keep the auto-rescrape logic for connection_failed status
  </action>
  <verify>
- `grep -c "EventSource" web/src/features/dashboard/components/recent-runs.tsx` returns 0
- `grep -c "/scrape/stream" web/src/features/dashboard/components/recent-runs.tsx` returns 0
- `grep -c "api.post" web/src/features/dashboard/components/recent-runs.tsx` returns at least 1
  </verify>
  <done>recent-runs.tsx updated to use WebSocket for progress, POST API for trigger</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Removed all SSE code from frontend, simplified to WebSocket-only</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Visit: http://localhost:5173
    3. Navigate to Dashboard
    4. Click "Start Scrape" button (in Recent Runs card)
    5. Verify: Progress appears via WebSocket (check Network tab for /api/ws connection)
    6. Verify: No EventSource connections in Network tab
    7. Verify: Scrape completes successfully with progress updates
    8. Navigate to Scrape Runs page, view a running scrape detail
    9. Verify: Progress displays correctly
    10. Check browser console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -rn "EventSource" web/src/features/` returns no results
- [ ] `grep -rn "text/event-stream" web/src/` returns no results
- [ ] `grep -rn "/scrape/stream" web/src/` returns no results
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] Manual verification of WebSocket progress works
</verification>

<success_criteria>
- All SSE code removed from frontend
- Hooks simplified to WebSocket-only
- recent-runs.tsx uses POST API + WebSocket for progress
- Build and lint pass
- Manual verification confirms WebSocket works end-to-end
- Phase 59 complete
</success_criteria>

<output>
After completion, create `.planning/phases/59-sse-removal-cleanup/59-02-SUMMARY.md`

Phase 59 complete, ready to ship v2.0
</output>
