---
phase: 07-match-views
plan: 01
type: execute
---

<objective>
Extend the events API to include odds data for cross-platform comparison.

Purpose: The current events API returns event metadata but no odds. Match views need odds data inline (for list view) and detailed (for match detail view).
Output: Enhanced events API endpoints returning latest odds per bookmaker with margin calculations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-match-views/07-CONTEXT.md

**Prior work:**
@.planning/phases/06-react-foundation/06-04-SUMMARY.md

**Key source files:**
@src/api/routes/events.py
@src/db/models/odds.py
@src/db/models/event.py
@src/matching/schemas.py

**Established patterns:**
- SQLAlchemy: selectinload for eager loading relationships
- Pydantic schemas in src/api/schemas/ or src/matching/schemas.py
- Query param validation with ge=/le= bounds
- Route ordering: specific paths before parameterized paths

**Key insight from 07-CONTEXT.md:**
- List view needs inline odds for configurable markets (1X2, O/U 2.5, BTTS)
- Detail view needs ALL markets grouped by Betpawa's taxonomy
- Per-selection odds comparison AND per-market margin comparison
- Missing markets shown as dash/N/A
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inline odds to events list endpoint</name>
  <files>src/api/routes/events.py, src/matching/schemas.py</files>
  <action>
Extend the events list endpoint to include latest odds for key markets (1X2, O/U 2.5, BTTS) per bookmaker.

1. Create new Pydantic schemas in src/matching/schemas.py:
   - `InlineOdds` with fields: market_id (str), market_name (str), outcomes (list of {name, odds})
   - `BookmakerInlineOdds` extending BookmakerOdds with: inline_odds (list[InlineOdds])
   - Update MatchedEvent to use BookmakerInlineOdds for bookmakers field

2. Modify `_build_matched_event()` to:
   - Query latest OddsSnapshot for each bookmaker link
   - Extract markets matching IDs: "1" (1X2), "18" (O/U 2.5), "29" (BTTS)
   - Include outcomes array with name and odds values
   - Handle missing snapshots/markets gracefully (empty list)

3. Use selectinload to eager-load odds_snapshots and market_odds to avoid N+1 queries.

Key market IDs (from Betpawa taxonomy):
- "1" = 1X2 (Match Result)
- "18" = Over/Under 2.5 Goals
- "29" = Both Teams to Score

Avoid: Loading all markets for list view (would be too heavy). Only fetch the 3 key markets.
  </action>
  <verify>
curl "http://localhost:8000/api/events?page=1&page_size=5" | jq '.events[0].bookmakers[0].inline_odds'
Returns array with 1X2, O/U 2.5, BTTS markets (or empty if no odds)
  </verify>
  <done>
Events list endpoint returns inline_odds array per bookmaker with key market odds. Missing odds shown as empty array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create event detail endpoint with full market odds</name>
  <files>src/api/routes/events.py, src/matching/schemas.py</files>
  <action>
Enhance the GET /events/{event_id} endpoint to return complete market odds for all bookmakers.

1. Create new schemas in src/matching/schemas.py:
   - `MarketOddsDetail`: betpawa_market_id, betpawa_market_name, line (optional), outcomes (list of {name, odds, is_active})
   - `BookmakerMarketData`: bookmaker_slug, bookmaker_name, snapshot_time (datetime), markets (list[MarketOddsDetail]), margin (float, calculated)
   - `EventDetailResponse`: extends MatchedEvent with markets_by_bookmaker (list[BookmakerMarketData])

2. Modify `get_event()` endpoint:
   - Eager load latest OddsSnapshot per bookmaker (order by captured_at DESC, limit 1 per bookmaker)
   - Load all MarketOdds for each snapshot
   - Calculate margin per market: margin = (sum(1/odds) - 1) * 100
   - Group markets by betpawa_market_id for easy comparison

3. Response structure should enable easy three-column comparison:
   ```json
   {
     "id": 123,
     "name": "Team A vs Team B",
     "markets_by_bookmaker": [
       {
         "bookmaker_slug": "betpawa",
         "snapshot_time": "2026-01-21T12:00:00Z",
         "markets": [
           {"betpawa_market_id": "1", "betpawa_market_name": "1X2", "outcomes": [...], "margin": 5.2}
         ]
       },
       ...
     ]
   }
   ```

4. Handle edge cases:
   - Bookmaker with no snapshot: include in response with empty markets array
   - Market with suspended outcomes (is_active=false): still include but mark as suspended

Avoid: Returning raw_response field (too large). Only return structured market data.
  </action>
  <verify>
curl "http://localhost:8000/api/events/1" | jq '.markets_by_bookmaker | length'
Returns 3 (one per bookmaker: betpawa, sportybet, bet9ja)
curl "http://localhost:8000/api/events/1" | jq '.markets_by_bookmaker[0].markets[0]'
Returns market object with betpawa_market_id, outcomes array, margin
  </verify>
  <done>
Event detail endpoint returns full market odds with margin calculations per bookmaker. Missing bookmakers shown with empty markets. Margin calculated for each market.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `curl /api/events` returns events with inline_odds per bookmaker
- [ ] `curl /api/events/{id}` returns markets_by_bookmaker with full odds
- [ ] Margin calculation is correct: (sum(1/odds) - 1) * 100
- [ ] Missing odds handled gracefully (empty arrays, not errors)
- [ ] No N+1 query issues (check with --log-level debug)
</verification>

<success_criteria>
- Events list includes inline odds for 1X2, O/U 2.5, BTTS markets
- Event detail includes all markets with outcomes and margins
- API backward compatible (existing fields still present)
- Response structure supports frontend three-column comparison
</success_criteria>

<output>
After completion, create `.planning/phases/07-match-views/07-01-SUMMARY.md`
</output>
