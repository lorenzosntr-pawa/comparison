---
phase: 07-match-views
plan: 02-FIX2
type: fix
---

<objective>
Fix 3 UAT issues from 07-02-FIX verification.

Source: 07-ISSUES.md
Priority: 1 blocker, 2 major

| ID | Issue | Severity |
|----|-------|----------|
| UAT-002 | BetPawa odds missing (<20% coverage) | Blocker |
| UAT-004 | Scraper significantly slower after 7.1 | Major |
| UAT-003 | Color coding not displaying | Major |

Note: UAT-002 and UAT-004 are related — fixing the scraper performance will also fix the odds coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/07-match-views/07-ISSUES.md

**Affected files:**
@src/scraping/orchestrator.py
@web/src/features/matches/components/match-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002/UAT-004 — Parallel BetPawa event fetching</name>
  <files>src/scraping/orchestrator.py</files>
  <action>
Refactor `_scrape_betpawa_competition()` to use parallel fetching with semaphore (like SportyBet does).

Current flow (sequential, slow):
```python
for event_data in events_data:
    parsed = self._parse_betpawa_event(event_data)
    if parsed:
        full_event_data = await client.fetch_event(event_id)  # Sequential!
        await asyncio.sleep(0.1)  # Rate limit delay
```

New flow (parallel, fast):
1. Parse all events from competition list
2. Create async tasks for fetching full event data
3. Use semaphore (10 concurrent) to limit parallel requests
4. Gather results with `asyncio.gather(return_exceptions=True)`
5. Reduce delay to 0.05s (like SportyBet)

Follow the pattern from `_scrape_sportybet()` which already does this correctly:
- `semaphore = asyncio.Semaphore(10)`
- Inner `fetch_single()` function with `async with semaphore`
- `asyncio.gather(*tasks, return_exceptions=True)`
- Filter out None/exceptions from results

This will:
- Fix UAT-002: All events fetched before timeout
- Fix UAT-004: 10x faster (parallel vs sequential)
  </action>
  <verify>
Run a manual scrape and verify:
1. BetPawa scraping completes without timeout
2. Check database: `SELECT COUNT(*) FROM odds_snapshots WHERE bookmaker_id = (SELECT id FROM bookmakers WHERE slug='betpawa')`
3. Count should be significantly higher than 40
  </verify>
  <done>
- BetPawa scraping completes within timeout (300s)
- Database has odds snapshots for all/most BetPawa events
- Scraping performance similar to pre-7.1 levels
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-003 — Static Tailwind classes for color coding</name>
  <files>web/src/features/matches/components/match-table.tsx</files>
  <action>
Replace dynamic Tailwind class construction with static lookup.

Current code (broken):
```tsx
bgClass = `bg-green-500/${opacityLevel}`  // Dynamic — not compiled
```

Fix: Create static class map with pre-defined opacity levels:
```tsx
const COLOR_CLASSES = {
  green: {
    10: 'bg-green-500/10',
    20: 'bg-green-500/20',
    30: 'bg-green-500/30',
    40: 'bg-green-500/40',
    50: 'bg-green-500/50',
  },
  red: {
    10: 'bg-red-500/10',
    20: 'bg-red-500/20',
    30: 'bg-red-500/30',
    40: 'bg-red-500/40',
    50: 'bg-red-500/50',
  },
} as const

// Usage in OddsValue component:
const color = delta > tolerance ? 'green' : 'red'
const opacityKey = (Math.max(Math.ceil(intensity * 5) * 10, 10) as 10 | 20 | 30 | 40 | 50)
bgClass = COLOR_CLASSES[color][opacityKey] || COLOR_CLASSES[color][10]
```

This ensures all class names exist at build time for Tailwind JIT.
  </action>
  <verify>
1. Run `cd web && pnpm build` — no errors
2. Open match list in browser
3. Find rows with Betpawa odds
4. Verify green/red backgrounds appear on competitor cells
  </verify>
  <done>
- Color coding visible on odds cells
- Green = Betpawa has higher (better) odds
- Red = Betpawa has lower (worse) odds
- Build completes without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] BetPawa scraping completes without timeout
- [ ] Database has BetPawa odds for most events (>80%)
- [ ] Color coding displays correctly in match list
- [ ] Build passes without errors
- [ ] All original acceptance criteria from issues met
</verification>

<success_criteria>
- All 3 UAT issues from 07-ISSUES.md addressed
- Tests pass
- Ready for re-verification via /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/07-match-views/07-02-FIX2-SUMMARY.md`
</output>
