---
phase: 07-match-views
plan: 03
type: execute
---

<objective>
Build the match detail view with full market comparison grid and margin analysis.

Purpose: Deep-dive view showing all markets for a match with per-selection odds comparison and per-market margin display.
Output: Match detail page with three-column comparison, color-coded odds, and market margins.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-match-views/07-CONTEXT.md
@.planning/phases/07-match-views/07-01-SUMMARY.md
@.planning/phases/07-match-views/07-02-SUMMARY.md

**Key source files:**
@web/src/features/matches/index.tsx
@web/src/lib/api.ts
@web/src/types/api.ts

**From 07-CONTEXT.md:**
- Header: Teams, kickoff, competition, match status
- Summary section: Key markets (1X2, O/U 2.5, BTTS) + overall competitive position indicator
- Full market comparison: Three columns (one per platform), Betpawa groupings as reference
- Per-selection odds comparison AND per-market margin comparison
- Missing markets displayed as dash/N/A
- Filterable by market type/group
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create market comparison grid</name>
  <files>web/src/features/matches/components/match-header.tsx, web/src/features/matches/components/market-grid.tsx, web/src/features/matches/components/market-row.tsx, web/src/features/matches/components/index.ts, web/src/features/matches/hooks/use-match-detail.ts, web/src/features/matches/hooks/index.ts, web/src/types/api.ts, web/src/lib/api.ts</files>
  <action>
Build the match detail page with header and market comparison grid.

1. Add TypeScript types for detail response (web/src/types/api.ts):
   ```typescript
   interface MarketOutcome {
     name: string
     odds: number
     is_active: boolean
   }

   interface MarketOddsDetail {
     betpawa_market_id: string
     betpawa_market_name: string
     line: number | null
     outcomes: MarketOutcome[]
     margin: number
   }

   interface BookmakerMarketData {
     bookmaker_slug: string
     bookmaker_name: string
     snapshot_time: string
     markets: MarketOddsDetail[]
   }

   interface EventDetailResponse extends MatchedEvent {
     markets_by_bookmaker: BookmakerMarketData[]
   }
   ```

2. Add getEventDetail to API client (web/src/lib/api.ts):
   - getEventDetail(id: number) => fetchJson<EventDetailResponse>(`/events/${id}`)

3. Create useMatchDetail hook (web/src/features/matches/hooks/use-match-detail.ts):
   - Takes eventId from route params
   - Returns { data, isPending, error }
   - staleTime: 30000, gcTime: 60000
   - refetchInterval: 60000 (1 min polling)

4. Create MatchHeader component (web/src/features/matches/components/match-header.tsx):
   - Large display: "Home Team vs Away Team"
   - Sub info: Tournament name, Kickoff time (formatted), Sport
   - Back button to /matches
   - Use Card component for container

5. Create MarketRow component (web/src/features/matches/components/market-row.tsx):
   - Props: marketId, marketName, bookmakerMarkets (map of slug -> MarketOddsDetail | null)
   - Four columns: Market Name | Betpawa | SportyBet | Bet9ja
   - Each bookmaker column shows outcomes with odds
   - Show "-" for missing bookmaker/market
   - Include margin badge in each bookmaker cell

6. Create MarketGrid component (web/src/features/matches/components/market-grid.tsx):
   - Props: marketsByBookmaker from API response
   - Build unified market list from Betpawa's markets (reference taxonomy)
   - Header row: Market | Betpawa | SportyBet | Bet9ja
   - Map each market to MarketRow
   - Group markets visually (dividers between groups if possible)

7. Update MatchDetail in matches/index.tsx:
   - Get eventId from useParams()
   - Call useMatchDetail(eventId)
   - Render MatchHeader + MarketGrid
   - Loading state with skeleton
   - Error state with message

Market groups for visual separation (optional dividers):
- Main: 1X2, Double Chance, Draw No Bet
- Goals: O/U, BTTS, Exact Score, Team Goals
- Handicaps: Asian Handicap, European Handicap
- Other: Corners, Cards, etc.

Avoid: Complex grid virtualization. Start simple, optimize if needed.
  </action>
  <verify>
Visit /matches/1 (or valid event ID)
Header shows match info
Grid shows all markets in rows
Each row shows 3 bookmaker columns
  </verify>
  <done>
Match detail page shows header with match info and market grid with all markets from all bookmakers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add color-coded odds and margin display</name>
  <files>web/src/features/matches/components/market-row.tsx, web/src/features/matches/components/odds-badge.tsx, web/src/features/matches/components/margin-indicator.tsx, web/src/features/matches/components/summary-section.tsx, web/src/features/matches/components/index.ts</files>
  <action>
Add color coding for odds comparison and margin display.

1. Create OddsBadge component (web/src/features/matches/components/odds-badge.tsx):
   - Props: odds (number | null), isBest (boolean), isSuspended (boolean)
   - Display odds with 2 decimal places
   - Green background if isBest (best odds among 3 bookmakers)
   - Red background if NOT best and worse than Betpawa by >3%
   - Gray/strikethrough if suspended
   - Dash if null

2. Create MarginIndicator component (web/src/features/matches/components/margin-indicator.tsx):
   - Props: margin (number), comparisonMargin (number | null)
   - Display margin as percentage: "5.2%"
   - Color code vs Betpawa:
     - Green if lower margin (better for punter)
     - Red if higher margin (worse)
     - Neutral if within 0.5%
   - Tooltip showing "Lower margin = better value"

3. Update MarketRow to use OddsBadge and MarginIndicator:
   - For each outcome, determine which bookmaker has best odds
   - Mark Betpawa's odds as green if best, red if worst
   - Show margin below outcomes in each cell
   - Highlight rows where Betpawa has significantly worse margin (>2%)

4. Create SummarySection component (web/src/features/matches/components/summary-section.tsx):
   - Shows key markets (1X2, O/U 2.5, BTTS) in condensed format
   - Overall competitive position indicator:
     - Calculate: how many outcomes Betpawa has best odds for vs total
     - Display as: "Competitive: 12/24 best odds (50%)"
     - Green if >60%, Yellow if 40-60%, Red if <40%
   - Average margin comparison vs competitors

5. Add SummarySection to MatchDetail page:
   - Place between header and full market grid
   - Use Card with "Quick Summary" title

Color coding logic:
- Best odds: Compare all 3 bookmakers for each outcome, highest wins
- Margin comparison: Lower is better (Betpawa margin vs competitors)
- Gradient intensity: Scale opacity by difference magnitude

Tailwind classes to use:
- bg-green-100 dark:bg-green-900/30 for positive
- bg-red-100 dark:bg-red-900/30 for negative
- text-green-700 dark:text-green-400 for positive text
- text-red-700 dark:text-red-400 for negative text

Avoid: Over-complicated color schemes. Keep to green (good) / red (bad) / neutral.
  </action>
  <verify>
Odds cells show green/red coloring based on comparison
Margins display with comparison to Betpawa
Summary section shows overall competitive position
  </verify>
  <done>
Color-coded odds comparison working. Margins display with competitive indicators. Summary shows overall position.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Match list and detail views with odds comparison and color coding</what-built>
  <how-to-verify>
    1. Start backend: cd mvp && uvicorn src.api.main:app --reload
    2. Start frontend: cd mvp/web && npm run dev
    3. Visit http://localhost:5173/matches
    4. Verify match list:
       - Table shows matches with odds columns
       - Green cells indicate Betpawa has better odds
       - Red cells indicate Betpawa has worse odds
       - Filters work (tournament, date)
       - Column settings toggle works
       - Settings persist after page refresh
    5. Click a match row to open detail view
    6. Verify match detail:
       - Header shows team names, kickoff, tournament
       - Summary section shows competitive position
       - Market grid shows all markets in rows
       - Three columns for each bookmaker
       - Green/red highlighting for best/worst odds
       - Margin percentages displayed
       - Missing markets show dash (-)
    7. Confirm overall UX:
       - Data is readable and dense but not overwhelming
       - Color coding is intuitive (green = good for Betpawa)
       - Navigation between list and detail is smooth
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Match detail loads with all market data
- [ ] Odds comparison shows best/worst with color coding
- [ ] Margin calculations display correctly
- [ ] Summary section shows overall competitive position
- [ ] Missing markets/odds show dash gracefully
- [ ] Human verification checkpoint passed
- [ ] npm run build passes without errors
</verification>

<success_criteria>
- Match detail page fully functional with all markets
- Color coding clearly shows Betpawa competitive position
- Margin comparison visible per market
- Summary provides quick overview
- Phase 7 complete - match views ready for use
</success_criteria>

<output>
After completion, create `.planning/phases/07-match-views/07-03-SUMMARY.md` with:
- Accomplishments (all three plans)
- Files created/modified
- Decisions made
- Issues encountered
- Note: "Phase 7 complete, ready for Phase 8"
</output>
