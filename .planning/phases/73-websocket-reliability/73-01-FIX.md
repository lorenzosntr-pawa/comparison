---
phase: 73-websocket-reliability
plan: 01-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 73-01.

Source: 73-01-ISSUES.md
Priority: 0 critical, 0 major, 1 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/73-websocket-reliability/73-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/73-websocket-reliability/73-01-PLAN.md

**Key files:**
@web/src/hooks/use-websocket.ts
@web/src/components/ui/connection-status.tsx
@web/src/features/dashboard/components/status-bar.tsx
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Retry button not appearing in disconnected state</name>
  <files>web/src/components/ui/connection-status.tsx</files>
  <action>
**Root cause analysis:**
The Retry button only shows when `state === 'error'`. However, during reconnection attempts:
1. `ws.onerror` fires and sets state to 'error'
2. `ws.onclose` fires immediately after and sets state to 'disconnected'
3. `scheduleReconnect()` is called, cycling through retries
4. User sees gray (disconnected) throughout the retry process
5. Only after all 10 retries exhaust does state become 'error'

**Fix approach:**
Show the Retry button in BOTH 'error' AND 'disconnected' states when `onReconnect` is provided. This allows users to manually trigger reconnection at any point during the retry cycle, not just after all retries are exhausted.

**Implementation:**
In connection-status.tsx, change line 102 from:
```tsx
{state === 'error' && onReconnect && (
```
to:
```tsx
{(state === 'error' || state === 'disconnected') && onReconnect && (
```

This is a minimal, targeted fix that:
- Shows Retry button when disconnected (during retry cycle)
- Shows Retry button when in error state (after max retries)
- Only shows when onReconnect callback is provided (consistent with current behavior)
- Doesn't change the hook logic, just the UI display condition
  </action>
  <verify>
- npm run build passes
- With backend down, indicator shows gray AND Retry button appears
- Clicking Retry attempts reconnection
- When connected, no Retry button visible
  </verify>
  <done>
- Retry button visible in both 'error' and 'disconnected' states
- Users can manually retry at any point during connection failures
- UAT-001 acceptance criteria met
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Retry button appears in disconnected state (not just error state)
- [ ] Clicking Retry triggers reconnection
- [ ] No Retry button when connected (green state)
</verification>

<success_criteria>
- UAT-001 from 73-01-ISSUES.md addressed
- Build passes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/73-websocket-reliability/73-01-FIX-SUMMARY.md`
</output>
