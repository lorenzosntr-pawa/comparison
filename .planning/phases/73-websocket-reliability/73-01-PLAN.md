---
phase: 73-websocket-reliability
plan: 01
type: execute
---

<objective>
Improve WebSocket connection lifecycle, reconnection logic, and state synchronization between UI and server.

Purpose: Ensure reliable real-time updates by handling reconnection gracefully and keeping UI state synchronized with server.
Output: Enhanced useWebSocket hook with reconnect callbacks, query invalidation on reconnect, connection status indicator in dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase (directly relevant):
@.planning/phases/72-websocket-investigation-bug-fixes/72-01-SUMMARY.md

# Key files:
@web/src/hooks/use-websocket.ts
@web/src/hooks/use-websocket-scrape-progress.ts
@web/src/hooks/use-odds-updates.ts
@web/src/features/dashboard/hooks/use-observe-scrape.ts
@src/api/websocket/manager.py

**Tech stack available:** React, TanStack Query v5, WebSocket API, shadcn/ui
**Established patterns:**
- Compound boolean for connection + activity state (Phase 72)
- WebSocket message envelope pattern: {type, timestamp, data}
- Query invalidation on WebSocket events

**Current implementation analysis:**
- Frontend uses exponential backoff reconnect (1s→30s, max 10 retries)
- Ping/pong keepalive (30s ping, 5s pong timeout)
- No state sync on reconnect (queries may be stale after reconnection)
- No visual indication of connection status
- Retry counter persists even after successful reconnection
- No manual reconnect after max retries exhausted
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnect callbacks and query invalidation</name>
  <files>web/src/hooks/use-websocket.ts, web/src/hooks/use-websocket-scrape-progress.ts, web/src/hooks/use-odds-updates.ts</files>
  <action>
Modify useWebSocket hook:
1. Add `onReconnect` callback option that fires when connection re-establishes after a disconnect
2. Track `wasConnected` ref to detect reconnection vs initial connection
3. Fire `onReconnect` only when transitioning from disconnected→connected (not on initial connect)
4. Reset retry counter (retriesRef and reconnectDelayRef) after connection stable for 30s using setTimeout
5. Add `reconnect` function to return type that can be called manually to force reconnection

Modify useWebSocketScrapeProgress:
1. Add `onReconnect` callback that invalidates queries: ['scheduler-history'], ['events'], ['scrape-run']
2. Also call checkForActiveScrapes equivalent (fetch /scrape/runs/active) on reconnect to sync state

Modify useOddsUpdates:
1. Add `onReconnect` callback that invalidates queries: ['events']
  </action>
  <verify>
- TypeScript compiles without errors
- Console logs "[useWebSocket] Reconnected" when reconnection occurs (not on initial connect)
- Manually disconnect network, reconnect → queries are invalidated
  </verify>
  <done>
- useWebSocket has onReconnect callback option and reconnect function
- Retry counter resets 30s after stable connection
- useWebSocketScrapeProgress invalidates queries on reconnect
- useOddsUpdates invalidates queries on reconnect
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connection status indicator with manual reconnect</name>
  <files>web/src/components/ui/connection-status.tsx, web/src/hooks/use-websocket.ts, web/src/features/dashboard/components/dashboard-header.tsx</files>
  <action>
Create ConnectionStatusIndicator component (web/src/components/ui/connection-status.tsx):
1. Accepts props: state (WebSocketState), onReconnect (optional callback), showLabel (boolean)
2. Visual states:
   - connected: green dot, tooltip "Connected"
   - connecting: yellow dot with pulse, tooltip "Connecting..."
   - disconnected: gray dot, tooltip "Disconnected"
   - error: red dot + "Retry" button (only if onReconnect provided), tooltip shows error
3. Compact design - just a colored dot (8px) with optional label
4. Use Tooltip from shadcn/ui for hover info

Update useWebSocket return type:
1. Add `reconnect: () => void` function that clears timers, resets retry state, and calls connect
2. Export this from hook return

Update dashboard header:
1. Find or create dashboard header component
2. Add ConnectionStatusIndicator showing WebSocket connection state
3. Wire up reconnect callback for manual retry

Keep the indicator subtle - it's informational, not primary UI.
  </action>
  <verify>
- npm run build passes
- Connection indicator visible in dashboard header
- Indicator shows correct state (green when connected)
- Manually disconnect → indicator turns gray/red
- Click "Retry" when in error state → reconnection attempted
  </verify>
  <done>
- ConnectionStatusIndicator component created with all states
- Indicator integrated into dashboard header
- Manual reconnect button works in error state
- Visual design is subtle and non-intrusive
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] TypeScript has no type errors
- [ ] Connection status indicator visible in dashboard
- [ ] Reconnect after network drop invalidates queries
- [ ] Manual reconnect button works after max retries
- [ ] Retry counter resets after 30s stable connection
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- WebSocket reconnection is more robust
- Users can see connection status and manually retry if needed
- Data stays fresh after reconnection events
</success_criteria>

<output>
After completion, create `.planning/phases/73-websocket-reliability/73-01-SUMMARY.md`
</output>
