---
phase: 49-market-grouping
plan: 01-FIX2
type: fix
---

<objective>
Fix 2 UAT issues from plan 49-01.

Source: 49-01-ISSUES.md
Priority: 0 critical, 1 major, 1 minor

**UAT-002 (Major):** Markets should appear in multiple category tabs
**UAT-003 (Minor):** Some category tabs may still be missing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/49-market-grouping/49-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/49-market-grouping/49-01-PLAN.md

**Key files:**
@src/scraping/event_coordinator.py (lines 1795-1810)
@src/db/models/odds.py
@web/src/features/matches/components/market-grid.tsx
@web/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change market_group to JSON array in database</name>
  <files>
    - alembic/versions/h4i0j6k1l4m5_market_groups_array.py (new)
    - src/db/models/odds.py
    - src/db/models/competitor.py
  </files>
  <action>
Create migration to change `market_group` column from String(50) to JSON type to store an array of groups.

In odds.py, change:
```python
market_group: Mapped[str | None] = mapped_column(String(50), nullable=True)
```
to:
```python
market_groups: Mapped[list[str] | None] = mapped_column(JSON, nullable=True)
```

Note: Rename from singular to plural (`market_group` → `market_groups`) to indicate it's now an array.

The migration should:
1. Add new column `market_groups` as JSON
2. Migrate data: convert existing single values to arrays (e.g., "goals" → ["goals"])
3. Drop old `market_group` column

Apply same change to CompetitorMarketOdds model.
  </action>
  <verify>Run `alembic upgrade head` - migration completes without errors</verify>
  <done>Database columns changed to JSON arrays, data migrated</done>
</task>

<task type="auto">
  <name>Task 2: Store full tabs array during scraping</name>
  <files>src/scraping/event_coordinator.py</files>
  <action>
Update the market extraction logic around line 1798-1802.

Change from:
```python
tabs = market_type.get("tabs", [])
market_group = next((t for t in tabs if t != "all"), tabs[0] if tabs else "other")
```

To:
```python
tabs = market_type.get("tabs", [])
# Store all non-"all" tabs, or ["other"] if empty
market_groups = [t for t in tabs if t != "all"]
if not market_groups:
    market_groups = ["other"]
```

Update the MarketOdds creation to use `market_groups=market_groups` instead of `market_group=market_group`.
  </action>
  <verify>Run scrape for one event, check that market_groups contains arrays with multiple values</verify>
  <done>Markets with multiple BetPawa tabs store all tab values</done>
</task>

<task type="auto">
  <name>Task 3: Update API schema and route</name>
  <files>
    - src/matching/schemas.py
    - src/api/routes/events.py
  </files>
  <action>
In schemas.py, update MarketOddsDetail:
```python
market_groups: list[str] | None = None  # Was: market_group: str | None = None
```

In events.py, update the response mapping to use the new field name.
  </action>
  <verify>Call `/api/events/{id}` endpoint, verify market_groups is returned as array</verify>
  <done>API returns market_groups as array</done>
</task>

<task type="auto">
  <name>Task 4: Update frontend types and filtering</name>
  <files>
    - web/src/types/api.ts
    - web/src/features/matches/components/market-grid.tsx
  </files>
  <action>
In api.ts, change MarketOddsDetail type:
```typescript
market_groups: string[] | null  // Was: market_group: string | null
```

In market-grid.tsx:
1. Update UnifiedMarket interface to use `marketGroups: string[]` (plural, array)
2. Update buildUnifiedMarkets to set `marketGroups: market.market_groups ?? ['other']`
3. Update getAvailableGroups to check if any market has the group in its array:
```typescript
function getAvailableGroups(markets: UnifiedMarket[]): string[] {
  const presentGroups = new Set<string>()
  markets.forEach(m => m.marketGroups.forEach(g => presentGroups.add(g)))
  return TAB_ORDER.filter(tab => tab === 'all' || presentGroups.has(tab))
}
```
4. Update the filter logic in useMemo to check if selected group is in the market's groups array:
```typescript
const filteredMarkets = useMemo(() => {
  if (activeGroup === 'all') return unifiedMarkets
  return unifiedMarkets.filter(m => m.marketGroups.includes(activeGroup))
}, [unifiedMarkets, activeGroup])
```
  </action>
  <verify>Build passes (`npm run build`), no TypeScript errors</verify>
  <done>Frontend handles market_groups as array, filtering works for multi-tab markets</done>
</task>

<task type="auto">
  <name>Task 5: Audit and fix TAB_ORDER for UAT-003</name>
  <files>web/src/features/matches/components/market-grid.tsx</files>
  <action>
Query the database to find all unique market_groups values:
```sql
SELECT DISTINCT jsonb_array_elements_text(market_groups) as group_name
FROM market_odds
WHERE market_groups IS NOT NULL
ORDER BY group_name;
```

Compare with current TAB_ORDER. If any values are missing, add them.

Also make TAB_ORDER dynamic by:
1. Adding any unknown groups to the end (before 'other')
2. This ensures any future BetPawa categories automatically appear

Update getAvailableGroups to handle unknown groups:
```typescript
function getAvailableGroups(markets: UnifiedMarket[]): string[] {
  const presentGroups = new Set<string>()
  markets.forEach(m => m.marketGroups.forEach(g => presentGroups.add(g)))

  // Include known tabs in order, plus any unknown groups alphabetically before 'other'
  const knownTabs = TAB_ORDER.filter(tab => tab === 'all' || presentGroups.has(tab))
  const unknownTabs = [...presentGroups].filter(g => !TAB_ORDER.includes(g)).sort()

  // Insert unknown tabs before 'other'
  const otherIndex = knownTabs.indexOf('other')
  if (otherIndex >= 0) {
    knownTabs.splice(otherIndex, 0, ...unknownTabs)
  } else {
    knownTabs.push(...unknownTabs)
  }

  return knownTabs
}
```
  </action>
  <verify>All BetPawa market categories appear as tabs when markets exist</verify>
  <done>TAB_ORDER covers all categories, unknown groups handled gracefully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Database migration runs successfully
- [ ] Markets with multiple BetPawa tabs are stored with all tab values
- [ ] API returns market_groups as array
- [ ] Frontend build passes
- [ ] Markets appear in ALL their category tabs (not just primary)
- [ ] All BetPawa categories show as tabs when markets exist
</verification>

<success_criteria>
- UAT-002 resolved: Markets appear in multiple tabs based on their full tabs array
- UAT-003 resolved: All BetPawa categories appear as tabs
- Tests pass
- Ready for re-verification with /gsd:verify-work 49
</success_criteria>

<output>
After completion, create `.planning/phases/49-market-grouping/49-01-FIX2-SUMMARY.md`
</output>
