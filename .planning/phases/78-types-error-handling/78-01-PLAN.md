---
phase: 78-types-error-handling
plan: 01
type: execute
---

<objective>
Add missing return type annotations and improve JSON error handling in scraper clients.

Purpose: Complete type coverage enables IDE support and future type checking; robust JSON handling prevents silent failures when APIs return unexpected responses.
Output: All Python functions have return type annotations, scraper clients gracefully handle malformed JSON responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

**Functions missing return types (10 total):**
- `src/api/app.py:104:lifespan` - async context manager
- `src/api/routes/scrape.py:863:scrape_platform` - internal async function
- `src/scraping/clients/base.py:57:create_retry_decorator` - returns decorator
- `src/scraping/event_coordinator.py:209:_timed_discover` - timing wrapper
- `src/storage/write_queue.py:124:start` - async void
- `src/storage/write_queue.py:130:stop` - async void
- `src/storage/write_queue.py:145:enqueue` - returns bool
- `src/storage/write_queue.py:170:_worker_loop` - async void
- `src/storage/write_queue.py:180:_drain` - async void
- `src/storage/write_queue.py:187:_process_with_retry` - returns bool

**Files needing JSONDecodeError handling (from CONCERNS.md):**
- `src/scraping/clients/bet9ja.py` - 3 response.json() calls
- `src/scraping/clients/betpawa.py` - 3 response.json() calls
- `src/scraping/clients/sportybet.py` - 3 response.json() calls

**Key constraint:** 256 functions already have return types; only 10 are missing.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add return type annotations to 10 missing functions</name>
  <files>src/api/app.py, src/api/routes/scrape.py, src/scraping/clients/base.py, src/scraping/event_coordinator.py, src/storage/write_queue.py</files>
  <action>
Add return type annotations to these 10 functions:

**api/app.py:104** - `lifespan`:
```python
from collections.abc import AsyncGenerator
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
```

**api/routes/scrape.py:863** - `scrape_platform` (internal function in scrape_single_event):
```python
async def scrape_platform(platform: str, platform_id: str) -> tuple[str, bool, str | None, int, int]:
```

**scraping/clients/base.py:57** - `create_retry_decorator`:
```python
from typing import Callable, TypeVar
from tenacity import AsyncRetrying

def create_retry_decorator() -> Callable[[Callable[..., T]], Callable[..., T]]:
```
Actually simpler: the return type is the tenacity retry decorator. Use `retry` return type directly or a type alias.

**scraping/event_coordinator.py:209** - `_timed_discover`:
```python
async def _timed_discover(name: str, coro: Coroutine) -> tuple[str, list[dict] | Exception, int]:
```

**storage/write_queue.py** - 6 functions:
```python
async def start(self) -> None:
async def stop(self) -> None:
async def enqueue(self, batch: WriteBatch) -> bool:
async def _worker_loop(self) -> None:
async def _drain(self) -> None:
async def _process_with_retry(self, batch: WriteBatch) -> bool:
```

For the decorator function, if complex generic typing proves difficult, use a simple return annotation or a type alias. Don't over-engineer.
  </action>
  <verify>Run `python -c "import api.app; import api.routes.scrape; import scraping.clients.base; import scraping.event_coordinator; import storage.write_queue"` from src/ directory to verify no syntax errors</verify>
  <done>All 10 functions have explicit return type annotations, code imports without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add JSONDecodeError handling to scraper clients</name>
  <files>src/scraping/clients/bet9ja.py, src/scraping/clients/betpawa.py, src/scraping/clients/sportybet.py</files>
  <action>
Wrap all 9 `response.json()` calls in try/except to handle malformed JSON responses gracefully.

**Pattern to apply:**
```python
import json  # Add at top if not present

# Replace bare:
data = response.json()

# With:
try:
    data = response.json()
except json.JSONDecodeError as e:
    raise ApiError(
        f"Invalid JSON response for {context}",
        details={"response_text": response.text[:500], "error": str(e)},
    ) from e
```

**bet9ja.py** - 3 locations:
- Line ~105: `fetch_event()` method
- Line ~168: `fetch_tournaments()` method
- Line ~214: Another method

**betpawa.py** - 3 locations:
- Line ~113: `fetch_event()` method
- Line ~171: Another method
- Line ~207: Another method

**sportybet.py** - 3 locations:
- Line ~110: `fetch_event()` method
- Line ~156: Another method
- Line ~213: Another method

Include relevant context in error message (event_id, tournament, etc.). Truncate response.text to 500 chars to avoid log spam.
  </action>
  <verify>Run `python -c "import scraping.clients.bet9ja; import scraping.clients.betpawa; import scraping.clients.sportybet"` from src/ directory; optionally create a test that passes malformed JSON to verify error handling</verify>
  <done>All 9 response.json() calls wrapped with JSONDecodeError handling, errors include relevant context</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "import api.app"` succeeds from src/ directory
- [ ] `python -c "import storage.write_queue"` succeeds
- [ ] `python -c "import scraping.clients.bet9ja"` succeeds
- [ ] All 10 functions have return type annotations
- [ ] All 9 response.json() calls have JSONDecodeError handling
- [ ] Backend starts without errors: `cd src && uvicorn api.app:app --port 8000`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No new errors or warnings introduced
- Type annotations follow existing codebase patterns
- Error messages are descriptive and include relevant context
</success_criteria>

<output>
After completion, create `.planning/phases/78-types-error-handling/78-01-SUMMARY.md`:

# Phase 78 Plan 01: Type Annotations & Error Handling Summary

**[Substantive one-liner describing what was accomplished]**

## Accomplishments

- Added return type annotations to 10 functions
- Added JSONDecodeError handling to 9 response.json() calls

## Files Created/Modified

- `src/api/app.py` - Added return type to lifespan
- `src/api/routes/scrape.py` - Added return type to scrape_platform
- `src/scraping/clients/base.py` - Added return type to create_retry_decorator
- `src/scraping/event_coordinator.py` - Added return type to _timed_discover
- `src/storage/write_queue.py` - Added return types to 6 methods
- `src/scraping/clients/bet9ja.py` - Added JSONDecodeError handling
- `src/scraping/clients/betpawa.py` - Added JSONDecodeError handling
- `src/scraping/clients/sportybet.py` - Added JSONDecodeError handling

## Decisions Made

[Any decisions about type complexity, error message format, etc.]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 78 complete, milestone v2.3 complete. Ready for next milestone.
</output>
