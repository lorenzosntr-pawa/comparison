---
phase: 80-specifier-bug-fix
plan: 01
type: execute
---

<objective>
Add line parameter to history API endpoints and frontend data layer.

Purpose: Enable filtering historical data by specifier line value (e.g., Over 2.5 vs Over 3.5)
Output: Backend API accepts `line` query param, frontend hooks and API client pass it through
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/79-investigation/BUG-REPORT.md

**Key files:**
@src/api/routes/history.py
@web/src/lib/api.ts
@web/src/features/matches/hooks/use-odds-history.ts
@web/src/features/matches/hooks/use-margin-history.ts
@web/src/features/matches/hooks/use-multi-odds-history.ts
@web/src/features/matches/hooks/use-multi-margin-history.ts

**Issue:** Historical charts for Over/Under and Handicap markets mix data from different lines (e.g., 2.5, 3.5, 4.5) because API filters by market_id only, ignoring line specifier. BUG-REPORT.md documents root cause.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add line query parameter to backend history API</name>
  <files>src/api/routes/history.py</files>
  <action>
Add `line` query parameter to both history endpoints:

1. In `get_odds_history` function (line ~196):
   - Add parameter: `line: float | None = Query(default=None, description="Filter by line value for specifier markets")`
   - In the BetPawa query section (after line 273 `.where(MarketOdds.betpawa_market_id == market_id)`), add:
     ```python
     if line is not None:
         query = query.where(MarketOdds.line == line)
     ```
   - In the competitor query section (after line 253 `.where(CompetitorMarketOdds.betpawa_market_id == market_id)`), add:
     ```python
     if line is not None:
         query = query.where(CompetitorMarketOdds.line == line)
     ```

2. In `get_margin_history` function (line ~344):
   - Add same `line` parameter
   - Add same conditional WHERE clauses for BetPawa query (after line 421) and competitor query (after line 401)

3. Update docstrings to document the new `line` parameter.
  </action>
  <verify>
Run Python syntax check:
```bash
python -m py_compile src/api/routes/history.py
```
  </verify>
  <done>Both endpoints accept optional `line` query param and filter results when provided</done>
</task>

<task type="auto">
  <name>Task 2: Add line parameter to frontend API client</name>
  <files>web/src/lib/api.ts</files>
  <action>
Update `getOddsHistory` and `getMarginHistory` functions in the api object:

1. Add `line?: number | null` to both function parameter types
2. In searchParams building, add:
   ```typescript
   if (params.line != null) searchParams.set('line', params.line.toString())
   ```

Both functions follow identical pattern - add line param and conditionally append to searchParams.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit src/lib/api.ts`</verify>
  <done>API client passes line parameter to backend when provided</done>
</task>

<task type="auto">
  <name>Task 3: Add line parameter to frontend hooks</name>
  <files>
web/src/features/matches/hooks/use-odds-history.ts,
web/src/features/matches/hooks/use-margin-history.ts,
web/src/features/matches/hooks/use-multi-odds-history.ts,
web/src/features/matches/hooks/use-multi-margin-history.ts
  </files>
  <action>
For each hook:

1. **use-odds-history.ts:**
   - Add `line?: number | null` to `UseOddsHistoryParams` interface
   - Destructure `line` in the hook function
   - Add `line` to queryKey array (after toTime)
   - Pass `line` to api.getOddsHistory call

2. **use-margin-history.ts:**
   - Same changes as use-odds-history.ts

3. **use-multi-odds-history.ts:**
   - Add `line?: number | null` to `UseMultiOddsHistoryParams` interface
   - Destructure `line` in the hook function
   - Add `line` to queryKey array in the queries.map (after toTime)
   - Pass `line` to api.getOddsHistory call in queryFn

4. **use-multi-margin-history.ts:**
   - Same changes as use-multi-odds-history.ts

**Pattern for queryKey update:**
```typescript
// Before
queryKey: ['odds-history', eventId, marketId, bookmakerSlug, fromTime, toTime]
// After
queryKey: ['odds-history', eventId, marketId, bookmakerSlug, fromTime, toTime, line]
```

This ensures cache invalidation works correctly when line changes.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit src/features/matches/hooks/use-*.ts`</verify>
  <done>All four hooks accept line parameter and include it in queryKey and API call</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Python syntax check passes for history.py
- [ ] TypeScript compiles without errors for modified files
- [ ] Backend server starts without errors: `cd src && python -m uvicorn api.main:app --reload` (verify no import errors)
</verification>

<success_criteria>
- Backend history endpoints accept optional `line` query parameter
- When `line` is provided, results are filtered to only that line value
- When `line` is omitted, behavior is unchanged (backward compatible)
- Frontend hooks and API client can pass line parameter to backend
- Query cache keys include line for proper invalidation
</success_criteria>

<output>
After completion, create `.planning/phases/80-specifier-bug-fix/80-01-SUMMARY.md`
</output>
