---
phase: 80-specifier-bug-fix
plan: 02
type: execute
---

<objective>
Update frontend components to pass line value through click handlers to HistoryDialog.

Purpose: Complete the data flow so specifier line value reaches the history API
Output: Clicking an odds badge for "Over 2.5" fetches history for line=2.5 only
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/80-specifier-bug-fix/80-01-SUMMARY.md

**Key files:**
@web/src/features/matches/components/history-dialog.tsx
@web/src/features/matches/components/market-row.tsx
@web/src/features/matches/components/market-grid.tsx
@web/src/features/matches/components/match-table.tsx

**Prior plan:** 80-01 added line parameter to API layer. This plan threads it through UI components.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add line prop to HistoryDialog and pass to hooks</name>
  <files>web/src/features/matches/components/history-dialog.tsx</files>
  <action>
1. Add `line?: number | null` to `HistoryDialogProps` interface (after marketId)

2. Destructure `line` in the component function (after marketId)

3. Pass `line` to all four history hooks:
   - `useOddsHistory({ ..., line })` (around line 116-121)
   - `useMarginHistory({ ..., line })` (around line 123-128)
   - `useMultiOddsHistory({ ..., line })` (around line 131-136)
   - `useMultiMarginHistory({ ..., line })` (around line 138-143)

4. Update dialog title to include line when present:
   ```typescript
   const marketDisplayName = line != null
     ? `${marketName} ${line}`
     : marketName
   ```
   Then use `marketDisplayName` in the title construction (around line 156-160).

Note: Include line in all hooks to ensure both single-bookmaker and comparison modes filter correctly.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit src/features/matches/components/history-dialog.tsx`</verify>
  <done>HistoryDialog accepts line prop and passes it to all history hooks; title shows line value</done>
</task>

<task type="auto">
  <name>Task 2: Update market-row and market-grid to pass line</name>
  <files>
web/src/features/matches/components/market-row.tsx,
web/src/features/matches/components/market-grid.tsx
  </files>
  <action>
**market-row.tsx:**

1. Update `onOddsClick` callback type in `MarketRowProps` interface (line 15):
   ```typescript
   onOddsClick?: (bookmakerSlug: string, marketId: string, marketName: string, line: number | null) => void
   ```

2. Update `onMarginClick` callback type similarly (line 16)

3. Update both callback invocations to pass `line`:
   - Line ~222: `onOddsClick(slug, marketId, displayName, line)`
   - Line ~236: `onMarginClick(slug, marketId, displayName, line)`

**market-grid.tsx:**

1. Add `line: number | null` to `HistoryDialogState` interface (after marketId, around line 42)

2. Update `handleHistoryClick` function signature (line 360):
   ```typescript
   const handleHistoryClick = (bookmakerSlug: string, marketId: string, marketName: string, line: number | null) => {
   ```

3. Add `line` to the state object in handleHistoryClick:
   ```typescript
   setHistoryDialog({
     eventId,
     marketId,
     bookmakerSlug,
     marketName,
     bookmakerName: BOOKMAKER_NAMES[bookmakerSlug] ?? bookmakerSlug,
     allBookmakers,
     line,  // ADD THIS
   })
   ```

4. Pass `line` to HistoryDialog component (around line 490):
   ```typescript
   <HistoryDialog
     ...
     line={historyDialog.line}
   />
   ```
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit src/features/matches/components/market-row.tsx src/features/matches/components/market-grid.tsx`</verify>
  <done>Line value flows from MarketRow click through MarketGrid to HistoryDialog</done>
</task>

<task type="auto">
  <name>Task 3: Update match-table to pass line (for completeness)</name>
  <files>web/src/features/matches/components/match-table.tsx</files>
  <action>
The match-table uses inline_odds with fixed markets (1X2, O/U 2.5, BTTS, DC). These inline markets currently don't have variable lines - they show fixed configurations. However, for API consistency and future-proofing:

1. Add `line: number | null` to `HistoryDialogState` interface (after marketId, around line 37)

2. In both `setHistoryDialog` calls (OddsValue onClick ~line 577 and MarginValue onClick ~line 618), add:
   ```typescript
   line: null,  // Inline markets use fixed configurations
   ```

3. Pass `line` to HistoryDialog component (around line 644):
   ```typescript
   <HistoryDialog
     ...
     line={historyDialog?.line}
   />
   ```

Note: Passing `line: null` for these markets ensures backward compatible behavior (API returns all lines when line is null, which is correct for these fixed-outcome markets).
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit src/features/matches/components/match-table.tsx`</verify>
  <done>match-table passes line (null for inline markets) to HistoryDialog for API consistency</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All TypeScript files compile without errors: `cd web && npx tsc --noEmit`
- [ ] Dev server starts: `cd web && npm run dev` (no runtime errors)
- [ ] Manual test: Navigate to event detail page, click an Over/Under odds badge, verify chart shows single line data
</verification>

<success_criteria>
- HistoryDialog receives and uses line prop
- MarketRow callbacks include line parameter
- MarketGrid passes line through handleHistoryClick to dialog state
- match-table passes null for inline markets (backward compatible)
- Over/Under 2.5 chart shows only 2.5 line data (not mixed with 3.5, 4.5, etc.)
- Phase 80 complete: Specifier bug fixed
</success_criteria>

<output>
After completion, create `.planning/phases/80-specifier-bug-fix/80-02-SUMMARY.md`
</output>
