---
phase: 84.2-tournament-detail-page
plan: 01
type: execute
---

<objective>
Create tournament detail page with market cards and margin timeline visualization.

Purpose: Enable traders to drill into a specific tournament to see margin statistics for ALL market types found in that tournament, with timeline charts showing margin progression over time.
Output: New `/historical-analysis/:tournamentId` route with TournamentDetailPage showing market cards grid and interactive timeline charts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./84.2-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84.2-tournament-detail-page/84.2-CONTEXT.md

# Prior phase context (from frontmatter):
@.planning/phases/84.1-fix-tournament-metrics-design/84.1-01-SUMMARY.md

# Key source files:
@web/src/routes.tsx
@web/src/features/historical-analysis/index.tsx
@web/src/features/historical-analysis/components/tournament-list.tsx
@web/src/features/historical-analysis/hooks/use-tournaments.ts
@web/src/features/matches/components/margin-line-chart.tsx
@web/src/features/matches/components/market-grid.tsx

**Tech stack available:**
- React Router (useParams, useNavigate)
- TanStack Query v5 (useQuery with queryKey)
- recharts (LineChart, XAxis, YAxis, Tooltip, ResponsiveContainer)
- shadcn/ui (Card, Button, Input, Skeleton)
- date-fns (format, subDays)

**Established patterns:**
- `useTournaments` hook: fetch events → accumulate by tournament → compute metrics
- `useParams` for route parameters
- `useNavigate` for programmatic navigation
- `MarginLineChart` for timeline visualization
- `fuzzyMatch` for search filtering
- Card grid layout (3-column responsive)

**Constraining decisions:**
- Phase 84.1: marginsByMarket Record structure for extensibility
- Phase 84.1: TRACKED_MARKETS constant exported for shared use
- CONTEXT.md: Out of scope - individual event drill-down, competitor comparison, first/last comparison

**Issues being addressed:**
- ISS-005: Tournament detail page with margin timeline
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route, Navigation, and Data Hook</name>
  <files>web/src/routes.tsx, web/src/features/historical-analysis/components/tournament-list.tsx, web/src/features/historical-analysis/hooks/use-tournament-markets.ts, web/src/features/historical-analysis/hooks/index.ts</files>
  <action>
1. In routes.tsx: Add route `/historical-analysis/:tournamentId` pointing to new TournamentDetailPage component (import from @/features/historical-analysis).

2. In tournament-list.tsx:
   - Import useNavigate from react-router
   - Replace placeholder handleClick with navigation: `navigate(\`/historical-analysis/\${tournament.id}\`)`
   - Add "View Details" button to TournamentCard (Button variant="outline" size="sm") - button click navigates, card itself no longer clickable
   - Remove cursor-pointer from Card

3. Create use-tournament-markets.ts hook:
   - Accept tournamentId and optional dateRange as params
   - Fetch events using api.getEvents with pagination loop (same pattern as useTournaments)
   - Filter events to only those matching tournamentId
   - Extract ALL unique markets (not just TRACKED_MARKETS) from betpawa's inline_odds
   - For each unique market (by betpawa_market_id + line), compute:
     - name: betpawa_market_name
     - avgMargin: average of all event margins for this market
     - minMargin: minimum margin
     - maxMargin: maximum margin
     - eventCount: how many events had this market
     - marginHistory: array of { capturedAt, margin } for timeline chart
   - Interface: TournamentMarket { id, name, line, avgMargin, minMargin, maxMargin, eventCount, marginHistory }
   - Return { data, isPending, error, tournament } where tournament is { id, name, country, eventCount }
   - Sort markets by eventCount descending (most common first)

4. In hooks/index.ts: Export useTournamentMarkets and TournamentMarket type
  </action>
  <verify>npm run build passes, navigate from tournament card opens /historical-analysis/:tournamentId URL</verify>
  <done>Route exists, TournamentCard has "View Details" button that navigates, useTournamentMarkets hook returns market data with computed stats</done>
</task>

<task type="auto">
  <name>Task 2: Tournament Detail Page with Market Cards and Timeline</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx, web/src/features/historical-analysis/index.tsx, web/src/features/historical-analysis/components/index.ts</files>
  <action>
1. Create tournament-detail.tsx:
   - Import useParams from react-router, useTournamentMarkets from ./hooks
   - TournamentDetailPage component:
     - Extract tournamentId from params, parse to number
     - Use useTournamentMarkets(tournamentId) to fetch data
     - Header: tournament.name, tournament.country, tournament.eventCount events
     - Search filter: Input for market search (useState), use fuzzyMatch pattern from market-grid.tsx
     - Market cards grid (3-column responsive):
       - Card for each TournamentMarket
       - Display: market name (+ line if present), avgMargin (formatted to 1 decimal), min-max range, event count
       - Cards clickable (onClick sets selectedMarket state)
     - Selected market state: useState<TournamentMarket | null>(null)
     - When selectedMarket !== null, render timeline section below cards:
       - Section header: "Margin Timeline: {market.name}"
       - Close button to clear selection
       - Reuse MarginLineChart from @/features/matches/components/margin-line-chart
       - Transform marginHistory to MarginHistoryPoint format: { captured_at, margin }
       - Chart height: 300px
   - Loading state: Skeleton cards (6 skeleton cards in grid)
   - Error state: Red error box
   - Empty state: "No market data found for this tournament"

2. In index.tsx: Export TournamentDetailPage
   - Import and re-export: export { TournamentDetailPage } from './tournament-detail'

3. In components/index.ts: Ensure FilterBar and DateRange are exported (should already be)

Visual structure:
```
| Tournament Name (Country) - N events |
|--------------------------------------|
| [Search markets...                 ] |
|                                      |
| +--------+ +--------+ +--------+     |
| | 1X2    | | O/U 2.5| | BTTS   |     |  <- 3-col grid of market cards
| | 5.2%   | | 4.8%   | | 6.1%   |     |  <- avg margin
| | 4-6%   | | 3-5%   | | 5-7%   |     |  <- range
| | 45 evts| | 42 evts| | 38 evts|     |  <- count
| +--------+ +--------+ +--------+     |
|                                      |
| [Timeline Chart when card clicked]   |
```
  </action>
  <verify>npm run build passes, /historical-analysis/123 renders page with market cards, clicking card shows timeline chart</verify>
  <done>Tournament detail page displays all markets with stats, clicking card reveals margin timeline chart, search filters markets</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Navigate to /historical-analysis, click "View Details" on a tournament card
- [ ] Tournament detail page loads with correct tournament info in header
- [ ] Market cards display with avg/min/max margin and event count
- [ ] Search input filters market cards
- [ ] Clicking a market card shows margin timeline chart
- [ ] Chart displays margin progression over time
</verification>

<success_criteria>

- Route /historical-analysis/:tournamentId functional
- TournamentCard navigates on "View Details" click
- useTournamentMarkets hook extracts ALL unique markets (not just 4 tracked)
- Market cards show avg, min, max margin and event count
- Timeline chart renders on card click
- Search filters markets by name
- No TypeScript errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/84.2-tournament-detail-page/84.2-01-SUMMARY.md`:

# Phase 84.2 Plan 01: Tournament Detail Page Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 85: Time-to-Kickoff Charts
</output>
