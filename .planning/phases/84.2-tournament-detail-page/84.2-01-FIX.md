---
phase: 84.2-tournament-detail-page
plan: 84.2-01-FIX
type: fix
---

<objective>
Fix UAT-001: Tournament Detail Page only shows 4 main markets instead of ALL markets.

Source: 84.2-01-ISSUES.md
Priority: 0 critical, 1 major, 0 minor

**Root Cause Analysis:**
The `useTournamentMarkets` hook extracts markets from `betpawa.inline_odds`, but `inline_odds` is a **summary field** containing only the 4 main markets (1X2, O/U 2.5, BTTS, DC) for event list display. The full market data is only available via the event detail endpoint (`/api/events/{id}`) which returns `markets_by_bookmaker`.

**Solution:**
Fetch full market data by calling the event detail endpoint for each tournament event, then extract ALL markets from `markets_by_bookmaker` instead of relying on `inline_odds`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/84.2-tournament-detail-page/84.2-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/84.2-tournament-detail-page/84.2-01-PLAN.md

**Key source files:**
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
@web/src/lib/api.ts
@web/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useTournamentMarkets to fetch full market data</name>
  <files>web/src/features/historical-analysis/hooks/use-tournament-markets.ts, web/src/lib/api.ts</files>
  <action>
1. In api.ts, ensure `getEventById(id: number)` exists and returns `EventDetailResponse`. If not, add it:
   - GET /api/events/{id}
   - Returns full event with markets_by_bookmaker

2. In use-tournament-markets.ts, update the data fetching logic:

   **Current (broken) approach:**
   - Fetch events list â†’ extract from inline_odds (only 4 markets)

   **New approach:**
   - Fetch events list with pagination
   - Filter to tournament events
   - For each tournament event, call getEventById to get full market data
   - Extract ALL markets from `markets_by_bookmaker[0].markets` (betpawa's full market list)
   - Accumulate into marketMap using getMarketKey pattern

   **Key changes to queryFn:**
   ```typescript
   // After filtering tournament events...
   for (const event of tournamentEvents) {
     // Fetch full event details to get all markets
     const eventDetail = await api.getEventById(event.id)

     // Find Betpawa in markets_by_bookmaker
     const betpawaData = eventDetail.markets_by_bookmaker.find(
       b => b.bookmaker_slug === BETPAWA_SLUG
     )
     if (!betpawaData) continue

     // Extract ALL markets
     for (const market of betpawaData.markets) {
       if (market.margin === null || market.margin < 0) continue

       const key = getMarketKey(market.betpawa_market_id, market.line)
       // ... accumulate into marketMap
     }
   }
   ```

3. Update the MarketAccumulator to use `betpawa_market_id` and `betpawa_market_name` fields from MarketOddsDetail

4. Add reasonable concurrency limit (fetch 5 events at a time) using Promise.all with chunking to avoid overwhelming the API

5. Update staleTime to 10 minutes (since we're making more API calls)
  </action>
  <verify>npm run build passes, no TypeScript errors</verify>
  <done>useTournamentMarkets now fetches full event details and extracts ALL markets from markets_by_bookmaker</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated useTournamentMarkets hook to fetch all markets via event detail endpoint</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Go to Historical Analysis page
    3. Click "View Details" on a tournament with multiple events
    4. Verify: Grid shows more than 4 market cards (should see Correct Score, HT/FT, Asian Handicap, etc.)
    5. Verify: Market cards display correct avg/min/max margins and event counts
    6. Verify: Click on a market card shows the margin timeline chart
  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Tournament detail page shows ALL markets (not just 4 tracked)
- [ ] Market cards display correct statistics
- [ ] Timeline chart works for any market
- [ ] Performance acceptable (loading indicator works, page loads within reasonable time)
</verification>

<success_criteria>
- UAT-001 resolved: All unique markets from Betpawa's full market list displayed
- No regression on existing functionality
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/84.2-tournament-detail-page/84.2-01-FIX-SUMMARY.md`
</output>
