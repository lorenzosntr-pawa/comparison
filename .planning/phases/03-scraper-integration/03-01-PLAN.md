---
phase: 03-scraper-integration
plan: 01
type: execute
domain: fastapi
---

<objective>
Set up FastAPI application foundation with async lifespan handler for HTTP client management.

Purpose: Establish the core FastAPI app structure that all scraper integration work builds upon.
Output: Working FastAPI app with proper startup/shutdown lifecycle and project structure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scraper-integration/03-RESEARCH.md
@.planning/phases/03-scraper-integration/03-CONTEXT.md
@.planning/phases/02-database-schema/02-01-SUMMARY.md

**Tech stack available:** SQLAlchemy 2.0 async, asyncpg, Pydantic v2
**Established patterns:** DeclarativeBase, async_sessionmaker, get_db dependency
**Key files:** src/db/engine.py (async engine pattern to follow)

**From RESEARCH.md:**
- Use FastAPI lifespan context manager for async client lifecycle
- Initialize httpx.AsyncClient instances at startup, close at shutdown
- Yield app state dict with clients for dependency injection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI app factory with lifespan handler</name>
  <files>src/api/app.py, src/api/__init__.py</files>
  <action>
Create FastAPI application factory with async lifespan context manager:

1. Create `src/api/__init__.py` (empty, marks package)

2. Create `src/api/app.py` with:
   - Import httpx, FastAPI, asynccontextmanager
   - Define `AppState` TypedDict with keys: sportybet_client, betpawa_client, bet9ja_client (all httpx.AsyncClient)
   - Create `lifespan(app: FastAPI)` async context manager that:
     - Uses nested `async with` for all three AsyncClient instances
     - Each client has platform-specific base_url and headers (from scraper configs)
     - Yields AppState dict
   - Create `create_app()` factory function that returns FastAPI(lifespan=lifespan, title="Betpawa Odds Comparison API", version="0.1.0")

Platform configs to use:
- SportyBet: base_url="https://www.sportybet.com", headers from scraper/src/sportybet_scraper/config.py
- BetPawa: base_url="https://www.betpawa.ng", headers from scraper/src/betpawa_scraper/config.py
- Bet9ja: base_url="https://web.bet9ja.com", headers from scraper/src/bet9ja_scraper/config.py

Include DEFAULT_TIMEOUT=30.0 for all clients.

Do NOT import from scraper package yet - copy the header constants directly to avoid import issues. We'll refactor to shared config later if needed.
  </action>
  <verify>python -c "from src.api.app import create_app; app = create_app(); print(app.title)"</verify>
  <done>FastAPI app imports without error, prints "Betpawa Odds Comparison API"</done>
</task>

<task type="auto">
  <name>Task 2: Set up API project structure and dependencies</name>
  <files>src/api/dependencies.py, src/api/routes/__init__.py, pyproject.toml</files>
  <action>
1. Create `src/api/routes/__init__.py` (empty, marks package)

2. Create `src/api/dependencies.py` with:
   - Import Request, httpx
   - `get_sportybet_client(request: Request) -> httpx.AsyncClient` - returns request.state.sportybet_client
   - `get_betpawa_client(request: Request) -> httpx.AsyncClient` - returns request.state.betpawa_client
   - `get_bet9ja_client(request: Request) -> httpx.AsyncClient` - returns request.state.bet9ja_client
   - Re-export `get_db` from src.db.engine for convenience

3. Update `pyproject.toml` dependencies to add:
   - fastapi>=0.109
   - uvicorn[standard]>=0.27

   (httpx, pydantic already available from existing deps)

4. Create `src/api/routes/health.py` with minimal stub:
   - APIRouter with prefix="/health", tags=["health"]
   - Single GET "/" endpoint returning {"status": "ok"} for now (full implementation in Plan 05)

5. Update `src/api/app.py` to include the health router:
   - Import router from src.api.routes.health
   - app.include_router(router)
  </action>
  <verify>pip install -e . && python -c "from src.api.app import create_app; app = create_app(); print([r.path for r in app.routes])"</verify>
  <done>Dependencies install, app has /health route registered, all imports work</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.api.app import create_app"` succeeds
- [ ] `pip install -e .` installs fastapi, uvicorn without errors
- [ ] App has lifespan handler defined
- [ ] Health route registered at /health
</verification>

<success_criteria>
- FastAPI app factory created with lifespan handler
- Three AsyncClient configs defined (sportybet, betpawa, bet9ja)
- Dependency injection helpers for clients created
- Project structure: src/api/, src/api/routes/
- Dependencies added to pyproject.toml
</success_criteria>

<output>
After completion, create `.planning/phases/03-scraper-integration/03-01-SUMMARY.md`
</output>
