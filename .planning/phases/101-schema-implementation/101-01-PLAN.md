---
phase: 101-schema-implementation
plan: 01
type: execute
---

<objective>
Remove raw_response columns from odds_snapshots and competitor_odds_snapshots tables to reclaim 33 GB (53% of database storage).

Purpose: The raw_response JSON columns store complete API responses that are never read after scraping completes. Phase 100 investigation confirmed these are unused by any API endpoints, features, or historical analysis.

Output: Updated scraping code, models, DTOs, write handler, and Alembic migration that drops the columns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 100 investigation findings:
@.planning/phases/100-investigation-analysis/100-01-SUMMARY.md
@.planning/phases/100-investigation-analysis/DISCOVERY.md

# Files to modify:
@src/db/models/odds.py
@src/db/models/competitor.py
@src/storage/write_queue.py
@src/storage/write_handler.py
@src/scraping/competitor_events.py
@src/scraping/event_coordinator.py

# Migration reference:
@alembic/versions/k7l3m9n5o1p2_add_unavailable_at.py

**Key Findings from Phase 100:**
- raw_response columns consume 33 GB (53% of database)
- odds_snapshots.raw_response: 23 GB
- competitor_odds_snapshots.raw_response: 10 GB
- NO API endpoints read raw_response
- NO historical analysis uses raw_response
- ONLY used during scraping: competitor_events.py reads raw_response to extract Bet9ja ID

**Critical Code Analysis:**
- competitor_events.py line 778-780: Reads raw_response.get("ID") for Bet9ja API calls
- BUT: external_id already contains the same ID (extracted in _parse_bet9ja_event line 265-266)
- Therefore: raw_response lookup is redundant and can be removed

**Constraining Decisions:**
- [Phase 100]: raw_response is safe to remove - code analysis confirms no reads after scraping
- [Phase 100]: Hold raw API data in memory during scrape only, don't persist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove raw_response from scraping code</name>
  <files>src/scraping/competitor_events.py, src/scraping/event_coordinator.py</files>
  <action>
In competitor_events.py:
1. Remove "raw_response": event_data from _parse_sportybet_event return dict (line ~224)
2. Remove "raw_response": event_data from _parse_bet9ja_event return dict (line ~278)
3. Update _fetch_and_update_full_odds to NOT include raw_response in events_to_fetch dict (line ~974) - just use {"snapshot_id": snapshot_id, "external_id": event.external_id}
4. Update _fetch_full_odds_api_only to use external_id directly for Bet9ja instead of trying raw_response first (lines 778-780). Change to: `bet9ja_event_id = external_id` (the raw fallback was redundant - external_id already contains the correct ID)

In event_coordinator.py:
1. Search for all occurrences of raw_response (around lines 1503, 1530, 1752, 1760)
2. Replace raw_response=raw_data with raw_response=None (or remove the argument if model allows)
3. If raw_data is only used for raw_response, can also remove those local variable assignments

Do NOT remove raw_response from models/DTOs yet - that's Task 2.
  </action>
  <verify>
grep -r "raw_response" src/scraping/ should show only the ORM model field assignments (will be None)
No grep matches for "raw_response.*event_data" or "raw_response.*raw" in scraping code
  </verify>
  <done>
- _parse_sportybet_event no longer includes raw_response in return dict
- _parse_bet9ja_event no longer includes raw_response in return dict
- _fetch_and_update_full_odds no longer reads snapshot.raw_response
- _fetch_full_odds_api_only uses external_id directly for Bet9ja (no raw fallback)
- event_coordinator.py passes None for raw_response
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove raw_response from models, DTOs, and write handler</name>
  <files>src/db/models/odds.py, src/db/models/competitor.py, src/storage/write_queue.py, src/storage/write_handler.py</files>
  <action>
In src/db/models/odds.py:
1. Remove the raw_response column definition from OddsSnapshot class (line ~62):
   `raw_response: Mapped[dict | None] = mapped_column(JSON, nullable=True)`
2. Update the docstring to remove mention of raw_response

In src/db/models/competitor.py:
1. Remove the raw_response column definition from CompetitorOddsSnapshot class (line ~198):
   `raw_response: Mapped[dict | None] = mapped_column(JSON, nullable=True)`
2. Update the docstring to remove mention of raw_response

In src/storage/write_queue.py:
1. Remove raw_response field from SnapshotWriteData dataclass (line ~66):
   `raw_response: dict | None`
2. Remove raw_response field from CompetitorSnapshotWriteData dataclass (line ~76):
   `raw_response: dict | None`

In src/storage/write_handler.py:
1. Remove raw_response=swd.raw_response from OddsSnapshot creation (line ~120)
2. Remove raw_response=cswd.raw_response from CompetitorOddsSnapshot creation (line ~135)
  </action>
  <verify>
grep -r "raw_response" src/db/models/ should return no matches
grep -r "raw_response" src/storage/ should return no matches
python -c "from src.db.models.odds import OddsSnapshot; print('OK')" succeeds
python -c "from src.storage.write_queue import SnapshotWriteData; print('OK')" succeeds
  </verify>
  <done>
- OddsSnapshot model no longer has raw_response column
- CompetitorOddsSnapshot model no longer has raw_response column
- SnapshotWriteData DTO no longer has raw_response field
- CompetitorSnapshotWriteData DTO no longer has raw_response field
- write_handler.py no longer sets raw_response on snapshots
  </done>
</task>

<task type="auto">
  <name>Task 3: Create and run Alembic migration to drop columns</name>
  <files>alembic/versions/m9n5o1p7q3r9_drop_raw_response.py</files>
  <action>
1. Find the latest migration revision by checking alembic/versions/ for most recent file
2. Create new migration file alembic/versions/m9n5o1p7q3r9_drop_raw_response.py with:
   - Revision: m9n5o1p7q3r9
   - down_revision: (latest migration revision ID)
   - upgrade(): Drop raw_response column from odds_snapshots and competitor_odds_snapshots
   - downgrade(): Add raw_response column back (nullable JSON)
3. Run the migration: cd to project root and run `alembic upgrade head`
4. Verify columns are dropped:
   - Connect to database
   - Check odds_snapshots and competitor_odds_snapshots no longer have raw_response column

Note: Do NOT run VACUUM FULL - that requires exclusive table lock and will block all operations. The space will be reclaimed gradually by PostgreSQL's autovacuum or can be done during a maintenance window.
  </action>
  <verify>
alembic current shows the new revision
SELECT column_name FROM information_schema.columns WHERE table_name = 'odds_snapshots' AND column_name = 'raw_response'; returns 0 rows
SELECT column_name FROM information_schema.columns WHERE table_name = 'competitor_odds_snapshots' AND column_name = 'raw_response'; returns 0 rows
  </verify>
  <done>
- Migration file created with correct revision chain
- Migration applied successfully
- raw_response columns no longer exist in database schema
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `grep -r "raw_response" src/` returns no matches in Python files (except maybe comments)
- [ ] `python -c "from src.db.models import *; from src.storage import *; print('OK')"` succeeds
- [ ] `alembic current` shows latest migration applied
- [ ] Database schema no longer has raw_response columns
- [ ] Application starts without errors: `python -c "from src.main import app; print('OK')"`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- raw_response completely removed from codebase and database
- Application functions normally after changes
</success_criteria>

<output>
After completion, create `.planning/phases/101-schema-implementation/101-01-SUMMARY.md`:

# Phase 101 Plan 01: Remove raw_response Columns Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 102: Application Migration, or note any blockers]
</output>
