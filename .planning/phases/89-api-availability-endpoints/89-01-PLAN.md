---
phase: 89-api-availability-endpoints
plan: 01
type: execute
---

<objective>
Add availability state to API responses so frontend can display unavailable markets.

Purpose: Enable frontend to distinguish "never offered" (null) from "became unavailable" (with timestamp) using the `available` boolean and `unavailable_since` timestamp fields.
Output: Updated API responses include availability fields on all market objects.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/87-investigation-schema-design/DISCOVERY.md
@.planning/phases/88-backend-availability-tracking/88-01-SUMMARY.md

**From Phase 88:**
- Schema migration added `unavailable_at` column to MarketOdds and CompetitorMarketOdds
- CachedMarket dataclass has `unavailable_at: datetime | None` field and `is_available` property
- Detection logic integrated into EventCoordinator

**Tech stack available:**
- Pydantic v2 with ConfigDict
- CachedMarket.is_available property ready
- MarketOdds.unavailable_at column in DB

**Key files:**
@src/matching/schemas.py
@src/api/routes/events.py
@src/caching/odds_cache.py

**Constraining decisions:**
- Phase 87: API should include `available: bool` and `unavailable_since: datetime | None`
- Phase 88: CachedMarket already has `unavailable_at` field with `is_available` property
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Pydantic schemas with availability fields</name>
  <files>src/matching/schemas.py</files>
  <action>
Add availability fields to the market response schemas:

1. `InlineOdds` (used in list view):
   - Add `available: bool = True`
   - Add `unavailable_since: datetime | None = None`

2. `MarketOddsDetail` (used in detail view):
   - Add `available: bool = True`
   - Add `unavailable_since: datetime | None = None`

These defaults (True, None) maintain backward compatibility - existing markets without availability tracking will appear as available.
  </action>
  <verify>Python import succeeds: `python -c "from src.matching.schemas import InlineOdds, MarketOddsDetail; print('OK')"`</verify>
  <done>Both InlineOdds and MarketOddsDetail have `available` and `unavailable_since` fields with correct defaults</done>
</task>

<task type="auto">
  <name>Task 2: Update API response builders to pass availability data</name>
  <files>src/api/routes/events.py</files>
  <action>
Update the four builder functions to extract availability from market objects:

1. `_build_inline_odds()` (BetPawa list view, lines ~133-183):
   - Market is `CachedMarket` from cache (has `unavailable_at` field)
   - Extract `available = market.unavailable_at is None`
   - Extract `unavailable_since = market.unavailable_at`
   - Pass to InlineOdds constructor

2. `_build_competitor_inline_odds()` (competitor list view, lines ~373-425):
   - Same pattern as above for competitor markets

3. `_build_market_detail()` (BetPawa detail view, lines ~554-584):
   - Market is `MarketOdds` ORM model (has `unavailable_at` column from Phase 88)
   - Extract availability using `getattr(market, 'unavailable_at', None)` for safe access
   - Pass to MarketOddsDetail constructor

4. `_build_competitor_market_detail()` (competitor detail view, lines ~633-663):
   - Market is `CompetitorMarketOdds` ORM model
   - Same pattern as above

Note: Use `getattr()` pattern for ORM models to handle DB fallback path gracefully (when cache miss loads from DB, the column is there).
  </action>
  <verify>Start API server and test endpoint: `curl -s http://localhost:8000/api/events/1 | python -c "import sys,json; d=json.load(sys.stdin); m=d['markets_by_bookmaker'][0]['markets'][0]; print('available:', m.get('available'), 'unavailable_since:', m.get('unavailable_since'))"` - should show `available: True unavailable_since: None` for available markets</verify>
  <done>All four builder functions pass `available` and `unavailable_since` fields; API responses include availability data</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.matching.schemas import InlineOdds, MarketOddsDetail"` succeeds
- [ ] API server starts without errors
- [ ] GET /api/events returns markets with `available` field
- [ ] GET /api/events/{id} returns markets with `available` and `unavailable_since` fields
- [ ] All 92 existing tests pass: `pytest`
</verification>

<success_criteria>

- Pydantic schemas updated with availability fields
- API response builders pass availability data
- API responses include `available: bool` and `unavailable_since: datetime | None`
- No breaking changes to existing consumers (defaults maintain compatibility)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/89-api-availability-endpoints/89-01-SUMMARY.md`:

# Phase 89 Plan 01: API Availability Endpoints Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/matching/schemas.py` - Added availability fields
- `src/api/routes/events.py` - Updated response builders

## Decisions Made

[If any]

## Issues Encountered

[If any]

## Next Phase Readiness

- Phase 90 can now style unavailable markets with data from API
</output>
