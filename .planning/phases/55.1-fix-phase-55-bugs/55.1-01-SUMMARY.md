---
phase: 55.1-fix-phase-55-bugs
plan: 01
subsystem: infra
tags: [asyncio, write-queue, stale-detection, cache, timezone, logging]

# Dependency graph
requires:
  - phase: 55-async-write-pipeline
    provides: async write queue, change detection, cache-first API
provides:
  - working async write pipeline without duplicate keyword crash
  - functional stale detection without timezone errors
  - on-demand scrapes integrated with cache and write queue
affects: [56-concurrency-tuning, 57-websocket-infrastructure]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "timezone stripping guard for datetime comparisons (extended existing pattern)"
    - "getattr() safe access for app state in on-demand scrape routes"

key-files:
  created: []
  modified:
    - src/storage/write_queue.py
    - src/scheduling/stale_detection.py
    - src/api/routes/scrape.py

key-decisions:
  - "Let **stats spread provide write_ms — no explicit duplicate needed"
  - "Guard both last_activity and started_at with timezone strip in stale detection"
  - "Capture odds_cache/write_queue in outer scope for background scrape task"

patterns-established: []

issues-created: []

# Metrics
duration: 3min
completed: 2026-02-05
---

# Phase 55.1 Plan 01: Fix Phase 55 Bugs Summary

**Fixed 3 async pipeline bugs: write_ms duplicate keyword crash (BUG-005), stale detection timezone mismatch (BUG-006), on-demand scrape cache/queue bypass (BUG-007)**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-05T15:41:11Z
- **Completed:** 2026-02-05T15:44:29Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- Async write batches now log successfully on first attempt — no triple-duplicate inserts
- Stale detection watchdog runs without timezone errors — stuck runs auto-failed correctly
- On-demand scrapes update cache immediately and persist via async write queue

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix BUG-005 — write_ms duplicate keyword** - `83c708d` (fix)
2. **Task 2: Fix BUG-006 — stale detection timezone mismatch** - `b6b92b4` (fix)
3. **Task 3: Fix BUG-007 — on-demand scrapes bypass cache/write queue** - `d2ead8a` (fix)

**Plan metadata:** (pending)

## Files Created/Modified
- `src/storage/write_queue.py` - Removed duplicate `write_ms` kwarg from success log in `_process_with_retry()`
- `src/scheduling/stale_detection.py` - Added timezone stripping guards for `last_activity` and `started_at` in `mark_run_stale()`
- `src/api/routes/scrape.py` - Added `odds_cache` and `write_queue` params to all 3 `EventCoordinator.from_settings()` calls

## Decisions Made
None - followed plan as specified

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## Next Phase Readiness
- All 3 bugs resolved (BUG-005, BUG-006, BUG-007)
- Phase 55.1 complete — async write pipeline fully functional
- Ready for Phase 56 (Concurrency Tuning)

---
*Phase: 55.1-fix-phase-55-bugs*
*Completed: 2026-02-05*
