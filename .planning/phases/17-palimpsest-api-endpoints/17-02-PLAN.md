---
phase: 17-palimpsest-api-endpoints
plan: 02
type: execute
---

<objective>
Create the main palimpsest events query endpoint with filtering, search, sorting, and tournament grouping.

Purpose: Provide a flexible API for querying events with full control over availability filters and display options.
Output: `/api/palimpsest/events` endpoint with rich filtering, search, and grouped response.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-palimpsest-api-endpoints/17-CONTEXT.md
@.planning/phases/17-palimpsest-api-endpoints/17-01-SUMMARY.md (after Plan 01 completes)

# Schemas defined in Plan 01:
@src/api/schemas/palimpsest.py

# Existing API patterns:
@src/api/routes/events.py
@src/db/models/competitor.py

**CONTEXT.md requirements:**
- Availability filter: betpawa-only | competitor-only | matched | all
- Platform filter: sportybet, bet9ja (comma-separated or list)
- Full-text search on teams, tournaments, leagues
- Sorting: kickoff, status, alphabetical
- Events grouped under tournaments
- Per-tournament coverage stats
- No pagination - return all matching data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create events endpoint with availability and platform filters</name>
  <files>src/api/routes/palimpsest.py</files>
  <action>
Add `GET /events` endpoint to palimpsest router:

1. **Query parameters**:
   - `availability: str = "all"` - Filter: betpawa-only | competitor-only | matched | all
   - `platforms: list[str] | None = None` - Filter to specific platforms (sportybet, bet9ja)
   - `sport_id: int | None = None` - Filter by sport
   - `include_started: bool = False` - Include events that have kicked off

2. **Query logic by availability**:

   **matched** (events on BetPawa AND competitor):
   - Query Event table joined to CompetitorEvent via sportradar_id OR betpawa_event_id
   - For each event, collect which platforms have it

   **betpawa-only**:
   - Query Event table WHERE sportradar_id NOT IN (SELECT sportradar_id FROM competitor_events)

   **competitor-only**:
   - Query CompetitorEvent WHERE betpawa_event_id IS NULL
   - Apply platform filter if specified

   **all** (default):
   - Union of all three categories
   - Use CTEs or subqueries for efficiency

3. **Platform filter**:
   - When platforms specified, only include competitor events from those sources
   - For matched events, still show if ANY specified platform matches

4. **Build PalimpsestEvent objects** from query results:
   - Determine availability type for each event
   - Collect platforms list (betpawa, sportybet, bet9ja)
   - Include tournament info via joins

5. **Return PalimpsestEventsResponse** with coverage stats calculated from the filtered result set.

Use async SQLAlchemy patterns. Optimize with selectinload for relationships.
Do NOT add pagination - return all matching events.
  </action>
  <verify>curl "http://localhost:8000/api/palimpsest/events?availability=competitor-only" returns events array</verify>
  <done>GET /api/palimpsest/events returns filtered events with correct availability classification</done>
</task>

<task type="auto">
  <name>Task 2: Add search, sorting, and tournament grouping</name>
  <files>src/api/routes/palimpsest.py</files>
  <action>
Enhance the events endpoint with search, sorting, and grouping:

1. **Add query parameters**:
   - `search: str | None = None` - Full-text search
   - `sort: str = "kickoff"` - Sort order: kickoff | alphabetical | tournament

2. **Implement search**:
   - Search across: home_team, away_team, tournament name
   - Use ILIKE with wildcards for case-insensitive partial match
   - Apply to both Event and CompetitorEvent queries

3. **Implement sorting**:
   - `kickoff`: Order by kickoff ascending (default)
   - `alphabetical`: Order by home_team, then away_team
   - `tournament`: Group by tournament, then kickoff within tournament

4. **Group events by tournament**:
   - After fetching events, group them into TournamentGroup objects
   - Each tournament includes:
     - Tournament metadata (id, name, country, sport)
     - TournamentCoverage (total, matched, betpawa_only, competitor_only for THIS tournament)
     - List of events in that tournament

   - Handle tournament source:
     - For BetPawa events: use Event.tournament relationship
     - For competitor-only events: use CompetitorTournament
     - When grouping, merge tournaments with same name/sport where possible

5. **Calculate coverage stats** for the response:
   - Overall CoverageStats from filtered result
   - Per-tournament TournamentCoverage

6. **Metadata priority for competitor-only events** (from ROADMAP):
   - When event exists on both sportybet and bet9ja but not betpawa
   - Use sportybet metadata as primary (sportybet > bet9ja priority)
   - This affects display name, teams, tournament info
  </action>
  <verify>curl "http://localhost:8000/api/palimpsest/events?search=arsenal&sort=tournament" returns grouped results</verify>
  <done>Events endpoint supports search, sorting, and returns events grouped by tournament with per-tournament stats</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `curl /api/palimpsest/events` returns all events grouped by tournament
- [ ] `?availability=matched` shows only events on both BetPawa and competitors
- [ ] `?availability=competitor-only` shows only events not on BetPawa
- [ ] `?availability=betpawa-only` shows only events not on competitors
- [ ] `?platforms=sportybet` filters to SportyBet data only
- [ ] `?search=team` filters by team/tournament name
- [ ] `?sort=tournament` groups and sorts correctly
- [ ] Coverage stats in response are accurate
</verification>

<success_criteria>

- Events endpoint with all filters working
- Search across teams and tournaments
- Sorting options functional
- Events grouped by tournament with per-tournament coverage
- Metadata priority applied for competitor-only events
- Phase 17 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/17-palimpsest-api-endpoints/17-02-SUMMARY.md`
</output>
