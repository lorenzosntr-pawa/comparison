---
phase: 17-palimpsest-api-endpoints
plan: 01
type: execute
---

<objective>
Create Pydantic response schemas and coverage statistics endpoint for palimpsest comparison API.

Purpose: Define the data contracts and provide a quick stats endpoint for the palimpsest comparison feature.
Output: Pydantic schemas in `src/api/schemas/palimpsest.py`, `/api/palimpsest/coverage` endpoint in `src/api/routes/palimpsest.py`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-palimpsest-api-endpoints/17-CONTEXT.md

# Phase 15 established competitor data patterns:
@.planning/phases/15-full-event-scraping/15-02-SUMMARY.md

# Existing API patterns to follow:
@src/api/routes/events.py
@src/db/models/competitor.py
@src/db/models/event.py

**Key data relationships:**
- `Event` table: BetPawa events with `sportradar_id`
- `CompetitorEvent` table: SportyBet/Bet9ja events with `sportradar_id` and optional `betpawa_event_id` FK
- Matched = CompetitorEvent.betpawa_event_id IS NOT NULL
- Competitor-only = CompetitorEvent.betpawa_event_id IS NULL
- BetPawa-only = Event with SR ID not in any CompetitorEvent.sportradar_id

**CONTEXT.md requirements:**
- Coverage stats: matched count, competitor-only count, betpawa-only count, percentages
- Per-platform breakdown (sportybet vs bet9ja)
- Accurate counts are essential
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Pydantic schemas for palimpsest API</name>
  <files>src/api/schemas/palimpsest.py, src/api/schemas/__init__.py</files>
  <action>
Create Pydantic v2 schemas using frozen models and ConfigDict (following project patterns):

1. **PlatformCoverage** - Per-platform stats:
   - platform: str (sportybet | bet9ja)
   - total_events: int
   - matched_events: int
   - unmatched_events: int
   - match_rate: float (percentage)

2. **CoverageStats** - Overall coverage summary:
   - total_events: int (unique events across all platforms)
   - matched_count: int (events present on BetPawa AND at least one competitor)
   - betpawa_only_count: int (events only on BetPawa)
   - competitor_only_count: int (events only on competitors)
   - match_rate: float (percentage of total that are matched)
   - by_platform: list[PlatformCoverage]

3. **PalimpsestEvent** - Event with availability info:
   - id: int (either event.id or competitor_event.id)
   - sportradar_id: str
   - name: str
   - home_team: str
   - away_team: str
   - kickoff: datetime
   - tournament_name: str
   - tournament_country: str | None
   - sport_name: str
   - availability: str (betpawa-only | competitor-only | matched)
   - platforms: list[str] (which platforms have this event)

4. **TournamentGroup** - Events grouped by tournament:
   - tournament_id: int
   - tournament_name: str
   - tournament_country: str | None
   - sport_name: str
   - coverage: TournamentCoverage
   - events: list[PalimpsestEvent]

5. **TournamentCoverage** - Per-tournament stats:
   - total: int
   - matched: int
   - betpawa_only: int
   - competitor_only: int

6. **PalimpsestEventsResponse** - Full response:
   - coverage: CoverageStats
   - tournaments: list[TournamentGroup]

Export all schemas from `src/api/schemas/__init__.py`.
  </action>
  <verify>python -c "from src.api.schemas.palimpsest import CoverageStats, PalimpsestEvent, TournamentGroup, PalimpsestEventsResponse; print('Schemas loaded')"</verify>
  <done>All 6 schema classes defined, imported successfully, following Pydantic v2 patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create coverage stats endpoint</name>
  <files>src/api/routes/palimpsest.py, src/api/app.py</files>
  <action>
Create `/api/palimpsest/coverage` endpoint:

1. **Create new route file** `src/api/routes/palimpsest.py`:
   - Import patterns from existing events.py (FastAPI, SQLAlchemy async, etc.)
   - Create router with prefix="/palimpsest", tags=["palimpsest"]

2. **Implement `GET /coverage` endpoint** returning `CoverageStats`:

   Query logic:
   a) Count total BetPawa events (from `events` table with upcoming kickoff)
   b) Count total competitor events by source (from `competitor_events` table with upcoming kickoff, grouped by source)
   c) Count matched events (competitor_events WHERE betpawa_event_id IS NOT NULL, by source)
   d) Calculate:
      - matched_count = distinct betpawa_event_ids that have competitor matches
      - betpawa_only_count = betpawa events with SR ID NOT IN competitor_events.sportradar_id
      - competitor_only_count = competitor_events WHERE betpawa_event_id IS NULL
      - total_events = matched_count + betpawa_only_count + competitor_only_count
      - match_rate = (matched_count / total_events) * 100

   Use efficient COUNT queries, not loading full rows.
   Filter to upcoming events only (kickoff > now) by default.

3. **Register router** in `src/api/app.py`:
   - Import palimpsest router
   - Include with prefix "/api/palimpsest"

4. **Query parameters**:
   - `include_started: bool = False` - Include events that have already kicked off
  </action>
  <verify>curl http://localhost:8000/api/palimpsest/coverage returns JSON with coverage stats structure</verify>
  <done>GET /api/palimpsest/coverage returns CoverageStats with accurate counts and per-platform breakdown</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.api.schemas.palimpsest import *"` succeeds
- [ ] API server starts without errors
- [ ] `curl /api/palimpsest/coverage` returns valid JSON with all fields
- [ ] Coverage stats counts are consistent (total = matched + betpawa_only + competitor_only)
</verification>

<success_criteria>

- All schemas defined with Pydantic v2 patterns
- Coverage endpoint returns accurate statistics
- Per-platform breakdown included
- No TypeScript/Python errors
- Ready for Plan 02 (events query endpoint)
  </success_criteria>

<output>
After completion, create `.planning/phases/17-palimpsest-api-endpoints/17-01-SUMMARY.md`
</output>
