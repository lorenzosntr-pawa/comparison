---
phase: 104-mapping-editor
plan: 04
type: execute
domain: react-ui
---

<objective>
Implement preview mode showing mapping impact and submit flow with validation.

Purpose: Allow users to review their mapping before saving and seamlessly update unmapped market status.
Output: Working preview → submit → success flow with proper cache invalidation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase
@.planning/phases/104-mapping-editor/104-01-PLAN.md
@.planning/phases/104-mapping-editor/104-02-PLAN.md
@.planning/phases/104-mapping-editor/104-03-PLAN.md

# Key files
@web/src/features/mappings/editor/index.tsx
@src/api/routes/mappings.py
@src/api/routes/unmapped.py
@src/api/schemas/mappings.py

**Tech stack available:** React, TanStack Query v5 (mutations), shadcn/ui (Dialog, Button, Alert), Tailwind v4
**Established patterns:** useMutation for POST/PATCH, invalidateQueries after mutation success
**Constraining decisions:**
- POST /api/mappings for create, PATCH /api/mappings/:id for update
- PATCH /api/unmapped/:id to set status=MAPPED after successful mapping creation
- CreateMappingRequest requires reason for audit log
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview panel component</name>
  <files>web/src/features/mappings/editor/components/mapping-preview.tsx</files>
  <action>
Create MappingPreview component showing the mapping that will be created/updated:

Props:
```typescript
interface MappingPreviewProps {
  mode: 'create' | 'extend';
  formState: MappingFormState;
  outcomes: OutcomeFormItem[];
  sourceMarket: UnmappedMarketDetailResponse;
  existingMapping?: MappingDetailResponse;
}
```

Preview display:
1. Mode badge: "Creating New Mapping" or "Extending Existing Mapping"
2. Summary card showing:
   - Canonical ID → Name
   - Platform coverage indicators (✓ Betpawa, ✓ SportyBet, etc.)
   - Outcome count
3. Impact section:
   - "This mapping will:"
   - For create: "Create new mapping with canonical_id: {id}"
   - For extend: "Add {platform} support to existing mapping"
   - "Mark {source} market '{name}' as MAPPED"
4. Outcome preview table (read-only, compact view of outcome mappings)
5. Warnings section:
   - Show if any required fields missing
   - Show if canonical_id conflicts with existing (for create mode)
   - Show if no outcomes defined

Use Alert component for warnings, Card for sections. Make it clear what will happen on submit.
  </action>
  <verify>npm run build passes, preview shows accurate summary of pending changes</verify>
  <done>MappingPreview displays clear summary of what will be created/updated</done>
</task>

<task type="auto">
  <name>Task 2: Create submit mutation and flow</name>
  <files>web/src/features/mappings/editor/hooks/use-create-mapping.ts, web/src/features/mappings/editor/hooks/use-update-unmapped-status.ts</files>
  <action>
Create mutations for saving mapping and updating unmapped status:

1. Create `use-create-mapping.ts`:
```typescript
interface CreateMappingParams {
  canonicalId: string;
  name: string;
  betpawaId: string | null;
  sportybetId: string | null;
  bet9jaKey: string | null;
  outcomeMapping: OutcomeFormItem[];
  priority: number;
  reason: string;
}

function useCreateMapping() {
  return useMutation({
    mutationFn: (params: CreateMappingParams) =>
      fetch('/api/mappings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          canonicalId: params.canonicalId,
          name: params.name,
          betpawaId: params.betpawaId,
          sportybetId: params.sportybetId,
          bet9jaKey: params.bet9jaKey,
          outcomeMapping: params.outcomeMapping.map(o => ({
            canonicalId: o.canonicalId,
            betpawaName: o.betpawaName,
            sportybetDesc: o.sportybetDesc,
            bet9jaSuffix: o.bet9jaSuffix,
            position: o.position,
          })),
          priority: params.priority,
          reason: params.reason,
        }),
      }),
    onSuccess: () => {
      // Invalidate mapping queries
      queryClient.invalidateQueries({ queryKey: ['mappings'] });
      queryClient.invalidateQueries({ queryKey: ['mapping-stats'] });
    },
  });
}
```

2. Create `use-update-unmapped-status.ts`:
```typescript
function useUpdateUnmappedStatus() {
  return useMutation({
    mutationFn: ({ id, status }: { id: number; status: string }) =>
      fetch(`/api/unmapped/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['unmapped'] });
      queryClient.invalidateQueries({ queryKey: ['high-priority-unmapped'] });
    },
  });
}
```

Handle both extend mode (PATCH existing mapping) and create mode (POST new mapping).
  </action>
  <verify>npm run build passes, mutations defined with proper types and cache invalidation</verify>
  <done>Create/update mutations ready with proper query invalidation</done>
</task>

<task type="auto">
  <name>Task 3: Integrate preview and submit into editor</name>
  <files>web/src/features/mappings/editor/index.tsx, web/src/features/mappings/editor/components/submit-dialog.tsx</files>
  <action>
Create submit dialog and integrate into editor:

1. Create `submit-dialog.tsx`:
   - Dialog with MappingPreview content
   - Reason textarea (required for audit log)
   - Cancel and Submit buttons
   - Loading state during submit
   - Error display if submit fails
   - Success state with redirect to dashboard

2. Update `editor/index.tsx`:
   - Add "Preview & Submit" button at bottom of right panel
   - Button disabled if form invalid (missing required fields, no outcomes)
   - On click: open SubmitDialog
   - Submit flow:
     a. Create/update mapping
     b. If successful, update unmapped status to MAPPED
     c. Show success message
     d. Navigate to /mappings dashboard

3. Validation before submit:
   - canonicalId required and valid format (a-z0-9_)
   - name required
   - At least one platform ID required
   - At least one outcome required
   - All outcomes have canonicalId

4. Error handling:
   - Show API errors in dialog
   - Handle 400 (validation), 409 (conflict) specifically
   - Allow retry without closing dialog

Add keyboard shortcut: Cmd/Ctrl+Enter to submit from dialog.
  </action>
  <verify>npm run build passes, end-to-end flow works: edit → preview → submit → success → redirect</verify>
  <done>Complete editor flow from edit through preview to successful submission</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Preview shows accurate mapping summary
- [ ] Validation prevents invalid submissions
- [ ] Submit creates/updates mapping via API
- [ ] Unmapped status updated to MAPPED after success
- [ ] Query cache invalidated (dashboard refreshes)
- [ ] Success navigates back to dashboard
- [ ] Error states display appropriately
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Complete end-to-end mapping editor workflow functional
- Phase 104 complete
</success_criteria>

<output>
After completion, create `.planning/phases/104-mapping-editor/104-04-SUMMARY.md`
</output>
