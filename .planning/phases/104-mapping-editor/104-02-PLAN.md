---
phase: 104-mapping-editor
plan: 02
type: execute
domain: react-ui
---

<objective>
Create the right panel with Betpawa market picker and mapping form fields.

Purpose: Enable users to select an existing mapping to extend or create a new mapping from scratch.
Output: Working target market configuration panel with searchable picker and form inputs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/104-mapping-editor/104-01-PLAN.md

# Key files
@web/src/features/mappings/editor/index.tsx
@src/api/routes/mappings.py
@src/api/schemas/mappings.py

**Tech stack available:** React, TanStack Query v5, shadcn/ui (Command, Popover, Form), Tailwind v4
**Established patterns:** Command + Popover for searchable selects (v1.3 pattern)
**Constraining decisions:**
- Mappings API already supports search parameter for list endpoint
- CreateMappingRequest schema defines required fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mapping picker with search</name>
  <files>web/src/features/mappings/editor/components/mapping-picker.tsx, web/src/features/mappings/editor/hooks/use-mappings-search.ts</files>
  <action>
Create searchable mapping picker using Command + Popover pattern:

1. Create `use-mappings-search.ts` hook:
   - Accepts search string, returns useQuery for GET /api/mappings?search={search}&pageSize=20
   - Debounce search input (300ms) to avoid excessive API calls
   - Return MappingListResponse type

2. Create `mapping-picker.tsx` component:
   - Props: `onSelect: (mapping: MappingListItem | null) => void`, `selectedId?: string`
   - Two modes via tabs or radio: "Select Existing" or "Create New"
   - "Select Existing" mode:
     - Command + Popover combo (shadcn pattern)
     - Search input filters existing mappings
     - Show canonical_id, name, platform badges for each option
     - Allow clearing selection
   - "Create New" mode:
     - Just shows text indicating new mapping will be created
     - Form fields handled in parent (next task)

Display selected mapping summary when one is chosen. Use existing patterns from country filter (Command + Popover).
  </action>
  <verify>npm run build passes, picker shows existing mappings with search, can select or clear</verify>
  <done>MappingPicker renders with search, allows selecting existing mapping or choosing "Create New"</done>
</task>

<task type="auto">
  <name>Task 2: Create target market form fields</name>
  <files>web/src/features/mappings/editor/components/target-market-form.tsx</files>
  <action>
Create TargetMarketForm component for mapping configuration:

Props:
```typescript
interface TargetMarketFormProps {
  mode: 'create' | 'extend';
  existingMapping?: MappingDetailResponse;
  sourceMarket: UnmappedMarketDetailResponse;
  value: MappingFormState;
  onChange: (value: MappingFormState) => void;
}

interface MappingFormState {
  canonicalId: string;
  name: string;
  betpawaId: string | null;
  sportybetId: string | null;
  bet9jaKey: string | null;
  priority: number;
}
```

Form fields (all using shadcn Input):
1. Canonical ID - text, required for create mode, readonly if extend mode
2. Name - text, required, auto-filled from existing or source market name
3. Platform IDs section:
   - Betpawa ID - text, optional
   - SportyBet ID - text, optional, auto-fill from source if source=sportybet
   - Bet9ja Key - text, optional, auto-fill from source if source=bet9ja
4. Priority - number input (0-100), default 10 for user mappings

Extend mode: pre-fill all fields from existingMapping, only allow editing platform IDs not already set.
Create mode: generate canonical_id suggestion from name (lowercase, underscores).

Use controlled form pattern - parent manages state via value/onChange props.
  </action>
  <verify>npm run build passes, form renders with all fields, controlled state works</verify>
  <done>TargetMarketForm displays all mapping fields with appropriate modes and auto-fill</done>
</task>

<task type="auto">
  <name>Task 3: Integrate picker and form into right panel</name>
  <files>web/src/features/mappings/editor/components/target-market-panel.tsx, web/src/features/mappings/editor/index.tsx</files>
  <action>
Create TargetMarketPanel that composes picker and form:

1. Create `target-market-panel.tsx`:
   - State: selectedMapping (MappingListItem | null), mode ('create' | 'extend'), formState
   - Show MappingPicker at top
   - When mapping selected: mode='extend', fetch full details, show form pre-filled
   - When "Create New" chosen: mode='create', show empty form
   - Use Card component for consistent styling

2. Update `editor/index.tsx`:
   - Import and render TargetMarketPanel in right column
   - Pass sourceMarket prop so form can auto-fill platform IDs
   - Add state management for form values (will be used for submit in Plan 04)

Layout should be:
- Left panel: ~40% width, source market display
- Right panel: ~60% width, target configuration
- Use CSS grid or flex for responsive layout
  </action>
  <verify>npm run build passes, editor shows both panels, selecting existing mapping loads details, create mode shows empty form</verify>
  <done>Editor page has complete two-panel layout with picker and form working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] MappingPicker searches existing mappings
- [ ] Selecting existing mapping pre-fills form
- [ ] Create New mode shows empty form with suggestions
- [ ] Platform IDs auto-fill from source market
- [ ] Form validation prevents empty required fields
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Target market configuration panel fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/104-mapping-editor/104-02-SUMMARY.md`
</output>
