---
phase: 104-mapping-editor
plan: 03
type: execute
domain: react-ui
---

<objective>
Create outcome mapping table with auto-suggest from source market sample outcomes.

Purpose: Enable users to define how source platform outcomes map to canonical outcomes with minimal manual input.
Output: Working outcome mapping editor with intelligent suggestions based on sample_outcomes data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase
@.planning/phases/104-mapping-editor/104-01-PLAN.md
@.planning/phases/104-mapping-editor/104-02-PLAN.md

# Key files
@web/src/features/mappings/editor/index.tsx
@src/market_mapping/types/normalized.py
@src/api/schemas/mappings.py

**Tech stack available:** React, shadcn/ui (Table, Input, Button), Tailwind v4
**Established patterns:** OutcomeMapping schema has canonical_id, betpawa_name, sportybet_desc, bet9ja_suffix, position
**Constraining decisions:**
- sample_outcomes in UnmappedMarketDetailResponse contains raw outcome data from scraping
- OutcomeMappingSchema requires canonical_id and position at minimum
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auto-suggest algorithm for outcomes</name>
  <files>web/src/features/mappings/editor/utils/outcome-suggest.ts</files>
  <action>
Create outcome suggestion utility that analyzes sample_outcomes:

```typescript
interface SuggestedOutcome {
  canonicalId: string;        // Suggested canonical ID (e.g., 'home', 'draw', 'over')
  betpawaName: string | null;
  sportybetDesc: string | null;
  bet9jaSuffix: string | null;
  position: number;
  confidence: 'high' | 'medium' | 'low';
  source: string; // Original value that triggered this suggestion
}

function suggestOutcomes(
  sampleOutcomes: any[] | null,
  sourcePlatform: 'sportybet' | 'bet9ja'
): SuggestedOutcome[]
```

Algorithm:
1. If sample_outcomes null/empty, return empty array
2. For each sample outcome, extract name/desc/value fields (platform-specific structure)
3. Match against known canonical patterns:
   - 'Home', '1', 'H' → canonical 'home'
   - 'Draw', 'X', 'D' → canonical 'draw'
   - 'Away', '2', 'A' → canonical 'away'
   - 'Over', 'O' → canonical 'over'
   - 'Under', 'U' → canonical 'under'
   - 'Yes', 'Y', 'GG' → canonical 'yes'
   - 'No', 'N', 'NG' → canonical 'no'
   - '1X', '12', 'X2' → canonical for double chance
4. Assign confidence:
   - high: exact match to known pattern
   - medium: partial/fuzzy match
   - low: no match, use original value as canonicalId
5. Set position based on order in sample_outcomes
6. Fill platform-specific field based on sourcePlatform

Handle edge cases: duplicate suggestions, special characters, numeric values.
  </action>
  <verify>npm run build passes, unit-testable function exported</verify>
  <done>suggestOutcomes function generates reasonable suggestions from raw sample data</done>
</task>

<task type="auto">
  <name>Task 2: Create outcome mapping table component</name>
  <files>web/src/features/mappings/editor/components/outcome-mapping-table.tsx</files>
  <action>
Create OutcomeMappingTable for editing outcome mappings:

Props:
```typescript
interface OutcomeMappingTableProps {
  outcomes: OutcomeFormItem[];
  onChange: (outcomes: OutcomeFormItem[]) => void;
  sourcePlatform: 'sportybet' | 'bet9ja';
}

interface OutcomeFormItem {
  canonicalId: string;
  betpawaName: string | null;
  sportybetDesc: string | null;
  bet9jaSuffix: string | null;
  position: number;
}
```

Table structure using shadcn Table:
- Column 1: Position (drag handle or up/down buttons for reordering)
- Column 2: Canonical ID (editable Input)
- Column 3: Betpawa Name (editable Input)
- Column 4: SportyBet Desc (editable Input, highlighted if source=sportybet)
- Column 5: Bet9ja Suffix (editable Input, highlighted if source=bet9ja)
- Column 6: Actions (delete button)

Features:
- Add row button at bottom
- Delete row with confirmation (or just delete if >1 row)
- Reorder via position up/down buttons (simpler than drag-drop)
- Highlight source platform column with different background

Keep table compact - outcomes typically have 2-4 rows.
  </action>
  <verify>npm run build passes, table renders with editable cells, add/remove/reorder works</verify>
  <done>OutcomeMappingTable allows full editing of outcome mappings with reordering</done>
</task>

<task type="auto">
  <name>Task 3: Integrate outcome mapping into editor</name>
  <files>web/src/features/mappings/editor/components/target-market-panel.tsx, web/src/features/mappings/editor/index.tsx</files>
  <action>
Integrate outcome mapping into the editor flow:

1. Update TargetMarketPanel:
   - Add outcomes state: OutcomeFormItem[]
   - When mode='extend' and existing mapping loaded: populate from existingMapping.outcomeMapping
   - When mode='create': call suggestOutcomes(sourceMarket.sampleOutcomes, sourceMarket.source) to auto-populate
   - Render OutcomeMappingTable below the form fields
   - Add "Auto-Suggest" button that re-runs suggestOutcomes if user wants to reset

2. Update editor/index.tsx:
   - Lift outcome state if needed for submit (may need to hoist form state to editor level)
   - Ensure form state + outcome state are available for Plan 04 submit

3. UX flow:
   - User navigates to editor with unmapped market
   - Chooses "Create New" or selects existing
   - If create: outcomes auto-suggested from sample_outcomes
   - User can edit suggestions, add/remove outcomes
   - Form + outcomes ready for preview/submit in Plan 04

Add visual indicator when outcomes are auto-suggested vs manually entered.
  </action>
  <verify>npm run build passes, auto-suggest populates outcomes on create mode, existing mapping outcomes load on extend mode</verify>
  <done>Outcome mapping integrated with auto-suggest, full editing capability in place</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Auto-suggest generates reasonable canonical IDs from sample outcomes
- [ ] Outcome table allows add/remove/edit/reorder
- [ ] Extend mode loads existing outcome mappings
- [ ] Create mode auto-suggests from source market
- [ ] Platform-specific fields highlighted appropriately
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Outcome mapping editor fully functional with auto-suggest
</success_criteria>

<output>
After completion, create `.planning/phases/104-mapping-editor/104-03-SUMMARY.md`
</output>
