---
phase: 45-handicap-mapping
plan: 01
type: execute
---

<objective>
Fix handicap market mapping for both SportyBet and Bet9ja - add missing handicap mappings and verify spread values are correctly extracted.

Purpose: Improve market mapping success rate for handicap-type markets identified in Phase 43 audit.
Output: Updated mappings in market_ids.py and bet9ja.py, verified with tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 43 Audit Findings:**
@.planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md

**Prior Phase 44 (related fixes):**
@.planning/phases/44-high-priority-market-mappings/44-03-SUMMARY.md

**Key source files:**
@src/market_mapping/mappers/bet9ja.py
@src/market_mapping/mappers/sportybet.py
@src/market_mapping/mappings/market_ids.py
@src/market_mapping/utils/specifier_parser.py

**Target markets from audit:**

Bet9ja unmapped handicap markets:
- HNDCORNER (76 occurrences) - UNKNOWN_MARKET - likely 3-Way Corner Handicap
- CAH2 (76 occurrences) - UNKNOWN_MARKET - unknown
- CAHH (74 occurrences) - UNKNOWN_MARKET - unknown
- CAH (52 occurrences) - UNKNOWN_MARKET - unknown
- CAH1 (3 occurrences) - UNKNOWN_MARKET - unknown

SportyBet unmapped handicap markets:
- 900312 (35 occurrences) - UNKNOWN_MARKET - Bookings Handicap

**Existing handicap implementations (VERIFIED WORKING):**
- Bet9ja: BET9JA_HANDICAP_KEYS = {AH, AH1T, AH2T, 1X2HND, 1X2HNDHT, 1X2HND2TN, AHCORNERS, AHCORNERS1T}
- SportyBet: HANDICAP_MARKET_IDS = {14, 16, 65, 66, 87, 88, 165, 176}
- **DB verification:** ~490K handicap records with correct spread values (100% have handicap_home populated)

**Handicap handling patterns:**
- Asian (2-way): S_{KEY}@{value}_{1|2} - home/away spread from param
- European (3-way): S_{KEY}@{value}_{1H|XH|2H} - home/draw/away with spread from param

**Note:** The "not correctly mapped" issue is specifically about the UNMAPPED markets above (CAH*, HNDCORNER, 900312), not the existing AH/1X2HND which are working correctly.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research CAH/HNDCORNER market structure from raw API data</name>
  <files>
    - src/scripts/research_handicap_markets.py (create)
    - .planning/phases/45-handicap-mapping/handicap-research.md (create)
  </files>
  <action>
Create a script to extract and analyze CAH and HNDCORNER markets from raw Bet9ja API responses:

1. Query CompetitorOddsSnapshot for BET9JA source with raw_response
2. Extract all keys matching S_CAH*, S_HNDCORNER* patterns
3. For each market type, collect:
   - Sample key formats (e.g., S_CAH@-1_1, S_HNDCORNER@2_1H)
   - Outcome suffix patterns (1, 2 for Asian; 1H, XH, 2H for European)
   - Parameter ranges (spread values seen)
4. Determine if each market:
   - Is Asian (2-way) or European (3-way)
   - Has a corresponding BetPawa market we can map to
   - Needs new mapping or just needs to be added to BET9JA_HANDICAP_KEYS

Write findings to handicap-research.md with:
- Each market's key format
- Outcome structure
- Whether it maps to existing BetPawa market
- Recommended action (add mapping, add to HANDICAP_KEYS, skip)

**Key insight:** CAH likely = Card Asian Handicap (booking points), HNDCORNER likely = 3-Way Handicap Corners
  </action>
  <verify>
python src/scripts/research_handicap_markets.py runs without error
handicap-research.md contains findings for all target markets
  </verify>
  <done>
- Research script created and run
- All target markets analyzed
- Clear mapping recommendations documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confirmed handicap mappings</name>
  <files>
    - src/market_mapping/mappings/market_ids.py
    - src/market_mapping/mappers/bet9ja.py
    - src/market_mapping/mappers/sportybet.py (if SportyBet Bookings Handicap needed)
    - tests/test_bet9ja_mapper.py
  </files>
  <action>
Based on Task 1 research, add mappings for confirmed markets:

**For Bet9ja:**
1. If HNDCORNER is 3-Way Corner Handicap:
   - Add MarketMapping for corner_3way_handicap_ft (if BetPawa has it)
   - Add "HNDCORNER" to BET9JA_HANDICAP_KEYS
   - Outcomes: 1H, XH, 2H (like 1X2HND)

2. If CAH* are Card Asian Handicap (bookings):
   - Add MarketMapping for bookings_asian_handicap_ft
   - Add "CAH" to BET9JA_HANDICAP_KEYS
   - Similar patterns for CAHH, CAH1, CAH2

**For SportyBet:**
1. Add 900312 (Bookings Handicap) to HANDICAP_MARKET_IDS if appropriate
2. Add MarketMapping if BetPawa equivalent exists

**Skip if:**
- No corresponding BetPawa market (would be UNSUPPORTED_PLATFORM)
- Market structure too different to map reliably

**Add tests:**
- Test each new handicap mapping extracts spread values correctly
- Verify outcome mapping for both Asian (2-way) and European (3-way) variants
  </action>
  <verify>
pytest tests/test_bet9ja_mapper.py -v -k "handicap" passes
pytest tests/test_sportybet_mapper.py -v -k "handicap" passes (if SportyBet changes made)
New mappings verified with actual API data structure
  </verify>
  <done>
- Confirmed handicap markets added to mappings
- New markets added to BET9JA_HANDICAP_KEYS
- Tests added and passing for new handicap types
  </done>
</task>

<task type="auto">
  <name>Task 3: Run end-to-end test with newly mapped markets</name>
  <files>
    - src/scripts/verify_handicap_mappings.py (create)
  </files>
  <action>
Create a script to verify the newly added handicap mappings work end-to-end:

**Pre-verified:** Existing markets (AH, 1X2HND, AHCORNERS) already confirmed working with ~490K records storing correct spread values.

**New verification needed:**

1. For each newly mapped market (HNDCORNER, CAH*, 900312 if added):
   - Find raw API data containing that market
   - Run through map_bet9ja_market_to_betpawa() or map_sportybet_to_betpawa()
   - Verify MappedMarket has correct:
     - betpawa_market_id
     - handicap.type (asian or european)
     - handicap.home/away values matching the param

2. Print summary:
   - Each new market key
   - Whether mapping succeeded
   - Sample handicap values extracted

**If any market cannot be mapped to a BetPawa equivalent:**
- Document as UNSUPPORTED_PLATFORM (expected - not all competitor markets exist on BetPawa)
- Don't add to mapping if no BetPawa ID exists
  </action>
  <verify>
python src/scripts/verify_handicap_mappings.py shows all newly added markets map correctly
Handicap values extracted match raw API params
  </verify>
  <done>
- Verification script created and run
- All added handicap mappings produce correct MappedMarket objects
- Unmappable markets documented with reason
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Research findings documented in handicap-research.md
- [ ] All confirmed mappings added to market_ids.py
- [ ] BET9JA_HANDICAP_KEYS updated with new market keys
- [ ] Tests added for new handicap mappings
- [ ] pytest tests/test_bet9ja_mapper.py passes
- [ ] Spread values verified in database
</verification>

<success_criteria>
- All mappable handicap markets from audit now have mappings
- Handicap spread values correctly extracted and stored
- Test coverage for handicap mapping includes new markets
- Remaining unmapped markets documented as UNSUPPORTED (no BetPawa equivalent)
</success_criteria>

<output>
After completion, create `.planning/phases/45-handicap-mapping/45-01-SUMMARY.md`
</output>
