---
phase: 45-handicap-mapping
plan: 01
type: execute
---

<objective>
Fix handicap market mapping for both SportyBet and Bet9ja - add missing handicap mappings and verify spread values are correctly extracted.

Purpose: Improve market mapping success rate for handicap-type markets identified in Phase 43 audit.
Output: Updated mappings in market_ids.py and bet9ja.py, verified with tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 43 Audit Findings:**
@.planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md

**Prior Phase 44 (related fixes):**
@.planning/phases/44-high-priority-market-mappings/44-03-SUMMARY.md

**Key source files:**
@src/market_mapping/mappers/bet9ja.py
@src/market_mapping/mappers/sportybet.py
@src/market_mapping/mappings/market_ids.py
@src/market_mapping/utils/specifier_parser.py

**Target markets from audit:**

Bet9ja unmapped handicap markets:
- HNDCORNER (76 occurrences) - UNKNOWN_MARKET - likely 3-Way Corner Handicap
- CAH2 (76 occurrences) - UNKNOWN_MARKET - unknown
- CAHH (74 occurrences) - UNKNOWN_MARKET - unknown
- CAH (52 occurrences) - UNKNOWN_MARKET - unknown
- CAH1 (3 occurrences) - UNKNOWN_MARKET - unknown

SportyBet unmapped handicap markets:
- 900312 (35 occurrences) - UNKNOWN_MARKET - Bookings Handicap

**Existing handicap implementations:**
- Bet9ja: BET9JA_HANDICAP_KEYS = {AH, AH1T, AH2T, 1X2HND, 1X2HNDHT, 1X2HND2TN, AHCORNERS, AHCORNERS1T}
- SportyBet: HANDICAP_MARKET_IDS = {14, 16, 65, 66, 87, 88, 165, 176}

**Handicap handling patterns:**
- Asian (2-way): S_{KEY}@{value}_{1|2} - home/away spread from param
- European (3-way): S_{KEY}@{value}_{1H|XH|2H} - home/draw/away with spread from param
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research CAH/HNDCORNER market structure from raw API data</name>
  <files>
    - src/scripts/research_handicap_markets.py (create)
    - .planning/phases/45-handicap-mapping/handicap-research.md (create)
  </files>
  <action>
Create a script to extract and analyze CAH and HNDCORNER markets from raw Bet9ja API responses:

1. Query CompetitorOddsSnapshot for BET9JA source with raw_response
2. Extract all keys matching S_CAH*, S_HNDCORNER* patterns
3. For each market type, collect:
   - Sample key formats (e.g., S_CAH@-1_1, S_HNDCORNER@2_1H)
   - Outcome suffix patterns (1, 2 for Asian; 1H, XH, 2H for European)
   - Parameter ranges (spread values seen)
4. Determine if each market:
   - Is Asian (2-way) or European (3-way)
   - Has a corresponding BetPawa market we can map to
   - Needs new mapping or just needs to be added to BET9JA_HANDICAP_KEYS

Write findings to handicap-research.md with:
- Each market's key format
- Outcome structure
- Whether it maps to existing BetPawa market
- Recommended action (add mapping, add to HANDICAP_KEYS, skip)

**Key insight:** CAH likely = Card Asian Handicap (booking points), HNDCORNER likely = 3-Way Handicap Corners
  </action>
  <verify>
python src/scripts/research_handicap_markets.py runs without error
handicap-research.md contains findings for all target markets
  </verify>
  <done>
- Research script created and run
- All target markets analyzed
- Clear mapping recommendations documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confirmed handicap mappings</name>
  <files>
    - src/market_mapping/mappings/market_ids.py
    - src/market_mapping/mappers/bet9ja.py
    - src/market_mapping/mappers/sportybet.py (if SportyBet Bookings Handicap needed)
    - tests/test_bet9ja_mapper.py
  </files>
  <action>
Based on Task 1 research, add mappings for confirmed markets:

**For Bet9ja:**
1. If HNDCORNER is 3-Way Corner Handicap:
   - Add MarketMapping for corner_3way_handicap_ft (if BetPawa has it)
   - Add "HNDCORNER" to BET9JA_HANDICAP_KEYS
   - Outcomes: 1H, XH, 2H (like 1X2HND)

2. If CAH* are Card Asian Handicap (bookings):
   - Add MarketMapping for bookings_asian_handicap_ft
   - Add "CAH" to BET9JA_HANDICAP_KEYS
   - Similar patterns for CAHH, CAH1, CAH2

**For SportyBet:**
1. Add 900312 (Bookings Handicap) to HANDICAP_MARKET_IDS if appropriate
2. Add MarketMapping if BetPawa equivalent exists

**Skip if:**
- No corresponding BetPawa market (would be UNSUPPORTED_PLATFORM)
- Market structure too different to map reliably

**Add tests:**
- Test each new handicap mapping extracts spread values correctly
- Verify outcome mapping for both Asian (2-way) and European (3-way) variants
  </action>
  <verify>
pytest tests/test_bet9ja_mapper.py -v -k "handicap" passes
pytest tests/test_sportybet_mapper.py -v -k "handicap" passes (if SportyBet changes made)
New mappings verified with actual API data structure
  </verify>
  <done>
- Confirmed handicap markets added to mappings
- New markets added to BET9JA_HANDICAP_KEYS
- Tests added and passing for new handicap types
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify spread values stored correctly in DB</name>
  <files>
    - src/scripts/verify_handicap_spreads.py (create)
  </files>
  <action>
Create verification script to confirm handicap spread values are correctly stored:

1. Query CompetitorMarketOdds for known handicap market IDs
2. Check that `handicap` field is populated (not null)
3. Verify handicap values are reasonable (e.g., -3 to +3 range for goals)
4. Sample check: compare raw API param with stored handicap.home value

**Check both:**
- Existing handicap markets (AH, 1X2HND, etc.)
- Newly added handicap markets (from Task 2)

Print summary:
- Total handicap markets in DB
- Percentage with valid handicap values
- Any markets missing spread values

If issues found, trace through:
1. Raw API -> parse_bet9ja_key() -> param extraction
2. _map_handicap_market() -> MappedHandicap creation
3. Storage in CompetitorMarketOdds.handicap field
  </action>
  <verify>
python src/scripts/verify_handicap_spreads.py shows >95% of handicap markets have valid spread values
No null handicap values for known handicap market types
  </verify>
  <done>
- Verification script created and run
- Spread values confirmed correctly stored
- Any issues documented for follow-up
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Research findings documented in handicap-research.md
- [ ] All confirmed mappings added to market_ids.py
- [ ] BET9JA_HANDICAP_KEYS updated with new market keys
- [ ] Tests added for new handicap mappings
- [ ] pytest tests/test_bet9ja_mapper.py passes
- [ ] Spread values verified in database
</verification>

<success_criteria>
- All mappable handicap markets from audit now have mappings
- Handicap spread values correctly extracted and stored
- Test coverage for handicap mapping includes new markets
- Remaining unmapped markets documented as UNSUPPORTED (no BetPawa equivalent)
</success_criteria>

<output>
After completion, create `.planning/phases/45-handicap-mapping/45-01-SUMMARY.md`
</output>
