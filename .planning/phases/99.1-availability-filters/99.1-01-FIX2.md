---
phase: 99.1-availability-filters
plan: 99.1-01-FIX2
type: fix
---

<objective>
Fix 2 UAT issues from plan 99.1-01.

Source: 99.1-01-ISSUES.md
Priority: 2 blockers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/99.1-availability-filters/99.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/99.1-availability-filters/99.1-01-PLAN.md

**Key Files:**
@src/api/routes/events.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix alerts filter to query only LATEST snapshots</name>
  <files>src/api/routes/events.py</files>
  <action>
The root cause of UAT-002 is that both the alerts count endpoint and the alerts filter query ALL historical snapshots instead of only the LATEST snapshot per event/bookmaker.

Fix the `/api/events/alerts/count` endpoint (around line 1059-1109):

1. Create a subquery to get the latest snapshot ID per event (like `_load_latest_snapshots_for_events` does):
   ```python
   # Subquery to get latest BetPawa snapshot ID per event
   latest_bp_snapshot_subq = (
       select(
           OddsSnapshot.event_id,
           func.max(OddsSnapshot.id).label("max_id"),
       )
       .group_by(OddsSnapshot.event_id)
       .subquery()
   )
   ```

2. Modify the BetPawa alerts query to join with this subquery:
   ```python
   bp_events_with_alerts = (
       select(OddsSnapshot.event_id)
       .join(
           latest_bp_snapshot_subq,
           (OddsSnapshot.event_id == latest_bp_snapshot_subq.c.event_id)
           & (OddsSnapshot.id == latest_bp_snapshot_subq.c.max_id),
       )
       .join(MarketOdds, MarketOdds.snapshot_id == OddsSnapshot.id)
       .join(Event, Event.id == OddsSnapshot.event_id)
       .where(
           MarketOdds.unavailable_at.isnot(None),
           Event.kickoff > now,
       )
       .distinct()
   )
   ```

3. Similarly fix the competitor markets query - get latest CompetitorOddsSnapshot per competitor_event_id:
   ```python
   latest_comp_snapshot_subq = (
       select(
           CompetitorOddsSnapshot.competitor_event_id,
           func.max(CompetitorOddsSnapshot.id).label("max_id"),
       )
       .group_by(CompetitorOddsSnapshot.competitor_event_id)
       .subquery()
   )

   comp_events_with_alerts = (
       select(CompetitorEvent.betpawa_event_id)
       .join(
           CompetitorOddsSnapshot,
           CompetitorOddsSnapshot.competitor_event_id == CompetitorEvent.id,
       )
       .join(
           latest_comp_snapshot_subq,
           (CompetitorOddsSnapshot.competitor_event_id == latest_comp_snapshot_subq.c.competitor_event_id)
           & (CompetitorOddsSnapshot.id == latest_comp_snapshot_subq.c.max_id),
       )
       .join(
           CompetitorMarketOdds,
           CompetitorMarketOdds.snapshot_id == CompetitorOddsSnapshot.id,
       )
       .join(Event, Event.id == CompetitorEvent.betpawa_event_id)
       .where(
           CompetitorMarketOdds.unavailable_at.isnot(None),
           CompetitorEvent.betpawa_event_id.isnot(None),
           Event.kickoff > now,
       )
       .distinct()
   )
   ```

4. Apply the SAME fix to the alerts filter in `list_events` (around line 1425-1466) - the logic is currently duplicated.

This ensures only the CURRENT availability state is checked, not historical data.
  </action>
  <verify>
1. Start the backend: `python -m uvicorn src.api.main:app --port 8001`
2. Call the alerts count endpoint: `curl "http://localhost:8001/api/events/alerts/count"`
3. Verify count reflects only CURRENT unavailable markets, not historical
4. Call the alerts filter: `curl "http://localhost:8001/api/events?availability=alerts&page_size=5"`
5. Verify returned events have actually unavailable markets in their LATEST snapshot
  </verify>
  <done>
- Alerts count endpoint queries only latest snapshot per event
- Alerts filter in list_events queries only latest snapshot per event
- Events with historically unavailable (but now available) markets no longer appear
- Only events with CURRENTLY unavailable markets are returned
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Alerts count reflects only current availability state
- [ ] Alerts filter returns only events with currently unavailable markets
- [ ] Clicking on a filtered event shows actual unavailable markets (strikethrough dashes)
</verification>

<success_criteria>
- UAT-002 resolved: Alerts filter only shows events with CURRENTLY unavailable markets
- No regressions to other availability modes
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/99.1-availability-filters/99.1-01-FIX2-SUMMARY.md`
</output>
