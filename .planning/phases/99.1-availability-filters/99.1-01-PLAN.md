---
phase: 99.1-availability-filters
plan: 01
type: execute
---

<objective>
Add "Alerts" toggle to Odds Comparison page that filters to show only events with availability issues.

Purpose: Enable quick visibility into events where bookmakers have unavailable markets, building foundation for future alerting system.
Output: Working "Alerts" toggle with count badge, filtering events with any unavailable markets.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99.1-availability-filters/99.1-CONTEXT.md

**Prior Phase:**
@.planning/phases/99-availability-tracking-fix/99-01-FIX2-SUMMARY.md

**Key Files:**
@web/src/features/matches/index.tsx
@web/src/features/matches/components/match-filters.tsx
@src/api/routes/events.py

**Tech stack available:** React, TanStack Query, shadcn/ui, FastAPI, SQLAlchemy
**Established patterns:**
- Toggle group UI pattern (index.tsx lines 136-163)
- Per-mode filter state pattern (index.tsx lines 44-51)
- `availability` query parameter in events API (events.py line 1063)
- `unavailable_at` field on market models for availability tracking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alerts filter to events API</name>
  <files>src/api/routes/events.py, src/matching/schemas.py</files>
  <action>
Extend the events list endpoint to support `availability='alerts'` mode:

1. In `list_events` function (line 1059), extend the `availability` Literal type to include 'alerts':
   ```python
   availability: Literal["betpawa", "competitor", "alerts"] = Query(...)
   ```

2. When `availability == "alerts"`:
   - Query BetPawa events that have at least one market with `unavailable_at IS NOT NULL`
   - Use a subquery to check MarketOdds.unavailable_at on the latest snapshot
   - Also include events where competitor markets are unavailable (check CompetitorMarketOdds.unavailable_at)
   - Return combined results (events where ANY bookmaker has unavailable markets)

3. Add `/api/events/alerts/count` endpoint to return just the count of events with availability issues:
   ```python
   @router.get("/alerts/count")
   async def get_alerts_count(request: Request, db: AsyncSession = Depends(get_db)) -> dict:
       # Count events with unavailable markets
       # Return {"count": N}
   ```

Implementation details:
- For BetPawa: Join Event -> OddsSnapshot (latest) -> MarketOdds where unavailable_at IS NOT NULL
- For competitors: Join CompetitorEvent -> CompetitorOddsSnapshot (latest) -> CompetitorMarketOdds where unavailable_at IS NOT NULL
- Deduplicate by event ID (an event may have multiple unavailable markets)
- Reuse existing time filters (exclude started events by default)
  </action>
  <verify>
curl "http://localhost:8000/api/events?availability=alerts" returns events with unavailable markets
curl "http://localhost:8000/api/events/alerts/count" returns {"count": N}
  </verify>
  <done>
- `availability='alerts'` returns only events with unavailable markets
- `/alerts/count` endpoint returns count without full event data
- Existing `availability='betpawa'` and `availability='competitor'` modes unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Alerts toggle with count badge to frontend</name>
  <files>web/src/features/matches/index.tsx, web/src/features/matches/hooks/use-matches.ts</files>
  <action>
Add "Alerts" as third toggle option in the Odds Comparison page:

1. Extend `MatchFiltersState.availability` type (match-filters.tsx line 88):
   ```typescript
   availability: 'betpawa' | 'competitor' | 'alerts'
   ```

2. Add hook to fetch alerts count (new file or extend use-matches.ts):
   ```typescript
   export function useAlertsCount() {
     return useQuery({
       queryKey: ['alerts', 'count'],
       queryFn: async () => {
         const res = await fetch('/api/events/alerts/count')
         return res.json() as Promise<{ count: number }>
       },
       refetchInterval: 30000, // Refresh every 30s
     })
   }
   ```

3. In MatchList component (index.tsx), add alerts mode state and toggle:
   - Add `alertsFilters` state alongside `betpawaFilters` and `competitorFilters`
   - Extend `currentMode` type: `'betpawa' | 'competitor' | 'alerts'`
   - Add "Alerts" button to toggle group (after "Competitors Only")
   - Show count badge on Alerts button: "Alerts (12)" when count > 0
   - Use same toggle group styling pattern

4. Update `handleModeSwitch` to support alerts mode.

5. Pass `availability: 'alerts'` to useMatches when in alerts mode.

Toggle UI example:
```tsx
<Button
  type="button"
  variant="ghost"
  size="sm"
  className={cn(
    'h-7 px-3 text-xs font-medium',
    currentMode === 'alerts' && 'bg-background text-foreground shadow-sm'
  )}
  onClick={() => handleModeSwitch('alerts')}
>
  Alerts {alertsCount > 0 && `(${alertsCount})`}
</Button>
```
  </action>
  <verify>
- npm run dev
- Visit Odds Comparison page
- See three toggles: "BetPawa", "Competitors Only", "Alerts (N)"
- Click "Alerts" toggle shows only events with unavailable markets
- Count badge updates when alerts exist
  </verify>
  <done>
- "Alerts" toggle appears alongside existing toggles
- Count badge shows number of events with availability issues
- Toggle filters table to show only affected events
- Each mode maintains independent filter state
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Alerts toggle visible and functional
- [ ] Count badge shows correct number
- [ ] Alerts mode shows only events with unavailable markets
- [ ] Switching between all three modes works correctly
- [ ] Backend returns correct filtered results
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- "Alerts" toggle functional with count badge
- Filter correctly shows events with any unavailable markets
- No regressions to existing BetPawa/Competitor modes
</success_criteria>

<output>
After completion, create `.planning/phases/99.1-availability-filters/99.1-01-SUMMARY.md`
</output>
