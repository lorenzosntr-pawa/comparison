---
phase: 43-market-mapping-audit
plan: 01
type: execute
---

<objective>
Comprehensive audit of market mapping across all 3 bookmakers to identify all unmapped and incorrectly mapped markets.

Purpose: Systematically discover ALL market mapping gaps so subsequent fix phases address real issues, not hypothetical ones.
Output: AUDIT-FINDINGS.md with categorized unmapped markets, statistics, and prioritized fix recommendations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-investigation-matching-audit/34-01-SUMMARY.md

**Prior related work:**
- Phase 34 established SQL-based audit methodology pattern
- ISS-002 documented that ~108 basic market mappings exist, many fail to map

**Key files:**
@src/market_mapping/mappings/market_ids.py
@src/market_mapping/mappers/sportybet.py
@src/market_mapping/mappers/bet9ja.py
@src/scraping/event_coordinator.py

**Tech stack available:**
- EventCoordinator for parallel scraping per event
- MappingError with error codes (UNKNOWN_MARKET, UNSUPPORTED_PLATFORM, etc.)
- PostgreSQL with competitor_events, competitor_odds_snapshots tables

**Constraining decisions:**
- Phase 34: SQL-based audit methodology established for data quality investigations
- Phase 42: Event-centric parallel scraping as default architecture
</context>

<tasks>

<task type="auto">
  <name>Task 1: Select diverse events and fetch raw market data</name>
  <files>src/scripts/audit_market_mapping.py</files>
  <action>
Create audit script that:
1. Query DB for 50+ events with good coverage (events that have data from all 3 platforms)
2. Prioritize diversity: different tournaments, leagues, countries
3. For each event, extract raw market data from stored odds snapshots:
   - BetPawa: Use OddsSnapshot.raw_response (JSON with all markets)
   - SportyBet: Use CompetitorOddsSnapshot.raw_response
   - Bet9ja: Use CompetitorOddsSnapshot.raw_response
4. Also fetch fresh from API for a subset (~10 events) to verify stored data matches live

Store in structured format for analysis: event_id, platform, raw_markets list.

Use existing DB models and scraping clients. Do NOT create new tables.
  </action>
  <verify>Script runs without error, outputs stats: "Collected X events with Y total markets across platforms"</verify>
  <done>50+ events collected with raw market data from at least 2 platforms each</done>
</task>

<task type="auto">
  <name>Task 2: Run mapping analysis with full error capture</name>
  <files>src/scripts/audit_market_mapping.py</files>
  <action>
Extend audit script to:
1. For each collected event/platform, attempt to map every market:
   - SportyBet: call map_sportybet_to_betpawa() for each market
   - Bet9ja: call map_bet9ja_market_to_betpawa() for each market/param/outcomes group
2. Capture ALL MappingError instances with full context:
   - error.code (UNKNOWN_MARKET, UNSUPPORTED_PLATFORM, NO_MATCHING_OUTCOMES, etc.)
   - error.context (market_id, market_desc, param, outcome_descs)
   - source platform
3. Track statistics:
   - Total markets attempted per platform
   - Successfully mapped count
   - Failed by error code
   - Unique unmapped market IDs with frequency counts
4. Group unmapped markets by inferred category (from market name/desc):
   - Corners, Cards, Player Props, Specials, etc.

Output intermediate JSON for analysis.
  </action>
  <verify>Script outputs: "Mapping analysis complete: X/Y SportyBet mapped, A/B Bet9ja mapped, Z unmapped unique market types"</verify>
  <done>Full mapping statistics captured, unmapped markets identified with frequency and categorization</done>
</task>

<task type="auto">
  <name>Task 3: Generate categorized audit report</name>
  <files>.planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md</files>
  <action>
Generate comprehensive audit report with:

## Executive Summary
- Total events analyzed
- Overall mapping success rate per platform
- Count of unique unmapped market types

## Current Coverage (What Works)
- List of 108 currently mapped market categories
- Mapping success rate by category

## Unmapped Markets by Category
For each category (Corners, Cards, Player Props, etc.):
- Market IDs and names from each platform
- Frequency (how many events have this market)
- Cross-platform availability (which platforms offer it)
- Priority recommendation (High/Medium/Low based on frequency)

## Incorrectly Mapped Markets
If any markets map to wrong outcomes or have outcome mismatches:
- Document the specific issues
- Provide fix recommendations

## Prioritized Fix Recommendations
- Phase 44+ suggestions based on findings
- Ordered by impact (frequency Ã— platforms)

Include actual market IDs and names from the audit data. NO hypotheticals - only document what the audit found.
  </action>
  <verify>cat .planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md shows structured report with real data</verify>
  <done>AUDIT-FINDINGS.md exists with categorized unmapped markets, statistics, and prioritized recommendations</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Audit script exists at src/scripts/audit_market_mapping.py
- [ ] At least 50 events analyzed from stored data
- [ ] AUDIT-FINDINGS.md contains real audit data, not placeholders
- [ ] Unmapped markets are categorized with frequency counts
- [ ] Fix recommendations are prioritized by impact
</verification>

<success_criteria>

- All 3 tasks completed
- AUDIT-FINDINGS.md documents real mapping gaps found in data
- Clear categorization of unmapped markets (Corners, Cards, etc.)
- Prioritized list enables informed planning of Phase 44+
- No guessing - findings based on actual audit data
</success_criteria>

<output>
After completion, create `.planning/phases/43-market-mapping-audit/43-01-SUMMARY.md` following summary-frontmatter.md template with:
- Actual statistics from audit
- Key findings (top unmapped categories)
- Recommended next phases based on findings
</output>
