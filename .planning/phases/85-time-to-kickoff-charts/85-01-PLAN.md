---
phase: 85-time-to-kickoff-charts
plan: 01
type: execute
---

<objective>
Enhance the tournament markets data hook with time-to-kickoff calculations and create a chart component with normalized X-axis showing time buckets.

Purpose: Enable visualization of margin patterns relative to kickoff time across events, making patterns comparable.
Output: Extended TournamentMarket interface with opening/closing margins and TimeToKickoffChart component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-time-to-kickoff-charts/85-CONTEXT.md
@.planning/phases/84.2-tournament-detail-page/84.2-01-FIX-SUMMARY.md

**Phase goal from CONTEXT.md:**
- X-axis: time-to-kickoff (normalized: -72h, -24h, -1h, etc.)
- Time bucket zones: 7+ days, 3-7 days, 24-72h, <24h
- Tournament average line per market
- Summary: openingâ†’closing margin + delta

**Key existing files:**
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
@web/src/features/matches/components/margin-line-chart.tsx

**Established patterns:**
- TournamentMarket interface with marginHistory array
- recharts LineChart with ReferenceArea for zones
- getMarketKey(id, line) for unique market identification
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance useTournamentMarkets with time-to-kickoff data</name>
  <files>web/src/features/historical-analysis/hooks/use-tournament-markets.ts</files>
  <action>
Extend the TournamentMarket interface and data computation:

1. Add new fields to TournamentMarket interface:
   - `openingMargin: number` - first margin data point (earliest captured_at)
   - `closingMargin: number` - last margin data point (closest to kickoff)
   - `marginDelta: number` - closingMargin - openingMargin

2. Replace MarginHistoryPoint with TimeToKickoffPoint:
   ```typescript
   interface TimeToKickoffPoint {
     hoursToKickoff: number  // negative values: -72, -24, -1, etc.
     margin: number
     eventId: number  // track which event for potential drill-down
   }
   ```

3. In the data extraction loop:
   - Track kickoff time for each event from eventDetail.kickoff
   - For each margin point, compute `hoursToKickoff = (capturedAt - kickoffTime) / (1000 * 60 * 60)`
   - This will produce negative values (e.g., -72 hours before kickoff)

4. After aggregation:
   - Sort marginHistory by hoursToKickoff (most negative first = earliest)
   - openingMargin = marginHistory[0].margin (earliest point)
   - closingMargin = marginHistory[marginHistory.length - 1].margin (latest/closest to kickoff)
   - marginDelta = closingMargin - openingMargin

5. Add per-bucket statistics:
   ```typescript
   interface BucketStats {
     bucket: '7d+' | '3-7d' | '24-72h' | '<24h'
     avgMargin: number
     pointCount: number
   }
   ```
   Add `bucketStats: BucketStats[]` to TournamentMarket.

   Bucket boundaries:
   - 7d+: hoursToKickoff <= -168 (7 * 24)
   - 3-7d: hoursToKickoff <= -72 && > -168
   - 24-72h: hoursToKickoff <= -24 && > -72
   - <24h: hoursToKickoff > -24

Keep backward compatibility: marginHistory still uses the interface expected by existing chart.
  </action>
  <verify>TypeScript compiles with no errors: `cd web && npx tsc --noEmit`</verify>
  <done>TournamentMarket has openingMargin, closingMargin, marginDelta, and bucketStats. marginHistory points have hoursToKickoff field.</done>
</task>

<task type="auto">
  <name>Task 2: Create TimeToKickoffChart component</name>
  <files>web/src/features/historical-analysis/components/time-to-kickoff-chart.tsx, web/src/features/historical-analysis/components/index.ts</files>
  <action>
Create a new chart component optimized for time-to-kickoff visualization:

1. Create `time-to-kickoff-chart.tsx`:
   ```typescript
   interface TimeToKickoffChartProps {
     data: TimeToKickoffPoint[]
     height?: number
     showBucketZones?: boolean  // default true
   }
   ```

2. X-axis configuration:
   - dataKey: hoursToKickoff
   - domain: [min(hoursToKickoff), 0] (left = earliest, right = kickoff)
   - tickFormatter: format as "-7d", "-3d", "-24h", "-1h", "KO" for 0
   - reversed: false (most negative on left)

3. Time bucket zones using ReferenceArea:
   - 7d+ zone: x1={min}, x2={-168}, fill="#f0f9ff" (light blue), fillOpacity={0.3}
   - 3-7d zone: x1={-168}, x2={-72}, fill="#fef3c7" (light yellow), fillOpacity={0.3}
   - 24-72h zone: x1={-72}, x2={-24}, fill="#fef9c3" (lighter yellow), fillOpacity={0.3}
   - <24h zone: x1={-24}, x2={0}, fill="#fee2e2" (light red), fillOpacity={0.3}

   Add subtle divider lines at bucket boundaries using ReferenceLine at x={-168}, x={-72}, x={-24}.

4. Line styling:
   - Single line for tournament average
   - stroke="#3b82f6" (blue)
   - strokeWidth={2}
   - dot={false} for cleaner look with many points

5. Tooltip:
   - Show hours-to-kickoff formatted nicely: "-3d 12h" or "-6h"
   - Show margin value: "5.2%"

6. Export from components/index.ts.

Use existing patterns from margin-line-chart.tsx (ResponsiveContainer, CartesianGrid, formatting).
  </action>
  <verify>`cd web && npx tsc --noEmit` passes</verify>
  <done>TimeToKickoffChart renders with normalized X-axis showing hours-to-kickoff and visual time bucket zones.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] TournamentMarket interface has openingMargin, closingMargin, marginDelta
- [ ] marginHistory points have hoursToKickoff computed from kickoff time
- [ ] TimeToKickoffChart component exists and exports
- [ ] Bucket zones render as shaded areas on chart
</verification>

<success_criteria>

- All tasks completed
- TypeScript compiles without errors
- Data hook computes time-to-kickoff for all margin points
- Chart component ready for use in dialog (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/85-time-to-kickoff-charts/85-01-SUMMARY.md`
</output>
