---
phase: 85-time-to-kickoff-charts
plan: 02
type: execute
---

<objective>
Create TimelineDialog component and integrate into TournamentDetailPage with opening/closing margin display on cards and timeline access buttons.

Purpose: Move timeline visualization to on-demand dialog and enhance market cards with margin direction insight.
Output: TimelineDialog component, updated market cards with opening→closing, page-level and card-level timeline access.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/85-time-to-kickoff-charts/85-CONTEXT.md
@.planning/phases/85-time-to-kickoff-charts/85-01-SUMMARY.md

**Phase goal from CONTEXT.md:**
- Timeline chart moves to dialog, keeps main page cleaner
- Dialog shows: time-to-kickoff chart, summary stats (opening→closing + delta), per-bucket breakdown
- Two access points: market card button, page-level button
- Market cards show opening→closing for main 4 markets (1X2, O/U 2.5, BTTS, DC)

**Available from Plan 01:**
- TournamentMarket with openingMargin, closingMargin, marginDelta, bucketStats
- marginHistory with hoursToKickoff points
- TimeToKickoffChart component

**Key existing files:**
@web/src/features/historical-analysis/tournament-detail.tsx
@web/src/features/matches/components/history-dialog.tsx (dialog pattern reference)

**Established patterns:**
- Dialog, DialogContent, DialogHeader, DialogTitle from shadcn/ui
- TRACKED_MARKETS constant for main 4 markets
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimelineDialog with summary stats</name>
  <files>web/src/features/historical-analysis/components/timeline-dialog.tsx, web/src/features/historical-analysis/components/index.ts</files>
  <action>
Create TimelineDialog component following HistoryDialog patterns:

1. Create `timeline-dialog.tsx`:
   ```typescript
   interface TimelineDialogProps {
     open: boolean
     onOpenChange: (open: boolean) => void
     market: TournamentMarket | null
     tournamentName: string
     // For multi-market mode (page-level access)
     allMarkets?: TournamentMarket[]
   }
   ```

2. Dialog structure:
   - DialogHeader: Market name (or "All Markets" for page-level)
   - Summary stats section at top:
     ```
     Opening: 4.8%  →  Closing: 5.2%  (Δ +0.4%)
     ```
     Style delta: green if negative (margin improved), red if positive (margin worsened)

3. Per-bucket breakdown below summary:
   ```
   Time Bucket    Avg Margin    Points
   7+ days        4.6%          12
   3-7 days       4.9%          28
   24-72h         5.1%          45
   <24h           5.2%          18
   ```
   Use a simple table or grid layout. Highlight the bucket with largest change.

4. TimeToKickoffChart below stats (from Plan 01):
   - Pass market.marginHistory (now with hoursToKickoff)
   - height={300}
   - showBucketZones={true}

5. Multi-market mode (when allMarkets provided):
   - Add Select/tabs at top to switch between markets
   - Default to first market
   - Switching market updates all stats and chart

6. Export from components/index.ts.

Use shadcn Dialog, Card, Table components. Follow HistoryDialog error boundary pattern if chart fails.
  </action>
  <verify>`cd web && npx tsc --noEmit` passes</verify>
  <done>TimelineDialog renders with summary stats header, bucket breakdown table, and TimeToKickoffChart.</done>
</task>

<task type="auto">
  <name>Task 2: Update TournamentDetailPage with timeline integration</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx</files>
  <action>
Update TournamentDetailPage to use the new dialog-based approach:

1. Import TimelineDialog and necessary UI components (Button with LineChart icon).

2. Add state for dialog:
   ```typescript
   const [timelineOpen, setTimelineOpen] = useState(false)
   const [timelineMarket, setTimelineMarket] = useState<TournamentMarket | null>(null)
   ```

3. Update MarketCard component:
   - For tracked markets (1X2, O/U 2.5, BTTS, DC - check by market.id against TRACKED_MARKETS):
     - Show opening→closing with delta:
       ```
       Opening: 4.8%  →  5.2%  (Δ +0.4%)
       ```
     - Style delta with color indicator
   - For all markets: show existing avgMargin, range, eventCount
   - Add small "Timeline" button (LineChart icon) at card bottom
   - onClick opens TimelineDialog for that specific market

4. Remove the inline timeline section (the Card at the bottom that appears on card click).
   Replace with dialog-based approach.

5. Add page-level "View All Timelines" button:
   - Place near search filter or in header area
   - Opens TimelineDialog with allMarkets prop (multi-market mode)
   - Icon: LineChart or similar

6. Clicking a market card:
   - OLD: selectedMarket state + inline chart
   - NEW: Opens TimelineDialog for that market
   - Remove selectedMarket state and related code

7. Wire up TimelineDialog at bottom of component JSX.

Keep: search filter, market cards grid, loading/error/empty states.
Remove: inline timeline Card section.
  </action>
  <verify>`cd web && npm run build` succeeds</verify>
  <done>Market cards show opening→closing for tracked markets, timeline button opens dialog, page-level timeline button works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Time-to-kickoff timeline system with dialog, bucket zones, and market card enhancements</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Navigate to Historical Analysis page
    3. Select a tournament with events and click "View Details"
    4. Verify market cards:
       - Cards show Opening → Closing with delta (colored)
       - Each card has a small "Timeline" button
    5. Click Timeline button on a market card:
       - Dialog opens with market name in header
       - Summary stats show opening/closing/delta at top
       - Bucket breakdown table shows 4 time periods
       - Chart shows time-to-kickoff X-axis (negative hours, 0 = kickoff)
       - Chart has shaded bucket zones (different colors for each period)
    6. Click page-level "View All Timelines" button:
       - Dialog opens in multi-market mode
       - Can switch between markets
    7. Verify X-axis labels: should show -7d, -3d, -24h, etc. not absolute timestamps
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] TimelineDialog component exists with stats header and bucket table
- [ ] Market cards show opening→closing delta for tracked markets
- [ ] Card-level Timeline button opens dialog
- [ ] Page-level button opens multi-market dialog
- [ ] Inline timeline section removed from page
- [ ] Chart X-axis shows hours-to-kickoff, not absolute time
</verification>

<success_criteria>

- All tasks completed
- Build passes without errors
- Timeline moved from inline to dialog
- Both access methods work (card button, page button)
- Phase 85 complete
</success_criteria>

<output>
After completion, create `.planning/phases/85-time-to-kickoff-charts/85-02-SUMMARY.md`
</output>
