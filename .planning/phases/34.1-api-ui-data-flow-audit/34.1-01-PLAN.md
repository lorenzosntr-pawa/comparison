---
phase: 34.1-api-ui-data-flow-audit
plan: 01
type: execute
---

<objective>
Trace data flow from database through API to frontend, identify exactly where data accuracy degrades.

Purpose: The backend matching system is 99.9% accurate (confirmed Phase 34), but frontend displays incorrect/stale data. This forensic investigation pinpoints the root cause(s) in the API query logic or frontend state management.

Output: Comprehensive audit report documenting all discrepancies with actionable fix paths for Phase 35+.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-api-ui-data-flow-audit/34.1-CONTEXT.md
@.planning/phases/34-investigation-matching-audit/34-01-SUMMARY.md
@.planning/phases/34-investigation-matching-audit/AUDIT-FINDINGS.md
@.planning/phases/34-investigation-matching-audit/34-01-ISSUES.md

# Key API files to audit:
@src/api/routes/events.py
@src/api/routes/palimpsest.py

# Key frontend files to audit:
@web/src/features/matches/index.tsx
@web/src/features/coverage/index.tsx
@web/src/lib/api.ts

**Affected pages per UAT-001:**
- Odds Comparison page (matches feature)
- Coverage page

**Symptoms observed:**
- Wrong odds values displayed
- Missing matches that should appear
- Stale data not refreshing
- Wrong coverage matching and mapping

**Key constraint:** Backend matching is 99.9% accurate — problem is downstream (API query logic or frontend).
</context>

<tasks>

<task type="auto">
  <name>Task 1: API Query Logic Audit</name>
  <files>src/api/routes/events.py, src/api/routes/palimpsest.py</files>
  <action>
Read and analyze the API endpoint code for:
1. `/events` endpoint in events.py — understand how it queries matched events, joins odds data, handles filtering
2. `/palimpsest/coverage` and `/palimpsest/events` in palimpsest.py — understand coverage stats and event listing queries

For each endpoint:
- Trace the SQLAlchemy query logic
- Identify any filtering that might exclude valid matches
- Check how odds data is joined/aggregated
- Check how "matched" vs "unmatched" is determined

Run direct SQL queries against the database to compare with API responses:
```sql
-- Example comparisons:
-- Count matched events via raw SQL vs what API returns
-- Check specific events that appear/don't appear
-- Verify odds values for specific matches
```

Document specific discrepancies found between SQL truth and API responses.
  </action>
  <verify>SQL queries executed successfully, API endpoint logic documented, discrepancies (if any) identified</verify>
  <done>API query logic fully audited, SQL vs API comparison complete, any query-level bugs documented</done>
</task>

<task type="auto">
  <name>Task 2: Frontend Data Flow Audit</name>
  <files>web/src/features/matches/index.tsx, web/src/features/coverage/index.tsx, web/src/lib/api.ts, web/src/types/api.ts</files>
  <action>
Audit the frontend data handling for both affected pages:

**Matches (Odds Comparison) page:**
1. Read web/src/features/matches/index.tsx and child components
2. Check how data is fetched (React Query hooks, polling intervals)
3. Verify data transformation before display
4. Check for any client-side filtering that might hide valid data

**Coverage page:**
1. Read web/src/features/coverage/index.tsx and child components
2. Same analysis: fetching, transformation, filtering

**Cross-cutting concerns:**
- Check React Query configuration (staleTime, cacheTime, refetchInterval)
- Check if there's client-side state that might get out of sync
- Check type definitions in api.ts — any mismatches that could cause display issues?
- Check for any computed values that might be calculated incorrectly

Document specific frontend issues found.
  </action>
  <verify>Frontend feature code fully read, React Query configuration documented, any client-side issues identified</verify>
  <done>Frontend data flow fully audited, caching/state issues (if any) documented</done>
</task>

<task type="auto">
  <name>Task 3: Create Audit Findings Report</name>
  <files>.planning/phases/34.1-api-ui-data-flow-audit/AUDIT-FINDINGS.md</files>
  <action>
Consolidate all findings into a structured audit report:

## Report Structure:
1. **Executive Summary** — Key findings in 2-3 sentences
2. **API Layer Findings** — Each issue with:
   - Location (file:line)
   - Description of the bug/issue
   - Evidence (SQL vs API comparison)
   - Impact (which symptoms it explains)
   - Fix approach (for Phase 35+)
3. **Frontend Layer Findings** — Same structure
4. **Root Cause Analysis** — Map each UAT symptom to its root cause(s)
5. **Recommended Fix Order** — Prioritized list for Phase 35+

Be specific: include code locations, exact values that differ, and concrete fix suggestions.

Close UAT-001 in 34-01-ISSUES.md if root cause is fully identified.
  </action>
  <verify>AUDIT-FINDINGS.md created with all findings documented, UAT-001 resolved or updated</verify>
  <done>Comprehensive audit report complete, clear fix path documented for Phase 35+</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Both API endpoints (events.py, palimpsest.py) fully audited
- [ ] Both frontend features (matches, coverage) fully audited
- [ ] SQL vs API comparisons documented
- [ ] All discrepancies identified with evidence
- [ ] Root causes mapped to UAT symptoms
- [ ] Fix paths documented for Phase 35+
</verification>

<success_criteria>
- All tasks completed
- AUDIT-FINDINGS.md created with specific, actionable findings
- Each finding includes: location, description, evidence, impact, fix approach
- UAT-001 root cause identified (or investigation blocked with reason)
- Clear handoff to Phase 35+ for remediation
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-api-ui-data-flow-audit/34.1-01-SUMMARY.md`:

# Phase 34.1 Plan 01: API/UI Data Flow Audit Summary

**[Substantive one-liner about what was discovered]**

## Accomplishments

- [Key finding 1]
- [Key finding 2]

## Files Created/Modified

- `.planning/phases/34.1-api-ui-data-flow-audit/AUDIT-FINDINGS.md` - Full audit report

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[What Phase 35+ needs to address based on findings]
</output>
