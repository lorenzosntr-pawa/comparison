---
phase: 07.2-scraping-performance
plan: 03
type: execute
---

<objective>
Implement enhanced scrape runs UI with detailed run information, history page, and run detail view.

Purpose: Provide full visibility into scraping operations â€” what happened, how long it took, per-platform breakdown.
Output: Enhanced RecentRuns widget, ScrapeRuns history page, ScrapeRunDetail page with per-platform breakdown.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-scraping-performance/07.2-CONTEXT.md

# Key source files:
@web/src/features/dashboard/components/recent-runs.tsx
@web/src/features/dashboard/hooks/use-scheduler.ts
@web/src/components/layout/app-layout.tsx
@src/api/routes/scrape.py
@src/api/schemas/scheduler.py

**Patterns established:**
- Feature pages in features/{name}/index.tsx
- Feature hooks in features/{name}/hooks/
- Feature components in features/{name}/components/
- shadcn/ui components for UI elements
- TanStack Query for data fetching

**From CONTEXT.md vision:**
- Enhanced dashboard widget linking to full history
- ScrapeRuns page: stats at top, run list below
- Run detail: per-platform breakdown, timing, errors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scrape runs history API endpoint</name>
  <files>src/api/routes/scrape.py, src/api/schemas/scheduler.py</files>
  <action>
1. In `src/api/schemas/scheduler.py`, enhance ScrapeRunResponse to include platform_timings:
   ```python
   class ScrapeRunResponse(BaseModel):
       id: int
       status: str
       started_at: datetime
       completed_at: datetime | None
       events_scraped: int
       events_failed: int
       trigger: str | None
       platform_timings: dict | None = None  # {"betpawa": {"duration_ms": N, "events_count": M}, ...}
   ```

2. In `src/api/routes/scrape.py`, add paginated history endpoint:
   ```python
   @router.get("", response_model=list[ScrapeRunResponse])
   async def list_scrape_runs(
       db: AsyncSession = Depends(get_db),
       limit: int = Query(default=20, ge=1, le=100),
       offset: int = Query(default=0, ge=0),
   ) -> list[ScrapeRunResponse]:
       """List scrape runs with pagination.

       Returns most recent runs first, including platform timing breakdown.
       """
       result = await db.execute(
           select(ScrapeRun)
           .order_by(ScrapeRun.started_at.desc())
           .offset(offset)
           .limit(limit)
       )
       runs = result.scalars().all()

       return [
           ScrapeRunResponse(
               id=run.id,
               status=run.status,
               started_at=run.started_at,
               completed_at=run.completed_at,
               events_scraped=run.events_scraped,
               events_failed=run.events_failed,
               trigger=run.trigger,
               platform_timings=run.platform_timings,
           )
           for run in runs
       ]
   ```

3. Add stats summary endpoint:
   ```python
   @router.get("/stats")
   async def get_scrape_stats(db: AsyncSession = Depends(get_db)):
       """Get scrape run statistics."""
       from sqlalchemy import func

       # Total runs
       total_result = await db.execute(select(func.count(ScrapeRun.id)))
       total_runs = total_result.scalar() or 0

       # Last 24 hours
       from datetime import timedelta
       cutoff = datetime.utcnow() - timedelta(hours=24)
       recent_result = await db.execute(
           select(func.count(ScrapeRun.id)).where(ScrapeRun.started_at > cutoff)
       )
       runs_24h = recent_result.scalar() or 0

       # Average duration (completed runs only)
       avg_result = await db.execute(
           select(func.avg(
               func.extract('epoch', ScrapeRun.completed_at - ScrapeRun.started_at)
           )).where(
               ScrapeRun.completed_at.isnot(None)
           )
       )
       avg_duration_seconds = avg_result.scalar()

       return {
           "total_runs": total_runs,
           "runs_24h": runs_24h,
           "avg_duration_seconds": round(avg_duration_seconds, 1) if avg_duration_seconds else None,
       }
   ```

Place `/stats` route BEFORE the `/{scrape_run_id}` route (specific before parameterized).
  </action>
  <verify>
1. Test stats: `curl http://localhost:8000/api/scrape/stats`
2. Test list: `curl http://localhost:8000/api/scrape?limit=5`
3. Both should return JSON without errors
  </verify>
  <done>
- GET /api/scrape returns paginated list of runs with platform_timings
- GET /api/scrape/stats returns total_runs, runs_24h, avg_duration_seconds
- ScrapeRunResponse includes platform_timings field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ScrapeRuns page and enhance RecentRuns widget</name>
  <files>web/src/features/scrape-runs/index.tsx, web/src/features/scrape-runs/hooks/use-scrape-runs.ts, web/src/features/scrape-runs/components/runs-table.tsx, web/src/features/scrape-runs/components/stats-summary.tsx, web/src/features/dashboard/components/recent-runs.tsx, web/src/components/layout/app-layout.tsx, web/src/App.tsx</files>
  <action>
1. Create `web/src/features/scrape-runs/hooks/use-scrape-runs.ts`:
   ```typescript
   import { useQuery } from '@tanstack/react-query'
   import { api } from '@/lib/api'

   interface ScrapeRun {
     id: number
     status: string
     started_at: string
     completed_at: string | null
     events_scraped: number
     events_failed: number
     trigger: string | null
     platform_timings: Record<string, { duration_ms: number; events_count: number }> | null
   }

   interface ScrapeStats {
     total_runs: number
     runs_24h: number
     avg_duration_seconds: number | null
   }

   export function useScrapeRuns(limit = 20, offset = 0) {
     return useQuery({
       queryKey: ['scrape-runs', limit, offset],
       queryFn: () => api.get<ScrapeRun[]>(`/scrape?limit=${limit}&offset=${offset}`),
       staleTime: 30_000,
     })
   }

   export function useScrapeStats() {
     return useQuery({
       queryKey: ['scrape-stats'],
       queryFn: () => api.get<ScrapeStats>('/scrape/stats'),
       staleTime: 60_000,
     })
   }
   ```

2. Create `web/src/features/scrape-runs/hooks/index.ts` to export hooks.

3. Create `web/src/features/scrape-runs/components/stats-summary.tsx`:
   - Display cards: Total Runs, Runs (24h), Avg Duration
   - Use shadcn Card component
   - Handle loading/error states

4. Create `web/src/features/scrape-runs/components/runs-table.tsx`:
   - Table with columns: Time, Status, Duration, Events, Trigger, Platform Breakdown
   - Platform breakdown shows per-platform events/timing as expandable or inline chips
   - Status badge with color coding (completed=green, partial=yellow, failed=red)
   - Click row to navigate to detail page (Link to /scrape-runs/{id})

5. Create `web/src/features/scrape-runs/components/index.ts` to export components.

6. Create `web/src/features/scrape-runs/index.tsx`:
   ```typescript
   export function ScrapeRunsPage() {
     return (
       <div className="space-y-6">
         <div>
           <h1 className="text-2xl font-bold">Scrape Runs</h1>
           <p className="text-muted-foreground">Scraping history and performance</p>
         </div>
         <StatsSummary />
         <RunsTable />
       </div>
     )
   }
   ```

7. Update `web/src/features/dashboard/components/recent-runs.tsx`:
   - Add "View All" link to /scrape-runs in card header
   - Show platform timing breakdown inline if available
   - Calculate and display duration (completed_at - started_at)

8. Add route to `web/src/App.tsx`:
   ```typescript
   import { ScrapeRunsPage } from '@/features/scrape-runs'
   // In routes:
   { path: 'scrape-runs', element: <ScrapeRunsPage /> }
   ```

9. Add nav item to `web/src/components/layout/app-layout.tsx` sidebar:
   - Add "Scrape Runs" with Activity icon under Dashboard

Use shadcn/ui components: Card, Table, Badge, Button.
Use formatDistanceToNow from date-fns for relative times.
Calculate duration: (new Date(completed_at) - new Date(started_at)) / 1000
  </action>
  <verify>
1. Build check: `cd web && pnpm build`
2. Navigate to /scrape-runs - should show stats and run history
3. Dashboard RecentRuns should have "View All" link
4. Click a run row to navigate to detail page (will be 404 until Task 3)
  </verify>
  <done>
- ScrapeRunsPage shows stats cards and runs table
- Runs table shows duration, events, platform breakdown
- RecentRuns widget enhanced with View All link and duration
- Navigation added to sidebar
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ScrapeRuns page with stats and history table, enhanced RecentRuns widget</what-built>
  <how-to-verify>
    1. Run backend: `cd src && python -m uvicorn api.main:app --reload`
    2. Run frontend: `cd web && pnpm dev`
    3. Visit http://localhost:5173
    4. Check Dashboard: RecentRuns widget should show "View All" link and duration per run
    5. Click "View All" or navigate to /scrape-runs
    6. Verify: Stats cards at top (Total Runs, Runs 24h, Avg Duration)
    7. Verify: Runs table with Status, Duration, Events columns
    8. Verify: Platform breakdown visible (if timing data exists)
    9. Trigger a scrape and refresh - new run should appear
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create ScrapeRunDetail page</name>
  <files>web/src/features/scrape-runs/[id].tsx, web/src/features/scrape-runs/hooks/use-scrape-run-detail.ts, web/src/features/scrape-runs/components/platform-breakdown.tsx, web/src/features/scrape-runs/components/error-list.tsx, web/src/App.tsx</files>
  <action>
1. Add scrape run detail endpoint to backend (if not exists) in `src/api/routes/scrape.py`:
   - The existing `/{scrape_run_id}` endpoint should include platform_timings
   - Add errors list to response by loading scrape_run.errors relationship

2. Create `web/src/features/scrape-runs/hooks/use-scrape-run-detail.ts`:
   ```typescript
   export function useScrapeRunDetail(id: number) {
     return useQuery({
       queryKey: ['scrape-run', id],
       queryFn: () => api.get<ScrapeRunDetail>(`/scrape/${id}`),
       staleTime: 60_000,
     })
   }
   ```

3. Create `web/src/features/scrape-runs/components/platform-breakdown.tsx`:
   - Card showing each platform's stats
   - Duration bar visualization (proportion of total time)
   - Events count and success indicator

4. Create `web/src/features/scrape-runs/components/error-list.tsx`:
   - Table of errors for this run (if any)
   - Columns: Platform, Error Type, Message, Time

5. Create `web/src/features/scrape-runs/[id].tsx`:
   ```typescript
   import { useParams } from 'react-router'

   export function ScrapeRunDetailPage() {
     const { id } = useParams<{ id: string }>()
     const { data, isPending, error } = useScrapeRunDetail(Number(id))

     return (
       <div className="space-y-6">
         <div className="flex items-center gap-4">
           <Button variant="ghost" size="sm" asChild>
             <Link to="/scrape-runs"><ArrowLeft /> Back</Link>
           </Button>
           <div>
             <h1 className="text-2xl font-bold">Scrape Run #{id}</h1>
             <p className="text-muted-foreground">
               {formatDistanceToNow(new Date(data?.started_at))} ago
             </p>
           </div>
         </div>

         {/* Summary Card */}
         <Card>
           <CardHeader><CardTitle>Summary</CardTitle></CardHeader>
           <CardContent>
             Status badge, total events, duration, trigger
           </CardContent>
         </Card>

         {/* Platform Breakdown */}
         <PlatformBreakdown timings={data?.platform_timings} />

         {/* Errors (if any) */}
         {data?.errors?.length > 0 && <ErrorList errors={data.errors} />}
       </div>
     )
   }
   ```

6. Add route to `web/src/App.tsx`:
   ```typescript
   { path: 'scrape-runs/:id', element: <ScrapeRunDetailPage /> }
   ```

7. Update runs-table.tsx to make rows clickable links to detail page.
  </action>
  <verify>
1. Build: `cd web && pnpm build`
2. Navigate to /scrape-runs/{id} for an existing run
3. Should show: summary card, platform breakdown, errors (if any)
4. Back button should return to /scrape-runs
  </verify>
  <done>
- ScrapeRunDetailPage shows complete run information
- Platform breakdown shows per-platform timing and events
- Error list shows any errors that occurred
- Navigation from runs table to detail page works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete scrape runs UI with history page and detail view</what-built>
  <how-to-verify>
    1. Ensure backend and frontend are running
    2. Trigger a scrape: `curl -X POST http://localhost:8000/api/scrape`
    3. Navigate to /scrape-runs
    4. Click on the most recent run row
    5. Verify detail page shows:
       - Summary card with status, duration, total events
       - Platform breakdown showing each platform's timing and events
       - Back button returns to /scrape-runs
    6. From dashboard, verify RecentRuns "View All" link works
    7. Verify the complete flow feels cohesive
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GET /api/scrape returns paginated run list
- [ ] GET /api/scrape/stats returns statistics
- [ ] ScrapeRunsPage displays stats and history table
- [ ] ScrapeRunDetailPage shows per-platform breakdown
- [ ] Dashboard RecentRuns links to full history
- [ ] All navigation works correctly
- [ ] `pnpm build` succeeds
</verification>

<success_criteria>

- Scrape run history visible in dedicated page with stats
- Individual run detail shows per-platform breakdown
- Dashboard widget enhanced with link to full history
- User can understand exactly what happened in each scrape run
- Phase 7.2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-scraping-performance/07.2-03-SUMMARY.md`:

# Phase 7.2 Plan 3: Frontend Scrape Runs UI Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 7.2 complete, ready for Phase 7 Plan 3: Match Detail View (07-03-PLAN.md)
</output>
