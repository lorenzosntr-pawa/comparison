---
phase: 84-tournament-summary-metrics
plan: 01
type: execute
---

<objective>
Add summary metrics to tournament cards in the historical analysis page.

Purpose: Enable traders to quickly assess tournament-level margin competitiveness and coverage without drilling down.
Output: Tournament cards displaying average margin, bookmaker coverage percentages, and trend indicators.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 83 Summary (foundation we're building on):
@.planning/phases/83-historical-analysis-page/83-01-SUMMARY.md

# Current implementation files:
@web/src/features/historical-analysis/index.tsx
@web/src/features/historical-analysis/hooks/use-tournaments.ts
@web/src/features/historical-analysis/components/tournament-list.tsx

# API types (InlineOdds contains margin data):
@web/src/types/api.ts

**Key context from Phase 83:**
- useTournaments hook fetches events via api.getEvents() and extracts unique tournaments
- Events have `bookmakers` array with `inline_odds` containing calculated `margin` per market
- TournamentCard is clickable placeholder for future drill-down
- Cards currently show: name, country, eventCount

**Available data in each event:**
- `bookmakers[]` with `bookmaker_slug`, `has_odds`, `inline_odds[]`
- Each `inline_odds` has `margin` (calculated bookmaker margin %)
- Can determine coverage by checking which bookmakers have `has_odds: true`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useTournaments hook with metrics calculation</name>
  <files>web/src/features/historical-analysis/hooks/use-tournaments.ts</files>
  <action>
Extend the hook to calculate tournament-level metrics from events data:

1. **Update TournamentWithCount interface** to add:
   - `avgMargin: number | null` - average 1X2 margin across all events (Betpawa)
   - `competitorAvgMargin: number | null` - average competitor 1X2 margin (SportyBet/Bet9ja best)
   - `coverageByBookmaker: Record<string, number>` - % of events with odds from each bookmaker
   - `trend: 'up' | 'down' | 'stable' | null` - margin trend indicator

2. **Calculate metrics during tournament extraction:**
   - For each event, extract Betpawa 1X2 margin from `inline_odds` (market_id "3743")
   - Calculate competitor best margin (lowest of sportybet/bet9ja)
   - Track which bookmakers have `has_odds: true` per event
   - After grouping, compute averages per tournament

3. **Trend calculation:**
   - Sort events by kickoff within tournament
   - Compare first-half avg margin to second-half avg margin
   - If second-half is lower by >0.5%, trend is 'down' (improving)
   - If second-half is higher by >0.5%, trend is 'up' (worsening)
   - Otherwise 'stable'
   - Minimum 4 events required for trend, else null

4. **Sort tournaments** by Betpawa avgMargin (ascending - best margins first), with null values last.

Avoid: Creating a separate API call for metrics - compute from existing events data to minimize API calls.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd web && npx tsc --noEmit
```
Hook returns tournaments with all new fields populated.
  </verify>
  <done>
useTournaments returns TournamentWithCount[] with avgMargin, competitorAvgMargin, coverageByBookmaker, and trend fields calculated from events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TournamentCard to display metrics</name>
  <files>web/src/features/historical-analysis/components/tournament-list.tsx</files>
  <action>
Update TournamentCard to show new tournament metrics:

1. **Layout restructure:**
   - Keep name and country at top
   - Add metrics row below with: margin comparison, coverage, trend
   - Keep event count badge

2. **Margin display:**
   - Show Betpawa margin with colored badge (green if < competitor, red if > competitor)
   - Format as "BP: X.X%" with comparison delta if competitor data available
   - Use MarginIndicator pattern from existing codebase if available, else create inline

3. **Coverage bar:**
   - Small horizontal bar showing coverage for each bookmaker
   - Three segments: betpawa (blue), sportybet (green), bet9ja (orange)
   - Width proportional to coverage % (0-100%)
   - Tooltip showing exact percentages

4. **Trend indicator:**
   - Small arrow icon: up (red), down (green), stable (gray dash)
   - Position next to margin
   - Null trend shows no indicator

5. **Handle null values gracefully:**
   - If avgMargin is null, show "â€”" instead
   - If coverageByBookmaker empty, hide coverage bar
   - If trend null, hide trend indicator

Use existing Tailwind utilities and shadcn components. Match existing card styling.
  </action>
  <verify>
1. Run dev server: `cd web && npm run dev`
2. Navigate to Historical Analysis page
3. Verify tournament cards show:
   - Margin with comparison color
   - Coverage bar with all three bookmakers
   - Trend arrow where applicable
4. TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>
Tournament cards display avgMargin (colored), coverage bar, and trend indicator. All metrics calculated from events. Layout matches design system.
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] Historical Analysis page loads tournament list with metrics
- [ ] Margins show colored comparison (green when better, red when worse)
- [ ] Coverage bars render for all tournaments with data
- [ ] Trend arrows display for tournaments with sufficient events
- [ ] Null/missing data handled gracefully (no crashes, clean display)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Tournament cards show avg margin, coverage, and trend
- Margin comparison colors correct (Betpawa green when lower than competitors)
- Coverage bar proportional to actual coverage %
- Trend calculation correct based on time-ordered event margins
</success_criteria>

<output>
After completion, create `.planning/phases/84-tournament-summary-metrics/84-01-SUMMARY.md`:

# Phase 84 Plan 01: Tournament Summary Metrics Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 84 complete, ready for Phase 85: Time-to-Kickoff Charts
</output>
