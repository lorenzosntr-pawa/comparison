# Phase 110.1-01: Dual-Query History API (BUG-028 Fix)

## Overview

Fix the historical data regression introduced in v2.9 by updating the history API to query BOTH the new `market_odds_history` table AND the legacy `odds_snapshots` + `market_odds` tables, then UNION the results.

## Problem

Phase 109 updated `src/api/routes/history.py` to only query `MarketOddsHistory`, but:
1. No data migration was performed from legacy tables
2. All pre-v2.9 historical data is orphaned in `odds_snapshots` + `market_odds`
3. History dialogs show empty charts for events scraped before Phase 107

## Solution: Dual-Query Approach

Modify `get_odds_history()` and `get_margin_history()` to:
1. Query new `market_odds_history` table (post-v2.9 data)
2. Query legacy `odds_snapshots` + `market_odds` tables (pre-v2.9 data)
3. UNION results with consistent response schema
4. Order by captured_at for chronological charts

## Files to Modify

### 1. `src/api/routes/history.py`

**get_odds_history():**
```python
# Query 1: New market_odds_history
new_data = await db.execute(
    select(MarketOddsHistory)
    .where(...)
)

# Query 2: Legacy odds_snapshots + market_odds
# BetPawa path
if bookmaker_slug == "betpawa":
    legacy_data = await db.execute(
        select(MarketOdds, OddsSnapshot.captured_at)
        .join(OddsSnapshot, MarketOdds.snapshot_id == OddsSnapshot.id)
        .join(Event, OddsSnapshot.event_id == Event.id)
        .where(Event.id == event_id)
        .where(MarketOdds.betpawa_market_id == market_id)
        .where(...)  # time filters
    )
else:
    # Competitor path
    legacy_data = await db.execute(
        select(CompetitorMarketOdds, CompetitorOddsSnapshot.captured_at)
        .join(CompetitorOddsSnapshot, ...)
        .join(CompetitorEvent, ...)
        .where(...)
    )

# Combine results
all_points = []
for row in new_data.scalars().all():
    all_points.append(OddsHistoryPoint(...))
for row in legacy_data.all():
    all_points.append(OddsHistoryPoint(...))

# Sort by captured_at
all_points.sort(key=lambda p: p.captured_at)
```

**get_margin_history():** Same dual-query approach

## Implementation Steps

1. [x] Add imports for legacy models (OddsSnapshot, MarketOdds, CompetitorOddsSnapshot, CompetitorMarketOdds, Event, CompetitorEvent)
2. [x] Create helper function `_query_legacy_betpawa_history()` for BetPawa
3. [x] Create helper function `_query_legacy_competitor_history()` for competitors
4. [x] Update `get_odds_history()` to call both new + legacy queries
5. [x] Update `get_margin_history()` to call both new + legacy queries
6. [x] Ensure deduplication if same timestamp exists in both sources
7. [ ] Test with events that have pre-v2.9 + post-v2.9 data

## Verification

1. Open history dialog for event scraped BEFORE v2.9 — should show data
2. Open history dialog for event scraped AFTER v2.9 — should show data
3. Open history dialog for event spanning migration — should show continuous timeline
4. Check margin history similarly

## Notes

- No database schema changes required
- No Alembic migration required
- Legacy tables remain untouched (still needed for cleanup)
- Performance: two queries instead of one, but acceptable for history dialogs
