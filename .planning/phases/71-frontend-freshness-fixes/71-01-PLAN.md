---
phase: 71-frontend-freshness-fixes
plan: 01
type: execute
---

<objective>
Enable real-time odds updates in the frontend by subscribing to WebSocket odds_update messages.

Purpose: Phase 70 fixed the backend to return accurate freshness timestamps. This phase connects the frontend to the existing WebSocket infrastructure so timestamps update in real-time without waiting for the 60-second polling interval.

Output: Frontend receives odds_update messages and invalidates queries immediately, resulting in real-time timestamp updates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/69-investigation-freshness-audit/69-01-SUMMARY.md
@.planning/phases/70-backend-freshness-fixes/70-01-SUMMARY.md
@.planning/phases/69-investigation-freshness-audit/FRESHNESS-AUDIT.md

# Relevant source files:
@web/src/hooks/use-websocket.ts
@web/src/hooks/use-websocket-scrape-progress.ts
@web/src/hooks/index.ts

# Key patterns established:
# - WebSocket hook pattern: useWebSocket() with topics array, onMessage callback
# - Query invalidation on events: queryClient.invalidateQueries({ queryKey: ['events'] })
# - Hook exports: Named exports from hooks/index.ts

**Issues being addressed from FRESHNESS-AUDIT.md:**
- Issue #3 (HIGH): Frontend doesn't subscribe to `odds_updates` topic
- Issue #4 (HIGH): No query invalidation on odds_update messages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useOddsUpdates hook</name>
  <files>web/src/hooks/use-odds-updates.ts, web/src/hooks/index.ts</files>
  <action>
Create a new hook `useOddsUpdates()` that subscribes to the `odds_updates` WebSocket topic and invalidates queries when odds change.

1. Create `use-odds-updates.ts`:
   - Import `useWebSocket` from `./use-websocket`
   - Import `useQueryClient` from `@tanstack/react-query`
   - Define interface for odds_update message data (matches backend broadcast):
     ```typescript
     interface OddsUpdateData {
       event_id: number
       bookmaker: string
       snapshot_id: number
       snapshot_time: string
     }
     ```
   - Create hook that:
     - Subscribes to `['odds_updates']` topic
     - On message with `type === 'odds_update'`, invalidate:
       - `['events']` - for list views (Odds Comparison page)
       - `['event', event_id]` - for detail view (Event Details page)
     - Return `{ isConnected }` for visibility

2. Update `index.ts`:
   - Add export for `useOddsUpdates` and `UseOddsUpdatesReturn`

Pattern note: Follow the same structure as `use-websocket-scrape-progress.ts` but simpler - no need for per-platform tracking, just query invalidation.
  </action>
  <verify>TypeScript compiles: `cd web && npm run typecheck`</verify>
  <done>Hook exists at use-odds-updates.ts, exports from index.ts, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Integrate useOddsUpdates into app</name>
  <files>web/src/App.tsx</files>
  <action>
Add `useOddsUpdates()` to the App component so it's active globally.

1. Import `useOddsUpdates` from `@/hooks`
2. Call the hook at the top level of App component (alongside other hooks if any)
3. No need to use the return value - the hook's side effect (query invalidation) is automatic

This ensures all pages benefit from real-time updates when WebSocket is connected.

Note: Keep existing polling as fallback - it handles WebSocket disconnections and initial page load.
  </action>
  <verify>
    1. Run dev server: `cd web && npm run dev`
    2. Open browser DevTools → Network → WS
    3. Verify WebSocket connects with `topics=odds_updates` (separate from scrape_progress)
    4. Wait for scrape cycle, verify `odds_update` messages appear in WS frames
    5. Verify TanStack Query DevTools shows query invalidation on odds_update
  </verify>
  <done>App.tsx imports and calls useOddsUpdates, WebSocket receives odds_update messages, queries invalidate on updates</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npm run typecheck` passes
- [ ] `cd web && npm run build` succeeds
- [ ] WebSocket connects with `odds_updates` topic
- [ ] Browser receives `odds_update` messages during scrape cycle
- [ ] Queries invalidate on odds_update (visible in TanStack Query DevTools)
- [ ] Timestamp in UI updates after scrape without manual refresh
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Real-time odds updates work end-to-end:
  1. Backend scrapes and caches new odds
  2. WebSocket broadcasts odds_update
  3. Frontend receives message and invalidates queries
  4. UI shows fresh timestamps immediately
</success_criteria>

<output>
After completion, create `.planning/phases/71-frontend-freshness-fixes/71-01-SUMMARY.md`:

# Phase 71 Plan 01: Frontend Freshness Fixes Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `web/src/hooks/use-odds-updates.ts` - New hook for odds update subscription
- `web/src/hooks/index.ts` - Added export
- `web/src/App.tsx` - Integrated hook

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, v2.2 milestone ready for verification
</output>
