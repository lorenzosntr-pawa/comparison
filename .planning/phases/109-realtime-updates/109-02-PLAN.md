---
phase: 109-realtime-updates
plan: 02
type: execute
---

<objective>
Add frontend real-time alert updates and sidebar badge.

Purpose: Enable instant UI updates when new alerts arrive and provide at-a-glance alert visibility in navigation.
Output: Risk Monitoring page auto-refreshes on new alerts, sidebar shows alert count badge.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/109-realtime-updates/109-01-SUMMARY.md

# Existing patterns:
@web/src/hooks/use-websocket.ts
@web/src/hooks/use-odds-updates.ts
@web/src/features/risk-monitoring/hooks/use-alerts.ts
@web/src/components/layout/app-sidebar.tsx

**Tech stack available:** TanStack Query v5, useWebSocket hook with topic subscriptions
**Established patterns:**
- useOddsUpdates subscribes to 'odds_updates' topic, invalidates queries on message
- Query keys: ['alerts', filters] for paginated alerts, ['alerts', 'stats'] for stats
- SidebarMenuBadge component for navigation badges
- mainNavItems and utilityNavItems arrays for navigation structure

**Prior decisions:**
- Phase 108: useAlerts, useAlertStats hooks created with proper query keys
- Alert stats includes newCount for badge display
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRiskAlertUpdates hook</name>
  <files>web/src/features/risk-monitoring/hooks/use-risk-alert-updates.ts, web/src/features/risk-monitoring/hooks/index.ts, web/src/App.tsx</files>
  <action>
1. Create use-risk-alert-updates.ts following useOddsUpdates pattern:
```typescript
/**
 * Real-time risk alert subscription hook.
 *
 * @module use-risk-alert-updates
 * @description Subscribes to real-time alert updates via WebSocket and automatically
 * invalidates TanStack Query caches when new alerts are detected.
 */

import { useCallback } from 'react'
import { useQueryClient } from '@tanstack/react-query'

import { useWebSocket, type WebSocketMessage } from '@/hooks/use-websocket'

/** Data payload for risk_alert WebSocket messages */
export interface RiskAlertUpdateData {
  alert_count: number
  event_ids: number[]
  severities: string[]
}

export interface UseRiskAlertUpdatesOptions {
  enabled?: boolean
}

export interface UseRiskAlertUpdatesReturn {
  isConnected: boolean
  reconnect: () => void
}

/**
 * Hook for subscribing to real-time risk alert updates via WebSocket.
 *
 * Cache invalidation:
 * - ['alerts'] - refreshes all alert queries (list + stats)
 */
export function useRiskAlertUpdates(
  options: UseRiskAlertUpdatesOptions = {}
): UseRiskAlertUpdatesReturn {
  const { enabled = true } = options

  const queryClient = useQueryClient()

  const handleMessage = useCallback(
    (message: WebSocketMessage<RiskAlertUpdateData>) => {
      if (message.type !== 'risk_alert') return

      console.log('[useRiskAlertUpdates] New alerts:', message.data.alert_count)

      // Invalidate all alert queries (list views and stats)
      queryClient.invalidateQueries({ queryKey: ['alerts'] })
    },
    [queryClient]
  )

  const handleReconnect = useCallback(() => {
    console.log('[useRiskAlertUpdates] Reconnected, invalidating queries')
    queryClient.invalidateQueries({ queryKey: ['alerts'] })
  }, [queryClient])

  const { state, reconnect } = useWebSocket<RiskAlertUpdateData>({
    topics: ['risk_alerts'],
    enabled,
    onMessage: handleMessage,
    onReconnect: handleReconnect,
  })

  return {
    isConnected: state === 'connected',
    reconnect,
  }
}
```

2. Update hooks/index.ts barrel export:
   - Add: export * from './use-risk-alert-updates'

3. In App.tsx:
   - Import useRiskAlertUpdates from '@/features/risk-monitoring/hooks'
   - Add hook call inside InnerApp component (alongside existing useOddsUpdates if present):
     ```typescript
     useRiskAlertUpdates()
     ```
   - This enables global alert subscription for all pages
  </action>
  <verify>grep -q "useRiskAlertUpdates" web/src/features/risk-monitoring/hooks/index.ts && grep -q "useRiskAlertUpdates" web/src/App.tsx</verify>
  <done>useRiskAlertUpdates hook created, exported, and called in App.tsx for global subscription</done>
</task>

<task type="auto">
  <name>Task 2: Add Risk Monitoring link with alert badge to sidebar</name>
  <files>web/src/components/layout/app-sidebar.tsx</files>
  <action>
1. Import additional components and hooks:
   - Add AlertTriangle from lucide-react (or ShieldAlert - pick appropriate icon)
   - Add SidebarMenuBadge from sidebar imports
   - Import useAlertStats from '@/features/risk-monitoring/hooks'

2. Add Risk Monitoring to mainNavItems array (after Historical Analysis):
   ```typescript
   { title: 'Risk Monitoring', url: '/risk-monitoring', icon: AlertTriangle },
   ```

3. Modify the sidebar navigation rendering to support badges:
   - In the mainNavItems.map section, add conditional badge for Risk Monitoring:
   ```tsx
   {mainNavItems.map((item) => (
     <SidebarMenuItem key={item.title}>
       <SidebarMenuButton
         asChild
         isActive={location.pathname === item.url}
         tooltip={item.title}
       >
         <NavLink to={item.url}>
           <item.icon />
           <span>{item.title}</span>
         </NavLink>
       </SidebarMenuButton>
       {/* Alert badge for Risk Monitoring */}
       {item.url === '/risk-monitoring' && newAlertCount > 0 && (
         <SidebarMenuBadge className="bg-red-500 text-white">
           {newAlertCount > 99 ? '99+' : newAlertCount}
         </SidebarMenuBadge>
       )}
     </SidebarMenuItem>
   ))}
   ```

4. Add alertStats query in AppSidebar component:
   ```typescript
   const { data: alertStats } = useAlertStats()
   const newAlertCount = alertStats?.byStatus?.new ?? 0
   ```

Note: The badge should show count of NEW (unacknowledged) alerts only, using byStatus.new from stats.
Use red background for visibility (bg-red-500 text-white).
  </action>
  <verify>grep -q "Risk Monitoring" web/src/components/layout/app-sidebar.tsx && grep -q "useAlertStats" web/src/components/layout/app-sidebar.tsx</verify>
  <done>Risk Monitoring appears in sidebar navigation with red badge showing new alert count</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Real-time alert updates and sidebar badge</what-built>
  <how-to-verify>
    1. Start dev servers: npm run dev (frontend) and uvicorn (backend)
    2. Open browser to http://localhost:5173
    3. Verify sidebar shows "Risk Monitoring" link under Analysis section
    4. If there are new alerts, verify red badge with count appears next to link
    5. Navigate to /risk-monitoring page
    6. Trigger a manual scrape (sidebar "Run Scrape" button)
    7. If alerts are detected during scrape, verify:
       - Alert list refreshes automatically (no manual page refresh needed)
       - Sidebar badge count updates
    8. Acknowledge some alerts and verify badge count decreases
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep "useRiskAlertUpdates" web/src/features/risk-monitoring/hooks/index.ts` shows export
- [ ] `grep "useRiskAlertUpdates" web/src/App.tsx` shows hook usage
- [ ] `grep "Risk Monitoring" web/src/components/layout/app-sidebar.tsx` shows nav item
- [ ] `grep "SidebarMenuBadge" web/src/components/layout/app-sidebar.tsx` shows badge usage
- [ ] `npm run build` succeeds without errors
</verification>

<success_criteria>

- useRiskAlertUpdates hook subscribes to risk_alerts topic
- Hook invalidates ['alerts'] queries on new alert messages
- Risk Monitoring link appears in sidebar navigation
- Badge shows new alert count (red, capped at 99+)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/109-realtime-updates/109-02-SUMMARY.md`:

# Phase 109 Plan 02: Frontend Real-Time Updates Summary

**Real-time alert subscription and sidebar badge for Risk Monitoring page**

## Accomplishments

- Created useRiskAlertUpdates hook for WebSocket subscription
- Added Risk Monitoring to sidebar navigation
- Implemented red badge showing new alert count

## Files Created/Modified

- `web/src/features/risk-monitoring/hooks/use-risk-alert-updates.ts` - WebSocket subscription hook
- `web/src/features/risk-monitoring/hooks/index.ts` - Added export
- `web/src/App.tsx` - Global hook subscription
- `web/src/components/layout/app-sidebar.tsx` - Navigation link and badge

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 110: Cross-Page Integration
</output>
