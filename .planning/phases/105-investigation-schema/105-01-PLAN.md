---
phase: 105-investigation-schema
plan: 01
type: execute
---

<objective>
Investigate alert detection patterns and design database schema for risk monitoring alerts.

Purpose: Establish the technical foundation for v2.9 Risk Monitoring by analyzing integration points, designing detection algorithms, and creating the database schema.
Output: DISCOVERY.md with detection algorithm design, database schema, and settings model changes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/105-investigation-schema/105-CONTEXT.md

# Key source files for understanding existing patterns:
@src/caching/change_detection.py
@src/caching/availability_detection.py
@src/caching/odds_cache.py
@src/db/models/settings.py
@src/scraping/event_coordinator.py

**From CONTEXT.md - Alert Types:**
1. Large % changes — Odds moved by X% within lookback window (default: 7%+)
2. Direction disagreement — BetPawa moved one way while competitors moved opposite
3. Availability changes — Market suspended/returned

**Severity Bands:**
- Yellow (warning): 7-10% change
- Orange (elevated): 10-15% change
- Red (critical): 15%+ change

**Tech Stack Available:**
- SQLAlchemy 2.0 async with Mapped[] columns
- Pydantic v2 frozen models
- structlog for logging
- Existing change_detection.py and availability_detection.py patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze detection integration and algorithm design</name>
  <files>.planning/phases/105-investigation-schema/DISCOVERY.md</files>
  <action>
    Analyze the scraping pipeline to determine:

    1. **Integration Point Analysis:**
       - Where in event_coordinator.py detection should occur
       - How change_detection.py's markets_changed() can be extended to calculate % changes
       - How to detect direction disagreement between Betpawa and competitors
       - How to reuse availability_detection.py for availability alerts

    2. **Algorithm Design:**
       - % Change calculation: ((new_odds - old_odds) / old_odds) * 100
       - Direction disagreement: Compare sign of change between Betpawa and each competitor for same market
       - Severity classification: Map % change to yellow/orange/red bands
       - Lookback window: Compare against previous cache state (already available in change_detection)

    3. **Detection Flow:**
       - During classify_batch_changes(), detect alerts alongside change classification
       - Pass detected alerts to write_handler for persistence
       - Fire WebSocket notification for real-time updates

    Document findings in DISCOVERY.md under "## Detection Algorithm Design" section.
  </action>
  <verify>DISCOVERY.md contains "## Detection Algorithm Design" with integration point, algorithm pseudocode, and data flow diagram</verify>
  <done>Detection algorithm fully documented with integration point, pseudocode for all 3 alert types, and data flow</done>
</task>

<task type="auto">
  <name>Task 2: Design database schema and settings model</name>
  <files>.planning/phases/105-investigation-schema/DISCOVERY.md</files>
  <action>
    Design the database schema following existing conventions (OddsSnapshot, StorageAlert patterns):

    1. **RiskAlert Table:**
       - id: BigInteger (high volume like odds_snapshots)
       - event_id: FK to events
       - bookmaker_slug: str (which bookmaker triggered alert)
       - market_id: str (betpawa_market_id)
       - market_name: str (human-readable)
       - line: Float | None (for specifier markets)
       - outcome_name: str | None (specific outcome if applicable)
       - alert_type: Enum (PRICE_CHANGE, DIRECTION_DISAGREEMENT, AVAILABILITY)
       - severity: Enum (WARNING, ELEVATED, CRITICAL)
       - change_percent: Float (absolute % change)
       - old_value: Float | None (previous odds)
       - new_value: Float | None (current odds)
       - competitor_direction: str | None (for disagreement: "up" or "down")
       - detected_at: DateTime (when alert was detected)
       - acknowledged_at: DateTime | None (when user acknowledged)
       - status: Enum (NEW, ACKNOWLEDGED, PAST)
       - event_kickoff: DateTime (for auto-moving to PAST)

    2. **Settings Model Additions:**
       - alert_enabled: bool (master toggle)
       - alert_threshold_warning: Float (default 7.0)
       - alert_threshold_elevated: Float (default 10.0)
       - alert_threshold_critical: Float (default 15.0)
       - alert_retention_days: int (default 7, separate from odds retention)
       - alert_lookback_minutes: int (default 60, comparison window)

    3. **Indexes:**
       - idx_risk_alerts_event (event_id, status) for event page badge queries
       - idx_risk_alerts_status_detected (status, detected_at DESC) for Risk Monitoring page
       - idx_risk_alerts_kickoff (event_kickoff) for auto-status transitions

    Document in DISCOVERY.md under "## Database Schema Design" with full SQLAlchemy model definitions.
  </action>
  <verify>DISCOVERY.md contains "## Database Schema Design" with complete RiskAlert model and Settings additions</verify>
  <done>Full schema documented with table definition, indexes, enums, and Settings model changes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DISCOVERY.md exists with all sections
- [ ] Detection algorithm documented with integration point and pseudocode
- [ ] Database schema complete with RiskAlert model and Settings additions
- [ ] Schema follows existing conventions (BigInteger IDs, DateTime, Mapped[] columns)
</verification>

<success_criteria>

- DISCOVERY.md contains Detection Algorithm Design section
- DISCOVERY.md contains Database Schema Design section
- All 3 alert types have documented detection logic
- Schema ready for implementation in Phase 106
</success_criteria>

<output>
After completion, create `.planning/phases/105-investigation-schema/105-01-SUMMARY.md`:

# Phase 105 Plan 01: Investigation & Schema Design Summary

**[One-liner summary of findings]**

## Accomplishments

- Detection algorithm designed for % changes, direction disagreement, and availability
- Database schema designed with RiskAlert table and Settings additions
- Integration point identified in event_coordinator.py

## Files Created/Modified

- `.planning/phases/105-investigation-schema/DISCOVERY.md` - Full technical design

## Decisions Made

[Key schema and algorithm decisions]

## Issues Encountered

[Any blockers or concerns discovered]

## Next Step

Ready for Phase 106: Backend Alert Detection
</output>
