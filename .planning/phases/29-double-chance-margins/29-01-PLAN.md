---
phase: 29-double-chance-margins
plan: 01
type: execute
---

<objective>
Add Double Chance market (1X, X2, 12) as a selectable column option and display per-market margins with color coding per bookmaker row.

Purpose: Enable comparison of Double Chance odds and show margin competitiveness per market per bookmaker.
Output: Double Chance columns in table, per-market margin display with green/red color coding.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase (dependency):
@.planning/phases/28-table-restructure/28-01-SUMMARY.md

# Key source files:
@src/api/routes/events.py (INLINE_MARKET_IDS, _build_inline_odds, _build_competitor_inline_odds)
@src/matching/schemas.py (InlineOdds schema)
@web/src/types/api.ts (InlineOdds TypeScript type)
@web/src/features/matches/components/match-table.tsx (MARKET_CONFIG, table rendering)
@web/src/features/matches/hooks/use-column-settings.ts (AVAILABLE_COLUMNS)

**Tech stack available:**
- React + TypeScript + TanStack Query v5
- shadcn/ui + Tailwind v4
- Pydantic v2 schemas
- Bookmakers-as-rows layout with rowspan grouping

**Established patterns:**
- MARKET_CONFIG defines market columns with id, label, outcomes
- INLINE_MARKET_IDS in backend determines which markets appear in inline_odds
- Color coding with static Tailwind classes (COLOR_CLASSES) for JIT compilation
- Margin calculated as (sum(1/odds) - 1) * 100

**Constraining decisions:**
- [Phase 28]: Bookmakers-as-rows layout with rowspan for match info columns
- [Phase 28]: Market group headers with outcome sub-headers

**From 29-CONTEXT.md:**
- Double Chance follows same column toggle pattern as existing markets
- Per-market margin per bookmaker row
- Color-coded margins: green=low/competitive, red=high
- Best margin highlighting per market
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Double Chance to inline markets and include margin in response</name>
  <files>src/api/routes/events.py, src/matching/schemas.py, web/src/types/api.ts</files>
  <action>
1. In src/matching/schemas.py, add `margin: float | None = None` field to InlineOdds class

2. In src/api/routes/events.py:
   - Add "4693" (Double Chance Full Time) to INLINE_MARKET_IDS: `["3743", "5000", "3795", "4693"]`
   - Update _build_inline_odds() to calculate and include margin for each market:
     - After building outcomes list, calculate margin using same formula as _calculate_margin(): `(sum(1/odds for odds in outcomes if odds > 0) - 1) * 100`
     - Add margin to InlineOdds() constructor
   - Apply same change to _build_competitor_inline_odds()

3. In web/src/types/api.ts, add `margin: number | null` to InlineOdds interface

Note: The margin calculation already exists in _calculate_margin() - reuse that pattern. Don't import it directly since it uses OutcomeDetail type; just apply same formula inline.
  </action>
  <verify>
- Python types pass: `cd src && python -c "from api.routes.events import _build_inline_odds; from matching.schemas import InlineOdds; print('OK')"`
- TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>InlineOdds schema includes margin field, Double Chance (4693) included in inline markets, margin calculated for all markets</done>
</task>

<task type="auto">
  <name>Task 2: Add Double Chance to MARKET_CONFIG and display margins in table</name>
  <files>web/src/features/matches/hooks/use-column-settings.ts, web/src/features/matches/components/match-table.tsx</files>
  <action>
1. In use-column-settings.ts:
   - Add to AVAILABLE_COLUMNS: `{ id: '4693', label: 'Double Chance' }`
   - Do NOT add to DEFAULT_VISIBLE_COLUMNS (user opts in)

2. In match-table.tsx:
   - Add to MARKET_CONFIG: `'4693': { id: '4693', label: 'DC', outcomes: ['1X', 'X2', '12'] }`

3. Add margin column per market group:
   - In the main header row (after market group headers), add one "Margin" column per visible market
   - In the outcome sub-header row, add one empty cell per margin column (to align with outcome columns)

4. Display margin per bookmaker row:
   - After each market's outcome cells, add a margin cell
   - Create MarginValue component similar to OddsValue:
     - Display margin as percentage with 1 decimal (e.g., "4.2%")
     - Color coding: Use same COLOR_CLASSES pattern
       - margin < 3%: green (competitive)
       - margin 3-6%: no color (neutral)
       - margin > 6%: red (high)
     - Intensity based on how far from neutral range
   - Get margin from bookmaker's inline_odds for that market

5. Highlight best (lowest) margin per market:
   - Before rendering rows, compute bestMargin per market across all bookmakers
   - In MarginValue, if this bookmaker has the best margin, add subtle highlight (e.g., font-bold or ring)

Implementation notes:
- Get margin from: `bookmaker.inline_odds?.find(m => m.market_id === marketId)?.margin`
- For header, colspan needs adjustment: each market group now has (outcomes.length + 1) columns
- Adjust outcome sub-header colSpan={5} to account for new margin columns
  </action>
  <verify>
- Build passes: `cd web && npm run build`
- Dev server runs: start dev server, visit /matches
- Double Chance appears in column toggle
- When DC enabled, shows 1X/X2/12 columns
- Margin column appears per market
- Margins color-coded (check a match with known margins)
  </verify>
  <done>Double Chance selectable as column, margins displayed per market per bookmaker with color coding, best margin highlighted</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Double Chance market columns and per-market margin display with color coding</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Visit: http://localhost:5173/matches (or appropriate port)
    3. Check column toggle - Double Chance should appear
    4. Enable Double Chance - should see 1X, X2, 12 columns
    5. Verify each market group has a Margin column
    6. Check margin colors: green for low (<3%), neutral for mid (3-6%), red for high (>6%)
    7. Verify best margin per market is highlighted
    8. Toggle markets on/off - margins should appear/disappear with their markets
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npm run build` succeeds
- [ ] `cd src && python -c "from matching.schemas import InlineOdds; print(InlineOdds.model_fields)"` shows margin field
- [ ] Double Chance market visible and selectable
- [ ] Margins display per market with color coding
- [ ] Best margin highlighted per market
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Double Chance columns display correctly (1X, X2, 12)
- Per-market margin shown per bookmaker row
- Margin color coding works (green/neutral/red)
- Best margin per market highlighted
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-double-chance-margins/29-01-SUMMARY.md`
</output>
