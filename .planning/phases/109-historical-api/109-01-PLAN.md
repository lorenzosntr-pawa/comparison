---
phase: 109-historical-api
plan: 01
type: execute
---

<objective>
Update history API endpoints to query market_odds_history instead of deprecated snapshot-based tables.

Purpose: Complete the read path migration by updating historical data queries to use the new market-level storage schema, enabling proper history charts and time-to-kickoff analysis.
Output: Working history endpoints querying market_odds_history, verified via curl tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/108-read-path-cache/108-01-SUMMARY.md
@.planning/phases/105-investigation-schema-design/DISCOVERY.md
@src/api/routes/history.py
@src/db/models/market_odds.py

**Tech stack available:**
- MarketOddsHistory model with (event_id, bookmaker_slug, betpawa_market_id, line, outcomes, captured_at)
- Partitioned table with idx_moh_event_market_time index

**Constraining decisions:**
- Phase 108: Use bookmaker_slug field for unified bookmaker handling
- Phase 107: History only contains CHANGED markets (not every scrape)
- Phase 105: market_odds_history is append-only with monthly partitioning
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update get_odds_history endpoint</name>
  <files>src/api/routes/history.py</files>
  <action>
Replace the current dual-path query logic (BetPawa tables vs competitor tables) with a single unified query against MarketOddsHistory:

```python
from src.db.models.market_odds import MarketOddsHistory

query = (
    select(MarketOddsHistory)
    .where(MarketOddsHistory.event_id == event_id)
    .where(MarketOddsHistory.bookmaker_slug == bookmaker_slug)
    .where(MarketOddsHistory.betpawa_market_id == market_id)
)

# Apply line filter for specifier markets
if line is not None:
    query = query.where(MarketOddsHistory.line == line)

# Apply time filters
if from_time:
    from_time_naive = from_time.replace(tzinfo=None) if from_time.tzinfo else from_time
    query = query.where(MarketOddsHistory.captured_at >= from_time_naive)
if to_time:
    to_time_naive = to_time.replace(tzinfo=None) if to_time.tzinfo else to_time
    query = query.where(MarketOddsHistory.captured_at <= to_time_naive)

query = query.order_by(MarketOddsHistory.captured_at)
```

IMPORTANT: MarketOddsHistory does NOT have unavailable_at field (only market_odds_current does). Return available=True and unavailable_at=None for all history points. This is acceptable because history only contains changed records, and availability changes would create separate history entries.

Remove unused imports: OddsSnapshot, MarketOdds, CompetitorOddsSnapshot, CompetitorMarketOdds, CompetitorEvent after confirming no other usage in this file.
  </action>
  <verify>
Server starts without import errors:
```bash
cd src && python -c "from api.routes.history import router; print('OK')"
```
  </verify>
  <done>get_odds_history queries MarketOddsHistory with unified bookmaker handling, no snapshot table references</done>
</task>

<task type="auto">
  <name>Task 2: Update get_margin_history endpoint</name>
  <files>src/api/routes/history.py</files>
  <action>
Apply same query pattern as Task 1 to get_margin_history:

1. Replace dual-path query with single MarketOddsHistory query
2. Calculate margin from outcomes JSONB using existing _calculate_margin_from_outcomes() helper
3. Return available=True and unavailable_at=None for all points (same reasoning as Task 1)
4. Keep existing response schema (MarginHistoryResponse) unchanged

The query logic is identical to Task 1, only the response building differs (margin-only vs full outcomes).
  </action>
  <verify>
```bash
cd src && python -c "from api.routes.history import router; print('OK')"
```
  </verify>
  <done>get_margin_history queries MarketOddsHistory, margin calculation preserved</done>
</task>

<task type="auto">
  <name>Task 3: Remove deprecated get_snapshot_history endpoint</name>
  <files>src/api/routes/history.py</files>
  <action>
The get_snapshot_history endpoint at `/{event_id}/history` returns a paginated list of OddsSnapshot records with market counts. With market-level storage, the snapshot concept no longer exists.

Frontend analysis shows this endpoint is NOT used:
- useOddsHistory calls /events/{id}/markets/{mid}/history
- useMarginHistory calls /events/{id}/markets/{mid}/margin-history
- No frontend code calls /events/{id}/history

Action: Remove the entire get_snapshot_history function and its route registration. This includes:
1. Delete the function definition (lines ~57-192)
2. Remove HistoricalSnapshot, SnapshotHistoryResponse from imports if no longer used
3. Clean up any dead imports after removal

Alternative (if cautious): Keep endpoint but return 410 Gone with message "Snapshot history deprecated in v2.9, use /markets/{id}/history instead"
  </action>
  <verify>
```bash
cd src && python -c "from api.routes.history import router; print('OK')"
```
  </verify>
  <done>get_snapshot_history removed or returns 410 Gone, no runtime errors</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd src && python -c "from api.routes.history import router"` succeeds
- [ ] history.py has no references to OddsSnapshot, CompetitorOddsSnapshot, MarketOdds, CompetitorMarketOdds
- [ ] All endpoints use MarketOddsHistory for queries
- [ ] No unused imports remain in file
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No import or syntax errors
- History API queries market_odds_history instead of deprecated snapshot tables
- Response schemas unchanged (API backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/109-historical-api/109-01-SUMMARY.md`:

# Phase 109 Plan 01: Historical API Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 110: Retention, Cleanup & Storage Page Fix]
</output>
