---
phase: 02-database-schema
plan: 01
type: execute
---

<objective>
Set up SQLAlchemy 2.0 async database foundation and core entity models.

Purpose: Establish the database layer that all subsequent phases depend on - async engine, session factory, and core reference/event models.
Output: Working async database setup with Sport, Tournament, Event, EventBookmaker, and Bookmaker models.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-schema/02-RESEARCH.md
@.planning/phases/02-database-schema/02-CONTEXT.md
@.planning/phases/01-market-mapping-port/01-06-SUMMARY.md

**Tech stack available:** Pydantic v2, pytest>=8.0
**Established patterns:** frozen Pydantic models, ConfigDict, discriminated unions

**From RESEARCH.md - MUST follow:**
- SQLAlchemy 2.0 with `DeclarativeBase` class (not `declarative_base()`)
- `expire_on_commit=False` for async sessions (CRITICAL)
- Naming conventions for constraints (enables Alembic autogenerate)
- asyncpg driver for PostgreSQL

**From CONTEXT.md:**
- Event-centric AND snapshot-based schema
- Hierarchy: Sport → Tournament → Event
- Support partial matches (2 of 3 bookmakers OK)
- Bookmaker config includes identity, scrape settings, market mappings
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create async engine and session factory</name>
  <files>src/db/__init__.py, src/db/engine.py, src/db/base.py</files>
  <action>
Create database package structure:

1. `src/db/base.py`:
   - Import `MetaData` from sqlalchemy, `DeclarativeBase` from sqlalchemy.orm
   - Define naming convention dict for pk, fk, ix, uq, ck constraints (from RESEARCH.md Pattern 4)
   - Create `Base` class inheriting from `DeclarativeBase` with `metadata = MetaData(naming_convention=convention)`

2. `src/db/engine.py`:
   - Import `create_async_engine`, `async_sessionmaker`, `AsyncSession` from sqlalchemy.ext.asyncio
   - Import `AsyncGenerator` from typing, `contextlib.asynccontextmanager`
   - Create `get_database_url()` function that reads from environment variable `DATABASE_URL` with default `postgresql+asyncpg://postgres:postgres@localhost:5432/betpawa`
   - Create module-level `engine` using `create_async_engine()` with pool_size=10, max_overflow=20, echo=False
   - Create `async_session_factory` using `async_sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)`
   - Create `async def get_db()` async generator for FastAPI dependency injection
   - Create `async def dispose_engine()` for clean shutdown

3. `src/db/__init__.py`:
   - Export: Base, engine, async_session_factory, get_db, dispose_engine

Do NOT use lazy engine creation - create at module import time (standard pattern for FastAPI).
  </action>
  <verify>python -c "from src.db import Base, engine, async_session_factory, get_db, dispose_engine; print('DB imports OK')"</verify>
  <done>All database foundation exports importable without error</done>
</task>

<task type="auto">
  <name>Task 2: Create core entity models</name>
  <files>src/db/models/__init__.py, src/db/models/sport.py, src/db/models/event.py, src/db/models/bookmaker.py</files>
  <action>
Create core models following SQLAlchemy 2.0 patterns:

1. `src/db/models/sport.py` - Sport and Tournament:
```python
# Sport model:
- id: Mapped[int] primary_key
- name: Mapped[str] unique (e.g., "Football")
- slug: Mapped[str] unique (e.g., "football")
- tournaments: relationship back to Tournament

# Tournament model:
- id: Mapped[int] primary_key
- sport_id: Mapped[int] ForeignKey to sports.id
- name: Mapped[str] (e.g., "English Premier League")
- country: Mapped[str | None] (e.g., "England")
- sportradar_id: Mapped[str | None] unique, nullable
- sport: relationship to Sport
- events: relationship back to Event
```

2. `src/db/models/bookmaker.py` - Bookmaker config:
```python
# Bookmaker model:
- id: Mapped[int] primary_key
- name: Mapped[str] unique (e.g., "Sportybet", "Betpawa", "Bet9ja")
- slug: Mapped[str] unique (e.g., "sportybet")
- is_active: Mapped[bool] default True
- base_url: Mapped[str | None] (API base URL)
- logo_url: Mapped[str | None]
- created_at: Mapped[datetime] server_default=func.now()
- updated_at: Mapped[datetime] server_default=func.now(), onupdate=func.now()
```

3. `src/db/models/event.py` - Event and EventBookmaker:
```python
# Event model (matched event across platforms):
- id: Mapped[int] primary_key
- tournament_id: Mapped[int] ForeignKey to tournaments.id
- name: Mapped[str] (e.g., "Arsenal vs Chelsea")
- home_team: Mapped[str]
- away_team: Mapped[str]
- kickoff: Mapped[datetime] (match start time)
- sportradar_id: Mapped[str] unique (cross-platform matching key)
- created_at: Mapped[datetime] server_default=func.now()
- tournament: relationship to Tournament
- bookmaker_links: relationship to EventBookmaker

# EventBookmaker model (per-bookmaker event data):
- id: Mapped[int] primary_key
- event_id: Mapped[int] ForeignKey to events.id
- bookmaker_id: Mapped[int] ForeignKey to bookmakers.id
- external_event_id: Mapped[str] (bookmaker's event ID)
- event_url: Mapped[str | None] (deep link to event on bookmaker site)
- created_at: Mapped[datetime] server_default=func.now()
- UniqueConstraint on (event_id, bookmaker_id)
- event: relationship to Event
- bookmaker: relationship to Bookmaker
```

4. `src/db/models/__init__.py`:
   - Import and re-export: Sport, Tournament, Bookmaker, Event, EventBookmaker
   - Import Base from db.base

Use `Mapped[]` type hints everywhere. Use `mapped_column()` for all columns.
Import `func` from sqlalchemy for server_default timestamps.
  </action>
  <verify>python -c "from src.db.models import Sport, Tournament, Bookmaker, Event, EventBookmaker; print('Models OK')"</verify>
  <done>All 5 core models importable, relationships defined, constraints named</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.db import Base, engine, async_session_factory"` succeeds
- [ ] `python -c "from src.db.models import Sport, Tournament, Bookmaker, Event, EventBookmaker"` succeeds
- [ ] All models have proper `__tablename__` attributes
- [ ] Naming convention applied (check Base.metadata.naming_convention is set)
</verification>

<success_criteria>

- Database foundation established with async engine and session factory
- 5 core models created with proper relationships
- All imports work without circular dependency issues
- Ready for odds snapshot models in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-schema/02-01-SUMMARY.md`
</output>
