---
phase: 08-scrape-runs-ui-improvements
plan: FIX2
type: fix
---

<objective>
Fix 3 UAT issues from Phase 8 re-verification testing.

Source: 08-ISSUES.md (UAT-004, UAT-005, UAT-006)
Priority: 0 critical, 1 major, 2 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/08-scrape-runs-ui-improvements/08-ISSUES.md

**Previous fix plan for reference:**
@.planning/phases/08-scrape-runs-ui-improvements/08-FIX.md

**Key files to understand:**
@src/api/routes/scrape.py
@web/src/features/dashboard/components/recent-runs.tsx
@src/scraping/orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-006 - SSE streaming doesn't save platform_timings (MAJOR)</name>
  <files>src/api/routes/scrape.py, src/scraping/orchestrator.py</files>
  <action>
The `/scrape/stream` endpoint doesn't save platform_timings to the database when scrape completes. The POST `/scrape` endpoint does (lines 106-114), but the SSE streaming endpoint's finally block only saves status and completed_at.

Root cause: The SSE endpoint uses `scrape_with_progress()` async generator but doesn't collect the result data to save platform_timings.

Fix approach:
1. Modify `scrape_with_progress()` in orchestrator.py to track platform timings as it emits progress events
2. The orchestrator already has timing data from each platform result - need to accumulate it
3. In the `/scrape/stream` endpoint's finally block, update the ScrapeRun with:
   - platform_timings (accumulated from successful platforms)
   - events_scraped (total count)
   - events_failed (failure count)
   - Correct status based on results (completed/partial/failed, not always COMPLETED)

Alternative simpler approach:
1. Track platform timings directly in the endpoint by watching SSE events
2. When a `storing_complete` event comes through with platform data, accumulate it
3. Save accumulated data in the finally block

Use the simpler approach - accumulate in the endpoint, matching the structure that works in POST /scrape.
  </action>
  <verify>
1. Start a scrape from dashboard widget
2. Wait for completion
3. Navigate to detail page
4. Verify "Platform Breakdown" card shows timing data for each platform
  </verify>
  <done>platform_timings saved to database for SSE-triggered scrapes, Platform Breakdown card displays correctly on detail page</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-004 - Dashboard widget progress bar not showing platform colors</name>
  <files>web/src/features/dashboard/components/recent-runs.tsx</files>
  <action>
The PLATFORM_PROGRESS_COLORS map was added in 08-FIX, but user reports it's not working on the dashboard widget (detail page works).

Debug approach:
1. Check if `activeProgress?.platform` is populated during SSE streaming
2. The SSE events may have platform as null during certain phases
3. The color class is applied conditionally:
   ```tsx
   isStreaming && activeProgress?.platform &&
     activeProgress.phase !== 'completed' &&
     activeProgress.phase !== 'failed' &&
     PLATFORM_PROGRESS_COLORS[activeProgress.platform.toLowerCase()]
   ```

Likely issue: The `platform` field in SSE events might be uppercase or have different casing. The lookup uses `.toLowerCase()` but the map keys are lowercase.

Also verify:
- The SSE events include platform during 'scraping' and 'storing' phases
- The platform name matches the keys in PLATFORM_PROGRESS_COLORS

Fix: Add console.log during development to check values, then fix the matching logic if needed.
  </action>
  <verify>Start scrape from dashboard, verify progress bar changes color per platform (green → blue → orange)</verify>
  <done>Progress bar shows platform-specific colors during active scraping on dashboard widget</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-005 - Dashboard widget status badge still has delay</name>
  <files>web/src/features/dashboard/components/recent-runs.tsx</files>
  <action>
The 08-FIX changed invalidateQueries to refetchQueries, but user still reports delay. The issue may be:
1. The refetch happens but the SSE completion signal comes before data is fully persisted
2. The backend might not have committed the transaction when the SSE 'completed' event fires

Fix approach:
1. Add a small delay (100-200ms) before refetching to ensure DB commit completes
2. Or use optimistic update: immediately update the local query cache with the expected completed status

Better approach - optimistic update:
```tsx
if (data.phase === 'completed' || data.phase === 'failed') {
  eventSource.close()
  setIsManualStreaming(false)

  // Optimistically update the most recent run in cache
  queryClient.setQueryData(['scheduler-history'], (old: any) => {
    if (!old?.runs?.[0]) return old
    return {
      ...old,
      runs: old.runs.map((run: any, i: number) =>
        i === 0 ? { ...run, status: data.phase === 'completed' ? 'completed' : 'failed' } : run
      )
    }
  })

  // Then refetch for accurate data
  void queryClient.refetchQueries({ queryKey: ['scheduler-history'] })
  void queryClient.refetchQueries({ queryKey: ['events'] })
}
```

This ensures the UI updates immediately while the refetch gets accurate data.
  </action>
  <verify>Complete a scrape from dashboard, verify status badge updates at the exact moment progress bar shows completion</verify>
  <done>Status badge updates simultaneously with progress bar completion, no visible delay</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] Platform Breakdown card shows data on detail page after SSE-triggered scrape
- [ ] Progress bar shows platform-specific colors on dashboard widget
- [ ] Status badge updates immediately on dashboard widget
</verification>

<success_criteria>
- All 3 UAT issues from 08-ISSUES.md (UAT-004, UAT-005, UAT-006) addressed
- Build passes
- Ready for re-verification with /gsd:verify-work 8
</success_criteria>

<output>
After completion, create `.planning/phases/08-scrape-runs-ui-improvements/08-FIX2-SUMMARY.md`
</output>
