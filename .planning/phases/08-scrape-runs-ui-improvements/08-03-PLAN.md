---
phase: 08-scrape-runs-ui-improvements
plan: 03
type: execute
---

<objective>
Implement platform-specific retry functionality for failed scrapes.

Purpose: Enable targeted recovery from partial failures by retrying only the failed platform(s) instead of the entire scrape run.
Output: Retry API endpoint accepting platform list, retry dialog UI with platform selection, integrated into detail page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./08-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-scrape-runs-ui-improvements/08-CONTEXT.md

# Prior plans in this phase:
@.planning/phases/08-scrape-runs-ui-improvements/08-01-SUMMARY.md
@.planning/phases/08-scrape-runs-ui-improvements/08-02-SUMMARY.md

# Key files to understand:
@src/api/routes/scrape.py
@src/scraping/orchestrator.py
@web/src/features/scrape-runs/detail.tsx
@web/src/features/scrape-runs/components/error-list.tsx

**Tech stack available:** FastAPI, SQLAlchemy, React 19, TanStack Query v5, shadcn/ui
**Established patterns:**
- Platform enum for type-safe platform references
- asyncio.gather for parallel scraping
- shadcn Dialog component for modals
- TanStack Query mutation hooks

**From 08-CONTEXT.md:**
- Platform-specific retry â€” ability to retry just the failed platform(s), not the whole run
- Detailed error messages and logs when scrapes fail
- Error details visible for troubleshooting
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry endpoint with platform selection</name>
  <files>src/api/routes/scrape.py, src/api/schemas/scheduler.py, src/scraping/orchestrator.py</files>
  <action>
Add POST /api/scrape/{run_id}/retry endpoint for platform-specific retry:

1. Create RetryRequest schema in scheduler.py:
   ```python
   class RetryRequest(BaseModel):
       platforms: list[str]  # ["sportybet", "bet9ja"] - platforms to retry
   ```

2. Add endpoint in scrape.py:
   - Accept run_id path param and RetryRequest body
   - Validate run exists and has status in (partial, failed)
   - Validate platforms are valid Platform enum values
   - Create new ScrapeRun with trigger="retry"
   - Call orchestrator with only specified platforms
   - Update original run's status if needed (e.g., add note about retry)
   - Return new ScrapeRun ID

3. Modify orchestrator.py to support partial platform list:
   - Add optional `platforms` parameter to scrape_all() and scrape_with_progress()
   - Default to all platforms if not specified
   - Only scrape specified platforms
   - Example: `await orchestrator.scrape_all(platforms=["sportybet", "bet9ja"])`

4. Handle edge cases:
   - Can't retry a running scrape (return 400)
   - Can't retry if all platforms already succeeded (return 400 with message)
   - Empty platforms list = retry all failed platforms

The retry creates a new ScrapeRun record (not modifying the original) for clean audit trail.
  </action>
  <verify>curl -X POST http://localhost:8000/api/scrape/{run_id}/retry -d '{"platforms":["sportybet"]}' returns new run ID</verify>
  <done>Retry endpoint accepts platform list and triggers partial scrape with new ScrapeRun record</done>
</task>

<task type="auto">
  <name>Task 2: Create retry dialog component</name>
  <files>web/src/features/scrape-runs/components/retry-dialog.tsx, web/src/features/scrape-runs/hooks/use-retry.ts, web/src/features/scrape-runs/hooks/index.ts, web/src/features/scrape-runs/components/index.ts</files>
  <action>
Create retry dialog with platform selection UI:

1. Create use-retry.ts hook:
   ```typescript
   interface RetryParams {
     runId: number;
     platforms: string[];
   }

   export function useRetry() {
     const queryClient = useQueryClient();
     return useMutation({
       mutationFn: async ({ runId, platforms }: RetryParams) => {
         return api.post<{ id: number }>(`/api/scrape/${runId}/retry`, { platforms });
       },
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: ['scrape-runs'] });
         queryClient.invalidateQueries({ queryKey: ['scrape-stats'] });
       },
     });
   }
   ```

2. Create retry-dialog.tsx:
   - Props: open, onOpenChange, runId, failedPlatforms (platforms that had errors)
   - Use shadcn Dialog, Checkbox, Button components
   - Show checkboxes for each failed platform:
     - Platform name with icon/color
     - Error count badge
     - Pre-checked by default
   - "Retry Selected" button triggers mutation
   - Show loading state during retry
   - Close dialog and navigate to new run on success
   - Handle error state (show toast or inline error)

3. Export from hooks/index.ts and components/index.ts

Dialog should be simple and focused - just platform selection, no additional options.
  </action>
  <verify>TypeScript compiles, dialog opens/closes correctly, checkboxes toggle platform selection</verify>
  <done>RetryDialog component with platform checkboxes and useRetry mutation hook</done>
</task>

<task type="auto">
  <name>Task 3: Integrate retry button on detail page</name>
  <files>web/src/features/scrape-runs/detail.tsx, web/src/features/scrape-runs/components/error-list.tsx</files>
  <action>
Add retry functionality to ScrapeRunDetailPage and ErrorList:

1. Modify detail.tsx:
   - Add "Retry Failed Platforms" button in header area (near status badge)
   - Only show button when status is "partial" or "failed"
   - Clicking opens RetryDialog with failed platforms pre-selected
   - Determine failed platforms from:
     a) Platforms in errors array
     b) Or platforms missing from platform_timings (if status is partial)

2. Modify error-list.tsx:
   - Add "Retry" action button in table row for each platform's errors
   - Clicking triggers retry for just that one platform
   - Or add "Retry All Failed" button at top of error list
   - Use same useRetry hook

3. After successful retry:
   - Show toast notification "Retry started"
   - Navigate to new run's detail page (or stay and show link)
   - Invalidate queries to refresh run list

4. Handle loading states:
   - Disable retry button while mutation is pending
   - Show spinner on button

Keep the retry UX simple - one click to retry all failed, or selective retry via dialog.
  </action>
  <verify>View /scrape-runs/{id} for a failed run, click Retry, verify new run is created and navigation works</verify>
  <done>Retry button on detail page and error list triggers platform-specific retry with dialog selection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] POST /api/scrape/{id}/retry creates new ScrapeRun with selected platforms only
- [ ] RetryDialog shows checkboxes for failed platforms
- [ ] Retry button appears on detail page for partial/failed runs
- [ ] Successful retry navigates to new run's detail page
- [ ] Original run is preserved (audit trail)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Platform-specific retry works end-to-end
- Retry creates new run record (not modifying original)
- Failed platforms can be retried individually or together
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-scrape-runs-ui-improvements/08-03-SUMMARY.md`
</output>
