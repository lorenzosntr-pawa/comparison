---
phase: 21-settings-persistence-integration
plan: 01
type: execute
---

<objective>
Make settings actually drive application behavior by syncing database values at startup.

Purpose: Settings page currently persists values to DB, but the scheduler starts with hardcoded defaults. After this plan, stored settings are loaded and applied when the server starts.

Output: Scheduler respects stored interval on startup, frontend types include all settings fields.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-settings-persistence-integration/21-CONTEXT.md

**Key files:**
@src/scheduling/scheduler.py
@src/api/app.py
@web/src/types/api.ts
@web/src/features/settings/hooks/use-settings.ts

**Tech stack available:**
- FastAPI with async lifespan
- APScheduler with `update_scheduler_interval()`
- TanStack Query v5 for frontend caching
- SQLAlchemy 2.0 async with Settings model

**Established patterns:**
- `get_settings_from_db()` exists in scheduler.py (returns Settings or None)
- `update_scheduler_interval()` reschedules the job with new interval
- Pydantic schemas use `to_camel` alias generator for frontend compatibility

**Constraining decisions:**
- Phase 20: Added `history_retention_days` to Settings model and API
- Settings use singleton pattern with id=1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync settings from DB at startup</name>
  <files>src/scheduling/scheduler.py, src/api/app.py</files>
  <action>
1. In scheduler.py, add async function `sync_settings_on_startup()`:
   - Call existing `get_settings_from_db()` to fetch settings
   - If settings exist and `scrape_interval_minutes` differs from DEFAULT_INTERVAL_MINUTES, call `update_scheduler_interval()` with stored value
   - Log the action: "Synced scheduler interval from settings: X minutes"
   - If no settings or fetch fails, log "Using default interval: 5 minutes" and continue

2. In app.py lifespan, after `start_scheduler()`:
   - Import and call `await sync_settings_on_startup()`
   - This ensures scheduler runs with DB-stored interval from first moment

Note: Do NOT call sync before `start_scheduler()` - the scheduler must be running for `update_scheduler_interval()` to work (it reschedules an existing job).
  </action>
  <verify>
1. Server starts without errors
2. Check logs show "Synced scheduler interval from settings" or "Using default interval"
3. GET /api/scheduler/status shows correct interval_minutes matching DB value
  </verify>
  <done>Scheduler respects stored interval on startup, not hardcoded default</done>
</task>

<task type="auto">
  <name>Task 2: Add historyRetentionDays to frontend types</name>
  <files>web/src/types/api.ts</files>
  <action>
1. Update `SettingsResponse` interface:
   - Add `historyRetentionDays: number` field

2. Update `SettingsUpdate` interface:
   - Add `historyRetentionDays?: number` field (optional for partial updates)

This ensures frontend receives complete settings data from API. The UI for editing this field is Phase 22 scope.
  </action>
  <verify>
1. TypeScript compiles without errors: `cd web && npm run build`
2. useSettings hook receives historyRetentionDays in data
  </verify>
  <done>Frontend types include historyRetentionDays, TypeScript builds cleanly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Server starts and syncs settings from DB
- [ ] Logs confirm settings sync on startup
- [ ] GET /api/settings returns all fields including historyRetentionDays
- [ ] GET /api/scheduler/status shows correct interval
</verification>

<success_criteria>

- All tasks completed
- Settings sync from DB on server startup
- Scheduler uses stored interval, not hardcoded default
- Frontend types complete with historyRetentionDays
- No TypeScript or Python errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-persistence-integration/21-01-SUMMARY.md`:

# Phase 21 Plan 01: Settings Persistence Integration Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 22: History Retention
</output>
