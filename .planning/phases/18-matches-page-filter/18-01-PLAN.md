---
phase: 18-matches-page-filter
plan: 01
type: execute
---

<objective>
Add toggle to Matches page for viewing competitor-only events alongside BetPawa-matched events.

Purpose: Enable odds comparison for events that only exist on competitor platforms (SportyBet/Bet9ja), expanding the Matches page from BetPawa-focused to full market visibility.

Output: Toggle at top of Matches page, competitor-only events displaying with their odds in the same table format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-matches-page-filter/18-CONTEXT.md
@.planning/phases/17-palimpsest-api-endpoints/17-02-SUMMARY.md

**Key files:**
@src/api/routes/events.py
@src/db/models/competitor.py
@web/src/features/matches/index.tsx
@web/src/features/matches/hooks/use-matches.ts
@web/src/features/matches/components/match-filters.tsx
@web/src/features/matches/components/match-table.tsx
@web/src/lib/api.ts
@web/src/types/api.ts

**Established patterns:**
- Pydantic v2 with frozen models and ConfigDict
- SQLAlchemy 2.0 async with Mapped[] columns
- TanStack Query v5 with polling intervals
- shadcn/ui Tabs component for toggle UI
- Metadata priority: sportybet > bet9ja for competitor-only events

**Key decisions from prior phases:**
- Phase 17: Palimpsest events endpoint uses `availability` filter (all|matched|betpawa-only|competitor-only)
- Phase 17: Metadata priority already implemented in palimpsest query
- Competitor odds stored in competitor_odds_snapshots/competitor_market_odds tables using same betpawa_market_id taxonomy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend /api/events endpoint with availability filter</name>
  <files>src/api/routes/events.py, src/matching/schemas.py</files>
  <action>
Add `availability` query parameter to `get_events` endpoint in events.py:
- `availability` parameter: Literal["betpawa", "all"] with default "betpawa"
- When "betpawa": current behavior (only BetPawa events with bookmaker odds)
- When "all": include competitor-only events WITH their inline odds

For competitor-only events:
1. Query CompetitorEvent where betpawa_event_id IS NULL
2. Apply same filters (kickoff_from, kickoff_to, search, tournament matching via sportradar_id)
3. Load CompetitorOddsSnapshot and CompetitorMarketOdds for inline odds
4. Build MatchedEvent response with:
   - Use negative IDs to distinguish from BetPawa events (e.g., id = -competitor_event.id)
   - Metadata from best source: prefer sportybet over bet9ja for duplicate SR IDs
   - bookmakers array with only competitor entries (no betpawa entry)
5. Merge with BetPawa events, sort by kickoff
6. Apply pagination to combined result

Key implementation notes:
- Reuse existing `_build_inline_odds` pattern for competitor odds
- Add helper function `_build_competitor_event` similar to `_build_matched_event`
- For metadata priority: if same sportradar_id exists on both sportybet and bet9ja, use sportybet
- Tournament matching: competitor events link to competitor_tournaments which have sportradar_id
  </action>
  <verify>
Test with curl:
- `curl localhost:8000/api/events?availability=betpawa` returns only BetPawa events (existing behavior)
- `curl localhost:8000/api/events?availability=all` returns BetPawa + competitor-only events
- Competitor-only events have negative IDs and no betpawa bookmaker in bookmakers array
  </verify>
  <done>
- availability parameter accepted on /api/events
- availability=all returns competitor-only events with inline odds
- Competitor events have negative IDs, metadata from best source
- Existing behavior unchanged when availability=betpawa or not specified
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mode toggle to Matches page</name>
  <files>web/src/features/matches/index.tsx, web/src/features/matches/hooks/use-matches.ts, web/src/features/matches/components/match-filters.tsx, web/src/lib/api.ts, web/src/types/api.ts</files>
  <action>
1. Update API client (web/src/lib/api.ts):
   - Add `availability?: 'betpawa' | 'all'` parameter to getEvents function

2. Update types (web/src/types/api.ts):
   - No changes needed - MatchedEvent already handles optional bookmaker data

3. Update MatchFiltersState (match-filters.tsx):
   - Add `availability: 'betpawa' | 'all'` to MatchFiltersState interface

4. Update DEFAULT_FILTERS (index.tsx):
   - Add `availability: 'betpawa'` to DEFAULT_FILTERS

5. Add toggle to MatchFilters component (match-filters.tsx):
   - Add shadcn/ui Tabs component at the START of the filter row (before Team search)
   - Two tabs: "BetPawa Events" (value='betpawa') and "All Events" (value='all')
   - Use compact styling: TabsList with h-9, TabsTrigger with px-3 py-1.5
   - When toggled, call updateFilter('availability', value)

6. Update useMatches hook (use-matches.ts):
   - Add `availability` to UseMatchesParams interface
   - Pass availability to api.getEvents()
   - Include availability in queryKey for proper cache separation

7. Update MatchList component (index.tsx):
   - Pass filters.availability to useMatches hook
  </action>
  <verify>
- npm run build in web/ succeeds without TypeScript errors
- Toggle visible at top of Matches page filter row
- Clicking "All Events" fetches with ?availability=all
- Clicking "BetPawa Events" fetches with ?availability=betpawa
- Query results update when toggle changes
  </verify>
  <done>
- Toggle/tabs visible at top of filter row
- Toggle state persisted in filters
- API calls include availability parameter
- Data refreshes when toggle changes
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle competitor-only events in table</name>
  <files>web/src/features/matches/components/match-table.tsx</files>
  <action>
1. Update row click handler:
   - Check if event.id is negative (competitor-only)
   - If negative: don't navigate to detail page (no detail view for competitor events)
   - Remove cursor-pointer class for competitor-only events
   - Optionally add title tooltip: "Competitor-only event - no detail view"

2. Verify bookmaker column handling:
   - Table already shows "-" when bookmaker not found (existing OddsValue handles null)
   - Competitor-only events will show "-" for BP column, odds for SB/B9
   - No code changes needed for this - verify it works

3. Add visual indicator for competitor-only events (subtle):
   - Add thin left border or background tint to distinguish competitor-only rows
   - Use `border-l-2 border-orange-500/30` or similar subtle indicator
   - Only apply when event.id < 0

This maintains the CONTEXT.md requirement that events "feel native" while providing subtle visual distinction.
  </action>
  <verify>
- Competitor-only events display in table with BP column showing "-"
- SB and/or B9 columns show actual odds for competitor events
- Clicking competitor-only event row does NOT navigate to detail page
- Subtle visual indicator distinguishes competitor-only events
- Existing BetPawa events continue to work (clickable, navigate to detail)
  </verify>
  <done>
- Competitor-only events render correctly with odds
- No navigation for competitor-only events
- Subtle visual indicator present
- BetPawa events unchanged
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds without TypeScript errors
- [ ] Toggle visible on Matches page, switches between modes
- [ ] "BetPawa Events" mode shows only BetPawa-matched events (existing behavior)
- [ ] "All Events" mode shows BetPawa + competitor-only events
- [ ] Competitor-only events have odds visible in SB/B9 columns
- [ ] Competitor-only events are not clickable (no detail view)
- [ ] Existing filters (search, tournament, date) work with both modes
</verification>

<success_criteria>
- Toggle at top of Matches page for switching between BetPawa-only and All Events modes
- Competitor-only events display in same table format with their odds
- Metadata priority applied (sportybet > bet9ja) for competitor-only events
- No regressions to existing Matches page functionality
- Plan 18-01 complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-matches-page-filter/18-01-SUMMARY.md`
</output>
