---
phase: 92-history-charts
plan: 01
type: execute
domain: ui
---

<objective>
Add availability visualization to history charts showing unavailable periods with dashed lines.

Purpose: Complete the availability tracking feature by showing historical availability state in charts, enabling users to see when odds became unavailable over time.
Output: History charts display dashed line segments for unavailable periods with a legend explaining the visual distinction.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (availability tracking):
@.planning/phases/90-odds-comparison-ui/90-01-SUMMARY.md
@.planning/phases/91-event-details-ui/91-01-SUMMARY.md

# Key source files:
@src/api/routes/history.py
@src/matching/schemas.py
@web/src/types/api.ts
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/components/margin-line-chart.tsx

**Tech stack available:**
- recharts for charting with strokeDasharray for dashed lines
- MarketOdds model has unavailable_at timestamp field
- formatUnavailableSince utility in market-utils.ts

**Established patterns:**
- Three-state availability: available (normal), unavailable (visual indicator), never_offered (dash)
- Availability extraction: `unavailable_at = getattr(market, 'unavailable_at', None)`
- Separate Line approach for segment styling in recharts (dashed overlay line)

**Constraining decisions:**
- [Phase 87]: Availability tracked via unavailable_at timestamp on MarketOdds
- [Phase 90]: Three-state rendering pattern with formatUnavailableSince utility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add availability fields to history API responses</name>
  <files>src/api/routes/history.py, src/matching/schemas.py</files>
  <action>
Update OddsHistoryPoint and MarginHistoryPoint Pydantic schemas to include availability:
- Add `available: bool = True` field with default for backward compatibility
- Add `unavailable_at: datetime | None = None` field

In history.py get_odds_history():
- Extract unavailable_at from MarketOdds: `unavailable_at = getattr(market, 'unavailable_at', None)`
- Set `available = unavailable_at is None`
- Include both fields in OddsHistoryPoint construction

In history.py get_margin_history():
- Same extraction pattern for MarginHistoryPoint
- `available` and `unavailable_at` fields added

For competitor tables (CompetitorMarketOdds), check if unavailable_at exists with getattr pattern.
  </action>
  <verify>curl http://localhost:8000/api/events/123/markets/3743/history?bookmaker_slug=betpawa shows available/unavailable_at fields in response</verify>
  <done>History API endpoints return availability state for each history point</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for history availability</name>
  <files>web/src/types/api.ts</files>
  <action>
Add availability fields to OddsHistoryPoint interface:
```typescript
export interface OddsHistoryPoint {
  captured_at: string
  outcomes: OutcomeOdds[]
  margin: number | null
  /** Whether the market was available at this point. Defaults to true. */
  available?: boolean
  /** ISO timestamp when market became unavailable, or null if available */
  unavailable_at?: string | null
}
```

Add same fields to MarginHistoryPoint interface:
```typescript
export interface MarginHistoryPoint {
  captured_at: string
  margin: number | null
  /** Whether the market was available at this point. Defaults to true. */
  available?: boolean
  /** ISO timestamp when market became unavailable, or null if available */
  unavailable_at?: string | null
}
```

Use optional fields with JSDoc for backward compatibility.
  </action>
  <verify>cd web && npx tsc --noEmit passes</verify>
  <done>TypeScript types include availability fields for history points</done>
</task>

<task type="auto">
  <name>Task 3: Add availability visualization to OddsLineChart</name>
  <files>web/src/features/matches/components/odds-line-chart.tsx</files>
  <action>
Implement dashed line overlay approach for unavailable periods:

1. Add helper function to segment data by availability:
```typescript
function getAvailabilitySegments(data: ChartDataPoint[]): {
  availableData: ChartDataPoint[]
  unavailableData: ChartDataPoint[]
} {
  // For each point, check available field (default true)
  // Return two arrays for rendering as separate lines
}
```

2. Update chartData transformation:
- Include `available` field in each data point (from OddsHistoryPoint)
- Default to true if field missing for backward compatibility

3. Render dual lines per series:
- Primary solid line for available periods (connectNulls=false, null out unavailable points)
- Secondary dashed line for unavailable periods (connectNulls=true, strokeDasharray="5 5")

4. Add chart legend item explaining dashed = unavailable:
- Use custom Legend formatter to append "(unavailable)" label for dashed lines
- Or add a note below chart: "Dashed line indicates market was unavailable"

5. Handle comparison mode:
- Apply same solid/dashed pattern per bookmaker
- Use same color with strokeDasharray for unavailable segments
  </action>
  <verify>cd web && npm run build succeeds</verify>
  <done>OddsLineChart renders dashed lines for unavailable periods with legend explanation</done>
</task>

<task type="auto">
  <name>Task 4: Add availability visualization to MarginLineChart</name>
  <files>web/src/features/matches/components/margin-line-chart.tsx</files>
  <action>
Apply same pattern as OddsLineChart:

1. Update chartData transformation:
- Include `available` field from MarginHistoryPoint
- Default to true for backward compatibility

2. For single bookmaker mode:
- Solid blue line for available periods
- Dashed blue line for unavailable periods (strokeDasharray="5 5")
- Use connectNulls=true on dashed line to bridge gaps

3. For comparison mode:
- Apply per-bookmaker: solid when available, dashed when unavailable
- Same BOOKMAKER_COLORS for both solid and dashed

4. Add availability indicator:
- Small note or legend item explaining dashed = unavailable
- Consistent with OddsLineChart presentation

5. Tooltip handling:
- When hovering on unavailable point, show "(unavailable)" in tooltip
- Format: "Margin: 4.5% (unavailable since Feb 10, 14:30)"
  </action>
  <verify>cd web && npm run build succeeds</verify>
  <done>MarginLineChart renders dashed lines for unavailable periods with tooltip indication</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] Backend returns available/unavailable_at in history responses
- [ ] Charts show solid lines for available periods
- [ ] Charts show dashed lines for unavailable periods
- [ ] Legend or note explains dashed line meaning
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- History API includes availability state in responses
- Both chart components visualize availability with dashed segments
- Users can understand availability history at a glance
- Phase 92 complete, v2.5 milestone ready to ship
</success_criteria>

<output>
After completion, create `.planning/phases/92-history-charts/92-01-SUMMARY.md` with frontmatter:

```yaml
---
phase: 92-history-charts
plan: 01
subsystem: ui
tags: [recharts, availability, dashed-lines, history-api]

requires:
  - phase: 91-event-details-ui
    provides: Availability styling patterns
provides:
  - History API with availability fields
  - Chart components with dashed unavailable segments
affects: []

tech-stack:
  added: []
  patterns:
    - "Dashed line overlay for unavailable periods in recharts"
    - "Dual-line rendering: solid=available, dashed=unavailable"

key-files:
  created: []
  modified:
    - src/api/routes/history.py
    - src/matching/schemas.py
    - web/src/types/api.ts
    - web/src/features/matches/components/odds-line-chart.tsx
    - web/src/features/matches/components/margin-line-chart.tsx

key-decisions:
  - "Dashed overlay approach vs gradient masking: simpler, works without SVG complexity"

patterns-established:
  - "available/unavailable_at fields in history API responses"
  - "Dual-line chart rendering for availability visualization"

issues-created: []
---
```
</output>
