---
phase: 06.1-cross-platform-scraping
plan: 06.1-01-FIX
type: fix
---

<objective>
Fix 2 UAT issues from plan 06.1-01 (1 deferred as external API issue).

Source: 06.1-01-ISSUES.md
Priority: 1 blocker, 1 minor, 1 major (external - deferred)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/06.1-cross-platform-scraping/06.1-01-ISSUES.md

**Affected files:**
@src/scraping/orchestrator.py
@src/scraping/clients/sportybet.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BetPawa competition parsing (UAT-001 - Blocker)</name>
  <files>src/scraping/orchestrator.py</files>
  <action>
Fix `_get_betpawa_competitions` method to correctly parse the BetPawa API response.

Current (broken):
```python
regions = categories_data.get("regions", [])
```

The BetPawa API returns:
```json
{
  "withRegions": [
    {
      "category": {...},
      "regions": [
        {
          "region": {"id": "198", "name": "Hungary"},
          "competitions": [{"competition": {"id": "12335"...}}]
        }
      ]
    }
  ]
}
```

Fix to:
```python
with_regions = categories_data.get("withRegions", [])
if not with_regions:
    return competition_ids

regions = with_regions[0].get("regions", [])
```

Keep the rest of the method logic unchanged (iterating regions and extracting competition IDs).
  </action>
  <verify>
1. Run POST /scrape
2. Check BetPawa returns events_count > 0
3. Check logs show "Scraping N BetPawa competitions" where N > 0
  </verify>
  <done>BetPawa scraping returns events (events_count > 0 in scrape response)</done>
</task>

<task type="auto">
  <name>Task 2: Fix SportyBet health check endpoint (UAT-002 - Minor)</name>
  <files>src/scraping/clients/sportybet.py</files>
  <action>
Update `check_health` method to use a working endpoint.

Current endpoint `/api/ng/factsCenter/sportsMenu/list` returns 404.
The main event fetch endpoint `/api/ng/factsCenter/event` works fine.

Change the health check to use a simple event fetch with a known valid SportRadar ID,
or use the working base URL check:

Option A (simpler): Check if base URL responds
```python
response = await self._client.get(
    f"{BASE_URL}/api/ng/factsCenter/event",
    params={"eventId": "sr:match:1", "productId": "3"},
    headers=HEADERS,
    timeout=5.0,
)
# Any response (even error) means API is reachable
return response.status_code in (200, 400, 404)  # 400/404 = API working but no event
```

Option B: Just check base URL is reachable
```python
response = await self._client.head(f"{BASE_URL}", timeout=5.0)
return response.status_code < 500
```

Use Option A - it tests the actual API endpoint we'll use.
  </action>
  <verify>
1. Run GET /health
2. Check SportyBet shows status: "healthy" (not "unhealthy")
  </verify>
  <done>SportyBet health check reports "healthy" when API is functional</done>
</task>

</tasks>

<note>
**UAT-003 (Bet9ja scraping) - DEFERRED:**

Investigation shows the Bet9ja API (sports.bet9ja.com) is not reachable from the current environment (HTTP 000 - connection timeout). This is an external API availability issue, not a code bug.

The Bet9ja client code appears correct - it's the API itself that's unavailable. This may be:
- Geo-blocking (requires Nigerian IP)
- Temporary downtime
- Network/firewall restrictions

The error message is empty because the exception is caught at the orchestrator level and the `str(result)` of a timeout exception can be empty.

**Resolution:** Monitor Bet9ja API availability. If it becomes reachable, test the scraping flow. If geo-blocking is confirmed, consider VPN/proxy options.
</note>

<verification>
Before declaring plan complete:
- [ ] BetPawa scraping returns events (blocker fixed)
- [ ] SportyBet health check reports healthy
- [ ] No regressions in existing functionality
</verification>

<success_criteria>
- UAT-001 (Blocker): BetPawa events are scraped successfully
- UAT-002 (Minor): SportyBet reports healthy status
- UAT-003 (Major): Documented as external issue, deferred
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-cross-platform-scraping/06.1-01-FIX-SUMMARY.md`
</output>
