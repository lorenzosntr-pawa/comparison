---
phase: 85.1-historical-analysis-card-margins
plan: 01
type: execute
---

<objective>
Add opening/closing margins per market to Historical Analysis tournament cards.

Purpose: Enable users to see margin trends (opening→closing) directly on tournament cards without clicking into detail view, matching the data shown on Tournament Detail page.
Output: Tournament cards display opening→closing margin with delta for tracked markets.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency context)
@.planning/phases/85-time-to-kickoff-charts/85-02-SUMMARY.md

# Key source files
@web/src/features/historical-analysis/hooks/use-tournaments.ts
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
@web/src/features/historical-analysis/components/tournament-list.tsx

**Problem being solved:**
- Historical Analysis tournament cards show only avgMargin per market
- Tournament Detail page shows opening→closing margin with delta
- Users must click into detail view to see margin trends
- The calculation patterns already exist in useTournamentMarkets, need replication

**Established patterns to follow:**
- Time-sorted margin history: sort by kickoff ascending, first = opening, last = closing
- Delta calculation: closingMargin - openingMargin
- Display pattern: "Opening: X% → Y% (+/-delta%)" with color coding
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add opening/closing margins to MarginMetrics interface and useTournaments hook</name>
  <files>web/src/features/historical-analysis/hooks/use-tournaments.ts</files>
  <action>
1. Extend MarginMetrics interface to add:
   - openingMargin: number | null
   - closingMargin: number | null
   - marginDelta: number | null

2. Update MarketAccumulatorData to track margin history:
   - Already has eventMargins array with { kickoff, margin } - reuse this

3. In the final conversion loop (line ~270), calculate opening/closing:
   - Sort eventMargins by kickoff ascending (already done for trend calculation)
   - openingMargin = first element's margin (or null if empty)
   - closingMargin = last element's margin (or null if empty)
   - marginDelta = closingMargin - openingMargin (or null if either is null)

Note: The eventMargins array is already populated during extraction (lines 243-246), so no changes needed there. Just add the calculation in the final conversion.
  </action>
  <verify>TypeScript compiles without errors: `cd web && npx tsc --noEmit`</verify>
  <done>MarginMetrics interface has openingMargin, closingMargin, marginDelta fields; useTournaments hook calculates these from kickoff-sorted margin history</done>
</task>

<task type="auto">
  <name>Task 2: Update MarketBreakdown to show opening→closing margins on tournament cards</name>
  <files>web/src/features/historical-analysis/components/tournament-list.tsx</files>
  <action>
1. Update MarketBreakdown component to display opening→closing when available:
   - For each tracked market, if openingMargin and closingMargin are not null:
     - Show: "Opening: X.X% → Y.Y% (±delta%)"
     - Color delta: green if negative (improved), red if positive (worsened), muted if zero
   - If opening/closing not available, fall back to showing avgMargin only

2. Layout approach (match Tournament Detail card pattern from tournament-detail.tsx lines 79-89):
   - Small text (text-xs) above the avgMargin line
   - Format: "Opening: {opening}% → {closing}% ({delta}%)"
   - Delta sign: + for positive, no sign for negative (already negative)

3. Keep MarginBadge component for avgMargin display (no change needed)

4. Import nothing new - use existing patterns from the file
  </action>
  <verify>Run dev server and navigate to Historical Analysis page - tournament cards should show opening→closing margins for tracked markets that have data; verify layout matches Tournament Detail cards</verify>
  <done>Tournament cards display opening→closing margin with delta for tracked markets; layout consistent with Tournament Detail page cards</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] Historical Analysis page loads without errors
- [ ] Tournament cards show opening→closing margins for markets with data
- [ ] Delta coloring: green for negative (improved), red for positive (worsened)
- [ ] Markets without opening/closing data show avgMargin only (graceful fallback)
</verification>

<success_criteria>
- MarginMetrics interface extended with opening/closing fields
- useTournaments calculates opening/closing from kickoff-sorted margin history
- Tournament cards display opening→closing with colored delta
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/85.1-historical-analysis-card-margins/85.1-01-SUMMARY.md`:

# Phase 85.1 Plan 01: Historical Analysis Card Margins Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Key decisions and rationale]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Phase Readiness
- [Ready for Phase 86 or any blockers]
</output>
