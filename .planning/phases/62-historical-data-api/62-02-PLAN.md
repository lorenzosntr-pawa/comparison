---
phase: 62-historical-data-api
plan: 02
type: execute
---

<objective>
Implement historical data API endpoints for querying snapshot, odds, and margin history.

Purpose: Enable frontend to fetch time-series data for odds movement visualization and margin tracking.
Output: New history router with 3 endpoints registered in the API.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-investigation-schema-design/DISCOVERY.md
@.planning/phases/62-historical-data-api/62-01-SUMMARY.md

# Key files:
@src/api/routes/events.py
@src/api/routes/__init__.py
@src/matching/schemas.py
@src/db/models/odds.py

# Established patterns from events.py:
# - FastAPI router with prefix and tags
# - Async SQLAlchemy with selectinload for eager loading
# - Query params: Query(default=..., description=...)
# - Time filtering with naive UTC datetimes (DB stores naive)
# - Margin calculation: (sum(1/odds) - 1) * 100

# Query patterns from DISCOVERY.md:
# 1. Snapshot list: SELECT id, captured_at, COUNT(markets) FROM odds_snapshots WHERE event_id=? GROUP BY id
# 2. Odds trend: JOIN odds_snapshots + market_odds WHERE event_id=? AND market_id=? ORDER BY captured_at
# 3. Margin history: Same as odds trend, calculate margin from outcomes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history router with snapshot history endpoint</name>
  <files>src/api/routes/history.py, src/api/routes/__init__.py</files>
  <action>
Create new router file `src/api/routes/history.py`:

1. Imports:
   - FastAPI: APIRouter, Depends, HTTPException, Query
   - SQLAlchemy: select, func, desc
   - datetime, structlog
   - Database models: OddsSnapshot, MarketOdds, Bookmaker, Event
   - Schemas: HistoricalSnapshot, SnapshotHistoryResponse, OddsHistoryResponse, OddsHistoryPoint, MarginHistoryResponse, MarginHistoryPoint, OutcomeOdds

2. Router setup:
   ```python
   router = APIRouter(prefix="/events", tags=["history"])
   ```

3. Implement `GET /events/{event_id}/history`:
   - Query params:
     - bookmaker_slug: str | None (filter by bookmaker)
     - from_time: datetime | None (start of time range)
     - to_time: datetime | None (end of time range)
     - page: int = 1
     - page_size: int = 100 (max 500)

   - Query logic:
     ```python
     # Base query with market count subquery
     market_count_subq = (
         select(MarketOdds.snapshot_id, func.count().label("market_count"))
         .group_by(MarketOdds.snapshot_id)
         .subquery()
     )

     query = (
         select(OddsSnapshot, Bookmaker, market_count_subq.c.market_count)
         .join(Bookmaker, OddsSnapshot.bookmaker_id == Bookmaker.id)
         .outerjoin(market_count_subq, OddsSnapshot.id == market_count_subq.c.snapshot_id)
         .where(OddsSnapshot.event_id == event_id)
     )

     # Apply filters
     if bookmaker_slug:
         query = query.where(Bookmaker.slug == bookmaker_slug)
     if from_time:
         query = query.where(OddsSnapshot.captured_at >= from_time.replace(tzinfo=None))
     if to_time:
         query = query.where(OddsSnapshot.captured_at <= to_time.replace(tzinfo=None))

     # Order and paginate
     query = query.order_by(desc(OddsSnapshot.captured_at))
     ```

   - Return SnapshotHistoryResponse with list of HistoricalSnapshot

4. Register router in `src/api/routes/__init__.py`:
   - Import: `from src.api.routes.history import router as history_router`
   - Add to router includes (after events_router)
  </action>
  <verify>curl -s "http://localhost:8000/api/events/1/history" | python -m json.tool | head -20</verify>
  <done>GET /events/{event_id}/history returns paginated snapshot list with market counts</done>
</task>

<task type="auto">
  <name>Task 2: Add market odds history and margin history endpoints</name>
  <files>src/api/routes/history.py</files>
  <action>
Add two more endpoints to the history router:

1. `GET /events/{event_id}/markets/{market_id}/history` - Odds trend with margin:
   - Query params:
     - bookmaker_slug: str (required - need to specify which bookmaker)
     - from_time: datetime | None
     - to_time: datetime | None

   - Query logic:
     ```python
     # Get bookmaker ID
     bookmaker = await db.execute(select(Bookmaker).where(Bookmaker.slug == bookmaker_slug))
     bookmaker = bookmaker.scalar_one_or_none()
     if not bookmaker:
         raise HTTPException(404, f"Bookmaker not found: {bookmaker_slug}")

     # Query snapshots with this market
     query = (
         select(OddsSnapshot, MarketOdds)
         .join(MarketOdds, MarketOdds.snapshot_id == OddsSnapshot.id)
         .where(OddsSnapshot.event_id == event_id)
         .where(OddsSnapshot.bookmaker_id == bookmaker.id)
         .where(MarketOdds.betpawa_market_id == market_id)
     )

     # Apply time filters, order by captured_at ASC for chronological chart data
     query = query.order_by(OddsSnapshot.captured_at)
     ```

   - Build response:
     - For each row, parse outcomes from JSONB
     - Calculate margin: `sum(1/odds for each outcome) - 1) * 100`
     - Return OddsHistoryResponse with list of OddsHistoryPoint

2. `GET /events/{event_id}/markets/{market_id}/margin-history` - Margin-only (lighter response):
   - Same query params as odds history
   - Same query logic
   - Return MarginHistoryResponse with list of MarginHistoryPoint (just captured_at + margin)
   - This is a lighter response for margin-only charts (no outcomes array)

Helper function for margin calculation (reuse from events.py pattern):
```python
def _calculate_margin_from_outcomes(outcomes: list) -> float | None:
    """Calculate margin from JSONB outcomes array."""
    if not outcomes:
        return None
    try:
        total_implied = sum(1.0 / o["odds"] for o in outcomes if o.get("odds", 0) > 0)
        if total_implied == 0:
            return None
        return round((total_implied - 1) * 100, 2)
    except (KeyError, TypeError, ZeroDivisionError):
        return None
```

Error handling:
- 404 if event not found
- 404 if bookmaker not found
- Return empty history list if no data (not 404)
  </action>
  <verify>curl -s "http://localhost:8000/api/events/1/markets/3743/history?bookmaker_slug=betpawa" | python -m json.tool | head -30</verify>
  <done>Both /markets/{market_id}/history and /markets/{market_id}/margin-history endpoints return chronological time-series data</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] History router created at src/api/routes/history.py
- [ ] Router registered in src/api/routes/__init__.py
- [ ] GET /events/{event_id}/history returns snapshot list
- [ ] GET /events/{event_id}/markets/{market_id}/history returns odds time-series
- [ ] GET /events/{event_id}/markets/{market_id}/margin-history returns margin time-series
- [ ] All endpoints handle time range filtering
- [ ] All endpoints handle bookmaker filtering
- [ ] No TypeScript/Python errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- API endpoints respond with correct schema
- Time-series data ordered chronologically for chart consumption
- Phase 62 complete
</success_criteria>

<output>
After completion, create `.planning/phases/62-historical-data-api/62-02-SUMMARY.md`
</output>
