---
phase: 104-monitoring-prevention
plan: 03
type: execute
domain: full-stack
---

<objective>
Add growth alerting to detect and display abnormal database growth patterns.

Purpose: Proactively warn operators when database grows faster than expected, preventing storage issues.
Output: Growth detection in sampling job, StorageAlert model, alerts API, and alerts display on Storage page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/104-monitoring-prevention/104-01-SUMMARY.md
@.planning/phases/104-monitoring-prevention/104-02-SUMMARY.md

**Existing infrastructure:**
@src/db/models/storage_sample.py - StorageSample model (from Plan 01)
@src/scheduling/jobs.py - sample_storage_sizes job (from Plan 01)
@web/src/features/storage/index.tsx - Storage page (from Plan 02)

**Key decisions from prior phases:**
- structlog for logging with bound context
- Pydantic v2 for schemas
- TanStack Query for frontend data fetching
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add growth detection and alert storage</name>
  <files>src/db/models/storage_alert.py, src/db/models/__init__.py, src/scheduling/jobs.py, src/api/routes/storage.py, src/api/schemas/storage.py, alembic/versions/xxx_add_storage_alerts.py</files>
  <action>
1. Create src/db/models/storage_alert.py:
   - StorageAlert model:
     - id: primary key
     - created_at: datetime with server_default=func.now()
     - alert_type: str ("growth_warning", "size_critical")
     - message: str (human-readable description)
     - current_bytes: int
     - previous_bytes: int
     - growth_percent: float
     - resolved_at: datetime | None (null until dismissed)
   - Follow CleanupRun pattern

2. Export in src/db/models/__init__.py

3. Create Alembic migration:
   - Run: alembic revision --autogenerate -m "add storage_alerts"

4. Update sample_storage_sizes() in src/scheduling/jobs.py:
   - After creating StorageSample, check for growth alert conditions:
     - Query previous sample (most recent before this one)
     - Calculate growth_percent = ((current - previous) / previous) * 100
     - If growth_percent > 20% (configurable threshold): create growth_warning alert
     - If total_bytes > 50 GB (configurable): create size_critical alert
   - Log alerts with structlog.warning()
   - Keep last 30 alerts, delete older resolved ones

5. Add alerts endpoints to src/api/routes/storage.py:
   - GET /api/storage/alerts: Return active (unresolved) alerts
   - POST /api/storage/alerts/{id}/resolve: Mark alert as resolved (set resolved_at)

6. Add schemas to src/api/schemas/storage.py:
   - StorageAlertResponse: id, created_at, alert_type, message, growth_percent, resolved_at
   - StorageAlertsResponse: alerts (list), count

Growth thresholds (add to Settings model if not already, or use constants):
- GROWTH_WARNING_PERCENT = 20 (20% growth in 24h triggers warning)
- SIZE_CRITICAL_BYTES = 50 * 1024**3 (50 GB triggers critical alert)
  </action>
  <verify>
1. alembic upgrade head succeeds
2. Manually trigger sample_storage_sizes() and verify alert creation with threshold exceeded
3. GET /api/storage/alerts returns alerts list
4. POST /api/storage/alerts/{id}/resolve marks alert resolved
  </verify>
  <done>
- StorageAlert model created and migrated
- Growth detection logic in sampling job
- Alerts API endpoints working
  </done>
</task>

<task type="auto">
  <name>Task 2: Add alerts display to Storage page</name>
  <files>web/src/features/storage/hooks/use-storage.ts, web/src/features/storage/components/alerts-banner.tsx, web/src/features/storage/components/index.ts, web/src/features/storage/index.tsx</files>
  <action>
1. Update web/src/features/storage/hooks/use-storage.ts:
   - Add useStorageAlerts(): TanStack Query hook for GET /api/storage/alerts
   - Add useResolveAlert(): Mutation hook for POST /api/storage/alerts/{id}/resolve
   - Type definitions for StorageAlert

2. Create web/src/features/storage/components/alerts-banner.tsx:
   - AlertsBanner component showing active alerts at top of Storage page
   - Alert styling:
     - growth_warning: Yellow/amber background with warning icon
     - size_critical: Red background with alert icon
   - Each alert shows: message, growth percentage, timestamp, Dismiss button
   - Dismiss button calls useResolveAlert mutation
   - Use Badge component for alert type indicator
   - Empty state: Show nothing (no banner) when no alerts

3. Export in web/src/features/storage/components/index.ts

4. Update web/src/features/storage/index.tsx:
   - Add AlertsBanner at the very top (before title)
   - Pass alerts data and resolve handler
   - Show count badge next to page title if alerts exist: "Storage (2 alerts)"

UI behavior:
- Alerts banner only visible when active alerts exist
- Dismissing an alert removes it from banner immediately (optimistic update)
- Use TanStack Query invalidation after resolve mutation
  </action>
  <verify>
1. Navigate to /storage
2. If alerts exist, yellow/red banner appears at top
3. Clicking Dismiss on an alert removes it
4. Alert count in title updates
  </verify>
  <done>
- Alerts banner displays active storage alerts
- Dismiss functionality resolves alerts
- Visual distinction between warning and critical alerts
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] StorageAlert model exists in database
- [ ] Growth detection runs during storage sampling
- [ ] GET /api/storage/alerts returns alerts
- [ ] Alert banner appears on Storage page when alerts exist
- [ ] Dismiss resolves alerts and updates UI
- [ ] No TypeScript/Python errors
</verification>

<success_criteria>

- All tasks completed
- Abnormal growth triggers alerts automatically
- Operators can see and dismiss alerts on Storage page
- No errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/104-monitoring-prevention/104-03-SUMMARY.md`
</output>
