---
phase: 52-polish-integration
plan: 01
type: execute
---

<objective>
Polish event details UX by extracting shared utilities, aligning summary categories with tab system, and improving empty state handling.

Purpose: Ensure all v1.9 features work together consistently and provide clear feedback in edge cases.
Output: Cleaner code with shared utilities, consistent category display, and better UX messaging.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v1.9 Phase Summaries (dependency graph):
@.planning/phases/48-event-summary-redesign/48-01-FIX2-SUMMARY.md
@.planning/phases/49-market-grouping/49-01-FIX2-SUMMARY.md
@.planning/phases/50-market-filtering/50-01-SUMMARY.md
@.planning/phases/51-navigation-ux/51-01-FIX-SUMMARY.md

# Key source files:
@web/src/features/matches/components/market-grid.tsx
@web/src/features/matches/components/summary-section.tsx
@web/src/features/matches/components/market-filter-bar.tsx

**Established patterns:**
- Market deduplication: mergeMarketOutcomes() merges split outcomes
- Tab filtering: markets have market_groups array, checked with .includes()
- Fuzzy search: subsequence matching for intuitive partial queries

**Issues being addressed:**
- Code duplication: mergeMarketOutcomes() copied between files
- Category mismatch: Summary uses keyword heuristics, tabs use actual market_groups
- Confusing empty state: "No markets in this category" shown even for search misses
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared market utilities</name>
  <files>web/src/features/matches/lib/market-utils.ts (new), web/src/features/matches/components/market-grid.tsx, web/src/features/matches/components/summary-section.tsx</files>
  <action>
Create new file `web/src/features/matches/lib/market-utils.ts` with:
1. `mergeMarketOutcomes(existing, incoming)` - merge outcomes from split market records
2. `buildDeduplicatedMarkets(marketsByBookmaker)` - build Map<slug, Map<key, MarketOddsDetail>>
3. `marketHasOdds(market)` - check if market has active outcomes with odds > 0
4. Export types needed by consumers

Update market-grid.tsx:
- Remove local mergeMarketOutcomes function
- Import from '../lib/market-utils'
- Use shared function in buildUnifiedMarkets

Update summary-section.tsx:
- Remove local mergeMarketOutcomes, buildDeduplicatedMarkets, marketHasOdds functions
- Import from '../lib/market-utils'
- Use shared functions in useMemo hooks

WHY: Eliminates 80+ lines of duplicated code, ensures consistent deduplication logic.
  </action>
  <verify>npm run build passes, no TypeScript errors, both components render correctly</verify>
  <done>Shared utilities in lib/market-utils.ts, both components import and use them, no duplicated functions</done>
</task>

<task type="auto">
  <name>Task 2: Align summary categories with tab system</name>
  <files>web/src/features/matches/components/summary-section.tsx</files>
  <action>
Replace keyword-based category detection with actual market_groups from data:

1. Remove `getMarketCategory()` function (keyword heuristics)
2. Remove `CATEGORY_LABELS` constant (Main/Goals/Handicaps/Other)
3. Update `calculateCompetitiveStats()` to:
   - Track stats by actual market_groups from market.market_groups array
   - Build category breakdown from groups present in data
   - Use same tab names as market-grid (Popular, Goals, Handicaps, Combos, Halves, Corners, Cards, Specials, Other)

4. Update category breakdown display:
   - Use TAB_NAMES mapping (import or duplicate from market-grid constants)
   - Filter to only show groups with outcomes > 0
   - Maintain color coding (green >= 60%, yellow 40-60%, red < 40%)

WHY: Summary and tabs now show consistent categories. User sees "Popular: 65%" in summary and clicks "Popular" tab - same markets. Currently summary shows "Main: X%" but there's no "Main" tab.
  </action>
  <verify>npm run build passes, summary shows same category names as tabs (Popular, Goals, etc. not Main)</verify>
  <done>Summary category breakdown uses actual market_groups, category names match tab names</done>
</task>

<task type="auto">
  <name>Task 3: Improve empty state messaging</name>
  <files>web/src/features/matches/components/market-grid.tsx</files>
  <action>
Update empty state handling in MarketGrid to provide context-aware messages:

1. After the table, update the empty state condition:
   - Currently: shows "No markets in this category" only if `activeTab !== 'all'`
   - Change to show different messages based on what filters are active:

```tsx
{filteredMarkets.length === 0 && (
  <div className="text-center py-4 text-muted-foreground text-sm">
    {searchQuery && activeTab !== 'all'
      ? `No markets matching "${searchQuery}" in ${TAB_NAMES[activeTab] ?? activeTab}`
      : searchQuery
        ? `No markets matching "${searchQuery}"`
        : activeTab !== 'all'
          ? `No markets in ${TAB_NAMES[activeTab] ?? activeTab}`
          : 'No markets available'}
  </div>
)}
```

2. Update MarketFilterBar to show clear button when search has text:
   - Add X button inside search input when searchQuery is not empty
   - Clicking X clears the search

WHY: User knows exactly why no results shown - is it the search query, the tab filter, or both?
  </action>
  <verify>npm run build passes, search "xyz" shows "No markets matching 'xyz'", search in Goals tab shows combined message, clear button works</verify>
  <done>Context-aware empty state messages, search has clear button when active</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` in web/ succeeds without errors
- [ ] No TypeScript errors
- [ ] market-utils.ts exports shared functions
- [ ] market-grid.tsx and summary-section.tsx import from shared module
- [ ] Summary category names match tab names (Popular, Goals, etc.)
- [ ] Empty states show context-appropriate messages
- [ ] Search clear button appears and works
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No duplicated code between market-grid and summary-section
- Summary categories align with tab categories
- Empty states provide actionable feedback
- v1.9 Event Details UX milestone complete
  </success_criteria>

<output>
After completion, create `.planning/phases/52-polish-integration/52-01-SUMMARY.md`:

# Phase 52 Plan 01: Polish & Integration Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `web/src/features/matches/lib/market-utils.ts` - Shared market utilities
- `web/src/features/matches/components/market-grid.tsx` - Uses shared utils, improved empty states
- `web/src/features/matches/components/summary-section.tsx` - Uses shared utils, aligned categories
- `web/src/features/matches/components/market-filter-bar.tsx` - Search clear button

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

v1.9 Event Details UX milestone complete. Ready for /gsd:complete-milestone.
</output>
