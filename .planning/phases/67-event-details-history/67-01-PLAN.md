---
phase: 67-event-details-history
plan: 01
type: execute
---

<objective>
Add click handlers on odds/margins in Event Details page to open history dialog.

Purpose: Enable users to view historical odds/margin movements by clicking any odds or margin value in the Event Details market grid.
Output: Clickable OddsBadge and MarginIndicator components that open HistoryDialog with market and bookmaker context.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 66 - same pattern):
@.planning/phases/66-odds-comparison-history/66-01-SUMMARY.md
@.planning/phases/66-odds-comparison-history/66-02-SUMMARY.md

# Source files to modify:
@web/src/features/matches/components/odds-badge.tsx
@web/src/features/matches/components/margin-indicator.tsx
@web/src/features/matches/components/market-row.tsx
@web/src/features/matches/components/market-grid.tsx
@web/src/features/matches/index.tsx

# Reference implementation (Phase 66 pattern):
@web/src/features/matches/components/match-table.tsx
@web/src/features/matches/components/history-dialog.tsx

**Established patterns from Phase 66:**
- onClick prop on value components with e.stopPropagation
- cursor-pointer + hover:ring-1 hover:ring-primary/50 visual feedback
- HistoryDialogState type with eventId, marketId, bookmakerSlug, marketName, bookmakerName, allBookmakers
- useState hook for dialog state, setHistoryDialog click handlers
- BOOKMAKER_NAMES constant for full bookmaker display names
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onClick prop to OddsBadge and MarginIndicator</name>
  <files>web/src/features/matches/components/odds-badge.tsx, web/src/features/matches/components/margin-indicator.tsx</files>
  <action>
Add onClick prop to both components following the MatchTable pattern:

**OddsBadge (odds-badge.tsx):**
- Add `onClick?: (e: React.MouseEvent) => void` to OddsBadgeProps interface
- Add onClick handler to the span element: `onClick={(e) => onClick?.(e)}`
- Add conditional styling: `onClick && 'cursor-pointer hover:ring-1 hover:ring-primary/50'`

**MarginIndicator (margin-indicator.tsx):**
- Add `onClick?: (e: React.MouseEvent) => void` to MarginIndicatorProps interface
- The component uses TooltipTrigger with asChild, so wrap content in a span or add onClick to the inner span
- Add onClick handler: `onClick={(e) => { e.stopPropagation(); onClick?.(e) }}`
- Add conditional styling: `onClick && 'cursor-pointer hover:ring-1 hover:ring-primary/50'`
- Note: Need stopPropagation inside the component since tooltip might interfere

Keep existing styling and functionality unchanged.
  </action>
  <verify>TypeScript compiles without errors: `cd web && npx tsc --noEmit`</verify>
  <done>Both components accept optional onClick prop and show pointer cursor with hover ring when clickable</done>
</task>

<task type="auto">
  <name>Task 2: Wire up HistoryDialog in MarketGrid and MarketRow</name>
  <files>web/src/features/matches/components/market-grid.tsx, web/src/features/matches/components/market-row.tsx, web/src/features/matches/index.tsx</files>
  <action>
**MarketRow (market-row.tsx):**
Add props for click handling:
- Add `eventId: number` prop (needed for dialog)
- Add `onOddsClick?: (bookmakerSlug: string, marketId: string, marketName: string) => void` prop
- Add `onMarginClick?: (bookmakerSlug: string, marketId: string, marketName: string) => void` prop
- Pass onClick to OddsBadge: `onClick={onOddsClick ? (e) => { e.stopPropagation(); onOddsClick(slug, market.betpawa_market_id, displayName) } : undefined}`
- Pass onClick to MarginIndicator: `onClick={onMarginClick ? (e) => { e.stopPropagation(); onMarginClick(slug, market.betpawa_market_id, displayName) } : undefined}`
- Only set onClick when odds/margin is not null and bookmaker exists

**MarketGrid (market-grid.tsx):**
Add HistoryDialog state and handlers:
- Import HistoryDialog and BookmakerInfo from './history-dialog'
- Import useParams from 'react-router' to get eventId
- Add BOOKMAKER_NAMES constant (same as match-table.tsx): `{ betpawa: 'BetPawa', sportybet: 'SportyBet', bet9ja: 'Bet9ja' }`
- Add HistoryDialogState interface and useState hook
- Create handler function for clicks:
```tsx
const handleOddsClick = (bookmakerSlug: string, marketId: string, marketName: string) => {
  // Build allBookmakers from marketsByBookmaker
  const allBookmakers = marketsByBookmaker
    .filter((bm) => bm.markets.length > 0)
    .map((bm) => ({
      slug: bm.bookmaker_slug,
      name: BOOKMAKER_NAMES[bm.bookmaker_slug] ?? bm.bookmaker_slug,
    }))
  setHistoryDialog({
    eventId,
    marketId,
    bookmakerSlug,
    marketName,
    bookmakerName: BOOKMAKER_NAMES[bookmakerSlug] ?? bookmakerSlug,
    allBookmakers,
  })
}
```
- Pass eventId, onOddsClick, onMarginClick to each MarketRow
- Render HistoryDialog at end of component (same pattern as MatchTable)

**MatchDetail (index.tsx):**
- Pass eventId to MarketGrid: `<MarketGrid marketsByBookmaker={event.markets_by_bookmaker} eventId={eventId} />`
- Update MarketGridProps to accept `eventId: number`
  </action>
  <verify>
1. `cd web && npx tsc --noEmit` passes
2. `cd web && npm run build` succeeds
  </verify>
  <done>Clicking odds/margin values in Event Details page opens HistoryDialog with correct market and bookmaker context</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes without errors
- [ ] `cd web && npm run build` succeeds
- [ ] Dev server shows clickable odds/margins in Event Details page
- [ ] Clicking an odds value opens HistoryDialog with correct market name
- [ ] Clicking a margin value opens HistoryDialog with correct market name
- [ ] Comparison mode toggle works in the dialog
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or build errors
- OddsBadge and MarginIndicator components have onClick prop
- Event Details page (MarketGrid) shows clickable odds/margins
- HistoryDialog opens with correct context when clicking any odds/margin cell
</success_criteria>

<output>
After completion, create `.planning/phases/67-event-details-history/67-01-SUMMARY.md`:

# Phase 67 Plan 01: Event Details History Summary

**[Substantive one-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Task Commits

Each task was committed atomically:

1. **Task 1: [description]** - `[hash]` (type)
2. **Task 2: [description]** - `[hash]` (type)

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any deviations, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 67 complete
- Ready for Phase 68: Market-Level History View
</output>
