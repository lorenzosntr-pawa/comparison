---
phase: 15-full-event-scraping
plan: 15-01-FIX2
type: fix
---

<objective>
Fix 2 UAT issues from plan 15-01.

Source: 15-01-ISSUES.md
Priority: 0 critical, 1 major, 1 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15-full-event-scraping/15-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/15-full-event-scraping/15-01-PLAN.md

**Affected files:**
@src/scraping/clients/bet9ja.py
@src/scraping/competitor_events.py
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-002: Bet9ja fetch_event accepts wrong response code</name>
  <files>src/scraping/clients/bet9ja.py</files>
  <action>
The Bet9ja individual event endpoint (`GetEvent`) returns `"R": "OK"` for success, but the current code on line 96 only checks for `"R": "D"`. This causes every Bet9ja event fetch to fail with ApiError.

Change line 96 from:
```python
if result_code == "D":
```
to:
```python
if result_code in ("D", "OK"):
```

Also update the error message on line 113 to reflect both valid codes:
```python
f"API returned R='{result_code}' for event {event_id}, expected 'D' or 'OK'"
```
  </action>
  <verify>
1. Run a manual test: call fetch_event with a valid Bet9ja event ID
2. Verify it returns data with `"O"` odds dict
3. Confirm no ApiError is raised for valid events
  </verify>
  <done>Bet9ja fetch_event successfully returns event data when API responds with "R": "OK"</done>
</task>

<task type="auto">
  <name>Investigate UAT-003: SportyBet SR ID linking discrepancy</name>
  <files>src/scraping/competitor_events.py</files>
  <action>
Investigate why SportyBet events have fewer betpawa_event_id links than Bet9ja for the same SR IDs.

1. Check `_parse_sportybet_event` (lines 139-190):
   - Line 159: `sportradar_id = event_id.replace("sr:match:", "")` - extracts just the numeric ID

2. Check `_parse_bet9ja_event` (lines 192-243):
   - Line 207-208: Uses `EXTID` field directly

3. Compare against betpawa Event.sportradar_id format:
   - Query a betpawa event to see if it stores "12345678" or "sr:match:12345678"

4. If formats differ:
   - Normalize SportyBet's parsed sportradar_id to match betpawa's format
   - OR normalize Bet9ja's EXTID to match

5. If formats match:
   - Investigate timing: are SportyBet events processed before betpawa events exist?
   - Check if _get_betpawa_event_by_sr_id query is correct

Document findings and fix if root cause is identified. If timing issue (events don't exist yet), document as expected behavior.
  </action>
  <verify>
1. After fix (if applicable), run scrape-competitor-events
2. Compare betpawa_event_id counts between sportybet and bet9ja
3. Verify same SR IDs are now linked in both platforms
  </verify>
  <done>Root cause identified and fixed, OR documented as expected behavior if no code fix needed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-002 fixed: Bet9ja events return markets after scrape
- [ ] UAT-003 addressed: Root cause identified/fixed or documented
- [ ] API test: POST /api/scheduler/scrape-competitor-events returns non-zero markets for both platforms
</verification>

<success_criteria>
- All UAT issues from 15-01-ISSUES.md addressed
- Bet9ja market count > 0 after scraping
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/15-full-event-scraping/15-01-FIX2-SUMMARY.md`
</output>
