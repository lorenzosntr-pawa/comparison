---
phase: 79-investigation
plan: 01
type: execute
---

<objective>
Root cause analysis for specifier bug in historical data queries.

Purpose: Document exactly why historical data for Over/Under and Handicap markets returns mixed data from different specifier lines, enabling Phase 80 to implement targeted fixes.
Output: Bug report documenting root cause, data flow, affected code, SQL evidence, and proposed fixes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@src/api/routes/history.py
@src/db/models/odds.py
@web/src/features/matches/components/history-dialog.tsx
@web/src/features/matches/hooks/use-odds-history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SQL verification of specifier data mixing</name>
  <files>.planning/phases/79-investigation/BUG-REPORT.md</files>
  <action>
Run SQL queries against the database to demonstrate the specifier bug:

1. Query showing Over/Under markets stored with different line values:
```sql
SELECT DISTINCT betpawa_market_id, betpawa_market_name, line
FROM market_odds
WHERE betpawa_market_id IN ('4', '5', '6')  -- Over/Under market IDs
ORDER BY betpawa_market_id, line;
```

2. Query showing history API would return mixed data for a single market:
```sql
SELECT s.captured_at, m.betpawa_market_id, m.betpawa_market_name, m.line
FROM odds_snapshots s
JOIN market_odds m ON m.snapshot_id = s.id
WHERE s.event_id = (SELECT id FROM events LIMIT 1)
AND m.betpawa_market_id = '4'  -- Total Goals Over/Under
ORDER BY s.captured_at;
```

Document findings showing that line values vary but would all be returned together.
  </action>
  <verify>BUG-REPORT.md contains SQL output showing multiple different line values for the same market_id within a single event's history</verify>
  <done>SQL evidence section complete with annotated query results</done>
</task>

<task type="auto">
  <name>Task 2: Document affected code paths and write bug report</name>
  <files>.planning/phases/79-investigation/BUG-REPORT.md</files>
  <action>
Complete BUG-REPORT.md with:

**Root Cause Analysis:**
1. Backend: `src/api/routes/history.py` lines 253 and 273 filter by `betpawa_market_id` only, not `line` or handicap values
2. Frontend: `HistoryDialog` props (line 64) accept only `marketId`, not `line`
3. Hooks: `useOddsHistory` (line 38-51) doesn't have `line` parameter
4. API: `api.getOddsHistory()` doesn't accept `line` parameter

**Data Flow Trace:**
```
User clicks "Over 2.5" odds badge
  → HistoryDialog opened with marketId="4" (NO line value passed)
    → useOddsHistory({ marketId: "4", ... })
      → GET /api/events/{id}/markets/4/history?bookmaker_slug=betpawa
        → SQL: WHERE betpawa_market_id = "4" (NO line filter)
          → Returns ALL Over/Under rows: 2.5, 3.5, 4.5, etc. MIXED
```

**Impact:**
- Over/Under charts show nonsensical mixed data (1.5, 2.5, 3.5 lines combined)
- Handicap charts mix different handicap values
- Margin calculations incorrect (comparing different lines)
- Charts unreadable and misleading

**Proposed Fix (Phase 80):**
1. Add `line` query parameter to history API endpoints
2. Add `line` prop to HistoryDialog
3. Add `line` to useOddsHistory hook params
4. Update API client to pass line parameter
5. Add `line` filter to SQL WHERE clause when provided

**Files Requiring Changes:**
- `src/api/routes/history.py` - Add line filter to queries
- `src/matching/schemas.py` - No change (already returns line)
- `web/src/features/matches/hooks/use-odds-history.ts` - Add line param
- `web/src/features/matches/hooks/use-margin-history.ts` - Add line param
- `web/src/features/matches/components/history-dialog.tsx` - Accept line prop
- `web/src/lib/api.ts` - Add line to getOddsHistory/getMarginHistory
- Callers of HistoryDialog - Pass line value
  </action>
  <verify>BUG-REPORT.md contains complete root cause, data flow, impact, proposed fix, and files list</verify>
  <done>Bug report is comprehensive enough to guide Phase 80 implementation without additional investigation</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] BUG-REPORT.md exists with all sections
- [ ] SQL evidence demonstrates the specifier mixing
- [ ] All affected code paths are documented
- [ ] Proposed fix is specific and actionable
- [ ] Files requiring changes are listed
</verification>

<success_criteria>

- Investigation complete with documented root cause
- SQL evidence proves the bug exists
- Phase 80 can implement fix without further investigation
- Bug report committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/79-investigation/79-01-SUMMARY.md`:

# Phase 79 Plan 01: Investigation Summary

**[One-liner summarizing findings]**

## Accomplishments

- Root cause identified
- SQL evidence gathered
- Fix approach documented

## Files Created/Modified

- `.planning/phases/79-investigation/BUG-REPORT.md` - Complete bug analysis

## Decisions Made

[Any decisions about approach]

## Issues Encountered

[Problems during investigation, or "None"]

## Next Step

Ready for Phase 80: Specifier Bug Fix
</output>
