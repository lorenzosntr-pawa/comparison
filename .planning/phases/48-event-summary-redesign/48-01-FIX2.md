---
phase: 48-event-summary-redesign
plan: 48-01-FIX2
type: fix
---

<objective>
Fix 1 UAT issue from plan 48-01 re-verification.

Source: 48-01-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/48-event-summary-redesign/48-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/48-event-summary-redesign/48-01-PLAN.md

**Previous fix plan:**
@.planning/phases/48-event-summary-redesign/48-01-FIX.md

**Source of deduplication logic:**
@web/src/features/matches/components/market-grid.tsx
</context>

<tasks>
<task type="auto">
  <name>Fix UAT-006: Apply market deduplication before counting</name>
  <files>web/src/features/matches/components/summary-section.tsx</files>
  <action>
The root cause is that `summary-section.tsx` operates on raw API data, while `market-grid.tsx` deduplicates/merges markets with the same ID.

**Fix approach:**
1. Extract the `mergeMarketOutcomes()` function from `market-grid.tsx` into a shared utility (or copy it)
2. In `calculateMarketCoverage()`, build a deduplicated market map BEFORE counting:
   - Create a Map keyed by `${market.betpawa_market_id}_${market.line ?? 'null'}`
   - Merge outcomes for duplicate keys (same logic as market-grid.tsx)
   - Count only the deduplicated markets that pass `marketHasOdds()`

3. Apply same deduplication to `calculateCompetitiveStats()` which also needs accurate counts

**Key insight from market-grid.tsx (lines 72-97):**
- Markets can have same ID but split outcomes
- The grid merges them with `mergeMarketOutcomes()`
- Summary needs identical treatment

**Implementation:**
Add a `buildDeduplicatedMarkets()` helper that:
1. Takes `BookmakerMarketData[]`
2. For each bookmaker, creates deduplicated Map of markets (merge same ID+line)
3. Returns `Map<string, Map<string, MarketOddsDetail>>` (bookmaker -> market key -> market)

Use this deduplicated structure in both `calculateMarketCoverage()` and `calculateCompetitiveStats()`.
  </action>
  <verify>
1. `npm run build` in web/ succeeds
2. Navigate to event details page
3. Verify Betpawa market count matches visible markets with odds
  </verify>
  <done>
- Betpawa market count only reflects unique markets with actual odds
- Count matches what user sees in the market grid
- UAT-006 resolved
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Market Coverage card shows accurate counts
- [ ] Count matches visible markets in grid
</verification>

<success_criteria>
- UAT-006 from 48-01-ISSUES.md addressed
- Market counts accurate and match grid display
- Build passes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/48-event-summary-redesign/48-01-FIX2-SUMMARY.md`
</output>
