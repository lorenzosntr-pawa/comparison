---
phase: 07.1-complete-odds-pipeline
plan: 01
type: execute
---

<objective>
Complete the BetPawa odds pipeline by adding OddsSnapshot storage and verifying end-to-end display.

Purpose: The tool is unusable without BetPawa odds — the entire value proposition is comparing BetPawa against competitors, but currently BetPawa odds aren't being stored at all.

Output: BetPawa odds stored in database and displayed in UI alongside SportyBet and Bet9ja.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-complete-odds-pipeline/07.1-RESEARCH.md
@.planning/phases/07.1-complete-odds-pipeline/07.1-CONTEXT.md
@.planning/phases/06.1-cross-platform-scraping/06.1-01-SUMMARY.md
@.planning/phases/07-match-views/07-02-SUMMARY.md

**Key source files:**
@src/scraping/orchestrator.py
@src/scraping/clients/betpawa.py
@src/db/models/odds.py

**Root cause (from research):**
- BetPawa scraper only calls `EventMatchingService.process_scraped_events()` which stores event metadata but NOT OddsSnapshot records
- SportyBet and Bet9ja correctly create OddsSnapshots with MarketOdds (pattern exists to follow)
- BetPawa markets don't need mapping — they ARE the canonical format (betpawa_market_id = marketType.id)

**Pattern to follow (from SportyBet implementation):**
1. Store raw_data in event dict from scraper
2. Create OddsSnapshot record with raw_response
3. Parse markets with _parse_*_markets() method
4. Create MarketOdds records linked to snapshot

**Market parity verified:** 211 canonical markets match between TypeScript and Python
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BetPawa odds storage to orchestrator</name>
  <files>src/scraping/orchestrator.py</files>
  <action>
1. Modify `_scrape_betpawa_competition()` to fetch full event data with markets:
   - After getting events list, fetch each event's full details using `client.fetch_event(event_id)`
   - Store the full response as `raw_data` in the returned event dict
   - Add rate limiting (0.1s delay like SportyBet)

2. Add `_parse_betpawa_markets(self, raw_data: dict) -> list[MarketOdds]` method:
   - BetPawa is canonical format — no mapping needed, direct extraction
   - Extract from `raw_data["markets"]` array
   - For each market: `marketType.id` = betpawa_market_id, `marketType.displayName` = betpawa_market_name
   - For each row in market: `formattedHandicap` = line
   - For each price in row: `name` = outcome name, `price` = odds, `suspended` = !is_active
   - Return list of MarketOdds objects

3. Modify `_store_events()` BetPawa section (lines 860-871):
   - After `process_scraped_events()`, add OddsSnapshot creation block
   - Follow Bet9ja pattern: look up events by sportradar_id, create snapshot for each
   - Parse markets with `_parse_betpawa_markets()` and create MarketOdds records

Key insight: BetPawa markets ARE the canonical format. Unlike SportyBet/Bet9ja which need mapping TO BetPawa format, BetPawa data is already correct — just extract and store.

Avoid: Don't try to use market_mapping mappers for BetPawa — there is no BetPawa mapper because BetPawa defines the canonical format.
  </action>
  <verify>
Run scrape and check database:
```bash
cd c:/Users/loren/Desktop/betpawa/comparison/mvp
python -c "
import asyncio
from sqlalchemy import select, func
from src.db.session import get_async_session
from src.db.models.odds import OddsSnapshot
from src.db.models.bookmaker import Bookmaker

async def check():
    async with get_async_session() as db:
        result = await db.execute(
            select(Bookmaker.name, func.count(OddsSnapshot.id))
            .join(Bookmaker, OddsSnapshot.bookmaker_id == Bookmaker.id)
            .group_by(Bookmaker.name)
        )
        for name, count in result.all():
            print(f'{name}: {count} snapshots')

asyncio.run(check())
"
```
Should show BetPawa with snapshot count > 0 (matching SportyBet/Bet9ja pattern).
  </verify>
  <done>BetPawa scraper creates OddsSnapshot and MarketOdds records. Database shows BetPawa snapshots after scrape.</done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end odds display</name>
  <files>src/api/routes/events.py, web/src/features/matches/components/match-table.tsx</files>
  <action>
1. Start the backend and trigger a scrape to populate data:
   ```bash
   cd c:/Users/loren/Desktop/betpawa/comparison/mvp
   # In one terminal
   uvicorn src.api.main:app --reload
   # In another terminal
   curl -X POST http://localhost:8000/api/scrape
   ```

2. Check API response includes BetPawa odds:
   ```bash
   curl http://localhost:8000/api/events | python -m json.tool | head -100
   ```
   - Look for `bookmaker_odds` array with entry for "betpawa"
   - Verify `inline_odds` contains 1X2, O/U 2.5, BTTS markets

3. Check UI displays odds:
   - Start frontend: `cd web && pnpm dev`
   - Navigate to matches page
   - Verify BetPawa column (BP) shows odds values, not dashes
   - Verify color coding works (green when BP > competitor, red when lower)

4. If issues found, debug the query in events.py:
   - The subquery for latest snapshot per (event_id, bookmaker_id) should now return BetPawa snapshots
   - inline_odds aggregation should include BetPawa markets

This is verification only — the API and UI already handle BetPawa display, they just needed data in the database.
  </action>
  <verify>
- API `/api/events` returns events with BetPawa in `bookmaker_odds`
- UI match list shows BP column with actual odds (not all dashes)
- Color coding works correctly (green = BetPawa better odds, red = worse)
  </verify>
  <done>API returns BetPawa odds in responses. UI displays BetPawa odds alongside competitors with correct color coding.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] BetPawa scraper creates OddsSnapshot records (check database)
- [ ] MarketOdds records created for BetPawa markets
- [ ] API `/api/events` includes BetPawa in bookmaker_odds
- [ ] UI match list displays BetPawa odds (not dashes)
- [ ] Color coding works (green/red based on odds comparison)
</verification>

<success_criteria>
- All tasks completed
- BetPawa odds stored in database after scrape
- API returns BetPawa odds in event responses
- UI displays all three bookmakers side-by-side with color coding
- Core value proposition (odds comparison) now functional
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-complete-odds-pipeline/07.1-01-SUMMARY.md`:

# Phase 7.1 Plan 1: Complete Odds Pipeline Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 7.1 complete
- Ready for Phase 7: Match Detail View (07-03-PLAN.md)
</output>
