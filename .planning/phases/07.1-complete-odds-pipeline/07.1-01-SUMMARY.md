---
phase: 07.1-complete-odds-pipeline
plan: 01
subsystem: scraping
tags: [betpawa, odds, orchestrator, market-parsing]

# Dependency graph
requires:
  - phase: 06.1-cross-platform-scraping
    provides: SportyBet and Bet9ja odds storage pattern to follow
provides:
  - BetPawa odds storage in OddsSnapshot/MarketOdds tables
  - Complete three-bookmaker odds comparison capability
affects: [07-match-views, 08-real-time-updates]

# Tech tracking
tech-stack:
  added: []
  patterns: [betpawa-canonical-markets, fallback-line-parsing]

key-files:
  created: []
  modified: [src/scraping/orchestrator.py]

key-decisions:
  - "BetPawa is canonical format — no mapping needed, direct extraction"
  - "Fallback line parsing from prices[0].handicap for O/U markets"

patterns-established:
  - "BetPawa canonical format: direct extraction from markets array"
  - "Line parsing fallback: row.formattedHandicap → prices[0].handicap"

issues-created: []

# Metrics
duration: 8 min
completed: 2026-01-21
---

# Phase 7.1 Plan 1: Complete Odds Pipeline Summary

**BetPawa odds storage via direct market extraction, enabling full three-bookmaker comparison**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-21T12:00:00Z
- **Completed:** 2026-01-21T12:08:00Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments

- Added BetPawa odds storage to orchestrator with OddsSnapshot and MarketOdds records
- Implemented `_parse_betpawa_markets()` for direct canonical market extraction (no mapping needed)
- Modified `_scrape_betpawa_competition()` to fetch full event data with markets
- Fixed line parsing for O/U markets (fallback from prices[0].handicap when row.formattedHandicap is None)
- Verified end-to-end: 40 BetPawa snapshots, 320+ MarketOdds records per scrape

## Task Commits

Each task was committed atomically:

1. **Task 1: Add BetPawa odds storage to orchestrator** - `b32cab3` (feat)
2. **Task 2: Verify end-to-end odds display** - (verification only, no code changes)

**Plan metadata:** (pending)

## Files Created/Modified

- `src/scraping/orchestrator.py` - Added BetPawa odds storage: `_parse_betpawa_markets()` method, full event fetching with markets, OddsSnapshot/MarketOdds creation in `_store_events()`

## Decisions Made

- **BetPawa is canonical format** — Unlike SportyBet/Bet9ja which need mapping TO BetPawa format, BetPawa data is already canonical. Direct extraction from `markets` array, no mapping library usage.
- **Line value fallback** — BetPawa O/U markets have `row.formattedHandicap = None` but store line in `prices[0].handicap`. Added fallback logic for robust parsing.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed line parsing for O/U markets**
- **Found during:** Task 2 verification
- **Issue:** O/U 2.5 market odds were being stored without line values because `row.formattedHandicap` was None
- **Fix:** Added fallback to extract line from `prices[0].handicap` when row-level value is missing
- **Files modified:** src/scraping/orchestrator.py
- **Verification:** O/U markets (market ID 5000) now show correct line values (1.5, 2.5, etc.)
- **Committed in:** b32cab3

---

**Total deviations:** 1 auto-fixed (bug), 0 deferred
**Impact on plan:** Bug fix necessary for correct O/U market display. No scope creep.

## Issues Encountered

None — implementation followed established patterns from SportyBet/Bet9ja.

## Next Phase Readiness

- Phase 7.1 complete — BetPawa odds now stored in database
- Core value proposition (odds comparison) now functional
- All three bookmakers display side-by-side with color coding
- Ready for Phase 7 Plan 3: Match Detail View (07-03-PLAN.md)

---
*Phase: 07.1-complete-odds-pipeline*
*Completed: 2026-01-21*
