---
phase: 111-settings-config
plan: 01
type: execute
---

<objective>
Add alert configuration to Settings page with configurable thresholds, retention, and master toggle.

Purpose: Allow users to customize alert detection behavior and connect backend detection to database settings.
Output: Functional alert settings section in Settings page, backend reading from database settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-investigation-schema/105-01-SUMMARY.md
@.planning/phases/106-backend-alert-detection/106-01-SUMMARY.md

**Key files:**
@src/db/models/settings.py - Has alert fields (alert_enabled, thresholds, retention)
@src/api/schemas/settings.py - MISSING alert fields in SettingsResponse/SettingsUpdate
@src/scraping/event_coordinator.py - Lines 1628-1632 have hardcoded AlertThresholds
@web/src/features/settings/index.tsx - Settings page layout
@web/src/features/settings/hooks/use-settings.ts - Settings hooks

**Prior decisions:**
- Phase 105: Defined 6 alert settings fields (alert_enabled, 3 thresholds, retention, lookback)
- Phase 106: "Hardcoded thresholds for now, Phase 111 will read from settings"
- Phase 107: Added alert fields to Settings model in database

**Established patterns:**
- CompactCard pattern for settings UI sections
- RetentionSelector component for days dropdowns
- SettingsUpdate partial update via PATCH
- camelCase aliases for frontend compatibility in Pydantic schemas
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alert fields to Pydantic settings schemas</name>
  <files>src/api/schemas/settings.py</files>
  <action>
Add alert configuration fields to both SettingsResponse and SettingsUpdate:

**SettingsResponse additions:**
- alert_enabled: bool (master toggle)
- alert_threshold_warning: float (default 7.0)
- alert_threshold_elevated: float (default 10.0)
- alert_threshold_critical: float (default 15.0)
- alert_retention_days: int (default 7)
- alert_lookback_minutes: int (default 60)

**SettingsUpdate additions (all optional with validation):**
- alert_enabled: bool | None
- alert_threshold_warning: float | None (ge=1.0, le=50.0)
- alert_threshold_elevated: float | None (ge=1.0, le=50.0)
- alert_threshold_critical: float | None (ge=1.0, le=100.0)
- alert_retention_days: int | None (ge=1, le=90)
- alert_lookback_minutes: int | None (ge=15, le=180)

Follow existing Field pattern with descriptions.
  </action>
  <verify>python -c "from src.api.schemas.settings import SettingsResponse, SettingsUpdate; print('Alert fields:', [f for f in SettingsResponse.model_fields if 'alert' in f])"</verify>
  <done>SettingsResponse and SettingsUpdate include all 6 alert fields with appropriate validation</done>
</task>

<task type="auto">
  <name>Task 2: Connect event_coordinator to settings for thresholds</name>
  <files>src/scraping/event_coordinator.py</files>
  <action>
Modify the risk detection call in store_batch_results() (~line 1628-1632) to:

1. Read thresholds from self._settings (EventCoordinator already has _settings attribute)
2. Check alert_enabled before running detection - skip if disabled
3. Use settings values instead of hardcoded AlertThresholds

The _settings attribute is populated from from_settings() factory method.

Changes:
- Before detect_risk_alerts call, check: `if not getattr(self._settings, 'alert_enabled', True): risk_alerts = []`
- Replace hardcoded AlertThresholds with:
  ```python
  thresholds=AlertThresholds(
      warning=getattr(self._settings, 'alert_threshold_warning', 7.0),
      elevated=getattr(self._settings, 'alert_threshold_elevated', 10.0),
      critical=getattr(self._settings, 'alert_threshold_critical', 15.0),
  ),
  ```

Use getattr with defaults for safety during migration.
  </action>
  <verify>grep -n "alert_enabled\|alert_threshold" src/scraping/event_coordinator.py</verify>
  <done>event_coordinator reads alert settings from self._settings; respects alert_enabled toggle; no hardcoded thresholds</done>
</task>

<task type="auto">
  <name>Task 3: Add alert settings UI to Settings page</name>
  <files>web/src/features/settings/components/alert-settings.tsx, web/src/features/settings/components/index.ts, web/src/features/settings/index.tsx, web/src/types/api.ts</files>
  <action>
1. **Update web/src/types/api.ts** - Add alert fields to Settings interface:
   - alertEnabled: boolean
   - alertThresholdWarning: number
   - alertThresholdElevated: number
   - alertThresholdCritical: number
   - alertRetentionDays: number
   - alertLookbackMinutes: number

   Add to SettingsUpdate type (all optional).

2. **Create web/src/features/settings/components/alert-settings.tsx**:
   - AlertEnabledToggle: Switch component using useSettings/useUpdateSettings
   - AlertThresholdsCard: Three number inputs for warning/elevated/critical thresholds (%)
   - AlertRetentionCard: Dropdown selector like RetentionSelector (1-90 days)

   Pattern: Each component follows existing selector components - useSettings for current value, useUpdateSettings for updates.

3. **Export from web/src/features/settings/components/index.ts**

4. **Update web/src/features/settings/index.tsx**:
   Add new section "Alert Configuration" after the retention settings row, using CompactCard pattern:

   ```tsx
   {/* Row: Alert Configuration */}
   <Card>
     <CardHeader className="pb-3">
       <CardTitle className="text-base">Risk Alerts</CardTitle>
       <CardDescription className="text-xs">
         Configure detection thresholds and alert behavior
       </CardDescription>
     </CardHeader>
     <CardContent className="space-y-4">
       <AlertEnabledToggle />
       <div className="grid grid-cols-3 gap-4">
         <AlertThresholdInput label="Warning" field="alertThresholdWarning" />
         <AlertThresholdInput label="Elevated" field="alertThresholdElevated" />
         <AlertThresholdInput label="Critical" field="alertThresholdCritical" />
       </div>
       <div className="grid grid-cols-2 gap-4">
         <AlertRetentionSelector />
       </div>
     </CardContent>
   </Card>
   ```

   Use existing UI components (Switch, Input from shadcn/ui). Show threshold as % (e.g., "7%").
  </action>
  <verify>Check that web/src/features/settings/components/alert-settings.tsx exists and exports are correct</verify>
  <done>Settings page displays Alert Configuration section with enable toggle, 3 threshold inputs, retention selector</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] GET /api/settings returns all 6 alert fields
- [ ] PATCH /api/settings accepts alert field updates
- [ ] npm run build succeeds
- [ ] Settings page shows Risk Alerts section with all controls
- [ ] Changing thresholds in UI persists to database
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Alert settings are functional end-to-end
- No TypeScript or Python errors
</success_criteria>

<output>
After completion, create `.planning/phases/111-settings-config/111-01-SUMMARY.md`:

# Phase 111 Plan 01: Settings & Configuration Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list with descriptions]

## Decisions Made

[Key decisions or "None"]

## Issues Encountered

[Problems and resolutions or "None"]

## Next Phase Readiness

Phase complete, v2.9 Risk Monitoring milestone ready for ship.
</output>
