---
phase: 103-mapping-dashboard
plan: 04
type: execute
---

<objective>
Add priority scoring algorithm for unmapped markets and display high-priority items on dashboard.

Purpose: Help users identify which unmapped markets to address first based on importance metrics.
Output: Priority score in unmapped API + HighPriorityUnmapped dashboard section
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/103-mapping-dashboard/103-03-SUMMARY.md

# Unmapped API to extend:
@src/api/routes/unmapped.py
@src/api/schemas/unmapped.py
@src/db/models/mapping.py

# Dashboard to extend:
@web/src/features/mappings/index.tsx

**Tech stack available:** SQLAlchemy computed columns, Pydantic computed fields, React
**Established patterns:** List item components with badges, onClick handlers for detail navigation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add priority scoring to unmapped API</name>
  <files>src/api/routes/unmapped.py, src/api/schemas/unmapped.py</files>
  <action>
1. Define priority scoring algorithm in unmapped.py:
   ```python
   def calculate_priority_score(occurrence_count: int, last_seen_at: datetime) -> int:
       """
       Priority score: higher = more important.

       Formula:
       - Base: occurrence_count (0-100 points, capped)
       - Recency bonus: +50 if seen in last 24h, +25 if in last 7 days
       - Total: 0-150 range
       """
       base = min(occurrence_count, 100)
       now = datetime.utcnow()
       hours_ago = (now - last_seen_at).total_seconds() / 3600
       if hours_ago < 24:
           recency = 50
       elif hours_ago < 168:  # 7 days
           recency = 25
       else:
           recency = 0
       return base + recency
   ```

2. Add priority_score field to UnmappedMarketListItem schema

3. Update list_unmapped_markets endpoint:
   - Calculate priority_score for each item
   - Add sort_by option: "priority" (default to occurrence_count DESC, then priority)
   - Return priority_score in response items

4. Add GET /unmapped/high-priority endpoint:
   - Returns top 5 NEW status unmapped markets by priority score
   - Simpler response: just the list, no pagination
   - Filter: status="NEW" only
  </action>
  <verify>
curl http://localhost:8000/api/unmapped?sort_by=priority returns items with priority_score field
curl http://localhost:8000/api/unmapped/high-priority returns top 5 high-priority items
  </verify>
  <done>
Unmapped API returns priority_score, high-priority endpoint returns top 5 items
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HighPriorityUnmapped dashboard section</name>
  <files>web/src/features/mappings/hooks/use-high-priority-unmapped.ts, web/src/features/mappings/components/high-priority-unmapped.tsx, web/src/features/mappings/components/index.ts, web/src/features/mappings/index.tsx</files>
  <action>
1. Create useHighPriorityUnmapped hook:
   - useQuery with queryKey ['unmapped-high-priority']
   - Fetches GET /api/unmapped/high-priority
   - Returns { data: items[], isLoading }

2. Create HighPriorityUnmapped component:
   - Card with header "High Priority Unmapped" and AlertTriangle icon (orange)
   - List of top 5 unmapped markets:
     - Each row: market_name (truncated), source badge (SportyBet/Bet9ja), priority score badge
     - Click handler: TODO - will link to mapping editor in Phase 104
   - Empty state: "All caught up!" with CheckCircle icon (green)
   - Loading skeleton with 5 rows

3. Priority score badge styling:
   - 100+: red background, "Critical"
   - 50-99: orange background, "High"
   - <50: yellow background, "Medium"

4. Integrate into MappingDashboard:
   - Add HighPriorityUnmapped below the chart/recent changes grid
   - Full width card
  </action>
  <verify>
Dashboard shows high-priority unmapped section with up to 5 items and priority badges
  </verify>
  <done>
High priority section displays unmapped markets with priority scoring and color-coded badges
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Mapping Dashboard with priority scoring</what-built>
  <how-to-verify>
    1. Run: npm run dev (in web/ folder)
    2. Navigate to /mappings
    3. Verify: Stats cards show mapping counts
    4. Verify: Platform coverage chart displays
    5. Verify: Recent changes shows audit log
    6. Verify: High Priority section shows top unmapped (or "All caught up!" if none)
    7. Verify: Priority badges show correct colors (red/orange/yellow)
    8. Test: Create a mapping via API, refresh, see it in recent changes
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Priority scoring algorithm returns scores 0-150
- [ ] /unmapped endpoint includes priority_score field
- [ ] /unmapped/high-priority returns top 5 NEW items
- [ ] Dashboard shows high-priority section
- [ ] Priority badges use correct color coding
- [ ] No TypeScript/Python errors
</verification>

<success_criteria>

- Priority scoring algorithm implemented
- High-priority endpoint functional
- Dashboard complete with all 4 sections: stats, chart, changes, high-priority
- Human verification approved
- Phase 103 complete
</success_criteria>

<output>
After completion, create `.planning/phases/103-mapping-dashboard/103-04-SUMMARY.md`
</output>
