---
phase: 35-remediation
plan: 01
type: execute
---

<objective>
Fix coverage statistics inflation and remediate 2 timing-affected events.

Purpose: Correct API-001 (competitor_only_count double-counting) and apply one-time SQL to link 2 orphaned events.
Output: Accurate coverage stats on palimpsest page, 100% event matching for matchable events.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 34 and 34.1 audit findings
@.planning/phases/34-investigation-matching-audit/AUDIT-FINDINGS.md
@.planning/phases/34.1-api-ui-data-flow-audit/AUDIT-FINDINGS.md

# Relevant source files
@src/api/routes/palimpsest.py

**From Phase 34.1 audit:**
- API-001: `/palimpsest/coverage` counts raw competitor rows instead of unique SR IDs
- Line 119-127 needs `COUNT(DISTINCT sportradar_id)` instead of `COUNT(*)`
- This inflates competitor_only_count by ~92% (254 vs 132 actual)

**From Phase 34 audit:**
- Only 2 events affected by timing bug (SR IDs: 67874330, 67874312)
- Scraped from Bet9ja 3 days before BetPawa added them
- Simple UPDATE query will fix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix coverage count deduplication (API-001)</name>
  <files>src/api/routes/palimpsest.py</files>
  <action>
Change line 119-127 from:
```python
competitor_only_query = (
    select(func.count())
    .select_from(CompetitorEvent)
    .where(CompetitorEvent.betpawa_event_id.is_(None))
)
```

To:
```python
competitor_only_query = (
    select(func.count(distinct(CompetitorEvent.sportradar_id)))
    .where(CompetitorEvent.betpawa_event_id.is_(None))
)
```

Note: `distinct` is already imported at the top of the file. Remove `.select_from()` as it's redundant when the column reference is in the count.
  </action>
  <verify>
Run SQL to get expected values, then compare with API:
```bash
# Get expected distinct count
psql -d comparison -c "SELECT COUNT(DISTINCT sportradar_id) FROM competitor_events WHERE betpawa_event_id IS NULL AND kickoff > NOW();"

# Start server and check API
curl http://localhost:8000/api/palimpsest/coverage | jq '.competitor_only_count'
```
Values should match.
  </verify>
  <done>
- `/palimpsest/coverage` returns competitor_only_count matching SQL DISTINCT count
- Match rate percentage increases from ~75% to ~83% (accurate)
- No runtime errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Run timing remediation SQL for orphaned events</name>
  <files>N/A (database operation)</files>
  <action>
Execute one-time remediation query to link competitor events that were scraped before their BetPawa counterparts existed:

```sql
UPDATE competitor_events ce
SET betpawa_event_id = e.id
FROM events e
WHERE ce.sportradar_id = e.sportradar_id
  AND ce.betpawa_event_id IS NULL
  AND ce.deleted_at IS NULL;
```

Run via psql or Alembic migration. Capture count of affected rows (should be 2).

Do NOT create a migration file - this is a one-time data fix, not a schema change. Run directly via psql.
  </action>
  <verify>
```bash
# Before: check orphaned count
psql -d comparison -c "SELECT COUNT(*) FROM competitor_events ce INNER JOIN events e ON ce.sportradar_id = e.sportradar_id WHERE ce.betpawa_event_id IS NULL;"

# Run remediation
psql -d comparison -c "UPDATE competitor_events ce SET betpawa_event_id = e.id FROM events e WHERE ce.sportradar_id = e.sportradar_id AND ce.betpawa_event_id IS NULL AND ce.deleted_at IS NULL;"

# After: should be 0
psql -d comparison -c "SELECT COUNT(*) FROM competitor_events ce INNER JOIN events e ON ce.sportradar_id = e.sportradar_id WHERE ce.betpawa_event_id IS NULL;"
```
  </verify>
  <done>
- 2 events linked (UPDATE affected 2 rows)
- No orphaned events remain (post-remediation query returns 0)
- Match accuracy now 100% for matchable events
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `/palimpsest/coverage` returns accurate competitor_only_count (matches DISTINCT SQL)
- [ ] Match rate shows ~83-84% (not inflated ~75%)
- [ ] Orphaned event count is 0 (remediation applied)
- [ ] No Python errors when hitting API endpoints
- [ ] Frontend coverage page shows corrected stats
</verification>

<success_criteria>
- API-001 fixed: coverage stats accurate
- Timing bug remediated: 0 orphaned events
- No regressions in palimpsest endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/35-remediation/35-01-SUMMARY.md`:

# Phase 35 Plan 01: Coverage Stats & Matching Fixes Summary

**[Substantive one-liner describing outcome]**

## Accomplishments
- Fixed coverage count deduplication (API-001)
- Remediated 2 timing-affected orphaned events
- Match rate now accurate at ~83%

## Files Created/Modified
- `src/api/routes/palimpsest.py` - DISTINCT count fix

## Decisions Made
[Any decisions made during execution]

## Issues Encountered
[Problems and resolutions]

## Next Phase Readiness
Ready for 35-02 (event detail competitor odds)
</output>
