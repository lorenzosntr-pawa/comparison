---
phase: 35-remediation
plan: 02
type: execute
---

<objective>
Enable event detail view to show fresh competitor odds from new architecture.

Purpose: Fix API-002 - event detail currently uses legacy odds system (506 events) while new system has 2400+ events with fresh data.
Output: Event detail page shows up-to-date competitor odds alongside BetPawa odds.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 34.1 audit findings
@.planning/phases/34.1-api-ui-data-flow-audit/AUDIT-FINDINGS.md

# Relevant source files
@src/api/routes/events.py
@src/db/models/competitor.py
@src/matching/schemas.py

**From Phase 34.1 audit (API-002):**
- `/events/{id}` fetches competitor odds from legacy `event_bookmakers` + `odds_snapshots` tables
- New v1.1 architecture stores competitor odds in `competitor_events` + `competitor_odds_snapshots`
- Legacy system: 506 sportybet events, 413 bet9ja events
- New system: 1113 sportybet events, 1309 bet9ja events (~2x coverage)

**Fix approach:**
1. Look up competitor events by `betpawa_event_id` match
2. Load their latest `competitor_odds_snapshots`
3. Merge into the response alongside legacy data

**Key models:**
- `CompetitorEvent.betpawa_event_id` links to BetPawa event
- `CompetitorOddsSnapshot` has `competitor_event_id` and `markets` relationship
- `CompetitorMarketOdds` has same structure as `MarketOdds` (betpawa_market_id, outcomes, line, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create competitor odds loader function</name>
  <files>src/api/routes/events.py</files>
  <action>
Add a new async function `_load_competitor_snapshots_for_event()` that:

1. Queries `CompetitorEvent` WHERE `betpawa_event_id = event_id`
2. For each competitor event, gets the latest `CompetitorOddsSnapshot` (by max id)
3. Returns dict mapping source (sportybet/bet9ja) to snapshot with loaded markets

Pattern similar to `_load_latest_snapshots_for_events()` but for competitor data:

```python
async def _load_competitor_snapshots_for_event(
    db: AsyncSession,
    event_id: int,
) -> dict[str, CompetitorOddsSnapshot]:
    """Load latest competitor odds snapshots for a BetPawa event.

    Queries competitor_events linked to this BetPawa event and loads
    their latest odds snapshots from the new v1.1 architecture.

    Returns:
        Dict mapping source (sportybet/bet9ja) to latest CompetitorOddsSnapshot.
    """
```

Use subquery pattern to get max snapshot ID per competitor_event_id, then join to load full snapshot with markets.
  </action>
  <verify>
Write a quick test query:
```python
# In Python REPL or test script
from src.api.routes.events import _load_competitor_snapshots_for_event
# Test with known matched event ID
result = await _load_competitor_snapshots_for_event(db, 123)  # Use real event ID
print(result.keys())  # Should show 'sportybet', 'bet9ja' if both have odds
```
  </verify>
  <done>
- Function exists and returns competitor snapshots
- Returns empty dict for events with no competitor matches
- Returns snapshots with loaded markets relationship
  </done>
</task>

<task type="auto">
  <name>Task 2: Merge competitor odds into event detail response</name>
  <files>src/api/routes/events.py</files>
  <action>
Modify `get_event()` endpoint to:

1. Call `_load_competitor_snapshots_for_event()` after loading legacy snapshots
2. Pass competitor snapshots to `_build_event_detail_response()`

Modify `_build_event_detail_response()` to:

1. Accept new parameter `competitor_snapshots: dict[str, CompetitorOddsSnapshot] | None = None`
2. After processing legacy bookmaker_links, add competitor bookmakers:

```python
# Add competitor odds from new architecture
if competitor_snapshots:
    for source, snapshot in competitor_snapshots.items():
        # Skip if we already have this bookmaker from legacy system
        if any(b.bookmaker_slug == source for b in bookmakers):
            continue

        inline_odds = _build_inline_odds_from_competitor(snapshot)
        bookmakers.append(
            BookmakerOdds(
                bookmaker_slug=source,
                bookmaker_name=source.title(),  # "sportybet" -> "Sportybet"
                external_event_id=str(snapshot.competitor_event.external_id),
                event_url=None,  # Competitor events don't have direct URLs
                has_odds=bool(snapshot.markets),
                inline_odds=inline_odds,
            )
        )
```

Create helper `_build_inline_odds_from_competitor()` that converts `CompetitorMarketOdds` to `InlineOdds` format. Same logic as `_build_inline_odds()` but reads from `CompetitorOddsSnapshot.markets` instead of `OddsSnapshot.markets`.

Note: The `CompetitorMarketOdds` model has the same fields as `MarketOdds`:
- `betpawa_market_id`, `betpawa_market_name`, `line`, `outcomes`
So the conversion logic is nearly identical.
  </action>
  <verify>
```bash
# Start dev server
python -m uvicorn src.api.main:app --reload

# Test event detail endpoint with known matched event
curl http://localhost:8000/api/events/123 | jq '.bookmakers[] | {slug: .bookmaker_slug, has_odds: .has_odds}'

# Should show sportybet and bet9ja with has_odds: true if they have data in new tables
```

Also verify:
- Events that only have legacy data still work
- Events with no competitor matches return only betpawa
- No duplicate bookmakers in response
  </verify>
  <done>
- Event detail shows competitor odds from new architecture
- Sportybet/Bet9ja appear with fresh odds (not 4-day-old data)
- No duplicates when both legacy and new data exist
- Legacy-only events still work correctly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `_load_competitor_snapshots_for_event()` function exists and works
- [ ] `get_event()` calls competitor loader
- [ ] Event detail response includes competitor odds from new tables
- [ ] No regression for events without competitor matches
- [ ] No duplicate bookmakers in response
- [ ] Inline odds (1X2, O/U 2.5, BTTS) display correctly for competitors
</verification>

<success_criteria>
- API-002 fixed: event detail shows fresh competitor odds
- Competitor data coverage increases from ~500 to ~2400 events
- No breaking changes to response schema
- Performance acceptable (no N+1 queries)
</success_criteria>

<output>
After completion, create `.planning/phases/35-remediation/35-02-SUMMARY.md`:

# Phase 35 Plan 02: Event Detail Competitor Odds Summary

**[Substantive one-liner describing outcome]**

## Accomplishments
- Created competitor odds loader for new v1.1 architecture
- Merged competitor odds into event detail response
- Coverage increased from ~500 to ~2400 competitor events

## Files Created/Modified
- `src/api/routes/events.py` - Added competitor odds loading and merging

## Decisions Made
[Any decisions made during execution]

## Issues Encountered
[Problems and resolutions]

## Next Phase Readiness
Phase 35 complete. Ready for Phase 36 (optional coverage gap analysis).
</output>
