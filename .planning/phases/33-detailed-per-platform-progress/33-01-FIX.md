---
phase: 33-detailed-per-platform-progress
plan: 33-01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 33-01: SSE stream closes prematurely on first per-platform completion event.

Source: 33-01-ISSUES.md
Priority: 1 blocker, 2 major (all share single root cause)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/33-detailed-per-platform-progress/33-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/33-detailed-per-platform-progress/33-01-PLAN.md

# Key source files:
@web/src/features/scrape-runs/components/live-progress.tsx
@src/scraping/orchestrator.py
@src/scraping/schemas.py

**Root cause analysis:**

The backend orchestrator emits `phase="completed"` events at two levels:
1. **Per-platform:** `platform="betpawa"`, `platform="sportybet"`, `platform="bet9ja"` — each with `phase="completed"`
2. **Overall:** `platform=null` with `phase="completed"` and `current=total` — the final scrape completion

The frontend at `live-progress.tsx:109` checks `data.phase === 'completed'` and closes the EventSource on ANY completed event — including per-platform ones. When BetPawa completes first, the stream dies before competitors start.

**Fix strategy:** Distinguish per-platform completion from overall completion using `data.platform === null && data.current === data.total`. Only close the stream on overall completion.

**Secondary issue:** The `overallPhase` state at line 89 (`setOverallPhase(data.phase)`) sets it to `completed` on any platform's completion event. This should only update to `completed` for overall events. Per-platform events should not override the overall phase state.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SSE stream completion detection and overall phase tracking</name>
  <files>web/src/features/scrape-runs/components/live-progress.tsx</files>
  <action>
Fix two bugs in the `onmessage` handler:

1. **Fix overall phase tracking (line 89):**
   Change `setOverallPhase(data.phase)` to only update overallPhase for non-platform events or for the final completion. When a per-platform event arrives (data.platform is not null), do NOT update overallPhase to "completed" — that's a per-platform completion, not overall.

   Logic:
   ```
   // Only update overall phase from non-platform events (overall status)
   // or from platform events that aren't completion (scraping/storing are fine)
   if (!data.platform || (data.phase !== 'completed' && data.phase !== 'failed')) {
     setOverallPhase(data.phase)
   }
   ```

2. **Fix stream closure (lines 109-119):**
   Change the completion check to only close the EventSource when the event is an overall completion — i.e., `data.platform === null` AND `data.phase === 'completed'` (or `data.phase === 'failed'`). Per-platform completed/failed events should NOT close the stream.

   The existing code:
   ```typescript
   if (data.phase === 'completed' || data.phase === 'failed') {
     eventSource.close()
     ...
   }
   ```

   Change to:
   ```typescript
   // Only close on overall completion (platform=null), not per-platform completion
   if ((data.phase === 'completed' || data.phase === 'failed') && !data.platform) {
     eventSource.close()
     ...
   }
   ```

This single change fixes all three UAT issues:
- UAT-001: Stream no longer closes on BetPawa's per-platform completion
- UAT-002: overallPhase doesn't flip to "completed" prematurely
- UAT-003: Stream stays open so all platform progress events are received and accumulated in the Map
  </action>
  <verify>
1. Run `cd web && npx tsc --noEmit` — no TypeScript errors
2. Start the app and trigger a scrape
3. Verify:
   - Stream stays open through all three platforms
   - BetPawa completes, then SportyBet shows "scraping...", then Bet9ja
   - All completed platforms show event counts and duration
   - Overall progress only shows "complete" after all platforms finish
   - Dashboard widget only shows complete after final event
  </verify>
  <done>
- SSE stream stays open until overall completion event (platform=null)
- Per-platform completions update platformProgress Map without closing stream
- Overall phase only updates to "completed" on the final non-platform event
- All three UAT issues resolved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 UAT issues fixed (UAT-001 blocker, UAT-002 major, UAT-003 major)
- [ ] No TypeScript errors (`cd web && npx tsc --noEmit`)
- [ ] Stream stays open through entire scrape lifecycle
- [ ] All three platforms display real progress data
- [ ] Overall completion only triggers on final event
</verification>

<success_criteria>
- All UAT issues from 33-01-ISSUES.md addressed
- TypeScript compilation passes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/33-detailed-per-platform-progress/33-01-FIX-SUMMARY.md`
</output>
