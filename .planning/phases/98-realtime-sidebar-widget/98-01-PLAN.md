---
phase: 98-realtime-sidebar-widget
plan: 01
type: execute
---

<objective>
Make sidebar status widgets update automatically when scrapes complete, without page refresh.

Purpose: Sidebar shows stale "Last Scrape" and event count data until polling catches up (30-60s delay). Real-time updates provide immediate feedback.
Output: Sidebar refreshes instantly when scrapes complete via WebSocket-triggered query invalidation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Tech stack available:**
- WebSocket infrastructure with topic-based pub/sub (v2.0)
- TanStack Query v5 with query invalidation
- useWebSocketScrapeProgress hook already subscribes to scrape_progress topic

**Established patterns:**
- useOddsUpdates hook pattern: subscribe to WebSocket topic, invalidate queries on message
- Query invalidation on scrape complete in useWebSocketScrapeProgress

**Key files:**
@web/src/hooks/use-websocket-scrape-progress.ts - scrape progress WebSocket hook
@web/src/components/layout/app-sidebar.tsx - sidebar using coverage/scrape-runs hooks
@web/src/features/coverage/hooks/use-coverage.ts - coverage hook (queryKey: ['coverage', ...])
@web/src/features/scrape-runs/hooks/use-scrape-runs.ts - scrape runs hook (queryKey: ['scrape-runs', ...])

**Problem analysis:**
Sidebar uses these queries that don't auto-refresh on scrape complete:
- `useCoverage()` → queryKey `['coverage', { includeStarted }]` - 60s poll
- `useScrapeRuns(1, 0)` → queryKey `['scrape-runs', 1, 0]` - 30s stale

`useWebSocketScrapeProgress` already invalidates on scrape complete but misses these keys:
- Current: `['scheduler-history']`, `['events']`, `['scrape-run']`
- Missing: `['coverage']`, `['scrape-runs']`

**Solution:**
Add 2 lines to existing hook - invalidate coverage and scrape-runs queries on completion.
No new hooks, no backend changes, no new WebSocket topics needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sidebar query invalidations to scrape progress hook</name>
  <files>web/src/hooks/use-websocket-scrape-progress.ts</files>
  <action>
In the completion handler (where phase === 'completed' or 'failed'), add two additional query invalidations:

```typescript
queryClient.invalidateQueries({ queryKey: ['coverage'] })
queryClient.invalidateQueries({ queryKey: ['scrape-runs'] })
```

These use prefix matching - any query starting with these keys will be invalidated.
This ensures the sidebar's coverage (event counts) and scrape-runs (last scrape info) update immediately.

Place these alongside the existing invalidations in the completion block (around line 175).
  </action>
  <verify>
1. Code review: Verify the invalidations are added in the correct location
2. TypeScript: `cd web && npx tsc --noEmit` passes
3. Lint: `cd web && npm run lint` passes
  </verify>
  <done>
- Two new invalidateQueries calls added for ['coverage'] and ['scrape-runs']
- No TypeScript or lint errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Sidebar now auto-updates when scrapes complete via WebSocket query invalidation</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev` (if not already running)
    2. Open app in browser at http://localhost:5173
    3. Look at the sidebar - note the current "Last Scrape" time and "Events" count
    4. Click "Run Scrape" button in the sidebar
    5. Watch the sidebar as scrape runs:
       - "Active Scrape" section should appear showing progress
       - When scrape completes, "Last Scrape" time should update IMMEDIATELY (not after 30s poll)
       - "Events" count should also update immediately if counts changed
    6. Verify no page refresh was needed - the sidebar updated in real-time
  </how-to-verify>
  <resume-signal>Type "approved" if sidebar updates immediately on scrape completion, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run lint` passes
- [ ] Sidebar "Last Scrape" updates immediately when scrape completes
- [ ] Sidebar "Events" count updates immediately when scrape completes
</verification>

<success_criteria>

- useWebSocketScrapeProgress invalidates coverage and scrape-runs queries on completion
- No TypeScript or lint errors
- Sidebar updates in real-time without page refresh
- Human verification confirms expected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/98-realtime-sidebar-widget/98-01-SUMMARY.md`
</output>
