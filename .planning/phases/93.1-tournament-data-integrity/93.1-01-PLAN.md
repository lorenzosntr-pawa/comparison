---
phase: 93.1-tournament-data-integrity
plan: 01
type: execute
---

<objective>
Fix tournament lookup and API filtering to include country, preventing new data corruption.

Purpose: Stop new events from being assigned to wrong tournaments when name matches but country differs.
Output: Updated tournament lookup logic and API filtering that correctly handles same-name tournaments from different countries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./93.1-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (BUG-016 details)

**Key files to modify:**
@src/scraping/event_coordinator.py (lines 2062-2116: _get_or_create_tournament_from_betpawa_raw)
@src/api/routes/events.py (lines 1274-1296: tournament filter for competitor events)
@src/db/models/sport.py (Tournament model reference)

**Root Cause (from investigation):**
1. `_get_or_create_tournament_from_betpawa_raw()` looks up tournaments by `name + sport_id` only
2. When "Premier League" (England) exists and "Premier League" (Singapore) comes in, lookup returns England's ID
3. Singapore events get linked to England's tournament
4. API filtering compounds this by matching competitor tournaments by name only

**Constraining decisions:**
- Tournament.country is already set when creating (line 2103), problem is lookup only
- CompetitorTournament lookup uses external_id which is unique per source - no change needed there
- Must maintain backward compatibility with existing data until migration runs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BetPawa tournament lookup to include country</name>
  <files>src/scraping/event_coordinator.py</files>
  <action>
Update `_get_or_create_tournament_from_betpawa_raw()` method (around line 2062):

1. Add `country` (from `region_name`) to the WHERE clause in the lookup query (lines 2089-2094):
   ```python
   result = await db.execute(
       select(Tournament.id).where(
           Tournament.name == comp_name,
           Tournament.sport_id == sport_id,
           Tournament.country == region_name,  # ADD THIS
       )
   )
   ```

2. Handle the edge case where `region_name` is None:
   - If region_name is None, use `Tournament.country.is_(None)` for the WHERE clause
   - Or coalesce to empty string for comparison consistency

3. Update the docstring to reflect that country is now part of the lookup key.

**Important:** Do NOT change how new tournaments are created - that already sets country correctly.
The fix is purely in the lookup logic.
  </action>
  <verify>
Run Python syntax check: `python -m py_compile src/scraping/event_coordinator.py`
Verify the query includes country in WHERE clause by reading the modified code.
  </verify>
  <done>
- Tournament lookup includes country in WHERE clause
- None/null country handled correctly
- Docstring updated
- No syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix API tournament filtering to include country</name>
  <files>src/api/routes/events.py</files>
  <action>
Update the tournament filter for competitor events (around lines 1274-1296):

**Current problem:**
- Gets tournament NAMES from BetPawa Tournament table (line 1277-1281)
- Matches CompetitorTournament by name only (lines 1291-1295)
- This returns ALL "Premier League" competitors regardless of country

**Fix approach:**
1. When getting tournament info, also get the country (line 1277-1281):
   ```python
   tournament_info_query = select(Tournament.name, Tournament.country).where(
       Tournament.id.in_(tournament_ids)
   )
   tournament_info_result = await db.execute(tournament_info_query)
   tournament_info = [(row[0], row[1]) for row in tournament_info_result.all()]
   ```

2. When matching competitor tournaments, include country in the condition (lines 1291-1295):
   ```python
   name_country_conditions = [
       and_(
           func.lower(CompetitorTournament.name) == name.lower(),
           # Handle country matching - country_raw in CompetitorTournament
           or_(
               CompetitorTournament.country_raw == country,
               # Also match if both are null/empty
               and_(CompetitorTournament.country_raw.is_(None), country is None),
           )
       )
       for name, country in tournament_info
   ]
   comp_query = comp_query.where(or_(*name_country_conditions))
   ```

**Edge case handling:**
- If BetPawa tournament has country=None, match CompetitorTournaments with country_raw=None
- Case-insensitive name matching (already done with func.lower)
- Country matching should be case-insensitive too (apply func.lower)

**Import needed:** Make sure `and_` is imported from sqlalchemy (likely already is).
  </action>
  <verify>
Run Python syntax check: `python -m py_compile src/api/routes/events.py`
Verify the modified code includes country in the filtering logic.
  </verify>
  <done>
- API tournament filter includes country in matching logic
- Country_raw from CompetitorTournament matched against Tournament.country
- Null/None countries handled correctly
- No syntax errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m py_compile src/scraping/event_coordinator.py` passes
- [ ] `python -m py_compile src/api/routes/events.py` passes
- [ ] Tournament lookup query includes country in WHERE clause
- [ ] API filtering includes country in competitor tournament matching
- [ ] Edge cases (null country) are handled
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No Python syntax errors
- Code prevents new same-name-different-country tournament collisions
</success_criteria>

<output>
After completion, create `.planning/phases/93.1-tournament-data-integrity/93.1-01-SUMMARY.md`
</output>
