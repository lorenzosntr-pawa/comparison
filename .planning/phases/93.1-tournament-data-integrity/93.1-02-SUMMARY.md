---
phase: 93.1-tournament-data-integrity
plan: 02
subsystem: database
tags: [alembic, sqlalchemy, postgresql, migration, constraints]

# Dependency graph
requires:
  - phase: 93.1
    provides: Code fixes for tournament lookup with country
provides:
  - Alembic migration for tournament uniqueness constraint
  - NOT NULL country with default 'Unknown'
  - Composite unique constraint (sport_id, name, country)
affects: [tournament-data, data-integrity, BUG-016-closure]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Data cleanup in migration upgrade() function"
    - "Duplicate handling with ID suffix appending"

key-files:
  created:
    - alembic/versions/l8m4n0o6p2q3_fix_tournament_country_uniqueness.py
  modified:
    - src/db/models/sport.py

key-decisions:
  - "Handle duplicates by appending tournament ID suffix to country"
  - "Use 'Unknown' as default for NULL countries"
  - "Add UniqueConstraint annotation to model for ORM awareness"

patterns-established:
  - "Data cleanup in migration upgrade() function"

issues-created: []

# Metrics
duration: 5min
completed: 2026-02-12
---

# Phase 93.1 Plan 02: Schema Migration Summary

**Alembic migration to fix tournament data integrity with composite unique constraint (sport_id, name, country)**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-12T10:00:00Z
- **Completed:** 2026-02-12T10:05:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Created Alembic migration to clean up NULL countries and add uniqueness constraint
- Updated Tournament model with UniqueConstraint annotation and NOT NULL country
- Migration handles existing duplicates by appending ID suffix

## Task Commits

Each task was committed atomically:

1. **Task 1: Create data cleanup and constraint migration** - `80ddad0` (feat)
2. **Task 2: Update Tournament model with constraint annotation** - `1e9a8f1` (feat)

**Plan metadata:** (this commit) (docs: complete plan)

## Files Created/Modified

- `alembic/versions/l8m4n0o6p2q3_fix_tournament_country_uniqueness.py` - Migration: cleanup NULL countries, handle duplicates, add unique constraint
- `src/db/models/sport.py` - Added UniqueConstraint and updated country column to NOT NULL

## Decisions Made

- **Duplicate handling strategy:** Append tournament ID suffix to country (e.g., "Unknown (42)") rather than merging tournaments - simpler and preserves existing event relationships
- **Default value:** Use "Unknown" for NULL countries - generic but accurate when country data is missing
- **Model annotation:** Add UniqueConstraint to __table_args__ for ORM awareness even though constraint is DB-level

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Migration ready to apply: `cd src && alembic upgrade head`
- BUG-016 fix complete after migration runs successfully
- Phase 93.1 complete - ready to continue with Phase 94

**IMPORTANT USER ACTION REQUIRED:**

After plan completion, run the migration manually:
```bash
cd src && alembic upgrade head
```

This applies the constraint. Verify no errors before marking BUG-016 as resolved.

---
*Phase: 93.1-tournament-data-integrity*
*Completed: 2026-02-12*
