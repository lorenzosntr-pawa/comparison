---
phase: 93.1-tournament-data-integrity
plan: 01
subsystem: database, api
tags: [sqlalchemy, tournament-lookup, data-integrity, filtering]

# Dependency graph
requires:
  - phase: None
    provides: N/A (fixing existing bug)
provides:
  - Country-aware tournament lookup in BetPawa event processing
  - Country-aware API filtering for competitor events
affects: [scraping, api-events, tournament-matching]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Tuple-based lookup keys (name + sport_id + country) for uniqueness"
    - "Null handling via .is_(None) for SQLAlchemy column comparisons"

key-files:
  created: []
  modified:
    - src/scraping/event_coordinator.py
    - src/api/routes/events.py

key-decisions:
  - "Use separate queries for NULL vs non-NULL country (cleaner than COALESCE)"
  - "Case-insensitive country matching in API (func.lower) for consistency"

patterns-established:
  - "Tournament lookup must include country to prevent same-name collisions"
  - "Null country matching via .is_(None) rather than == None"

issues-created: []

# Metrics
duration: 8min
completed: 2026-02-12
---

# Phase 93.1-01: Tournament Data Integrity Code Fixes Summary

**Fixed tournament lookup and API filtering to include country, preventing new data corruption from same-name tournaments in different countries**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-12T12:30:00Z
- **Completed:** 2026-02-12T12:38:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Tournament lookup now includes country in WHERE clause, preventing "Premier League" England from matching "Premier League" Singapore
- API competitor event filtering now matches tournaments by both name AND country
- Null country handling implemented correctly with .is_(None) comparisons
- Case-insensitive matching maintained for both tournament name and country

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix BetPawa tournament lookup to include country** - `a40e00e` (fix)
2. **Task 2: Fix API tournament filtering to include country** - `2493929` (fix)

**Plan metadata:** (this commit) (docs: complete plan)

## Files Created/Modified

- `src/scraping/event_coordinator.py` - Updated `_get_or_create_tournament_from_betpawa_raw()` to include country in lookup query
- `src/api/routes/events.py` - Updated tournament filter for competitor events to match on name + country

## Decisions Made

- **Separate queries for NULL vs non-NULL country:** Chose explicit if/else with `.is_(None)` rather than COALESCE for clarity and to avoid potential type coercion issues
- **Case-insensitive country matching:** Applied `func.lower()` to both Tournament.country and CompetitorTournament.country_raw for consistency

## Deviations from Plan

None - plan executed exactly as written

## Issues Encountered

None

## Next Phase Readiness

- Code fixes complete, preventing NEW data corruption
- Ready for 93.1-02: Data Migration to fix existing corrupted data
- Migration should clean up events incorrectly linked to wrong tournaments

---
*Phase: 93.1-tournament-data-integrity*
*Plan: 01*
*Completed: 2026-02-12*
