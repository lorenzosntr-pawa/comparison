---
phase: 44-high-priority-market-mappings
plan: 01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 44-01 (Blocker UI display bug, Major HAOU mapping, Minor outcome handling).

Source: 44-01-ISSUES.md
Priority: 1 blocker, 1 major, 1 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/44-high-priority-market-mappings/44-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/44-high-priority-market-mappings/44-01-PLAN.md

**Key files to investigate:**
@src/api/routes/events.py
@frontend/src/pages/EventDetailPage.tsx (or equivalent)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate and fix UI duplicate rows bug (UAT-002 - Blocker)</name>
  <files>
    - frontend/src/pages/EventDetailPage.tsx (or events page component)
    - frontend/src/components/MarketComparison.tsx (or equivalent)
    - src/api/routes/events.py (if API is sending duplicates)
  </files>
  <action>
**Investigation steps:**
1. Check API response for /events/1928 to see if duplicates come from backend
   - Run: `curl http://localhost:8000/events/1928 | python -m json.tool | head -200`
   - Look for duplicate market entries in `markets_by_bookmaker`

2. If duplicates in API:
   - Check `_build_bookmaker_market_data()` in events.py
   - Look for loops that might add same market multiple times
   - Check if O/U markets with different lines are being grouped incorrectly

3. If API is clean, check frontend:
   - Look for how markets are grouped/displayed
   - Check for missing key props in React lists causing re-renders
   - Look for cartesian product logic that multiplies rows incorrectly

**Fix based on findings:**
- If API issue: Fix the query/grouping logic
- If frontend issue: Fix the rendering/grouping logic
- Ensure each market+line combination appears exactly once per bookmaker
  </action>
  <verify>
1. curl http://localhost:8000/events/1928 shows no duplicate markets
2. UI shows single row per market (not 6+ duplicates)
3. All outcomes (No goal, 1-2, 3+) visible in single row
  </verify>
  <done>
- No duplicate rows in UI
- Each market appears once per bookmaker
- Multigoals markets display correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Bet9ja odds not appearing in UI (UAT-002 continued)</name>
  <files>
    - frontend/src/components/MarketComparison.tsx (or equivalent)
    - src/api/routes/events.py
  </files>
  <action>
**Investigation steps:**
1. Verify API returns Bet9ja odds for TMGHO (28000077):
   - Check if Bet9ja is in `markets_by_bookmaker` response
   - Verify TMGHO market with "1-2" outcome is included

2. Check how frontend matches outcomes across bookmakers:
   - Look for outcome name matching logic
   - Bet9ja has "1-2" while Betpawa might have "1-2" - should match
   - Check if case sensitivity or whitespace causes mismatches

3. Check if frontend filters out markets with partial outcomes:
   - Bet9ja only has "1-2", not "No goal" or "3+"
   - UI might be hiding entire market if all outcomes don't match

**Fix based on findings:**
- Ensure outcome matching is case-insensitive and whitespace-normalized
- Don't hide markets just because some outcomes are missing
- Show "-" for missing outcomes, but show available odds
  </action>
  <verify>
1. API response includes Bet9ja TMGHO market with "1-2" odds
2. UI shows Bet9ja "1-2" odds (not "-" dash)
3. Missing outcomes (No goal, 3+) show "-" for Bet9ja
  </verify>
  <done>
- Bet9ja odds appear in UI for available outcomes
- "-" shown only for outcomes Bet9ja doesn't have
- Comparison table correctly shows partial data
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix HAOU Home/Away confusion (UAT-001 - Major)</name>
  <files>
    - src/market_mapping/mappings/market_ids.py
    - src/market_mapping/mappers/bet9ja.py
  </files>
  <action>
**Context from 44-01-ISSUES.md:**
- HAOU is a combined Bet9ja market with 4 outcomes: OH (Over Home), UH (Under Home), OA (Over Away), UA (Under Away)
- Current mapping has betpawa_id=None (UNSUPPORTED_PLATFORM)
- But the outcomes themselves should map to two separate Betpawa markets:
  - OH/UH → Betpawa "Home Team Over/Under" (5006)
  - OA/UA → Betpawa "Away Team Over/Under" (5003)

**Options to consider:**
1. **Split mapping approach:** When Bet9ja HAOU is encountered, split into two MappedMarket objects - one for Home O/U, one for Away O/U
2. **Combined display approach:** Keep as one market but display correctly

**Recommended fix:**
1. Modify bet9ja mapper to split HAOU into two separate markets
2. Map OH/UH outcomes to betpawa_market_id="5006" (Home O/U)
3. Map OA/UA outcomes to betpawa_market_id="5003" (Away O/U)
4. Return two MappedMarket objects instead of one

**Implementation:**
- In bet9ja.py, add special handling for HAOU market
- When market_key="HAOU", split outcomes and create two mapped markets
  </action>
  <verify>
1. Run verify_market_fixes.py - HAOU should no longer show UNSUPPORTED_PLATFORM
2. Bet9ja Home O/U should appear alongside Betpawa Home O/U (5006)
3. Bet9ja Away O/U should appear alongside Betpawa Away O/U (5003)
  </verify>
  <done>
- HAOU splits into Home O/U and Away O/U correctly
- Home outcomes map to Home market
- Away outcomes map to Away market
- No more Home/Away confusion
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python src/scripts/verify_market_fixes.py` shows improved HAOU results
- [ ] UI shows no duplicate rows for Multigoals markets
- [ ] Bet9ja odds appear in UI for markets they have data for
- [ ] HAOU correctly splits into Home and Away markets
</verification>

<success_criteria>
- UAT-002 (Blocker): No duplicate rows, Bet9ja odds visible
- UAT-001 (Major): HAOU Home/Away no longer confused
- UAT-003 (Minor): Acknowledged - outcome incompatibility is expected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/44-high-priority-market-mappings/44-01-FIX-SUMMARY.md`
</output>
