---
phase: 44-high-priority-market-mappings
plan: 01
type: execute
domain: market-mapping
---

<objective>
Fix NO_MATCHING_OUTCOMES errors for HIGH priority markets by aligning outcome mappings with actual API data.

Purpose: These markets are already recognized in market_ids.py but outcomes don't match what the APIs return. These are the "closest to working" fixes - just need outcome structure alignment.

Output: Updated market_ids.py with corrected outcome mappings for 6 markets, improving mapping success rate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md
@.planning/phases/43-market-mapping-audit/audit_raw_data.json
@.planning/phases/44-high-priority-market-mappings/44-CONTEXT.md
@src/market_mapping/mappings/market_ids.py
@src/market_mapping/mappers/bet9ja.py
@src/market_mapping/mappers/sportybet.py

**Phase 43-01 Results:**
- SportyBet: 47.3% mapping success (8,323/17,605 markets)
- Bet9ja: 36.1% mapping success (5,580/15,465 markets)

**HIGH Priority NO_MATCHING_OUTCOMES Markets:**
| Platform | Market Key | Description | Frequency | Current Issue |
|----------|------------|-------------|-----------|---------------|
| bet9ja | HTFTOU | Half Time/Full Time + O/U | 248 | Combo market outcomes don't match |
| bet9ja | TMGHO | Team Multigoal - Home | 99 | Multigoal outcome structure |
| bet9ja | TMGAW | Team Multigoal - Away | 99 | Multigoal outcome structure |
| sportybet | 551 | Multiscores | 66 | Complex outcome variants |
| bet9ja | HTFTCS | HT/FT Correct Score | 54 | Score combination structure |
| bet9ja | HAOU | Home/Away Over/Under | 50 | Team-specific O/U outcomes |
| sportybet | 46 | HT/FT Correct Score | 56 | Score combination structure |

**Pattern:** These are parameterized combo markets where outcome suffixes/descriptions have specific patterns we're not matching correctly.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze raw outcome structures for NO_MATCHING_OUTCOMES markets</name>
  <files>.planning/phases/44-high-priority-market-mappings/outcome-analysis.md</files>
  <action>
Load audit_raw_data.json and extract actual outcome structures for the 6 target markets:
1. Parse JSON and find events with these market types
2. For each market, document: actual outcome suffixes (bet9ja) or descriptions (sportybet)
3. Compare against current OutcomeMapping in market_ids.py
4. Identify specific mismatches (wrong suffix, case sensitivity, missing outcomes)

Focus on:
- HTFTOU: What outcome suffixes does bet9ja actually use? (expect combos like "1/1_O", "1/X_U" etc.)
- TMGHO/TMGAW: What multigoal ranges and suffixes?
- Multiscores/551: What outcome descriptions does sportybet return?
- HTFTCS: Score combo suffixes
- HAOU: Team-specific O/U suffixes

Document findings in outcome-analysis.md for reference during fixes.
  </action>
  <verify>outcome-analysis.md exists with clear documentation of actual vs expected outcome structures for all 6 markets</verify>
  <done>Each market has documented: current mapping, actual API outcomes, specific mismatches identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix outcome mappings in market_ids.py</name>
  <files>src/market_mapping/mappings/market_ids.py</files>
  <action>
Based on outcome-analysis.md findings, update OutcomeMapping entries for each market:

1. **If mapping exists but outcomes wrong:** Update bet9ja_suffix or sportybet_desc to match actual API values
2. **If mapping exists but missing outcomes:** Add additional OutcomeMapping entries for new outcome variants
3. **If market is combo (HTFTOU, HTFTCS):** Ensure all valid combinations are mapped

Rules:
- Preserve existing canonical_id and betpawa_name values
- Only modify bet9ja_suffix and sportybet_desc to match actual API data
- Add position values for new outcomes (continue from last position)
- If outcome has no betpawa equivalent, set betpawa_name=None

For parameterized markets like HTFTOU that combine HT/FT result with O/U:
- Check if BET9JA_OVER_UNDER_KEYS in bet9ja.py includes HTFTOU (it does per line 48)
- Ensure outcome suffixes match the pattern: result_combo + O/U suffix

Avoid: Breaking existing working mappings - only modify specific outcome fields.
  </action>
  <verify>grep -n "HTFTOU\|TMGHO\|TMGAW\|Multiscores\|HTFTCS\|HAOU" src/market_mapping/mappings/market_ids.py shows updated entries</verify>
  <done>All 6 markets have corrected outcome mappings matching actual API response structures</done>
</task>

<task type="auto">
  <name>Task 3: Verify fixes with spot-check audit</name>
  <files>src/scripts/audit_market_mapping.py</files>
  <action>
Run a targeted audit on the 6 fixed markets to verify improvements:

1. Modify audit script (or create temp variant) to only test the 6 target markets
2. Run against 10-20 events to spot-check
3. Verify NO_MATCHING_OUTCOMES count is reduced for these markets
4. If issues found, iterate on fixes

Verification command:
```bash
python -m src.scripts.audit_market_mapping --markets HTFTOU,TMGHO,TMGAW,551,HTFTCS,HAOU --limit 20
```

If audit script doesn't support --markets flag, manually test by:
1. Reading sample event data
2. Calling map_bet9ja_market_to_betpawa() or map_sportybet_to_betpawa()
3. Confirming no MappingError with code NO_MATCHING_OUTCOMES

Document any remaining issues for follow-up.
  </action>
  <verify>Spot-check shows reduced NO_MATCHING_OUTCOMES errors for target markets</verify>
  <done>All 6 markets pass spot-check validation with no NO_MATCHING_OUTCOMES errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] outcome-analysis.md documents actual outcome structures for all 6 markets
- [ ] market_ids.py has corrected OutcomeMapping entries
- [ ] No syntax errors in market_ids.py (Python imports successfully)
- [ ] Spot-check shows NO_MATCHING_OUTCOMES resolved for target markets
- [ ] Existing tests still pass: `python -m pytest tests/test_bet9ja_mapper.py tests/test_sportybet_mapper.py -v`
</verification>

<success_criteria>
- All 6 HIGH priority NO_MATCHING_OUTCOMES markets have corrected outcome mappings
- Spot-check validation passes
- No regression in existing mapping tests
- Analysis documented for future reference
</success_criteria>

<output>
After completion, create `.planning/phases/44-high-priority-market-mappings/44-01-SUMMARY.md`:

# Phase 44 Plan 01: NO_MATCHING_OUTCOMES Fixes Summary

**[One-liner: What was fixed]**

## Accomplishments
- [Markets fixed]
- [Outcome patterns corrected]

## Files Created/Modified
- `src/market_mapping/mappings/market_ids.py` - Outcome mapping corrections
- `.planning/phases/44-high-priority-market-mappings/outcome-analysis.md` - Analysis doc

## Metrics
- Markets fixed: 6
- Estimated occurrences resolved: ~672 (248+99+99+66+54+50+56)

## Issues Encountered
[Any remaining issues or edge cases]

## Next Step
Ready for 44-02-PLAN.md (UNKNOWN_MARKET fixes)
</output>
