---
phase: 44-high-priority-market-mappings
plan: 01-FIX2
type: fix
---

<objective>
Fix UAT-004: Duplicate market rows in UI.

Source: 44-01-ISSUES.md
Priority: 1 major issue

The previous fix (44-01-FIX) correctly merges outcomes from split market records into a single market. However, the code iterates over the raw API response instead of the deduplicated map, causing duplicate rows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/44-high-priority-market-mappings/44-01-ISSUES.md

**Affected file:**
@web/src/features/matches/components/market-grid.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Fix duplicate row iteration in buildUnifiedMarkets</name>
  <files>web/src/features/matches/components/market-grid.tsx</files>
  <action>
The bug is on line 116: `for (const market of betpawaData.markets)` iterates over raw API data with duplicates.

**Root cause:**
- `bookmakerMaps` correctly deduplicates markets (lines 77-97)
- But line 116 iterates over `betpawaData.markets` (raw, not deduplicated)
- When Betpawa has 3 records for same market (split outcomes), it creates 3 unified entries

**Fix:**
Change lines 115-136 to iterate over the deduplicated `bookmakerMaps.get('betpawa')` instead of `betpawaData.markets`:

```typescript
// First add Betpawa markets (they define the reference)
const betpawaMap = bookmakerMaps.get('betpawa')
if (betpawaMap) {
  for (const [key, market] of betpawaMap) {
    const bookmakerMarkets = new Map<string, MarketOddsDetail | null>()
    for (const slug of BOOKMAKER_ORDER) {
      const bMap = bookmakerMaps.get(slug)
      bookmakerMarkets.set(slug, bMap?.get(key) ?? null)
    }

    unifiedMarkets.push({
      id: market.betpawa_market_id,
      name: market.betpawa_market_name,
      line: market.line,
      bookmakerMarkets,
    })
    allMarketKeys.delete(key)
  }
}
```

This uses the already-deduplicated map, eliminating duplicate rows.
  </action>
  <verify>
1. `npm run build` passes
2. Visit a match detail page with multigoal markets
3. Verify each market appears only ONCE (no duplicate rows)
4. Verify outcomes are still merged correctly (multiple outcomes per row)
  </verify>
  <done>
- No duplicate market rows in UI
- Outcomes still correctly merged
- Build passes
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Build succeeds without errors
- [ ] No duplicate market rows visible in UI
- [ ] Market outcomes still merge correctly
- [ ] TMGHO/TMGAW show single row with all outcomes
- [ ] Correct Score markets show single row
</verification>

<success_criteria>
- UAT-004 from 44-01-ISSUES.md addressed
- Build passes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/44-high-priority-market-mappings/44-01-FIX2-SUMMARY.md`
</output>
