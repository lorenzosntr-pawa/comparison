---
phase: 44-high-priority-market-mappings
plan: 03
type: execute
domain: market-mapping
---

<objective>
Fix UNKNOWN_PARAM_MARKET errors for HIGH priority combo markets by adding parameter handling support.

Purpose: These markets are recognized but have parameterized variants (e.g., 1X2 + Over/Under combos) that we don't handle. Need to update mappers to process the parameters correctly.

Output: Updated mapper logic to handle combo market parameters, resolving ~1,500 market occurrences.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-market-mapping-audit/AUDIT-FINDINGS.md
@.planning/phases/43-market-mapping-audit/audit_raw_data.json
@.planning/phases/44-high-priority-market-mappings/44-CONTEXT.md
@src/market_mapping/mappers/bet9ja.py
@src/market_mapping/mappers/sportybet.py
@src/market_mapping/mappings/market_ids.py

**HIGH Priority UNKNOWN_PARAM_MARKET Markets:**
| Platform | Market ID | Description | Frequency | Parameter Type |
|----------|-----------|-------------|-----------|----------------|
| bet9ja | 1X2OU | 1X2 + Over/Under | 348 | O/U line (e.g., @2.5) |
| bet9ja | DCOU | Double Chance + Over/Under | 342 | O/U line (e.g., @2.5) |
| sportybet | 37 | 1X2 & Over/Under | 264 | total=X.X specifier |
| sportybet | 547 | Double Chance & Over/Under | 264 | total=X.X specifier |
| sportybet | 818 | Halftime/Fulltime & Over/Under | 216 | total=X.X specifier |
| sportybet | 36 | Over/Under & GG/NG | 66 | total=X.X specifier |

**Total Impact:** ~1,500 market occurrences

**Root Cause:**
- These markets combine two concepts (e.g., 1X2 result + O/U goals)
- They have a parameter (the O/U line) but aren't in BET9JA_OVER_UNDER_KEYS
- The mapper sees a param it doesn't recognize and raises UNKNOWN_PARAM_MARKET

**Pattern Analysis:**
- Bet9ja format: `S_1X2OU@2.5_1O` = 1X2 + O/U at 2.5, Home+Over outcome
- SportyBet: market ID 37 with specifier `total=2.5`

**Existing Handling:**
- `BET9JA_OVER_UNDER_KEYS` in bet9ja.py defines which markets use O/U params
- `is_over_under_market()` in sportybet.py checks for O/U markets
- Adding combo markets to these lists should enable parameter handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze combo market parameter patterns</name>
  <files>.planning/phases/44-high-priority-market-mappings/param-market-research.md</files>
  <action>
Research the actual parameter and outcome formats for combo markets:

From audit_raw_data.json, for each target market:
1. Find sample occurrences
2. Document the parameter format (e.g., @2.5 for bet9ja, total=2.5 for sportybet)
3. Document outcome combinations (e.g., "1O", "1U", "XO", "XU", "2O", "2U" for 1X2OU)
4. Verify the market needs parameter handling (not just missing mapping)

Key questions:
- 1X2OU: Outcomes are 6 combos (3 results x 2 O/U) or separate?
- DCOU: Similar pattern with 3 DC outcomes x 2 O/U?
- SportyBet 37: Same combo pattern as bet9ja?
- 818: HT/FT (9 outcomes) x O/U (2) = 18 outcomes?
- 36: O/U x GG/NG = 4 outcomes?

Create param-market-research.md documenting:
- Market ID and name
- Parameter format
- Full outcome list
- Proposed handling approach
  </action>
  <verify>param-market-research.md exists with documented patterns for all 6 target markets</verify>
  <done>Each combo market has: parameter format, outcome structure, handling approach documented</done>
</task>

<task type="auto">
  <name>Task 2: Update mappers to handle combo market parameters</name>
  <files>src/market_mapping/mappers/bet9ja.py, src/market_mapping/mappers/sportybet.py, src/market_mapping/mappings/market_ids.py</files>
  <action>
Based on param-market-research.md, implement parameter handling:

**For Bet9ja (bet9ja.py):**
1. Add combo market keys to appropriate sets:
   - If using O/U param: add to BET9JA_OVER_UNDER_KEYS
   - May need new set for combo markets if outcome structure differs
2. Update _map_over_under_market() or create _map_combo_market() if needed
3. Ensure outcome mapping handles combo suffixes (e.g., "1O", "XU")

**For SportyBet (sportybet.py):**
1. Update TIME_BASED_MARKET_IDS or create new set for combo markets
2. Update parameterized market handling in map_sportybet_to_betpawa()
3. Handle total specifier for combo markets

**For market_ids.py:**
1. Add MarketMapping entries for combo markets if not present
2. Ensure outcome_mapping includes all combo outcomes
3. Example for 1X2OU:
```python
MarketMapping(
    canonical_id="1x2_over_under_ft",
    name="1X2 & Over/Under - Full Time",
    betpawa_id="XXXX",  # or None
    sportybet_id="37",
    bet9ja_key="S_1X2OU",
    outcome_mapping=(
        OutcomeMapping(canonical_id="home_over", betpawa_name="1 & Over", sportybet_desc="Home & Over", bet9ja_suffix="1O", position=0),
        OutcomeMapping(canonical_id="home_under", betpawa_name="1 & Under", sportybet_desc="Home & Under", bet9ja_suffix="1U", position=1),
        # ... more combos
    ),
),
```

Rules:
- Keep existing O/U and handicap handling working (don't break)
- Combo markets likely need line value in MappedMarket output
- Test incrementally: add one market at a time
  </action>
  <verify>
grep -n "1X2OU\|DCOU" src/market_mapping/mappers/bet9ja.py shows market keys in handling sets
grep -n "37\|547\|818" src/market_mapping/mappers/sportybet.py shows sportybet handling
python -c "from market_mapping.mappers import bet9ja, sportybet" succeeds
  </verify>
  <done>Mapper logic updated to handle all 6 HIGH priority combo markets with parameters</done>
</task>

<task type="auto">
  <name>Task 3: Verify parameter handling with tests and spot-check</name>
  <files>tests/test_bet9ja_mapper.py, tests/test_sportybet_mapper.py</files>
  <action>
Verify the combo market parameter handling works:

1. **Add targeted tests for new combo markets:**
For bet9ja, test:
```python
def test_1x2_over_under_combo():
    result = map_bet9ja_market_to_betpawa(
        market_key="1X2OU",
        param="2.5",
        outcomes={"1O": "2.50", "1U": "4.00", "XO": "5.50", ...}
    )
    assert result.line == 2.5
    assert len(result.outcomes) >= 4  # or expected count
```

For sportybet, test:
```python
def test_1x2_over_under_combo_sportybet():
    market = SportybetMarket(id="37", specifier="total=2.5", outcomes=[...])
    result = map_sportybet_to_betpawa(market)
    assert result.line == 2.5
```

2. **Run existing tests to ensure no regression:**
```bash
python -m pytest tests/test_bet9ja_mapper.py tests/test_sportybet_mapper.py -v
```

3. **Spot-check with audit data:**
Load real market data from audit_raw_data.json for combo markets
Verify mapping succeeds without UNKNOWN_PARAM_MARKET error

Document any edge cases or issues found.
  </action>
  <verify>
pytest tests/test_*_mapper.py -v passes all tests
Spot-check with real data shows combo markets mapping successfully
  </verify>
  <done>Combo market handling verified with new tests and spot-check validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] param-market-research.md documents all 6 target combo markets
- [ ] bet9ja.py updated with combo market key handling
- [ ] sportybet.py updated with combo market specifier handling
- [ ] market_ids.py has mappings for all combo markets with full outcome sets
- [ ] No import/syntax errors in modified files
- [ ] New targeted tests added and passing
- [ ] Existing tests still pass (no regression)
- [ ] Spot-check shows UNKNOWN_PARAM_MARKET resolved for target markets
</verification>

<success_criteria>
- All 6 HIGH priority UNKNOWN_PARAM_MARKET combos have working parameter handling
- New tests validate the functionality
- No regression in existing mapping functionality
- ~1,500 market occurrences now mappable
</success_criteria>

<output>
After completion, create `.planning/phases/44-high-priority-market-mappings/44-03-SUMMARY.md`:

# Phase 44 Plan 03: UNKNOWN_PARAM_MARKET Fixes Summary

**[One-liner: Combo market parameter handling added]**

## Accomplishments
- [Markets now handling parameters]
- [Code changes made]

## Files Created/Modified
- `src/market_mapping/mappers/bet9ja.py` - Combo market key sets
- `src/market_mapping/mappers/sportybet.py` - Combo specifier handling
- `src/market_mapping/mappings/market_ids.py` - Combo market mappings
- `tests/test_*_mapper.py` - New combo tests
- `.planning/phases/44-high-priority-market-mappings/param-market-research.md` - Research doc

## Markets Fixed
| Market | Platform | Frequency | Fix |
|--------|----------|-----------|-----|
| 1X2OU | bet9ja | 348 | Added to O/U handling |
| ... | ... | ... | ... |

## Issues Encountered
[Any issues]

## Next Step
Phase 44 complete - run full audit to measure improvement, then plan Phase 45
</output>
