---
phase: 14-scraping-logging-workflow
plan: 04
type: execute
---

<objective>
Enhance detail page with timeline view, live log stream, and step-level progress for each bookmaker.

Purpose: Provide complete visibility into scrape workflow with audit trail and real-time operation tracking.
Output: Timeline showing phase transitions, terminal-like log stream for active scrapes, enhanced per-bookmaker progress cards.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scraping-logging-workflow/14-CONTEXT.md

# Key source files:
@web/src/features/scrape-runs/detail.tsx
@web/src/features/scrape-runs/hooks/use-scrape-run-detail.ts
@src/api/routes/scrape.py

# Prior plans in this phase:
@.planning/phases/14-scraping-logging-workflow/14-01-SUMMARY.md
@.planning/phases/14-scraping-logging-workflow/14-02-SUMMARY.md
@.planning/phases/14-scraping-logging-workflow/14-03-SUMMARY.md

**UI vision from CONTEXT.md:**
- Timeline view showing when each phase started/ended
- Live log stream like a terminal during active scrapes
- Progress breakdown with cards/sections per bookmaker showing steps and status
- Errors shown inline AND in summary section

**Established patterns:**
- useScrapeRunDetail hook with pollWhileRunning
- SSE EventSource for real-time progress
- Card, Badge components from shadcn/ui
- formatDistanceToNow from date-fns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phase history API endpoint and timeline component</name>
  <files>src/api/routes/scrape.py, src/api/schemas/scheduler.py, web/src/features/scrape-runs/components/timeline.tsx, web/src/features/scrape-runs/hooks/use-phase-history.ts</files>
  <action>
1. Add API endpoint in src/api/routes/scrape.py:
   GET /api/scrape/runs/{run_id}/phases
   - Query ScrapePhaseLog table for this run_id
   - Order by started_at ASC
   - Return list of ScrapePhaseLogResponse

2. Add ScrapePhaseLogResponse to src/api/schemas/scheduler.py (if not already from 14-02):
   - id: int
   - platform: str | None
   - phase: str
   - started_at: datetime
   - ended_at: datetime | None
   - events_processed: int | None
   - message: str | None
   - error_details: dict | None

3. Create web/src/features/scrape-runs/hooks/use-phase-history.ts:
```tsx
export function usePhaseHistory(runId: number) {
  return useQuery({
    queryKey: ['scrape-run-phases', runId],
    queryFn: () => api.get<ScrapePhaseLog[]>(`/scrape/runs/${runId}/phases`),
    staleTime: 30_000,  // Refresh every 30s
  })
}
```

4. Create web/src/features/scrape-runs/components/timeline.tsx:
   - Display phases as vertical timeline
   - Each phase shows: time, platform (if any), phase name, message
   - Failed phases highlighted in red with error info
   - Active phase (no ended_at) shows spinner
   - Calculate duration between started_at and ended_at
   - Use relative time for recent (e.g., "2 min ago") and absolute for older

Timeline visual structure:
```
○ 10:05:23 | Initializing | Starting scrape of 3 platforms
│
● 10:05:24 | BetPawa | Discovering | Finding competitions...
│ ↳ 45 competitions found
│
● 10:05:26 | BetPawa | Scraping | Fetching events...
│ ↳ 234 events scraped
│
● 10:05:30 | BetPawa | Storing | Saving to database...
│ ↳ 234 events stored
│
● 10:05:32 | SportyBet | Scraping | Fetching events...
│ ↳ 189 events scraped
...
```

Do NOT remove existing components - timeline is additive.
  </action>
  <verify>curl http://localhost:8000/api/scrape/runs/1/phases (returns phase history array)</verify>
  <done>Phase history API endpoint created, timeline component shows phase transitions with timing</done>
</task>

<task type="auto">
  <name>Task 2: Add live log stream and enhance per-bookmaker progress cards</name>
  <files>web/src/features/scrape-runs/detail.tsx, web/src/features/scrape-runs/components/live-log.tsx, web/src/features/scrape-runs/components/platform-progress-card.tsx</files>
  <action>
1. Create web/src/features/scrape-runs/components/live-log.tsx:
   - Terminal-like display (monospace font, dark background)
   - Scrollable container with auto-scroll to bottom
   - Show recent SSE messages as log lines
   - Format: [timestamp] [platform] phase: message
   - Color code by severity: info=gray, warning=yellow, error=red
   - Show spinner for active operations

```tsx
function LiveLog({ messages }: { messages: LogMessage[] }) {
  const containerRef = useRef<HTMLDivElement>(null)

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    if (containerRef.current) {
      containerRef.current.scrollTop = containerRef.current.scrollHeight
    }
  }, [messages])

  return (
    <div
      ref={containerRef}
      className="h-48 overflow-y-auto bg-zinc-900 text-zinc-100 font-mono text-xs p-3 rounded-md"
    >
      {messages.map((msg, i) => (
        <div key={i} className={cn(
          'py-0.5',
          msg.level === 'error' && 'text-red-400',
          msg.level === 'warning' && 'text-yellow-400',
        )}>
          <span className="text-zinc-500">[{msg.time}]</span>
          {msg.platform && (
            <span className={PLATFORM_COLORS[msg.platform]}> [{msg.platform}]</span>
          )}
          <span> {msg.phase}:</span>
          <span> {msg.message}</span>
        </div>
      ))}
    </div>
  )
}
```

2. Create web/src/features/scrape-runs/components/platform-progress-card.tsx:
   - Card for each platform showing detailed step progress
   - Shows current phase with appropriate icon
   - Progress bar for overall platform progress
   - Step list: discovering → scraping → mapping → storing → completed
   - Each step shows: icon, name, status (pending/active/done), count if applicable
   - Timing info for completed steps

3. Update web/src/features/scrape-runs/detail.tsx:
   - Import and use Timeline component (show below summary card)
   - Import and use LiveLog component (show for active scrapes only)
   - Replace or enhance existing "Live Progress Panel" with PlatformProgressCard components
   - Collect SSE messages for LiveLog display
   - Show timeline for completed runs, live log for active runs

4. Enhance error display:
   - Keep existing ErrorList at bottom
   - Also show inline error indicators on timeline entries
   - When phase has error_details, show brief error inline with expandable details

Layout for active scrape:
```
[Header with back button, title, retry button]

[Live Log - terminal-like stream of recent events]

[Per-Platform Progress Cards - 3 cards side by side]
  - BetPawa Card: [✓ discovering] [✓ scraping 234] [⟳ storing...] [○ done]
  - SportyBet Card: [✓ scraping 189] [○ storing] [○ done]
  - Bet9ja Card: [○ discovering] [○ scraping] [○ storing] [○ done]

[Summary Card - existing]
[Platform Breakdown - existing]
[Errors - existing]
```

Layout for completed scrape:
```
[Header]
[Timeline - showing all phase transitions with timing]
[Summary Card]
[Platform Breakdown]
[Errors (if any)]
```

Do NOT break existing functionality - enhancements should be additive.
Keep the existing PlatformBreakdown and ErrorList components.
  </action>
  <verify>Start dev server, trigger scrape, verify: live log appears during scrape, timeline appears after completion</verify>
  <done>Live log stream shows real-time operations, per-platform cards show step-level progress, timeline shows completed phases</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced detail page with timeline, live log stream, and per-bookmaker progress cards</what-built>
  <how-to-verify>
    1. Run: `cd web && pnpm dev` (frontend) and `uvicorn src.main:app --reload` (backend)
    2. Go to dashboard, trigger a new scrape
    3. During scrape, click on the running scrape row to go to detail page
    4. Verify: Live log (terminal-like) appears showing real-time operations
    5. Verify: Per-platform progress cards show step-by-step status
    6. Wait for scrape to complete
    7. Verify: Timeline appears showing all phase transitions with timing
    8. Verify: Each timeline entry shows platform, phase, message, duration
    9. Navigate to an older completed scrape
    10. Verify: Timeline displays correctly for historical data
    11. If there were errors, verify: errors appear inline on timeline AND in error summary
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API endpoint GET /api/scrape/runs/{id}/phases returns phase history
- [ ] Timeline component renders phase history correctly
- [ ] Live log stream appears for active scrapes
- [ ] Per-platform progress cards show step-level status
- [ ] Existing functionality (summary, platform breakdown, errors) still works
- [ ] Human verified detail page changes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified detail page enhancements
- Timeline shows phase transitions with timing
- Live log shows real-time operations during active scrapes
- Per-platform cards show step-level progress
- Errors displayed inline and in summary
- Phase 14 complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-scraping-logging-workflow/14-04-SUMMARY.md`:

# Phase 14 Plan 04: Detail Page Enhancement Summary

**[One-liner summary]**

## Accomplishments
- Phase history API endpoint created
- Timeline component shows phase transitions
- Live log stream for active scrapes
- Per-platform progress cards with step-level status
- Enhanced error display (inline and summary)

## Files Created/Modified
[list files]

## Decisions Made
[key decisions]

## Issues Encountered
[problems and resolutions, or "None"]

## Next Step
Phase 14 complete, ready for next phase
</output>
