---
phase: 82-comparison-table
plan: 01
type: execute
---

<objective>
Enhance the locked timestamp comparison panels with best/worst odds highlighting, margin display, and Betpawa delta comparison.

Purpose: Enable traders to quickly identify which bookmaker offers best value at any locked timestamp, using the same visual patterns established in the main odds comparison table.
Output: Enhanced comparison panels in OddsLineChart, MarginLineChart, and MarketHistoryPanel with OddsBadge-style coloring and margin/delta information.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/81-interactive-chart/81-01-FIX-SUMMARY.md

# Key files to modify
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/components/margin-line-chart.tsx
@web/src/features/matches/components/market-history-panel.tsx

# Existing patterns to follow
@web/src/features/matches/components/odds-badge.tsx
@web/src/features/matches/components/margin-indicator.tsx

**Tech stack available:** recharts, OddsBadge component, MarginIndicator component
**Established patterns:**
- OddsBadge: green for best odds, red for worst/>3% worse than Betpawa
- MarginIndicator: green for lower margin than Betpawa, red for higher
- Betpawa as reference bookmaker for all comparisons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComparisonTable component</name>
  <files>web/src/features/matches/components/comparison-table.tsx</files>
  <action>Create a reusable ComparisonTable component for locked timestamp data:

  Props:
  - `lockedData`: Record<string, unknown> (the locked data point from chart)
  - `outcomeNames`: string[] (list of outcome names)
  - `bookmakerSlugs`: string[] (list of bookmaker slugs, will be reordered)
  - `bookmakerNames`: Record<string, string> (slug -> display name)
  - `mode`: 'comparison' | 'single' (comparison = multi-bookmaker, single = one bookmaker multi-outcome)
  - `showMargin`: boolean (whether to show margin row)

  Features:
  1. **Column ordering**: Always put 'betpawa' first, then other bookmakers alphabetically
  2. **Best/worst detection**: For each outcome row, find best (highest) and worst (lowest) odds across bookmakers
  3. **Cell rendering**: Use OddsBadge styling patterns:
     - Green background: isBest=true (highest odds for this outcome)
     - Red background: significantly worse than Betpawa (>3% lower)
     - Neutral: all other cases
  4. **Delta column**: Add "vs BP" column showing difference from Betpawa (e.g., "+0.12" or "-0.05")
  5. **Margin row**: If showMargin=true, add final row showing margin for each bookmaker, using MarginIndicator color logic (green if lower than Betpawa, red if higher)

  Table structure (comparison mode):
  ```
  | Outcome | Betpawa | vs BP | SportyBet | vs BP | Bet9ja | vs BP |
  |---------|---------|-------|-----------|-------|--------|-------|
  | Home    | 1.85*   | -     | 1.80      | -0.05 | 1.92*  | +0.07 |
  | Draw    | 3.40    | -     | 3.50*     | +0.10 | 3.35   | -0.05 |
  | Away    | 4.20*   | -     | 4.00      | -0.20 | 4.15   | -0.05 |
  | Margin  | 4.2%    | -     | 4.8%      | +0.6% | 4.0%*  | -0.2% |
  ```
  * = best value for that row

  For single mode (one bookmaker, multi-outcome), skip vs BP column and show outcomes with margin.

  Use inline styles matching OddsBadge/MarginIndicator patterns (bg-green-100, text-green-700, etc.)
  Export from components/index.ts.</action>
  <verify>TypeScript compilation passes, component exports correctly</verify>
  <done>ComparisonTable component created with best/worst highlighting, delta columns, and margin row</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ComparisonTable into chart components</name>
  <files>web/src/features/matches/components/odds-line-chart.tsx, web/src/features/matches/components/margin-line-chart.tsx, web/src/features/matches/components/market-history-panel.tsx, web/src/features/matches/components/index.ts</files>
  <action>Replace existing locked comparison panels with ComparisonTable:

  **OddsLineChart (comparison mode)**:
  - Replace the existing grid div (lines 340-377) with ComparisonTable
  - Pass: lockedData from chartData[lockedIndex], outcomeNames (just selectedOutcome), bookmakerSlugs, bookmakerNames from multiData, mode='comparison', showMargin=false
  - Keep the "Locked at..." header and Unlock button

  **OddsLineChart (single mode)**:
  - Replace the existing grid for single bookmaker (lines 359-376) with ComparisonTable
  - Pass: lockedData, outcomeNames, bookmakerSlugs=['betpawa'], bookmakerNames, mode='single', showMargin=showMargin prop

  **MarginLineChart**:
  - Similar pattern to OddsLineChart - replace existing locked panel
  - Pass showMargin=true since this is the margin chart

  **MarketHistoryPanel**:
  - Replace the table in the locked comparison panel (lines 283-325)
  - Pass: lockedData needs to be assembled from chartDataByOutcome at lockedTime, outcomeNames, bookmakerSlugs, bookmakerNames from multiData, mode='comparison', showMargin=true
  - This one is more complex because data is per-outcome, need to merge into single lockedData object

  **index.ts**: Export ComparisonTable

  Key pattern: The lockedData record has keys matching bookmaker slugs (comparison mode) or outcome names (single mode), with numeric values for odds.</action>
  <verify>npm run build succeeds, lock chart at timestamp and verify table shows best/worst highlighting</verify>
  <done>All three chart components use ComparisonTable with consistent best/worst highlighting and delta display</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced comparison table with best odds highlighting, delta columns, and margin display</what-built>
  <how-to-verify>
    1. Run: npm run dev (in web directory)
    2. Navigate to any event with history data
    3. Open the history dialog (click any odds cell)
    4. Enable comparison mode (toggle)
    5. Click on the chart to lock a timestamp
    6. Verify comparison table shows:
       - Betpawa column first
       - Best odds highlighted green
       - Worse-than-Betpawa odds highlighted red (if >3% lower)
       - "vs BP" delta columns with +/- differences
       - Margin row at bottom with color coding
    7. Test MarketHistoryPanel (full market view tab):
       - Click chart to lock timestamp
       - Verify table shows all outcomes with same highlighting
    8. Unlock and verify table disappears
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors in web directory
- [ ] ComparisonTable component exported from features/matches/components/index.ts
- [ ] Best odds highlighted green in all chart comparison panels
- [ ] Delta columns show +/- difference from Betpawa
- [ ] Margin row shows color-coded margins when applicable
- [ ] Betpawa always appears as first column
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Consistent best/worst highlighting across all chart components
- Delta columns provide clear Betpawa comparison at a glance
</success_criteria>

<output>
After completion, create `.planning/phases/82-comparison-table/82-01-SUMMARY.md`
</output>
