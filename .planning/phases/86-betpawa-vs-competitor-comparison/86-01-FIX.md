---
phase: 86-betpawa-vs-competitor-comparison
plan: 86-01-FIX
type: fix
---

<objective>
Fix 4 UAT issues from plan 86-01.

Source: 86-01-ISSUES.md
Priority: 1 blocker, 2 major, 1 minor

**UAT-003 (Blocker):** Bookmaker toggle buttons missing from Historical Analysis page - integration incomplete
**UAT-001 (Major):** Best Comp column doesn't react to toggle selection - UX feedback needed
**UAT-002 (Major):** Missing 1X2 margin data - backend inline_odds filter (deferred)
**UAT-004 (Minor):** Competitive badge only on 1X2 - user wants on all markets
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/86-betpawa-vs-competitor-comparison/86-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/86-betpawa-vs-competitor-comparison/86-01-PLAN.md

**Key files:**
@web/src/features/historical-analysis/index.tsx
@web/src/features/historical-analysis/components/filter-bar.tsx
@web/src/features/historical-analysis/components/bookmaker-filter.tsx
@web/src/features/historical-analysis/components/tournament-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-003 - Integrate BookmakerFilter into FilterBar and page</name>
  <files>
    - web/src/features/historical-analysis/components/filter-bar.tsx
    - web/src/features/historical-analysis/index.tsx
  </files>
  <action>
The BookmakerFilter component exists but was never integrated into the page. Task 2 from 86-01-PLAN.md was not fully implemented.

1. **Update FilterBar props** to accept bookmaker selection:
   ```typescript
   interface FilterBarProps {
     dateRange: DateRange
     onDateRangeChange: (range: DateRange) => void
     selectedBookmakers: string[]
     onBookmakersChange: (selected: string[]) => void
   }
   ```

2. **Import and render BookmakerFilter** in FilterBar:
   - Add import: `import { BookmakerFilter } from './bookmaker-filter'`
   - Add it to the filter bar layout (after the Quick Select presets, before date inputs)
   - Pass: `selected={selectedBookmakers} onChange={onBookmakersChange}`

3. **Add state to HistoricalAnalysisPage** (index.tsx):
   - Add import for useState if not present
   - Add state: `const [selectedBookmakers, setSelectedBookmakers] = useState(['betpawa', 'sportybet', 'bet9ja'])`
   - Pass to FilterBar: `selectedBookmakers={selectedBookmakers} onBookmakersChange={setSelectedBookmakers}`
   - Pass to TournamentList: `selectedBookmakers={selectedBookmakers}`
  </action>
  <verify>
    - Build succeeds: `cd web && npm run build`
    - Historical Analysis page shows bookmaker toggle buttons in filter bar
    - Clicking toggles changes their selected state visually
  </verify>
  <done>
    - FilterBar renders BookmakerFilter component
    - selectedBookmakers state exists in page
    - Toggle buttons visible with brand-colored dots
    - Clicking toggles updates visual state
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-001 - Make toggle selection visible in card display</name>
  <files>
    - web/src/features/historical-analysis/components/tournament-list.tsx
  </files>
  <action>
The toggle doesn't affect visible data because "Best Comp" always shows competitorAvgMargin from ALL competitors. Fix the UX to show what the toggle affects.

1. **Add selectedBookmakers prop** to TournamentList, TournamentCard, and MarketBreakdown:
   ```typescript
   interface TournamentListProps {
     tournaments: TournamentMetrics[]
     isLoading: boolean
     selectedBookmakers: string[]  // Add this
   }
   ```

2. **Update the "Best Comp." column header** in MarketBreakdown:
   - Count selected competitors: `selectedBookmakers.filter(b => b !== 'betpawa').length`
   - If 2 competitors: show "Best Comp."
   - If 1 competitor: show that competitor's name (SportyBet or Bet9ja)
   - If 0 competitors: hide the column entirely

3. **Filter visibility of competitive badge** based on selection:
   - Only show badge if at least one competitor is selected
   - Badge compares Betpawa vs competitorAvgMargin (still best of all, but UX is clearer)

Note: Per-bookmaker margin columns are added in 86-02. This fix makes the current UX less confusing by showing what's selected.
  </action>
  <verify>
    - Toggle SportyBet off → header changes to "Bet9ja" instead of "Best Comp."
    - Toggle both off → competitor column hides entirely
    - Badge disappears when no competitors selected
  </verify>
  <done>
    - Column header reflects selected bookmakers
    - Column hides when no competitors selected
    - Toggle has visible effect on tournament cards
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-004 - Show competitive badge on all market rows</name>
  <files>
    - web/src/features/historical-analysis/components/tournament-list.tsx
  </files>
  <action>
User wants the +/- competitive badge on all market rows, not just 1X2.

1. Find where CompetitiveBadge is rendered in MarketBreakdown.
2. Remove the condition that limits it to marketId === '3743' (1X2).
3. Show badge for all tracked markets: 1X2, O/U 2.5, BTTS, DC.
4. Keep same coloring: green for better than competitor, red for worse.
  </action>
  <verify>
    Badge appears on all 4 market rows (1X2, O/U 2.5, BTTS, DC)
  </verify>
  <done>
    - Competitive badge (+/-) shows on all market rows
    - Each row shows Betpawa vs competitor difference
  </done>
</task>

<task type="auto">
  <name>Task 4: Document UAT-002 as deferred</name>
  <files>
    - .planning/phases/86-betpawa-vs-competitor-comparison/86-01-ISSUES.md
  </files>
  <action>
UAT-002 (Missing 1X2 margin data) requires backend changes to `_build_inline_odds()` in src/api/routes/events.py. This is out of scope for the current UI fix plan.

Update 86-01-ISSUES.md:
1. Add "## Deferred Issues" section before "## Resolved Issues"
2. Move UAT-002 to Deferred section
3. Add note: "Backend fix - out of scope for UI fix plan. Will be addressed separately."
  </action>
  <verify>ISSUES.md has Deferred section with UAT-002</verify>
  <done>UAT-002 documented as deferred with rationale</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Bookmaker toggle buttons visible on Historical Analysis page
- [ ] Toggling bookmakers affects column header text
- [ ] Toggling all competitors off hides the competitor column
- [ ] Competitive badge appears on all 4 market rows
- [ ] ISSUES.md documents deferred item
</verification>

<success_criteria>
- UAT-003 (Blocker) fixed: Toggle buttons visible on page
- UAT-001 (Major) fixed: Toggle has visible effect on display
- UAT-004 (Minor) fixed: Badge on all market rows
- UAT-002 (Major) deferred: Backend fix documented
- Build passes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/86-betpawa-vs-competitor-comparison/86-01-FIX-SUMMARY.md`
</output>
