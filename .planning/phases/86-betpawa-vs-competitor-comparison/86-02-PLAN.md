---
phase: 86-betpawa-vs-competitor-comparison
plan: 02
type: execute
---

<objective>
Add multi-bookmaker margin display to market cards on Tournament Detail page.

Purpose: Enable per-market comparison of Betpawa vs competitors within a tournament.
Output: Market cards with Betpawa | SportyBet | Bet9ja columns, bookmaker filter in page header.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-CONTEXT.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-01-SUMMARY.md

# Source files
@web/src/features/historical-analysis/tournament-detail.tsx
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
@web/src/features/historical-analysis/components/bookmaker-filter.tsx

**Tech stack available:**
- React 19, TanStack Query v5, shadcn/ui, Tailwind v4
- BookmakerFilter component (from 86-01)
- BOOKMAKER_COLORS constant (from 86-01)

**Established patterns:**
- TournamentMarket interface with avgMargin, minMargin, maxMargin
- MarketCard component with margin stats display
- fuzzyMatch for market search filtering

**Constraining decisions:**
- Brand colors consistent with 86-01
- "—" for missing data, muted text
- All bookmakers on by default
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useTournamentMarkets with competitor margin data</name>
  <files>web/src/features/historical-analysis/hooks/use-tournament-markets.ts</files>
  <action>
Extend the hook to fetch and aggregate competitor margin data per market:

1. Update TournamentMarket interface to include competitor data:
   ```typescript
   interface TournamentMarket {
     // ... existing fields
     competitorMargins: Record<string, MarketMarginStats | null>
     // e.g., { sportybet: { avgMargin: 5.2, minMargin: 4.8, maxMargin: 5.6 }, bet9ja: null }
   }

   interface MarketMarginStats {
     avgMargin: number
     minMargin: number
     maxMargin: number
   }
   ```

2. In the hook, for each market:
   - Extract competitor margin data from event.bookmakers where bookmaker_slug is 'sportybet' or 'bet9ja'
   - Aggregate avg/min/max across events for each competitor
   - Store in competitorMargins keyed by bookmaker slug
   - If competitor has no data for a market, set to null

3. The existing code iterates through events and finds Betpawa markets. Extend to also find competitor markets with matching market_id (using the inline_odds array from competitor bookmakers).

4. For market matching: Use the same market_id + line combination to identify equivalent markets across bookmakers.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>TournamentMarket includes competitorMargins with per-bookmaker avg/min/max, hook calculates competitor stats</done>
</task>

<task type="auto">
  <name>Task 2: Add BookmakerFilter to TournamentDetailPage</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx</files>
  <action>
Add bookmaker selection to the tournament detail page:

1. Import BookmakerFilter from components.

2. Add state for selectedBookmakers:
   ```typescript
   const [selectedBookmakers, setSelectedBookmakers] = useState(['betpawa', 'sportybet', 'bet9ja'])
   ```

3. Add BookmakerFilter to the header area (after tournament name, before "View All Timelines" button).

4. Pass selectedBookmakers to MarketCard components for column filtering.

Layout update in header:
```
[Back] Tournament Name          [BookmakerFilter] [View All Timelines]
       Country — X events
```
  </action>
  <verify>App compiles and page shows bookmaker filter: `cd web && npm run build`</verify>
  <done>TournamentDetailPage has bookmaker filter in header, state updates on toggle</done>
</task>

<task type="auto">
  <name>Task 3: Update MarketCard with multi-bookmaker columns</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx</files>
  <action>
Redesign MarketCard to show multi-bookmaker margins:

1. Update MarketCard props:
   - Add `selectedBookmakers: string[]`
   - Add `competitorMargins: Record<string, MarketMarginStats | null>` (from TournamentMarket)

2. Change margin display from single value to table layout:
   ```
   Market Name 2.5
   ─────────────────────────
   Opening: 5.2% → 4.8% (-0.4%)  [if tracked market]
   ─────────────────────────
              Betpawa  SportyBet  Bet9ja
   Avg margin   5.0%     4.8%      —
   Range      4.5-5.5  4.2-5.0    —
   Events       12        10       —
   ─────────────────────────
   [Timeline button]
   ```

3. For each visible bookmaker (based on selectedBookmakers):
   - Show column with avg margin, range, event count
   - Use "—" for missing data
   - Apply brand color to column header (use BOOKMAKER_COLORS)

4. Add competitive badge on avg margin row:
   - Compare Betpawa avgMargin to best competitor avgMargin
   - Show +X.X% (red) if Betpawa worse, -X.X% (green) if better

5. Handle edge cases:
   - If only Betpawa selected, show single column (current layout)
   - If no competitors have data, show Betpawa only
  </action>
  <verify>App builds and market cards show multi-column layout: `cd web && npm run build`</verify>
  <done>Market cards show bookmaker columns, filter hides/shows columns, competitive badge displays</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Hook returns competitor margin stats per market
- [ ] Bookmaker filter appears in tournament detail header
- [ ] Market cards show multi-column margin display
- [ ] Toggle filter updates visible columns
</verification>

<success_criteria>

- All tasks completed
- useTournamentMarkets returns competitorMargins per market
- Bookmaker filter in tournament detail header
- Market cards show per-bookmaker columns with avg/range
- Competitive badge shows +/- vs best competitor
</success_criteria>

<output>
After completion, create `.planning/phases/86-betpawa-vs-competitor-comparison/86-02-SUMMARY.md`
</output>
