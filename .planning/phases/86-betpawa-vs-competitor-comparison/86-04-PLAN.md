---
phase: 86-betpawa-vs-competitor-comparison
plan: 04
type: execute
---

<objective>
Add difference view to timeline dialog showing Betpawa vs competitor margin gaps over time.

Purpose: Enable deep analysis of when and where Betpawa leads or lags competitors.
Output: Bar chart showing margin difference by time bucket, integrated with view mode toggle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-CONTEXT.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-01-SUMMARY.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-02-SUMMARY.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-03-SUMMARY.md

# Source files
@web/src/features/historical-analysis/components/timeline-dialog.tsx
@web/src/features/historical-analysis/components/time-to-kickoff-chart.tsx
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts

**Tech stack available:**
- React 19, recharts (BarChart, Bar, Cell), shadcn/ui
- BOOKMAKER_COLORS (from 86-01)
- TimelineDialog with view mode toggle (from 86-03)

**Established patterns:**
- BucketStats with bucket, avgMargin, pointCount
- Time buckets: 7d+, 3-7d, 24-72h, <24h
- Color coding: green = Betpawa better (negative diff), red = Betpawa worse (positive diff)

**Constraining decisions:**
- Difference view shows Betpawa minus best competitor
- Positive = Betpawa has higher margin (worse for bettors)
- Negative = Betpawa has lower margin (better for bettors)
- Bar colors: green for negative, red for positive
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DifferenceBarChart component</name>
  <files>web/src/features/historical-analysis/components/difference-bar-chart.tsx, web/src/features/historical-analysis/components/index.ts</files>
  <action>
Create a bar chart showing margin difference by time bucket:

1. Props interface:
   ```typescript
   interface DifferenceBarChartProps {
     betpawaBuckets: BucketStats[]
     competitorBuckets: Record<string, BucketStats[]>  // per bookmaker
     selectedCompetitor?: string  // which competitor to compare (default: best)
     height?: number
   }
   ```

2. Calculate difference data:
   - For each time bucket, calculate: Betpawa avgMargin - Competitor avgMargin
   - If comparing to "best competitor", use lowest competitor margin at each bucket
   - Handle missing data (competitor may not have data for all buckets)

3. Create difference data structure:
   ```typescript
   interface DifferenceBucket {
     bucket: string           // "7d+", "3-7d", etc.
     difference: number       // Betpawa - Competitor
     betpawaMargin: number
     competitorMargin: number
     competitorName: string   // "SportyBet" or "Best Competitor"
   }
   ```

4. Render BarChart from recharts:
   ```tsx
   <BarChart data={differenceData}>
     <CartesianGrid strokeDasharray="3 3" />
     <XAxis dataKey="bucket" />
     <YAxis
       tickFormatter={(v) => `${v > 0 ? '+' : ''}${v.toFixed(1)}%`}
       domain={['dataMin - 0.5', 'dataMax + 0.5']}
     />
     <ReferenceLine y={0} stroke="#888" strokeDasharray="3 3" />
     <Tooltip content={<CustomTooltip />} />
     <Bar dataKey="difference">
       {differenceData.map((entry, index) => (
         <Cell
           key={index}
           fill={entry.difference < 0 ? '#22c55e' : '#ef4444'}
         />
       ))}
     </Bar>
   </BarChart>
   ```

5. Custom tooltip showing:
   ```
   24-72 hours
   Betpawa: 5.2%
   SportyBet: 4.8%
   Difference: +0.4% (Betpawa higher)
   ```

6. Add legend explaining colors:
   - Green bar = Betpawa is more competitive (lower margin)
   - Red bar = Competitor is more competitive

7. Export from components/index.ts.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>DifferenceBarChart component renders bar chart with colored bars, shows difference per time bucket</done>
</task>

<task type="auto">
  <name>Task 2: Integrate difference chart with view mode toggle</name>
  <files>web/src/features/historical-analysis/components/timeline-dialog.tsx</files>
  <action>
Wire up the difference view in TimelineDialog:

1. Import DifferenceBarChart.

2. Update TournamentMarket prop usage to pass competitor bucket data:
   - Need to calculate competitor bucket stats from competitorTimelineData
   - Or extend useTournamentMarkets to pre-calculate competitorBucketStats

3. In TimelineDialog, calculate competitor bucket stats from timeline data:
   ```typescript
   function calculateBucketStats(points: TimeToKickoffPoint[]): BucketStats[] {
     // Group points by bucket
     // Calculate avgMargin per bucket
     // Return sorted bucket array
   }
   ```

4. Render based on viewMode state:
   ```tsx
   {viewMode === 'overlay' ? (
     <TimeToKickoffChart
       data={effectiveMarket.timeToKickoffHistory}
       competitorData={effectiveMarket.competitorTimelineData}
       selectedBookmakers={dialogBookmakers}
       height={300}
       showBucketZones={true}
     />
   ) : (
     <DifferenceBarChart
       betpawaBuckets={effectiveMarket.bucketStats}
       competitorBuckets={competitorBucketStats}
       height={300}
     />
   )}
   ```

5. Update SummaryStats to show comparison summary in difference mode:
   - "Betpawa is X.X% higher/lower than [competitor] on average"

6. Hide bucket breakdown table in difference mode (the chart IS the breakdown).
  </action>
  <verify>App builds and view toggle switches between chart types: `cd web && npm run build`</verify>
  <done>View mode toggle switches between overlay and difference views, difference chart shows colored bars</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete bookmaker comparison feature across cards and timeline dialog</what-built>
  <how-to-verify>
    1. Run: npm run dev (in web directory)
    2. Visit: http://localhost:5173/historical-analysis

    **Tournament Cards (Historical Analysis page):**
    3. Verify: Bookmaker toggles in filter bar
    4. Toggle: Hide SportyBet, cards update to show only Betpawa + Bet9ja
    5. Cards: Show multi-column margin breakdown with competitive badges

    **Market Cards (Tournament Detail page):**
    6. Click: "View Details" on any tournament
    7. Verify: Bookmaker filter in header
    8. Cards: Show per-bookmaker avg margin and range columns

    **Timeline Dialog:**
    9. Click: "Timeline" on any market card
    10. Verify: Bookmaker filter within dialog (separate from page filter)
    11. Chart: Multiple colored lines (Betpawa blue, SportyBet green, Bet9ja orange)
    12. Toggle: View mode to "Difference"
    13. Chart: Bar chart showing +/- difference by time bucket
    14. Colors: Green bars where Betpawa is better, red where worse
    15. Hover: Tooltip shows both margins and difference

    **Edge cases:**
    16. Toggle off all competitors: Only Betpawa line/data shown
    17. Market with no competitor data: Columns show "â€”"
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] DifferenceBarChart renders colored bars
- [ ] View toggle switches between overlay and difference
- [ ] Difference chart shows correct +/- values per bucket
- [ ] All bookmaker comparison features work end-to-end
</verification>

<success_criteria>

- All tasks completed
- DifferenceBarChart shows margin gaps by time bucket
- View mode toggle works correctly
- Green bars for Betpawa advantage, red for competitor advantage
- Full feature verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/86-betpawa-vs-competitor-comparison/86-04-SUMMARY.md`
</output>
