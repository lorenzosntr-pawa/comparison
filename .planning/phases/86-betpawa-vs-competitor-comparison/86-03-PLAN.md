---
phase: 86-betpawa-vs-competitor-comparison
plan: 03
type: execute
---

<objective>
Add multi-bookmaker overlay mode to the timeline dialog with stacked margin lines.

Purpose: Enable visual comparison of margin patterns over time across all bookmakers.
Output: TimelineDialog with bookmaker filter, view mode toggle, and multi-line overlay chart.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-CONTEXT.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-01-SUMMARY.md
@.planning/phases/86-betpawa-vs-competitor-comparison/86-02-SUMMARY.md

# Source files
@web/src/features/historical-analysis/components/timeline-dialog.tsx
@web/src/features/historical-analysis/components/time-to-kickoff-chart.tsx
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
@web/src/features/historical-analysis/components/bookmaker-filter.tsx

**Tech stack available:**
- React 19, recharts (LineChart, Line), shadcn/ui
- BookmakerFilter, BOOKMAKER_COLORS (from 86-01)
- TimeToKickoffChart with ReferenceArea zones

**Established patterns:**
- TimelineDialog with SummaryStats, BucketBreakdownTable, TimeToKickoffChart
- TournamentMarket.timeToKickoffHistory for Betpawa data
- Multi-line recharts with multiple Line components

**Constraining decisions:**
- Overlay view as default (quick browse mode)
- Separate bookmaker filter within dialog (independent from card filter)
- Brand colors for each bookmaker line
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend hook with competitor timeline data</name>
  <files>web/src/features/historical-analysis/hooks/use-tournament-markets.ts</files>
  <action>
Extend useTournamentMarkets to include competitor time-to-kickoff data:

1. Update TournamentMarket interface:
   ```typescript
   interface TournamentMarket {
     // ... existing fields
     timeToKickoffHistory: TimeToKickoffPoint[]  // Betpawa (existing)
     competitorTimelineData: Record<string, TimeToKickoffPoint[]>
     // e.g., { sportybet: [...points], bet9ja: [...points] }
   }
   ```

2. In the aggregation logic, for each market and each event:
   - Extract competitor margin data from event.bookmakers
   - Calculate hoursToKickoff using the same formula as Betpawa
   - Add point to competitorTimelineData[bookmakerSlug]

3. TimeToKickoffPoint structure (already exists):
   ```typescript
   interface TimeToKickoffPoint {
     hoursToKickoff: number  // negative = before kickoff
     margin: number
     eventName?: string      // optional for tooltip
   }
   ```

4. Sort each competitor's data by hoursToKickoff ascending.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>TournamentMarket includes competitorTimelineData with per-bookmaker time-to-kickoff arrays</done>
</task>

<task type="auto">
  <name>Task 2: Add bookmaker filter and view toggle to TimelineDialog</name>
  <files>web/src/features/historical-analysis/components/timeline-dialog.tsx</files>
  <action>
Enhance TimelineDialog header with controls:

1. Import BookmakerFilter and BOOKMAKER_COLORS.

2. Add state for dialog-specific bookmaker selection:
   ```typescript
   const [dialogBookmakers, setDialogBookmakers] = useState(['betpawa', 'sportybet', 'bet9ja'])
   ```

3. Add state for view mode:
   ```typescript
   const [viewMode, setViewMode] = useState<'overlay' | 'difference'>('overlay')
   ```

4. Add controls to dialog header (below title, above content):
   ```
   ┌────────────────────────────────────────────┐
   │ Market Name - Timeline                  X  │
   ├────────────────────────────────────────────┤
   │ [Betpawa] [SportyBet] [Bet9ja]             │
   │ View: [Overlay ✓] [Difference]             │
   ├────────────────────────────────────────────┤
   │ [Summary stats]                            │
   │ [Chart]                                    │
   └────────────────────────────────────────────┘
   ```

5. Use shadcn ToggleGroup for view mode selector:
   - "Overlay" (default) - multi-line chart
   - "Difference" - gap chart (implemented in 86-04)

6. Pass dialogBookmakers to chart component.

7. For now, difference view shows placeholder: "Difference view coming soon"
  </action>
  <verify>App compiles and dialog shows controls: `cd web && npm run build`</verify>
  <done>TimelineDialog has bookmaker filter and view mode toggle in header, state updates correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create multi-line overlay chart</name>
  <files>web/src/features/historical-analysis/components/time-to-kickoff-chart.tsx</files>
  <action>
Extend TimeToKickoffChart to support multi-bookmaker overlay:

1. Update props:
   ```typescript
   interface TimeToKickoffChartProps {
     data: TimeToKickoffPoint[]              // Betpawa data
     competitorData?: Record<string, TimeToKickoffPoint[]>  // Optional competitor data
     selectedBookmakers?: string[]            // Which bookmakers to show
     height?: number
     showBucketZones?: boolean
   }
   ```

2. When competitorData is provided:
   - Merge all data points to calculate unified X-axis domain
   - Render multiple Line components, one per bookmaker
   - Use BOOKMAKER_COLORS for each line stroke

3. Chart structure with multiple lines:
   ```tsx
   <LineChart data={mergedData}>
     <CartesianGrid />
     {/* Reference areas for time buckets */}
     <XAxis dataKey="hoursToKickoff" />
     <YAxis />
     <Tooltip />

     {/* Betpawa line - always shown if selected */}
     {selectedBookmakers?.includes('betpawa') && (
       <Line
         dataKey="betpawa"
         stroke={BOOKMAKER_COLORS.betpawa}
         strokeWidth={2}
         dot={false}
       />
     )}

     {/* Competitor lines */}
     {selectedBookmakers?.includes('sportybet') && competitorData?.sportybet && (
       <Line
         dataKey="sportybet"
         stroke={BOOKMAKER_COLORS.sportybet}
         strokeWidth={2}
         dot={false}
       />
     )}
     {/* ... bet9ja similarly */}
   </LineChart>
   ```

4. Merge data approach:
   - Create unified hoursToKickoff values from all bookmakers
   - For each point, include margin values keyed by bookmaker
   - Handle missing values (bookmaker may not have data at all time points)

5. Update tooltip to show all bookmaker values at hover point:
   ```
   -48h
   Betpawa: 5.2%
   SportyBet: 4.8%
   Bet9ja: —
   ```

6. Add legend showing bookmaker names with colored indicators.
  </action>
  <verify>App builds and chart shows multiple lines: `cd web && npm run build`</verify>
  <done>TimeToKickoffChart renders multiple bookmaker lines with brand colors, tooltip shows all values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Hook returns competitor timeline data per market
- [ ] TimelineDialog shows bookmaker filter in header
- [ ] View mode toggle appears (overlay selected by default)
- [ ] Chart displays multiple colored lines for selected bookmakers
- [ ] Tooltip shows all bookmaker values at hover point
</verification>

<success_criteria>

- All tasks completed
- Competitor timeline data available per market
- Dialog has independent bookmaker filter
- View mode toggle with overlay/difference options
- Multi-line chart with brand colors and legend
</success_criteria>

<output>
After completion, create `.planning/phases/86-betpawa-vs-competitor-comparison/86-03-SUMMARY.md`
</output>
