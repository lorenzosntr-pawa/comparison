---
phase: 86-betpawa-vs-competitor-comparison
plan: 02-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 86-02.

Source: 86-02-ISSUES.md
Priority: 0 critical, 2 major, 1 cosmetic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/86-betpawa-vs-competitor-comparison/86-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/86-betpawa-vs-competitor-comparison/86-02-PLAN.md

# Source files
@web/src/features/historical-analysis/tournament-detail.tsx
@web/src/features/historical-analysis/hooks/use-tournament-markets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Column alignment in MarketCard</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx</files>
  <action>
Fix the column alignment issues in the multi-bookmaker table:

1. Use fixed column widths instead of dynamic `1fr` for consistency
2. Set minimum width for first column (label column) to prevent squishing
3. Use consistent text alignment across all cells
4. Add proper spacing between columns

Current problematic code uses inline gridTemplateColumns with dynamic widths:
```tsx
gridTemplateColumns: `auto ${visibleBookmakers.map(() => '1fr').join(' ')}`
```

Replace with fixed-width approach:
```tsx
// Use consistent column widths
gridTemplateColumns: `6rem repeat(${visibleBookmakers.length}, minmax(4rem, 1fr))`
```

Ensure:
- Label column has fixed minimum width (e.g., 6rem)
- Bookmaker columns have equal width with minmax
- All numeric values right-aligned
- Column headers center-aligned
  </action>
  <verify>App builds: `cd web && npm run build`</verify>
  <done>Multi-column table has properly aligned columns that are easy to compare</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 - Add opening/closing margins for competitors</name>
  <files>
web/src/features/historical-analysis/hooks/use-tournament-markets.ts
web/src/features/historical-analysis/tournament-detail.tsx
  </files>
  <action>
Add opening and closing margin data for competitor bookmakers:

**Part A: Extend MarketMarginStats interface** (use-tournament-markets.ts)

Add openingMargin and closingMargin to MarketMarginStats:
```typescript
export interface MarketMarginStats {
  avgMargin: number
  minMargin: number
  maxMargin: number
  eventCount: number
  openingMargin?: number  // First recorded margin
  closingMargin?: number  // Last recorded margin
}
```

**Part B: Calculate competitor opening/closing in hook**

In the competitor margin aggregation logic:
1. Track first and last margin captured_at timestamps per competitor per market
2. Store the margin values from earliest and latest snapshots
3. Add to the MarketMarginStats returned for each competitor

**Part C: Display competitor opening/closing in MarketCard**

Update the MarketCard multi-column layout to show opening/closing for all bookmakers, not just Betpawa:

```
Market Name 2.5
─────────────────────────
          Betpawa  SportyBet  Bet9ja
Opening    5.2%     4.8%       5.0%
Closing    4.8%     4.6%       4.9%
Avg margin 5.0%     4.7%       5.0%
Range    4.5-5.5  4.2-5.0   4.8-5.2
Events     12        10         8
```

Note: This removes the special tracked-market-only opening/closing display and unifies it into the table for ALL markets.
  </action>
  <verify>App builds and shows opening/closing for all bookmakers: `cd web && npm run build`</verify>
  <done>All bookmaker columns show opening and closing margins, not just Betpawa</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-003 - Make CompetitiveBadge more visible</name>
  <files>web/src/features/historical-analysis/tournament-detail.tsx</files>
  <action>
Improve visibility of the CompetitiveBadge:

1. Move badge to a more prominent position - next to Betpawa header instead of buried in avg margin row
2. Add background color for better contrast:
   - Red background (bg-red-100) for worse (+X.X%)
   - Green background (bg-green-100) for better (-X.X%)
3. Add padding and rounded corners for pill-style badge
4. Increase font weight

Change from:
```tsx
<span className={`text-xs font-medium ${colorClass}`}>
  ({sign}{diff.toFixed(1)}%)
</span>
```

To:
```tsx
<span className={`text-xs font-semibold px-1.5 py-0.5 rounded ${colorClass} ${bgClass}`}>
  {sign}{diff.toFixed(1)}%
</span>
```

Where bgClass is `bg-red-100` for worse, `bg-green-100` for better.
  </action>
  <verify>App builds: `cd web && npm run build`</verify>
  <done>CompetitiveBadge is clearly visible with background color and better positioning</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 UAT issues addressed
- [ ] `cd web && npm run build` succeeds
- [ ] Column alignment is consistent across all rows
- [ ] Opening/closing margins show for all bookmakers
- [ ] CompetitiveBadge is visually prominent
</verification>

<success_criteria>
- UAT-001: Columns properly aligned in multi-bookmaker table
- UAT-002: Opening/closing margins visible for SportyBet and Bet9ja
- UAT-003: CompetitiveBadge has background color and better visibility
</success_criteria>

<output>
After completion, create `.planning/phases/86-betpawa-vs-competitor-comparison/86-02-FIX-SUMMARY.md`
</output>
