---
phase: 63-freshness-timestamps
plan: 01
type: execute
---

<objective>
Add "last updated" timestamps to odds display in Odds Comparison and Event Details pages.

Purpose: Enable users to see when odds were last scraped, providing transparency about data freshness.
Output: Timestamps visible on both pages showing when each bookmaker's odds were captured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant prior phase summaries:
@.planning/phases/62-historical-data-api/62-02-SUMMARY.md

# Key source files:
@src/matching/schemas.py
@src/api/routes/events.py
@web/src/types/api.ts
@web/src/features/matches/components/match-table.tsx
@web/src/features/matches/components/summary-section.tsx

**Current state:**
- Event Details page: `BookmakerMarketData` already has `snapshot_time` field - just needs UI display
- Odds Comparison page: `BookmakerOdds` schema is MISSING `snapshot_time` field - needs backend + frontend work

**Tech stack available:**
- Pydantic v2 with ConfigDict
- FastAPI with async SQLAlchemy
- React with TanStack Query v5
- shadcn/ui components with Tailwind v4

**Established patterns:**
- Timestamp display uses ISO strings from backend, formatted in frontend
- Relative time display pattern (e.g., "2 min ago") common in similar apps
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snapshot_time to BookmakerOdds schema and events API</name>
  <files>src/matching/schemas.py, src/api/routes/events.py</files>
  <action>
1. In src/matching/schemas.py, add `snapshot_time: datetime | None = None` field to `BookmakerOdds` class (after `inline_odds` field).

2. In src/api/routes/events.py, update `_build_matched_event()` function:
   - Accept snapshots_by_bookmaker dict parameter (already exists)
   - For each bookmaker link, extract `captured_at` from the appropriate snapshot
   - For BetPawa: `snapshot = snapshots_by_bookmaker.get(link.bookmaker_id)` then `snapshot.captured_at if snapshot else None`
   - For competitors (sportybet/bet9ja): `comp_snapshot = competitor_snapshots.get(link.bookmaker.slug)` then `comp_snapshot.captured_at if comp_snapshot else None`
   - Add `snapshot_time=...` to the `BookmakerOdds(...)` constructor call

Note: The function signature already has the snapshot dicts - just need to extract the timestamp.
  </action>
  <verify>
1. Run: `python -c "from src.matching.schemas import BookmakerOdds; print(BookmakerOdds.model_fields.keys())"` - should show snapshot_time
2. Start dev server and call GET /api/events - response should include snapshot_time in each bookmaker object
  </verify>
  <done>
- BookmakerOdds schema has snapshot_time field
- Events API returns snapshot_time for each bookmaker
- Existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Display freshness timestamps in frontend</name>
  <files>web/src/types/api.ts, web/src/features/matches/components/match-table.tsx, web/src/features/matches/components/summary-section.tsx, web/src/features/matches/lib/market-utils.ts</files>
  <action>
1. In web/src/types/api.ts:
   - Add `snapshot_time: string | null` to `BookmakerOdds` interface (after `inline_odds`)

2. Create a reusable timestamp display helper in web/src/features/matches/lib/market-utils.ts:
   ```typescript
   export function formatRelativeTime(isoString: string | null): string {
     if (!isoString) return '';
     const date = new Date(isoString);
     const now = new Date();
     const diffMs = now.getTime() - date.getTime();
     const diffMins = Math.floor(diffMs / 60000);

     if (diffMins < 1) return 'just now';
     if (diffMins < 60) return `${diffMins}m ago`;
     const diffHours = Math.floor(diffMins / 60);
     if (diffHours < 24) return `${diffHours}h ago`;
     return date.toLocaleDateString();
   }
   ```

3. In web/src/features/matches/components/match-table.tsx:
   - Import formatRelativeTime
   - Find where bookmaker odds are displayed (likely in a table cell or row)
   - Add a small muted timestamp below or beside the bookmaker name/odds
   - Use pattern: `<span className="text-xs text-muted-foreground">{formatRelativeTime(bookmaker.snapshot_time)}</span>`

4. In web/src/features/matches/components/summary-section.tsx:
   - The component receives `marketsByBookmaker: BookmakerMarketData[]` which already has `snapshot_time`
   - Add timestamp display in the "Market Coverage" section next to each bookmaker name
   - Display format: "Betpawa â€¢ 2m ago" or similar

Note: Keep timestamp display subtle (text-xs, text-muted-foreground) so it doesn't clutter the interface.
  </action>
  <verify>
1. Run: `cd web && npm run build` - no TypeScript errors
2. Start dev server and navigate to Odds Comparison page - timestamps visible per bookmaker row
3. Navigate to Event Details page - timestamps visible in summary section
  </verify>
  <done>
- TypeScript types updated with snapshot_time
- Relative time helper function works correctly
- Odds Comparison page shows "X min ago" timestamps
- Event Details summary shows "X min ago" timestamps
- UI is not cluttered - timestamps are subtle and secondary
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npm run build` succeeds without TypeScript errors
- [ ] Events API returns snapshot_time in BookmakerOdds objects
- [ ] Odds Comparison page displays freshness timestamps per bookmaker
- [ ] Event Details page displays freshness timestamps in summary section
- [ ] Timestamps update correctly after data refresh
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Timestamps display is subtle and doesn't clutter UI
- Phase 63 complete
</success_criteria>

<output>
After completion, create `.planning/phases/63-freshness-timestamps/63-01-SUMMARY.md`
</output>
