---
phase: 106-schema-migration
plan: 01
type: execute
---

<objective>
Create market_odds_current and market_odds_history tables with Alembic migration and SQLAlchemy models.

Purpose: Establish new market-level storage schema designed in Phase 105 for 95% storage reduction.
Output: Two new tables (market_odds_current, market_odds_history) with ORM models and monthly partitions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-investigation-schema-design/DISCOVERY.md
@.planning/phases/105-investigation-schema-design/105-01-SUMMARY.md

# Key source files:
@src/db/models/odds.py
@src/db/models/competitor.py
@src/db/base.py
@alembic/versions/a41eec60ab32_add_storage_alerts.py

**Schema from Phase 105 DISCOVERY.md:**

market_odds_current (upsert pattern):
- UNIQUE (event_id, bookmaker_slug, betpawa_market_id, COALESCE(line, 0))
- Unified BetPawa + competitors via bookmaker_slug column

market_odds_history (append-only):
- Monthly partitioning on captured_at
- Minimal columns for history charts (no handicap fields)

**Key decisions from Phase 105:**
- Unified storage for BetPawa + competitors using bookmaker_slug
- COALESCE(line, 0) in UNIQUE constraint for NULL line handling
- Monthly partitioning for efficient retention cleanup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration for new tables</name>
  <files>alembic/versions/{timestamp}_add_market_level_tables.py</files>
  <action>
Create Alembic migration with:

1. market_odds_current table:
   - id BIGSERIAL PRIMARY KEY
   - event_id INTEGER NOT NULL (no FK - allows negative competitor-only IDs)
   - bookmaker_slug VARCHAR(20) NOT NULL
   - betpawa_market_id VARCHAR(50) NOT NULL
   - betpawa_market_name VARCHAR(255) NOT NULL
   - line FLOAT (nullable)
   - handicap_type VARCHAR(50) (nullable)
   - handicap_home FLOAT (nullable)
   - handicap_away FLOAT (nullable)
   - outcomes JSONB NOT NULL
   - market_groups JSONB (nullable)
   - unavailable_at TIMESTAMPTZ (nullable)
   - last_updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - last_confirmed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

   UNIQUE constraint: Use raw SQL for COALESCE expression:
   ```sql
   CREATE UNIQUE INDEX idx_moc_unique ON market_odds_current(event_id, bookmaker_slug, betpawa_market_id, COALESCE(line, 0))
   ```

   Regular indexes:
   - idx_moc_event (event_id)
   - idx_moc_bookmaker (bookmaker_slug)
   - idx_moc_event_bookmaker (event_id, bookmaker_slug)

2. market_odds_history table (partitioned):
   - Create parent table with PARTITION BY RANGE (captured_at)
   - id BIGSERIAL PRIMARY KEY
   - event_id INTEGER NOT NULL
   - bookmaker_slug VARCHAR(20) NOT NULL
   - betpawa_market_id VARCHAR(50) NOT NULL
   - line FLOAT (nullable)
   - outcomes JSONB NOT NULL
   - captured_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

   Indexes:
   - idx_moh_event_market_time (event_id, betpawa_market_id, captured_at DESC)
   - idx_moh_bookmaker_market (bookmaker_slug, betpawa_market_id)

3. Create monthly partitions for history table:
   - market_odds_history_2026_02 (2026-02-01 to 2026-03-01)
   - market_odds_history_2026_03 (2026-03-01 to 2026-04-01)
   - market_odds_history_2026_04 (2026-04-01 to 2026-05-01)

Use op.execute() for raw SQL where Alembic ops don't support partitioning or expression indexes. Follow existing migration patterns in alembic/versions/.

IMPORTANT: Do NOT add foreign key constraints to events table - event_id can be negative for competitor-only events.
  </action>
  <verify>alembic upgrade head succeeds without errors</verify>
  <done>Migration file created, tables exist in database with correct schema and partitions</done>
</task>

<task type="auto">
  <name>Task 2: Create SQLAlchemy ORM models</name>
  <files>src/db/models/market_odds.py, src/db/models/__init__.py</files>
  <action>
Create new file src/db/models/market_odds.py with:

1. MarketOddsCurrent class:
   - Follows existing patterns in odds.py (BigInteger PK, Mapped[], mapped_column())
   - __tablename__ = "market_odds_current"
   - All columns matching migration schema
   - __table_args__ with Index definitions (match migration indexes)
   - Docstring following PEP 257 and existing model patterns

2. MarketOddsHistory class:
   - __tablename__ = "market_odds_history"
   - Simpler structure (no handicap fields, no FK relationships)
   - Note in docstring: "This is a partitioned table - partitions created via migration"

3. Update src/db/models/__init__.py:
   - Import and export both new models

Follow existing conventions from src/db/models/odds.py:
- Use BigInteger for id and high-volume columns
- Use Mapped[] type hints
- Use DateTime(timezone=True) for timestamptz
- Include proper docstrings

Do NOT create relationships to other tables yet - those will be added in Phase 108 when read paths change.
  </action>
  <verify>python -c "from src.db.models.market_odds import MarketOddsCurrent, MarketOddsHistory; print('OK')"</verify>
  <done>Both models import successfully with correct column definitions</done>
</task>

<task type="auto">
  <name>Task 3: Verify schema correctness</name>
  <files>None (verification only)</files>
  <action>
Run verification queries to confirm schema:

1. Check market_odds_current structure:
   ```sql
   SELECT column_name, data_type, is_nullable
   FROM information_schema.columns
   WHERE table_name = 'market_odds_current'
   ORDER BY ordinal_position;
   ```

2. Check unique index exists with COALESCE:
   ```sql
   SELECT indexname, indexdef
   FROM pg_indexes
   WHERE tablename = 'market_odds_current';
   ```

3. Check market_odds_history partitions exist:
   ```sql
   SELECT inhrelid::regclass AS partition_name
   FROM pg_inherits
   WHERE inhparent = 'market_odds_history'::regclass;
   ```

4. Test UPSERT works correctly on market_odds_current:
   ```sql
   INSERT INTO market_odds_current (event_id, bookmaker_slug, betpawa_market_id, betpawa_market_name, outcomes)
   VALUES (1, 'betpawa', '3743', '1X2', '[]')
   ON CONFLICT (event_id, bookmaker_slug, betpawa_market_id, COALESCE(line, 0))
   DO UPDATE SET last_confirmed_at = NOW();
   ```
   Then clean up test row.

5. Test INSERT into partitioned history table:
   ```sql
   INSERT INTO market_odds_history (event_id, bookmaker_slug, betpawa_market_id, outcomes, captured_at)
   VALUES (1, 'betpawa', '3743', '[]', '2026-02-24 10:00:00+00');
   ```
   Then clean up test row.

If any check fails, identify the issue and fix the migration/models.
  </action>
  <verify>All 5 verification queries succeed</verify>
  <done>Schema verified correct: unique index with COALESCE, partitions exist, UPSERT and partition INSERT work</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `alembic upgrade head` succeeds
- [ ] `alembic current` shows latest migration
- [ ] market_odds_current table exists with UNIQUE index
- [ ] market_odds_history table exists with 3 monthly partitions
- [ ] ORM models import successfully
- [ ] Test UPSERT and partition INSERT both work
</verification>

<success_criteria>

- Alembic migration created and applied successfully
- market_odds_current table with UNIQUE constraint using COALESCE
- market_odds_history partitioned table with monthly partitions
- SQLAlchemy models created following project conventions
- All verification queries pass
</success_criteria>

<output>
After completion, create `.planning/phases/106-schema-migration/106-01-SUMMARY.md`:

# Phase 106 Plan 01: Schema Migration Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- Migration file created: alembic/versions/{hash}_add_market_level_tables.py
- market_odds_current: X columns, Y indexes, UNIQUE constraint with COALESCE
- market_odds_history: X columns, Y partitions (2026_02, 2026_03, 2026_04)
- SQLAlchemy models: MarketOddsCurrent, MarketOddsHistory

## Files Created/Modified

- `alembic/versions/{hash}_add_market_level_tables.py` - New migration
- `src/db/models/market_odds.py` - New ORM models
- `src/db/models/__init__.py` - Export new models

## Decisions Made

[Any decisions made during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 107 ready: Write path changes
- Tables created and verified
- Old tables preserved for rollback (odds_snapshots, market_odds, competitor_*)
</output>
