---
phase: 93-odds-comparison-page
plan: 01-FIX
type: fix
---

<objective>
Fix 2 UAT enhancement issues from plan 93-01.

Source: 93-01-ISSUES.md
Priority: 0 critical, 0 major, 2 minor

Both issues are UX enhancements to improve filtering behavior on the Odds Comparison page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/93-odds-comparison-page/93-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/93-odds-comparison-page/93-01-PLAN.md

**Files to modify:**
@web/src/features/matches/components/match-filters.tsx
@web/src/features/matches/index.tsx
@web/src/features/matches/hooks/use-events.ts
@src/api/routes/events.py

**Established patterns:**
- Country data comes from tournaments via useTournaments hook
- Events API accepts tournament_ids, availability parameters
- Command + Popover pattern for filter dropdowns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Country filter should filter events list</name>
  <files>web/src/features/matches/components/match-filters.tsx, web/src/features/matches/index.tsx, web/src/features/matches/hooks/use-events.ts, src/api/routes/events.py</files>
  <action>
Make country filter affect both the tournament dropdown AND the events list.

**Backend changes (src/api/routes/events.py):**
1. Add `countries: list[str] | None = Query(None)` parameter to `/events` endpoint
2. For BetPawa events: filter `Event.tournament` -> `Tournament.country` IN countries
3. For competitor events: filter `CompetitorEvent.tournament` -> `CompetitorTournament.country` IN countries
4. Both filters use case-insensitive matching with `func.lower()`

**Frontend changes:**
1. In use-events.ts: Add `countries` parameter to useEvents hook
2. In use-events.ts: Pass countries to `/events` API call as comma-separated string
3. In match-filters.tsx: Pass countryFilter to useEvents (via parent)
4. In index.tsx: Wire up countryFilter to useEvents

The country filter already exists in the UI - just need to also send it to the API.
  </action>
  <verify>
1. `npm run build` in web/ succeeds
2. Start backend and frontend
3. Select a country filter
4. Events list now shows only events from that country (not just filtered tournament dropdown)
5. Works for all availability modes (all, betpawa, competitor)
  </verify>
  <done>
Country filter affects both tournament dropdown AND events list. Selecting "Nigeria" shows only Nigerian events, not just Nigerian tournaments in the dropdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 - Filter dropdowns scope to availability mode</name>
  <files>web/src/features/matches/components/match-filters.tsx, web/src/features/matches/hooks/use-tournaments.ts</files>
  <action>
Make filter dropdowns (country, tournament) show only relevant options based on availability mode.

**Approach:**
1. The useTournaments hook already returns tournaments with event_count
2. Filter tournaments in match-filters.tsx based on current availability mode:
   - `availability='all'`: Show all tournaments (no change)
   - `availability='betpawa'`: Show tournaments where event_count > 0 (has BetPawa events)
   - `availability='competitor'`: Show tournaments where competitor_only_count > 0 (has competitor-only events)

**Implementation:**
1. In match-filters.tsx: Accept `availability` prop
2. Filter `tournaments` list before extracting countries:
   - For 'betpawa': filter where t.event_count > 0
   - For 'competitor': filter where t.competitor_only_count > 0
3. Extract countries from filtered tournaments (not all tournaments)
4. Tournament dropdown also uses filtered list

**Note:** The tournaments API already returns event_count and competitor_only_count per tournament. No backend changes needed.

Check the actual tournament response shape first - the counts may use different field names. Read useTournaments hook to confirm.
  </action>
  <verify>
1. `npm run build` in web/ succeeds
2. Set availability to "Competitor only"
3. Country filter dropdown shows only countries with competitor events
4. Tournament filter dropdown shows only tournaments with competitor events
5. Set availability to "BetPawa only"
6. Dropdowns show only options with BetPawa events
7. Set availability to "All"
8. Dropdowns show all options (original behavior)
  </verify>
  <done>
Filter dropdowns dynamically scope to current availability mode. In competitor-only mode, only countries/tournaments with competitor data appear in dropdowns.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All minor issues fixed
- [ ] `npm run build` succeeds without errors
- [ ] Country filter affects events list (UAT-001)
- [ ] Filter dropdowns scope to availability mode (UAT-002)
- [ ] No regressions in existing filter functionality
</verification>

<success_criteria>
- All UAT issues from 93-01-ISSUES.md addressed
- Both enhancements working as specified
- Tests/build pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/93-odds-comparison-page/93-01-FIX-SUMMARY.md`
</output>
