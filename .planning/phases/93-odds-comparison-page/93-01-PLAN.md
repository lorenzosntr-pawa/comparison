---
phase: 93-odds-comparison-page
plan: 01
type: execute
---

<objective>
Add country filter and fix tournament filtering for competitor-only events on the Odds Comparison page.

Purpose: Enable users to filter events by country and ensure tournament filters work correctly in competitor-only mode.
Output: Working country filter dropdown, tournament filter that applies to both BetPawa and competitor events.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@web/src/features/matches/index.tsx
@web/src/features/matches/components/match-filters.tsx
@web/src/features/matches/hooks/use-tournaments.ts
@src/api/routes/events.py

**Established patterns:**
- Command + Popover pattern for searchable multi-select comboboxes (v1.3)
- useTournaments hook already fetches all tournaments with country field

**Current state:**
- `/events/tournaments` returns all tournaments with country field
- Tournament filter works for BetPawa events, but line 1154-1155 in events.py shows it's skipped for competitor events
- No country filter exists in the UI

**Backend issue (lines 1154-1155 of events.py):**
```python
# Tournament filter for competitor events via sportradar_id matching
# (more complex - skip for now as competitor tournaments have different IDs)
```

CompetitorEvent uses CompetitorTournament which has different IDs from Tournament. Need to filter by sportradar_id or tournament name matching.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add country filter to Odds Comparison page</name>
  <files>web/src/features/matches/components/match-filters.tsx, web/src/features/matches/index.tsx</files>
  <action>
Add a country filter dropdown to MatchFilters:

1. Extract unique countries from tournaments data in useTournaments hook
2. Add countryFilter to MatchFiltersState interface (string[] for multi-select)
3. Create country filter dropdown using Command + Popover pattern (same as tournament filter)
4. Filter tournaments shown in league dropdown by selected countries
5. When country filter changes, reset tournament filter to empty
6. Update clearFilters to reset country filter
7. Update hasActiveFilters check to include countryFilter.length > 0

The country filter should:
- Show "All countries" when empty
- Show "{n} countries" when some selected
- Support multi-select with checkboxes
- Filter the league dropdown to only show tournaments from selected countries

Note: Do NOT modify the API - country filtering is done client-side by filtering the tournaments list in the UI.
  </action>
  <verify>
1. Run `npm run build` in web/ directory - no errors
2. Start dev server, open Odds Comparison page
3. Country filter appears between Team search and League filter
4. Selecting countries filters the league dropdown
5. Clear filters resets country selection
  </verify>
  <done>
Country filter visible and functional, league dropdown filtered by country selection, builds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix tournament filter for competitor-only events</name>
  <files>src/api/routes/events.py</files>
  <action>
Fix the competitor events query to support tournament filtering.

When availability='competitor' and tournament_ids is provided:
1. Get the Tournament records for the provided tournament_ids
2. Extract tournament names from those records
3. Filter CompetitorEvents where their CompetitorTournament.name matches any of the tournament names (case-insensitive)

Implementation approach:
1. In the competitor section (after line 1100), before comp_query execution:
2. If tournament_ids provided, query Tournament table to get names
3. Add WHERE clause: CompetitorTournament.name IN (tournament_names) via join

This works because tournament names are consistent across platforms (e.g., "Premier League" on both BetPawa and competitor sites).

Do NOT use sportradar_id matching - CompetitorTournament doesn't have sportradar_id.
  </action>
  <verify>
1. Start backend: `python -m uvicorn src.api.app:app --reload`
2. GET /events?availability=competitor - returns competitor-only events
3. GET /events?availability=competitor&tournament_ids=123 - filters by tournament name
4. Verify filtered results only contain events from matching tournament names
  </verify>
  <done>
Tournament filter works for competitor-only events, API returns filtered results based on tournament name matching
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in web/ succeeds without errors
- [ ] Country filter dropdown renders and is functional
- [ ] League filter shows only tournaments from selected countries
- [ ] Tournament filter works for both betpawa and competitor availability modes
- [ ] No regressions in existing filter functionality
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Country filter integrates with existing filter patterns
- Tournament filter works for competitor-only events
  </success_criteria>

<output>
After completion, create `.planning/phases/93-odds-comparison-page/93-01-SUMMARY.md`
</output>
