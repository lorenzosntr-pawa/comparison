---
phase: 93-odds-comparison-page
plan: 01-FIX3
type: fix
---

<objective>
Fix 1 UAT blocker issue from plan 93-01.

Source: 93-01-ISSUES.md
Priority: 1 blocker (UAT-006)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/93-odds-comparison-page/93-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/93-odds-comparison-page/93-01-PLAN.md

**Key files:**
@src/api/routes/events.py (lines 900-950)
@src/db/models/competitor.py (lines 33-80)
</context>

<analysis>
**Root Cause Analysis for UAT-006:**

The `/api/events/countries?availability=competitor` endpoint crashes with a 500 error at line 922:

```python
select(CompetitorTournament.country)
```

**Problem:** The `CompetitorTournament` model does NOT have a `country` attribute. It has:
- `country_raw` (line 65) - Raw country string from source platform
- `country_iso` (line 66) - Normalized ISO 3166-1 alpha-3 country code

The BetPawa `Tournament` model HAS `country` (line 77), but `CompetitorTournament` uses a different naming convention.

**Fix:** Replace all references to `CompetitorTournament.country` with `CompetitorTournament.country_raw` in the countries endpoint.

Locations to fix (lines 922, 924, 928, 930):
- Line 922: `select(CompetitorTournament.country)` → `select(CompetitorTournament.country_raw)`
- Line 928: `CompetitorTournament.country.isnot(None)` → `CompetitorTournament.country_raw.isnot(None)`
- Line 930: `.order_by(CompetitorTournament.country)` → `.order_by(CompetitorTournament.country_raw)`
</analysis>

<tasks>
<task type="auto">
  <name>Fix CompetitorTournament.country reference in countries endpoint</name>
  <files>src/api/routes/events.py</files>
  <action>
In the `list_countries` function (lines 901-948), replace all references to
`CompetitorTournament.country` with `CompetitorTournament.country_raw`:

1. Line 922: Change `select(CompetitorTournament.country)` to `select(CompetitorTournament.country_raw)`
2. Line 928: Change `CompetitorTournament.country.isnot(None)` to `CompetitorTournament.country_raw.isnot(None)`
3. Line 930: Change `.order_by(CompetitorTournament.country)` to `.order_by(CompetitorTournament.country_raw)`

Note: Line 924 uses CompetitorTournament.id which is correct, don't change that.
  </action>
  <verify>
1. Run: `curl "http://localhost:8000/api/events/countries?availability=competitor"` - should return 200 with list of countries
2. Run: `npm run build` in web/ - should succeed
  </verify>
  <done>
- /api/events/countries?availability=competitor returns 200 with country list
- No 500 errors when switching to competitor mode on Odds Comparison page
- Country dropdown populates correctly in competitor mode
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `/api/events/countries?availability=competitor` returns 200 (not 500)
- [ ] Country dropdown shows countries in competitor mode (not "No countries found")
- [ ] `npm run build` succeeds without errors
</verification>

<success_criteria>
- UAT-006 blocker resolved
- Countries endpoint works for both betpawa and competitor availability modes
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/93-odds-comparison-page/93-01-FIX3-SUMMARY.md`
</output>
