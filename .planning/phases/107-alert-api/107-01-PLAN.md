---
phase: 107-alert-api
plan: 01
type: execute
domain: backend
---

<objective>
Create RiskAlert database model and update Settings model with alert configuration fields.

Purpose: Establish the database layer for alert persistence and configuration.
Output: RiskAlert model with indexes, Settings additions, Alembic migration applied.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-investigation-schema/DISCOVERY.md

# Key files:
@src/db/models/settings.py
@src/db/base.py

# Prior phase context:
# - Phase 105: Designed RiskAlert schema with BigInteger IDs, 3 indexes
# - Phase 106: Created RiskAlertData DTO in write_queue.py, detection integrated
# - Established patterns: AlertType, AlertSeverity enums in risk_detection.py

# Tech stack available:
# - SQLAlchemy 2.0 async with Mapped[] columns
# - Alembic for migrations
# - Pydantic v2 for settings validation

# Constraining decisions:
# - Phase 105: BigInteger IDs for RiskAlert table (high volume expected)
# - Phase 105: Separate alert_retention_days from odds_retention_days
# - Phase 106: AlertType and AlertSeverity enums defined in risk_detection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RiskAlert database model</name>
  <files>src/db/models/risk_alert.py, src/db/models/__init__.py</files>
  <action>
Create new file `src/db/models/risk_alert.py` following the DISCOVERY.md schema:

1. Import from sqlalchemy: BigInteger, DateTime, Float, ForeignKey, Index, String, func
2. Import Mapped, mapped_column, relationship from sqlalchemy.orm
3. Import Base from src.db.base

4. Create AlertStatus enum (str, Enum) with values: NEW, ACKNOWLEDGED, PAST
   - Note: AlertType and AlertSeverity already exist in risk_detection.py, import from there

5. Create RiskAlert(Base) model with:
   - __tablename__ = "risk_alerts"
   - id: Mapped[int] BigInteger primary_key
   - event_id: Mapped[int] ForeignKey("events.id")
   - bookmaker_slug: Mapped[str] String(50)
   - market_id: Mapped[str] String(50)
   - market_name: Mapped[str] String(255)
   - line: Mapped[float | None] Float nullable
   - outcome_name: Mapped[str | None] String(100) nullable
   - alert_type: Mapped[str] String(50)
   - severity: Mapped[str] String(20)
   - change_percent: Mapped[float] Float default=0.0
   - old_value: Mapped[float | None] Float nullable
   - new_value: Mapped[float | None] Float nullable
   - competitor_direction: Mapped[str | None] String(100) nullable
   - detected_at: Mapped[datetime] DateTime server_default=func.now()
   - acknowledged_at: Mapped[datetime | None] DateTime nullable
   - status: Mapped[str] String(20) default="new"
   - event_kickoff: Mapped[datetime] DateTime

6. Add relationship: event: Mapped["Event"] = relationship()

7. Add __table_args__ with 3 indexes:
   - idx_risk_alerts_event: (event_id, status) - for event page badge queries
   - idx_risk_alerts_status_detected: (status, detected_at DESC) - for Risk Monitoring page
   - idx_risk_alerts_kickoff: (event_kickoff) - for auto-status job

8. Update src/db/models/__init__.py to export RiskAlert and AlertStatus

Include PEP 257 docstrings following existing model patterns.
  </action>
  <verify>python -c "from src.db.models.risk_alert import RiskAlert, AlertStatus; print('Model imports successfully')"</verify>
  <done>RiskAlert model created with all fields, 3 indexes, AlertStatus enum defined, exported from __init__.py</done>
</task>

<task type="auto">
  <name>Task 2: Add Settings columns and run migration</name>
  <files>src/db/models/settings.py, alembic/versions/</files>
  <action>
1. Update src/db/models/settings.py to add 6 alert configuration fields (after max_concurrent_events):
   ```python
   # Alert configuration (Phase 107)
   alert_enabled: Mapped[bool] = mapped_column(default=True)
   alert_threshold_warning: Mapped[float] = mapped_column(Float, default=7.0)
   alert_threshold_elevated: Mapped[float] = mapped_column(Float, default=10.0)
   alert_threshold_critical: Mapped[float] = mapped_column(Float, default=15.0)
   alert_retention_days: Mapped[int] = mapped_column(default=7)
   alert_lookback_minutes: Mapped[int] = mapped_column(default=60)
   ```
   Also add Float import from sqlalchemy if not present.

2. Update Settings docstring to document new fields.

3. Generate migration:
   ```bash
   cd c:/Users/loren/Desktop/betpawa/comparison/mvp1
   alembic revision --autogenerate -m "add_risk_alerts_table_and_settings"
   ```

4. Review generated migration file - ensure it:
   - Creates risk_alerts table with all columns
   - Creates all 3 indexes (idx_risk_alerts_event, idx_risk_alerts_status_detected, idx_risk_alerts_kickoff)
   - Adds 6 new columns to settings table

5. Run migration:
   ```bash
   alembic upgrade head
   ```

6. Verify migration applied successfully.
  </action>
  <verify>alembic current shows latest revision; python -c "from src.db.models import RiskAlert; from src.db.models.settings import Settings; print('Models OK')"</verify>
  <done>Settings model has 6 alert fields, migration created risk_alerts table with indexes, migration applied successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `from src.db.models.risk_alert import RiskAlert, AlertStatus` succeeds
- [ ] `alembic current` shows latest revision
- [ ] Settings model has alert_enabled, alert_threshold_*, alert_retention_days, alert_lookback_minutes fields
- [ ] Database has risk_alerts table with correct columns (verify via psql or similar)
</verification>

<success_criteria>

- RiskAlert model created with BigInteger ID, all fields, 3 indexes
- AlertStatus enum defined (NEW, ACKNOWLEDGED, PAST)
- Settings model updated with 6 alert configuration fields
- Alembic migration created and applied
- All model imports working
</success_criteria>

<output>
After completion, create `.planning/phases/107-alert-api/107-01-SUMMARY.md`
</output>
