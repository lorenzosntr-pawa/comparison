# Phase 66-02: History Dialog Fixes

## Context

Phase 66-01 implemented history dialog functionality, but UAT revealed three issues:
- BUG-010: Competitor odds history not working (only BetPawa works)
- BUG-011: Odds tab redundantly shows margin line (separate Margin tab exists)
- BUG-012: No multi-bookmaker comparison capability

## Objectives

1. Fix backend API to query competitor tables for sportybet/bet9ja history
2. Remove redundant margin line from Odds tab
3. Enable multi-bookmaker comparison with overlay charts

## Changes Required

### Part 1: Backend - Competitor History Support (BUG-010)

**File: `src/api/routes/history.py`**

Currently queries only `odds_snapshots` table. Need to add logic to detect bookmaker type and query appropriate table:
- If `bookmaker_slug == 'betpawa'`: Query `OddsSnapshot` + `MarketOdds`
- If `bookmaker_slug in ('sportybet', 'bet9ja')`: Query `CompetitorOddsSnapshot` + `CompetitorMarketOdds`

Changes to `get_odds_history()`:
1. Check bookmaker_slug to determine data source
2. For competitors:
   - Join `CompetitorOddsSnapshot` with `CompetitorEvent` on `competitor_event_id`
   - Filter by `CompetitorEvent.betpawa_event_id == event_id` (links to BetPawa event)
   - Filter by `CompetitorEvent.source == bookmaker_slug`
   - Join `CompetitorMarketOdds` on `snapshot_id`
   - Filter by `betpawa_market_id == market_id`
3. Apply same time filters and ordering
4. Return same response shape

Same changes needed for `get_margin_history()`.

**New imports needed:**
```python
from src.db.models.competitor import (
    CompetitorEvent,
    CompetitorOddsSnapshot,
    CompetitorMarketOdds,
)
```

### Part 2: Frontend - Remove Redundant Margin (BUG-011)

**File: `web/src/features/matches/components/history-dialog.tsx`**

Line 130: Change `showMargin={true}` to `showMargin={false}`

### Part 3: Multi-Bookmaker Comparison (BUG-012)

#### 3a. Dialog Enhancement

**File: `web/src/features/matches/components/history-dialog.tsx`**

Current props:
```tsx
bookmakerSlug: string
bookmakerName: string
```

Change to:
```tsx
selectedBookmakers: { slug: string; name: string }[]  // Primary + optionally others
allBookmakers: { slug: string; name: string }[]      // All available for this market
```

Add bookmaker multi-select toggle in dialog header for comparison mode.

#### 3b. New Multi-Bookmaker Hook

**New file: `web/src/features/matches/hooks/use-multi-odds-history.ts`**

```tsx
export function useMultiOddsHistory({
  eventId,
  marketId,
  bookmakerSlugs,  // string[] - all selected bookmakers
  enabled,
}: UseMultiOddsHistoryParams) {
  // Use TanStack Query's useQueries to fetch in parallel
  // Return merged data structure keyed by bookmaker
}
```

Response shape:
```tsx
{
  [bookmakerSlug: string]: {
    history: OddsHistoryPoint[]
    bookmakerName: string
  }
}
```

Similarly create `use-multi-margin-history.ts`.

#### 3c. Chart Enhancement - Multi-Series Support

**File: `web/src/features/matches/components/odds-line-chart.tsx`**

Change data prop to support multi-bookmaker:
```tsx
interface OddsLineChartProps {
  data: OddsHistoryPoint[]  // Single bookmaker (current)
  // OR
  multiData?: Record<string, { history: OddsHistoryPoint[]; bookmakerName: string }>
  comparisonMode?: boolean
}
```

In comparison mode:
- Show one outcome at a time (e.g., "Home" for 1X2 market)
- Each bookmaker is a separate line with different color
- Legend shows bookmaker names
- Y-axis shows odds values

**File: `web/src/features/matches/components/margin-line-chart.tsx`**

Similar enhancement:
```tsx
interface MarginLineChartProps {
  data: MarginHistoryPoint[]  // Single bookmaker
  // OR
  multiData?: Record<string, { history: MarginHistoryPoint[]; bookmakerName: string }>
  comparisonMode?: boolean
}
```

In comparison mode:
- Each bookmaker's margin as separate line
- Different colors per bookmaker
- Legend shows bookmaker names

#### 3d. Dialog State Management

**File: `web/src/features/matches/components/history-dialog.tsx`**

Add state:
```tsx
const [comparisonMode, setComparisonMode] = useState(false)
const [selectedBookmakers, setSelectedBookmakers] = useState<string[]>([])
```

Add UI:
- Toggle switch for "Compare bookmakers"
- When enabled, show checkboxes for available bookmakers
- Default: only clicked bookmaker selected

#### 3e. Match Table Props Update

**File: `web/src/features/matches/components/match-table.tsx`**

Update history dialog state to pass all available bookmakers:
```tsx
setHistoryDialog({
  eventId: event.id,
  marketId,
  selectedBookmakers: [{ slug: bookmakerSlug, name: bookmakerName }],
  allBookmakers: getAvailableBookmakersForMarket(event, marketId),
  marketName: MARKET_CONFIG[marketId].label,
})
```

## Implementation Order

1. **Backend first** - Fix BUG-010 so competitor data works
2. **Quick fix** - BUG-011 single line change
3. **Multi-bookmaker** - BUG-012 with frontend changes

## Testing

1. Click SportyBet odds cell → Should show historical data
2. Click Bet9ja margin cell → Should show historical data
3. Click BetPawa odds cell → Odds tab should NOT show margin line
4. Enable comparison mode → Should show multiple bookmakers on same chart
5. Compare 3 bookmakers → All three lines visible with legend

## Files Modified

- `src/api/routes/history.py` - Add competitor table queries
- `web/src/features/matches/components/history-dialog.tsx` - Remove margin, add comparison UI
- `web/src/features/matches/components/odds-line-chart.tsx` - Multi-series support
- `web/src/features/matches/components/margin-line-chart.tsx` - Multi-series support
- `web/src/features/matches/hooks/use-multi-odds-history.ts` - NEW
- `web/src/features/matches/hooks/use-multi-margin-history.ts` - NEW
- `web/src/features/matches/components/match-table.tsx` - Pass all bookmakers

## Success Criteria

- [ ] SportyBet/Bet9ja odds history displays correctly
- [ ] Odds tab shows only odds lines (no margin)
- [ ] Comparison mode toggle works
- [ ] Multi-bookmaker chart shows all selected bookmakers
- [ ] Legend correctly identifies each bookmaker line
