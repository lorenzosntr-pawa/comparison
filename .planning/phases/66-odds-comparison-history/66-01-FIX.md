---
phase: 66-odds-comparison-history
plan: 01-FIX
type: fix
---

<objective>
Fix 2 UAT blocker issues from plan 66-01.

Source: 66-01-ISSUES.md
Priority: 2 blocker

The page crashes to blank when clicking odds or margin cells because:
1. OddsLineChart assumes `data[0].outcomes` exists when data has items
2. If outcomes array is undefined or null, accessing `.length` crashes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/66-odds-comparison-history/66-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/66-odds-comparison-history/66-01-PLAN.md

**Component with crash:**
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/components/history-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add defensive null checks to OddsLineChart</name>
  <files>web/src/features/matches/components/odds-line-chart.tsx</files>
  <action>
The crash occurs because the code accesses `data[0].outcomes.length` without checking if outcomes exists:

```tsx
const outcomeNames = useMemo(() => {
  if (!data.length || !data[0].outcomes.length) return []  // CRASH: outcomes might be undefined
  return data[0].outcomes.map((o) => o.name)
}, [data])
```

Fix by adding optional chaining:
1. In `outcomeNames` useMemo: Change `!data[0].outcomes.length` to `!data[0].outcomes?.length`
2. In `chartData` useMemo: Add optional chaining when iterating outcomes: `point.outcomes?.forEach`
3. Also ensure the early return properly handles when data exists but outcomes don't

The guard should be: `if (!data.length || !data[0]?.outcomes?.length) return []`
  </action>
  <verify>npm run type-check passes, review the defensive checks</verify>
  <done>OddsLineChart handles missing/undefined outcomes without crashing</done>
</task>

<task type="auto">
  <name>Task 2: Add error boundary or graceful degradation to HistoryDialog</name>
  <files>web/src/features/matches/components/history-dialog.tsx</files>
  <action>
Add additional safety to prevent crashes from propagating:

1. Ensure the chart components receive defensive props
2. Wrap chart rendering with null checks for data?.history
3. Consider adding try/catch or error handling in the data transformation

Specifically:
- In odds tab: Check `oddsHistory.data?.history` before passing to OddsLineChart
- In margin tab: Check `marginHistory.data?.history` before passing to MarginLineChart

Current code:
```tsx
<OddsLineChart
  data={oddsHistory.data?.history ?? []}
  showMargin={true}
/>
```

This already uses `?? []` which should be safe, but let's also add explicit checks for the loading/error states to ensure they show before attempting to render charts.
  </action>
  <verify>npm run build succeeds, manually test clicking cells</verify>
  <done>HistoryDialog handles API responses gracefully without page crashes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed null/undefined handling in OddsLineChart and HistoryDialog</what-built>
  <how-to-verify>
    1. Run: npm run dev (in web directory)
    2. Navigate to Odds Comparison page
    3. Click on any odds value cell
    4. Verify: Dialog opens without crashing the page
    5. Click on any margin value cell
    6. Verify: Dialog opens without crashing the page
    7. Check: Charts display data or "No historical data available" message
    8. Check: Clicking row elsewhere still navigates to event details
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All blocker issues from 66-01-ISSUES.md addressed
- [ ] `npm run type-check` passes
- [ ] `npm run build` succeeds
- [ ] Clicking odds cell opens dialog (no crash)
- [ ] Clicking margin cell opens dialog (no crash)
- [ ] Dialog shows chart or "No data" message
- [ ] Page doesn't go blank/crash
</verification>

<success_criteria>
- Both UAT-001 and UAT-002 issues resolved
- Odds comparison page remains stable when clicking cells
- Tests pass
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/66-odds-comparison-history/66-01-FIX-SUMMARY.md`
</output>
