---
phase: 68-market-level-history
plan: 01
type: execute
---

<objective>
Add comprehensive market-level history view showing all outcomes across all bookmakers on synchronized timeline.

Purpose: Enable users to see the complete market picture - how all outcomes moved across all bookmakers simultaneously - complementing the existing single-outcome comparison view.
Output: "Full Market View" mode in HistoryDialog displaying small-multiples chart layout (one chart per outcome, each showing all bookmakers).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency chain)
@.planning/phases/65-history-dialog-component/65-01-SUMMARY.md
@.planning/phases/66-odds-comparison-history/66-02-SUMMARY.md
@.planning/phases/67-event-details-history/67-01-FIX-SUMMARY.md

# Key source files
@web/src/features/matches/components/history-dialog.tsx
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/hooks/use-multi-odds-history.ts

**Current state:**
- HistoryDialog has two modes: single bookmaker (all outcomes) and comparison (one outcome, multiple bookmakers)
- OddsLineChart supports both modes via `comparisonMode` and `multiData` props
- useMultiOddsHistory already fetches all outcomes for all bookmakers

**Gap (Phase 68 addresses):**
- No way to see ALL outcomes × ALL bookmakers simultaneously
- Comparison mode forces users to switch between outcomes with selector buttons
- Full market picture requires multiple dialog interactions

**Design decision:**
- Small-multiples layout (3 mini charts, one per outcome) rather than one chart with 9 lines
- Each mini chart shows that outcome across all bookmakers
- Synchronized time axis for coherent market picture
- Cleaner than cramming 9 lines on one chart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MarketHistoryPanel component with small-multiples layout</name>
  <files>web/src/features/matches/components/market-history-panel.tsx, web/src/features/matches/components/index.ts</files>
  <action>
Create a new component that displays the full market view using small-multiples chart layout:

1. Component accepts `multiData` (MultiOddsHistoryData from useMultiOddsHistory) and `height` props
2. Extract all unique outcome names from the data (Home/Draw/Away, Over/Under, etc.)
3. Render a responsive grid of mini OddsLineCharts (one per outcome):
   - Use CSS grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3` for responsive layout
   - Each mini chart has fixed height (~180px) with outcome name as title
   - All charts synchronized by time axis (same data transformation as comparison mode)
4. Each mini chart shows all bookmakers for that ONE outcome:
   - Filter multiData to just that outcome's values
   - Transform data similar to OddsLineChart comparison mode but for single outcome
   - Use bookmaker colors from BOOKMAKER_COLORS constant
5. Add shared legend at bottom showing bookmaker colors
6. Handle empty state gracefully

Data transformation per mini chart:
- Create timeMap merging all bookmaker timestamps
- For each timestamp, extract just this outcome's odds from each bookmaker
- Sort by time for chronological display

Export from components/index.ts.
  </action>
  <verify>TypeScript compilation passes (`cd web && npx tsc --noEmit`)</verify>
  <done>MarketHistoryPanel component exists and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Full Market View mode into HistoryDialog</name>
  <files>web/src/features/matches/components/history-dialog.tsx</files>
  <action>
Enhance HistoryDialog to include Full Market View mode:

1. Add new state: `const [fullMarketView, setFullMarketView] = useState(false)`
2. In comparison mode header section (where bookmaker checkboxes are), add a toggle:
   - Below the bookmaker checkboxes, add "Full Market View" switch
   - Use shadcn Switch with Label: "Show all outcomes"
   - Only visible when `comparisonMode` is true
3. When `fullMarketView` is enabled:
   - In Odds TabsContent, render MarketHistoryPanel instead of OddsLineChart
   - Pass `multiData={multiOddsHistory.data}` and reasonable height
   - Margin tab continues to show MarginLineChart (full market view only affects Odds tab)
4. Update dialog title when full market view is active:
   - `${marketName} - Full Market View` instead of `${marketName} - Compare Bookmakers`
5. Reset `fullMarketView` to false when dialog closes or comparison mode is toggled off

Import MarketHistoryPanel at top of file.
  </action>
  <verify>TypeScript compilation passes (`cd web && npx tsc --noEmit`)</verify>
  <done>HistoryDialog supports Full Market View toggle in comparison mode, renders MarketHistoryPanel when enabled</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Market View mode showing all outcomes × all bookmakers in small-multiples layout</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Navigate to Odds Comparison page, find an event with multiple bookmakers
    3. Click on any odds value to open History Dialog
    4. Enable "Compare bookmakers" toggle → should see existing comparison mode with outcome selector
    5. Enable "Show all outcomes" toggle (new) → should see:
       - Small-multiples layout with one mini chart per outcome (e.g., Home/Draw/Away)
       - Each mini chart shows all selected bookmakers as different colored lines
       - Shared legend at bottom indicating bookmaker colors
       - Time axis synchronized across all mini charts
    6. Toggle between modes to verify smooth state transitions
    7. Test with different market types (1X2, Over/Under, etc.)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] Full Market View displays correctly in HistoryDialog
- [ ] All outcomes visible simultaneously with bookmaker differentiation
- [ ] Responsive layout works at different viewport widths
</verification>

<success_criteria>
- MarketHistoryPanel component created with small-multiples layout
- HistoryDialog enhanced with Full Market View toggle in comparison mode
- All outcomes × all bookmakers visible on synchronized timeline
- Visual verification confirms usable market-level history view
- Phase 68 complete
</success_criteria>

<output>
After completion, create `.planning/phases/68-market-level-history/68-01-SUMMARY.md`:

# Phase 68 Plan 01: Market-Level History View Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Phase 68 complete - milestone v2.1 ready for wrap-up]
</output>
