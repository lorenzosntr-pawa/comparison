---
phase: 47-combo-market-display-fix
plan: 01
type: execute
domain: frontend
---

<objective>
Fix combo markets (1X2OU, DCOU, etc.) that show margins but no odds â€” caused by getUnifiedOutcomes() not checking outcomes.length before using reference bookmaker.

Purpose: Enable accurate display of combo market odds and margins by fixing the outcome presence check and adding cross-bookmaker outcome name normalization.
Output: Modified market-row.tsx with outcomes.length checks and normalizeOutcomeName() function.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (BUG-004)

# Key source files:
@web/src/features/matches/components/market-row.tsx

**Root cause (BUG-004):**
- `getUnifiedOutcomes()` checked if market exists but not if `outcomes.length > 0`
- Combo markets have market objects with empty outcome arrays for some bookmakers
- Result: margin calculated but no outcomes to display
- Additional issue: Betpawa uses " - " separator (e.g., "1X - Under"), others use " & " (e.g., "1X & Under")

**Fix:**
1. Check `outcomes.length > 0` before using market as reference
2. Add `normalizeOutcomeName()` to handle separator differences
3. Only show margin when `outcomeNames.length > 0`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix outcome presence check and add name normalization</name>
  <files>web/src/features/matches/components/market-row.tsx</files>
  <action>
1. Add normalizeOutcomeName() function:
   ```typescript
   function normalizeOutcomeName(name: string): string {
     return name
       .replace(/ - /g, ' & ')  // Betpawa uses " - ", others use " & "
       .replace(/\s+/g, ' ')    // Normalize whitespace
       .trim()
   }
   ```

2. In getUnifiedOutcomes():
   - Change `if (betpawaMarket)` to `if (betpawaMarket && betpawaMarket.outcomes.length > 0)`
   - Change `if (market)` to `if (market && market.outcomes.length > 0)` in fallback loop

3. In getOutcomeForBookmaker():
   - Use normalizeOutcomeName() for matching: `normalizeOutcomeName(o.name) === normalizedTarget`

4. In getOddsComparison():
   - Use normalizeOutcomeName() for matching

5. In MarketRow render:
   - Add `outcomeNames.length > 0` to margin display condition
  </action>
  <verify>
1. `cd web && npm run typecheck` - TypeScript validation
2. Verify changes applied in market-row.tsx
  </verify>
  <done>
- normalizeOutcomeName() added for cross-bookmaker matching
- outcomes.length checks added in getUnifiedOutcomes()
- Normalized matching in getOutcomeForBookmaker() and getOddsComparison()
- Margin gated on outcomeNames.length > 0
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Combo market display fix with outcome name normalization</what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev` (frontend) + backend
    2. Navigate to Odds Comparison page, click any match
    3. Find combo market rows (1X2OU, DCOU, HTFTOU)
    4. Confirm: Odds now display (not just margin)
    5. Confirm: Margins only show when outcomes exist
    6. Confirm: Cross-bookmaker matching works despite separator differences
  </how-to-verify>
  <resume-signal>Type "approved" if combo markets display correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] TypeScript compiles without errors
- [ ] normalizeOutcomeName() function added
- [ ] outcomes.length checks in getUnifiedOutcomes()
- [ ] Margin gated on outcomeNames.length > 0
- [ ] Combo markets display odds (not just margins)
</verification>

<success_criteria>

- Task 1 completed: Code changes applied to market-row.tsx
- Checkpoint passed: Visual verification confirms combo markets display correctly
- BUG-004 resolved
</success_criteria>

<output>
After completion, create `.planning/phases/47-combo-market-display-fix/47-01-SUMMARY.md`
</output>
