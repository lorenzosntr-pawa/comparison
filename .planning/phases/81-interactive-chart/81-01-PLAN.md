---
phase: 81-interactive-chart
plan: 01
type: execute
---

<objective>
Add click-to-lock crosshair interactions to history charts, enabling users to lock a timestamp for detailed value inspection.

Purpose: Enable precise point-in-time comparison by locking crosshair at clicked position. Forms foundation for Phase 82 comparison table.
Output: Interactive charts with click-to-lock functionality across OddsLineChart, MarginLineChart, and MarketHistoryPanel.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (dependency graph)
@.planning/phases/80-specifier-bug-fix/80-02-SUMMARY.md

# Key source files
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/components/margin-line-chart.tsx
@web/src/features/matches/components/market-history-panel.tsx
@web/src/features/matches/components/history-dialog.tsx

**Tech stack available:** recharts (LineChart, Tooltip, ReferenceLine), React (useState, useCallback)
**Established patterns:**
- recharts Tooltip with custom formatters
- ReferenceLine for visual markers
- Chart component props for data and callbacks
**Constraining decisions:**
- [Phase 80]: Line parameter flows through component hierarchy
- [Phase 64]: recharts integration patterns established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create use-chart-lock hook</name>
  <files>web/src/features/matches/hooks/use-chart-lock.ts</files>
  <action>
Create a React hook to manage chart crosshair lock state:

```typescript
interface ChartLockState {
  lockedTime: string | null       // ISO timestamp of locked point
  lockedIndex: number | null      // Index in chart data array
  isLocked: boolean               // Convenience flag
}

interface UseChartLockReturn extends ChartLockState {
  handleChartClick: (data: { activePayload?: Array<{ payload: { time: string } }> }) => void
  clearLock: () => void
}
```

Implementation:
- `useState` to track `lockedTime` and `lockedIndex`
- `handleChartClick` toggles lock: if already locked at same index, unlock; otherwise lock at clicked index
- Extract time from recharts click event payload: `data.activePayload?.[0]?.payload?.time`
- `clearLock` resets both states to null
- Export `isLocked` as computed boolean `lockedTime !== null`

DO NOT use useRef for lock state - useState ensures re-renders on lock change.
  </action>
  <verify>TypeScript compiles without errors: `cd web && npx tsc --noEmit`</verify>
  <done>Hook file exists, exports UseChartLockReturn interface and useChartLock function</done>
</task>

<task type="auto">
  <name>Task 2: Add click-to-lock to OddsLineChart and MarginLineChart</name>
  <files>web/src/features/matches/components/odds-line-chart.tsx, web/src/features/matches/components/margin-line-chart.tsx</files>
  <action>
Update both chart components to support click-to-lock:

**New props:**
```typescript
interface OddsLineChartProps {
  // ... existing props
  onLockChange?: (lockedTime: string | null, lockedData: Record<string, unknown> | null) => void
}
```

**Implementation pattern (apply to both components):**

1. Add local state via useChartLock hook:
```typescript
const { lockedTime, lockedIndex, isLocked, handleChartClick, clearLock } = useChartLock()
```

2. Add onClick handler to LineChart:
```typescript
<LineChart
  data={chartData}
  onClick={handleChartClick}
  // ... existing props
>
```

3. When locked, add ReferenceLine at the locked position:
```typescript
{isLocked && lockedIndex !== null && (
  <ReferenceLine
    x={chartData[lockedIndex]?.timeLabel}
    stroke="hsl(var(--primary))"
    strokeWidth={2}
    strokeDasharray="none"
  />
)}
```

4. Modify Tooltip to show locked data when locked:
- Add `active` prop check: when `isLocked`, force tooltip to show locked data
- Use recharts Tooltip's `content` prop for custom rendering when locked

5. Add "Click to unlock" indicator when locked - small text below chart:
```typescript
{isLocked && (
  <div className="text-xs text-muted-foreground text-center mt-1 cursor-pointer" onClick={clearLock}>
    Click chart or here to unlock
  </div>
)}
```

6. Call `onLockChange` callback when lock state changes:
```typescript
useEffect(() => {
  if (onLockChange) {
    const lockedData = isLocked && lockedIndex !== null ? chartData[lockedIndex] : null
    onLockChange(lockedTime, lockedData)
  }
}, [lockedTime, lockedIndex, isLocked])
```

**MarginLineChart specifics:**
- Same pattern, simpler data structure (just margin values)
- ReferenceLine import already exists (used for referenceValue)

DO NOT use cursor="pointer" on the chart container - recharts handles cursor styling.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit` and charts render without errors</verify>
  <done>Both charts support click-to-lock with visual indicator and callback</done>
</task>

<task type="auto">
  <name>Task 3: Add synchronized lock to MarketHistoryPanel</name>
  <files>web/src/features/matches/components/market-history-panel.tsx</files>
  <action>
Add click-to-lock to small-multiples panel with synchronized time across all mini-charts:

**New props:**
```typescript
interface MarketHistoryPanelProps {
  multiData?: MultiOddsHistoryData
  height?: number
  onLockChange?: (lockedTime: string | null) => void
}
```

**Implementation:**

1. Add shared lock state at panel level (not per chart):
```typescript
const [lockedTime, setLockedTime] = useState<string | null>(null)
const isLocked = lockedTime !== null
```

2. Find locked index for each outcome's data:
```typescript
const getLockedIndex = (data: ChartDataPoint[]) => {
  if (!lockedTime) return null
  return data.findIndex(d => d.time === lockedTime)
}
```

3. Add onClick to each mini LineChart that sets the shared lockedTime:
```typescript
onClick={(data) => {
  const time = data.activePayload?.[0]?.payload?.time
  if (time) {
    setLockedTime(prev => prev === time ? null : time)
  }
}}
```

4. Render ReferenceLine at lockedTime in each mini-chart:
```typescript
{isLocked && (() => {
  const idx = getLockedIndex(chartDataByOutcome[outcomeName] || [])
  if (idx === null || idx < 0) return null
  return (
    <ReferenceLine
      x={chartDataByOutcome[outcomeName]?.[idx]?.timeLabel}
      stroke="hsl(var(--primary))"
      strokeWidth={2}
    />
  )
})()}
```

5. Add unlock indicator below the grid:
```typescript
{isLocked && (
  <div className="text-xs text-muted-foreground text-center cursor-pointer" onClick={() => setLockedTime(null)}>
    Locked at {format(new Date(lockedTime), 'MMM d, HH:mm')} - Click to unlock
  </div>
)}
```

6. Call onLockChange callback when lock state changes.

DO NOT create separate lock state per mini-chart - synchronization requires shared state.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>MarketHistoryPanel shows synchronized locked crosshair across all outcome charts</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Click-to-lock crosshair interactions on all history charts</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Visit: http://localhost:5173
    3. Navigate to Odds Comparison page
    4. Click any odds value to open history dialog
    5. Test single bookmaker mode:
       - Hover over chart - tooltip follows mouse
       - Click on chart - crosshair locks, vertical line appears
       - Note locked timestamp in tooltip
       - Click again - crosshair unlocks
    6. Enable "Compare bookmakers" toggle
    7. Test comparison mode:
       - Click on chart - all lines show locked point
       - Values displayed at locked timestamp
    8. Enable "Show all outcomes" for full market view
    9. Test synchronized lock:
       - Click one mini-chart - all charts show locked line at same time
       - Verify "Locked at [time] - Click to unlock" message appears
       - Click unlock message - all charts unlock
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] Click-to-lock works in single bookmaker mode
- [ ] Click-to-lock works in comparison mode
- [ ] Click-to-lock synchronized in full market view
- [ ] Visual indicator shows when locked
- [ ] Click to unlock works
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Charts support click-to-lock crosshair interaction
- Locked state exposed via callback for Phase 82 integration
</success_criteria>

<output>
After completion, create `.planning/phases/81-interactive-chart/81-01-SUMMARY.md`:

# Phase 81 Plan 01: Interactive Chart Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 82: Comparison Table]
</output>
