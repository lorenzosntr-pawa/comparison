---
phase: 81-interactive-chart
plan: 01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 81-01: click-to-lock doesn't persist on OddsLineChart and MarginLineChart, comparison panel doesn't appear.

Source: 81-01-ISSUES.md
Priority: 0 critical, 3 major, 0 minor

Root cause hypothesis: The "brief flash" on click suggests the handler fires but state doesn't persist. Likely causes:
1. recharts onClick event format differs from expected (activePayload structure)
2. Parent component re-renders resetting chart state
3. Time comparison logic issue causing immediate unlock
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/81-interactive-chart/81-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/81-interactive-chart/81-01-PLAN.md

**Key source files:**
@web/src/features/matches/hooks/use-chart-lock.ts
@web/src/features/matches/components/odds-line-chart.tsx
@web/src/features/matches/components/margin-line-chart.tsx
@web/src/features/matches/components/history-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix click handler in useChartLock</name>
  <files>web/src/features/matches/hooks/use-chart-lock.ts</files>
  <action>
Investigate and fix the click-to-lock hook:

**1. Add console logging to understand what recharts provides:**
```typescript
const handleChartClick = useCallback(
  (data: ChartClickData) => {
    console.log('[useChartLock] click data:', JSON.stringify(data, null, 2))
    console.log('[useChartLock] current lockedTime:', lockedTime)
    // ... rest of handler
  },
  [lockedTime]
)
```

**2. Check if activePayload exists and has expected structure:**
The recharts onClick might provide data differently. Check:
- `data.activePayload` (array of point data)
- `data.activeTooltipIndex` (index in data array)
- `data.chartX`, `data.chartY` (click coordinates)

**3. Likely fix - use activeTooltipIndex instead of time comparison:**
The time comparison might fail if time formats don't match exactly. Instead:
```typescript
if (lockedIndex === index) {
  // Clicking same index unlocks
  setLockedTime(null)
  setLockedIndex(null)
} else {
  // Lock at new position
  setLockedTime(time)
  setLockedIndex(index)
}
```

**4. Handle edge case where activeTooltipIndex is undefined:**
When clicking between data points, recharts may not provide an index. Fall back gracefully.

After fixing, remove console.log statements.
  </action>
  <verify>Add temporary console.log, click on chart in browser, check console output shows expected data structure</verify>
  <done>Click handler correctly extracts time and index from recharts event and persists lock state</done>
</task>

<task type="auto">
  <name>Task 2: Fix OddsLineChart to properly display lock state</name>
  <files>web/src/features/matches/components/odds-line-chart.tsx</files>
  <action>
Review and fix OddsLineChart lock display:

**1. Verify ReferenceLine renders when locked:**
Add console log to check if isLocked and lockedIndex are truthy:
```typescript
{console.log('[OddsLineChart] isLocked:', isLocked, 'lockedIndex:', lockedIndex)}
```

**2. Check if chartData[lockedIndex] exists:**
The lockedIndex might be stale if chartData changed. Add validation:
```typescript
{isLocked && lockedIndex !== null && lockedIndex < chartData.length && chartData[lockedIndex] && (
  <ReferenceLine ... />
)}
```

**3. Verify the lock state persists through renders:**
If chartData is recalculating on every render, the indices might shift. Ensure useMemo has stable dependencies.

**4. Check onLockChange effect isn't causing issues:**
The useEffect calling onLockChange includes chartData in dependencies. If parent re-renders on callback, this could cause a loop.
Consider:
```typescript
useEffect(() => {
  if (!onLockChange) return
  // ... callback logic
}, [lockedTime, lockedIndex, isLocked, onLockChange]) // Remove chartData if not strictly needed
```

After confirming fix works, remove console.log statements.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>OddsLineChart displays ReferenceLine and comparison panel when locked</done>
</task>

<task type="auto">
  <name>Task 3: Fix MarginLineChart with same pattern</name>
  <files>web/src/features/matches/components/margin-line-chart.tsx</files>
  <action>
Apply the same fixes from Task 2 to MarginLineChart:

1. Check if click handler is wired up correctly
2. Verify ReferenceLine condition includes bounds check
3. Fix onLockChange effect dependencies if needed
4. Ensure comparison panel renders when locked

The fix pattern should mirror OddsLineChart exactly.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>MarginLineChart displays lock indicator and comparison panel when locked</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed click-to-lock functionality on both chart components</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Navigate to Odds Comparison or Event Details
    3. Click an odds value to open history dialog
    4. Click on the OddsLineChart:
       - Vertical reference line should appear
       - Comparison panel should show below chart with locked values
       - Tooltip should stop following mouse
    5. Click the "Unlock" button or chart again:
       - Reference line should disappear
       - Comparison panel should hide
    6. Switch to margin tab and repeat test
    7. Verify both charts work correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed
- [ ] All major issues fixed
- [ ] Minor issues fixed or documented as deferred
- [ ] Original acceptance criteria from issues met
</verification>

<success_criteria>
- UAT-001: OddsLineChart click-to-lock persists and shows reference line
- UAT-002: MarginLineChart click-to-lock persists and shows reference line
- UAT-003: Comparison panel appears below charts when locked
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/81-interactive-chart/81-01-FIX-SUMMARY.md`
</output>
