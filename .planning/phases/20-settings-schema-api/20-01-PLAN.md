---
phase: 20-settings-schema-api
plan: 01
type: execute
---

<objective>
Add history retention setting to the existing settings infrastructure.

Purpose: Prepare for Phase 22 (History Retention) by adding `history_retention_days` column to settings table. This enables users to configure how long scrape history is kept before cleanup.

Output: Settings model extended with retention field, migration created, schemas updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing settings infrastructure (Phase 10):**
@src/db/models/settings.py
@src/api/schemas/settings.py
@src/api/routes/settings.py

**Patterns established:**
- Single-row singleton pattern (id=1)
- Pydantic v2 with ConfigDict, alias_generator=to_camel
- SQLAlchemy 2.0 with Mapped[] columns
- Partial update pattern (only update provided fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add history_retention_days to Settings model and create migration</name>
  <files>src/db/models/settings.py, alembic/versions/*_add_history_retention_setting.py</files>
  <action>
    Add `history_retention_days: Mapped[int] = mapped_column(default=7)` to Settings model.
    Default of 7 days is sensible for odds data that changes frequently.

    Create migration with: `alembic revision --autogenerate -m "add_history_retention_setting"`

    Migration should:
    - Add column with server_default=7 (for existing rows)
    - No need to modify existing row since default handles it

    Review and clean up autogenerated migration if needed (remove extraneous changes).
  </action>
  <verify>
    - `alembic check` shows no pending changes
    - `alembic upgrade head` applies successfully
    - SELECT history_retention_days FROM settings returns 7
  </verify>
  <done>Settings model has history_retention_days column, migration applied, default value set</done>
</task>

<task type="auto">
  <name>Task 2: Update Pydantic schemas for history retention</name>
  <files>src/api/schemas/settings.py</files>
  <action>
    In SettingsResponse:
    - Add `history_retention_days: int` field

    In SettingsUpdate:
    - Add `history_retention_days: int | None = Field(default=None, ge=1, le=90, description="Days to keep scrape history (1-90)")`

    The range 1-90 allows flexibility while preventing excessive storage or immediate deletion.

    No route changes needed - existing partial update logic handles new fields automatically.
  </action>
  <verify>
    - GET /api/settings returns historyRetentionDays field
    - PUT /api/settings with {"historyRetentionDays": 14} updates the value
    - PUT with out-of-range values (0, 100) returns 422
  </verify>
  <done>API returns and accepts history retention setting, validation enforces 1-90 day range</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Settings model has history_retention_days column
- [ ] Migration applied successfully
- [ ] GET /api/settings includes historyRetentionDays: 7
- [ ] PUT /api/settings can update the value
- [ ] Validation rejects invalid values
</verification>

<success_criteria>

- Both tasks completed
- All verification checks pass
- No TypeScript/Python errors
- Settings API works with new field
</success_criteria>

<output>
After completion, create `.planning/phases/20-settings-schema-api/20-01-SUMMARY.md`
</output>
