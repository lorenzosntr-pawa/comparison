---
phase: 20-settings-schema-api
plan: 01
subsystem: database
tags: [sqlalchemy, pydantic, alembic, settings]

# Dependency graph
requires:
  - phase: 10-settings-page
    provides: Settings model and API infrastructure
provides:
  - history_retention_days column in Settings model
  - Migration for adding the column
  - API support for getting/setting retention days
affects: [21-settings-persistence, 22-history-retention]

# Tech tracking
tech-stack:
  added: []
  patterns: []

key-files:
  created:
    - alembic/versions/a7b3c1d4e8f2_add_history_retention_setting.py
  modified:
    - src/db/models/settings.py
    - src/api/schemas/settings.py
    - src/api/routes/settings.py

key-decisions:
  - "Default retention of 7 days for frequently changing odds data"
  - "Validation range 1-90 days to prevent extremes"

patterns-established: []

issues-created: []

# Metrics
duration: 8min
completed: 2026-01-25
---

# Phase 20 Plan 01: Add history_retention_days setting Summary

**Settings model extended with history_retention_days column (default 7), migration created, API updated to expose the field with 1-90 day validation**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-25T12:00:00Z
- **Completed:** 2026-01-25T12:08:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Added history_retention_days column to Settings model with default=7
- Created Alembic migration a7b3c1d4e8f2 with server_default for existing rows
- Extended Pydantic schemas (SettingsResponse and SettingsUpdate)
- Added update handler in routes for the new field

## Task Commits

Each task was committed atomically:

1. **Task 1: Add history_retention_days to Settings model and create migration** - `dabade6` (feat)
2. **Task 2: Update Pydantic schemas for history retention** - `e7c1790` (feat)

**Plan metadata:** (pending)

## Files Created/Modified

- `alembic/versions/a7b3c1d4e8f2_add_history_retention_setting.py` - Migration to add history_retention_days column
- `src/db/models/settings.py` - Added history_retention_days: Mapped[int] column
- `src/api/schemas/settings.py` - Added field to SettingsResponse and SettingsUpdate
- `src/api/routes/settings.py` - Added handler for updating history_retention_days

## Decisions Made

- Default of 7 days chosen as sensible for odds data that changes frequently
- Validation range 1-90 days prevents both immediate deletion (1) and excessive storage (>90)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added update handler in routes**
- **Found during:** Task 2 (Update Pydantic schemas)
- **Issue:** Plan stated "No route changes needed" but partial update logic explicitly checks each field
- **Fix:** Added if-block to handle history_retention_days updates
- **Files modified:** src/api/routes/settings.py
- **Verification:** Code review confirms field will be updated
- **Committed in:** e7c1790 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Necessary for correct operation. No scope creep.

## Issues Encountered

- Database not running during execution - migration created manually instead of autogenerated
- API verification steps not run (require running database)

## Next Phase Readiness

- Settings infrastructure ready for history_retention_days
- Migration needs to be applied when database is available: `alembic upgrade head`
- Ready for Phase 21: Settings Persistence Integration

---
*Phase: 20-settings-schema-api*
*Completed: 2026-01-25*
