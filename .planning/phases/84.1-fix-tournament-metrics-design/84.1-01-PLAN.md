---
phase: 84.1-fix-tournament-metrics-design
plan: 01
type: execute
---

<objective>
Fix tournament metrics to include started events and per-market margin breakdown.

Purpose: Enable accurate historical tournament analysis by including completed matches and showing margin breakdowns across market types (1X2, O/U 2.5, BTTS, Double Chance).
Output: Updated useTournaments hook with complete data, TournamentCard with per-market margin display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-tournament-summary-metrics/84-01-SUMMARY.md

**Key files:**
@web/src/features/historical-analysis/hooks/use-tournaments.ts
@web/src/features/historical-analysis/components/tournament-list.tsx
@web/src/features/matches/hooks/use-column-settings.ts (reference for market IDs)

**Issues addressed:**
- BUG-013: Tournament metrics exclude started events
- BUG-014: Tournament metrics only show 1X2 market margins
- BUG-015: No per-market margin breakdown per tournament

**Established patterns (Phase 84):**
- TournamentAccumulator pattern for multi-field aggregation
- First-half vs second-half trend calculation with 0.5% threshold
- MarginBadge component with comparison coloring
- CoverageBar component with bookmaker segments

**Market IDs (from use-column-settings.ts):**
- 3743 = 1X2 Full Time
- 5000 = Over/Under 2.5 Full Time
- 3795 = Both Teams To Score Full Time
- 4693 = Double Chance Full Time
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useTournaments hook for multi-market metrics</name>
  <files>web/src/features/historical-analysis/hooks/use-tournaments.ts</files>
  <action>
1. Add `include_started: true` to the api.getEvents() call (lines 149-154) to include completed matches in historical analysis.

2. Define market configuration constant at top of file:
```typescript
const TRACKED_MARKETS = [
  { id: '3743', label: '1X2' },
  { id: '5000', label: 'O/U 2.5' },
  { id: '3795', label: 'BTTS' },
  { id: '4693', label: 'DC' },
] as const
```

3. Create MarginMetrics interface for per-market data:
```typescript
interface MarginMetrics {
  avgMargin: number | null
  competitorAvgMargin: number | null
  trend: 'up' | 'down' | 'stable' | null
}
```

4. Update TournamentWithCount interface:
- Replace `avgMargin`, `competitorAvgMargin`, `trend` with:
  `marginsByMarket: Record<string, MarginMetrics>`
- Keep existing fields: id, name, country, eventCount, coverageByBookmaker

5. Update TournamentAccumulator:
- Replace single-market arrays with per-market structure:
  `marginData: Record<string, { betpawaMargins: number[], competitorMargins: number[], eventMargins: {kickoff: string, margin: number}[] }>`

6. Update extractBookmaker1X2Margin() to generic extractBookmakerMargin(event, bookmakerSlug, marketId)

7. Update getBestCompetitorMargin() to accept marketId parameter

8. In the main loop, iterate over TRACKED_MARKETS and accumulate margins for each market type

9. In the conversion step, calculate MarginMetrics for each market using calculateTrend()

Keep existing calculateTrend() function unchanged - it works per-market.
Keep existing coverage calculation unchanged - it's event-level, not market-level.
  </action>
  <verify>npm run type-check passes, no errors in use-tournaments.ts</verify>
  <done>TournamentWithCount has marginsByMarket with all 4 market types, include_started=true added to API call</done>
</task>

<task type="auto">
  <name>Task 2: Update TournamentCard with per-market breakdown display</name>
  <files>web/src/features/historical-analysis/components/tournament-list.tsx</files>
  <action>
1. Import TRACKED_MARKETS from use-tournaments.ts (export it in Task 1)

2. Update MarginBadge to accept marketLabel parameter for display

3. Create MarketBreakdown component that renders each market's metrics:
```typescript
function MarketBreakdown({ marginsByMarket }: { marginsByMarket: Record<string, MarginMetrics> }) {
  return (
    <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
      {TRACKED_MARKETS.map(market => {
        const metrics = marginsByMarket[market.id]
        if (!metrics?.avgMargin) return null // Skip markets with no data

        return (
          <div key={market.id} className="flex items-center justify-between gap-2">
            <span className="text-muted-foreground">{market.label}:</span>
            <MarginBadge
              avgMargin={metrics.avgMargin}
              competitorAvgMargin={metrics.competitorAvgMargin}
              trend={metrics.trend}
            />
          </div>
        )
      })}
    </div>
  )
}
```

4. Update TournamentCard:
- Remove the single MarginBadge call
- Add MarketBreakdown component in the metrics row
- Keep CoverageBar as-is (it's event-level, not market-level)

5. Handle empty state: if no markets have data, show "No margin data" message
  </action>
  <verify>npm run type-check passes, UI renders correctly with npm run dev</verify>
  <done>Tournament cards show per-market margin breakdown with 1X2, O/U 2.5, BTTS, DC margins and trend indicators</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes without errors
- [ ] Historical Analysis page loads successfully
- [ ] Tournament cards show metrics for multiple market types (not just 1X2)
- [ ] Started/completed events are included in tournament counts
- [ ] Each market shows: Betpawa margin, delta from competitor, trend arrow
</verification>

<success_criteria>

- All tasks completed
- BUG-013 fixed: include_started=true added to API call
- BUG-014 fixed: Metrics extracted for 1X2, O/U 2.5, BTTS, DC markets
- BUG-015 fixed: Per-market breakdown displayed on tournament cards
- No TypeScript errors
- UI renders correctly with per-market metrics
</success_criteria>

<output>
After completion, create `.planning/phases/84.1-fix-tournament-metrics-design/84.1-01-SUMMARY.md`

Use the summary template from ./summary.md with:
- Frontmatter with dependency graph and patterns
- Performance metrics
- List of accomplishments
- Task commits
- Files modified
- Decisions made
- Next phase readiness
</output>
