---
phase: 84.1-fix-tournament-metrics-design
plan: 01
subsystem: historical-analysis
tags: [react, tanstack-query, metrics, tournament]

# Dependency graph
requires:
  - phase: 84-tournament-summary-metrics
    provides: useTournaments hook, TournamentCard, CoverageBar, MarginBadge components
provides:
  - Multi-market margin metrics (1X2, O/U 2.5, BTTS, DC)
  - include_started support for completed matches
  - Per-market breakdown display in tournament cards
affects: [85, 86, 87, 88]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Per-market accumulator structure for multi-metric aggregation"
    - "MarginMetrics interface for reusable margin display"

key-files:
  created: []
  modified:
    - web/src/features/historical-analysis/hooks/use-tournaments.ts
    - web/src/features/historical-analysis/hooks/index.ts
    - web/src/features/historical-analysis/components/tournament-list.tsx
    - web/src/lib/api.ts

key-decisions:
  - "Use marginsByMarket Record instead of flat fields for extensibility"
  - "Keep coverage at event-level (not market-level) for simplicity"
  - "Sort tournaments by 1X2 margin ascending (primary market)"

patterns-established:
  - "Per-market accumulator: Record<marketId, { betpawaMargins[], competitorMargins[], eventMargins[] }>"
  - "MarginMetrics interface: { avgMargin, competitorAvgMargin, trend }"
  - "TRACKED_MARKETS constant exported for shared use"

issues-created: []

# Metrics
duration: 8min
completed: 2026-02-10
---

# Phase 84.1 Plan 01: Fix Tournament Metrics Summary

**Multi-market margin breakdown with 1X2, O/U 2.5, BTTS, and DC metrics, plus include_started for completed matches**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-10T15:05:00Z
- **Completed:** 2026-02-10T15:13:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Extended useTournaments hook to extract margins for 4 market types (1X2, O/U 2.5, BTTS, DC)
- Added include_started=true to API call for historical analysis (BUG-013 fix)
- Created MarketBreakdown component showing 2x2 grid of per-market metrics
- Updated TournamentWithCount interface to use marginsByMarket structure (BUG-014/015 fix)
- Added include_started parameter to api.getEvents() function

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend useTournaments hook for multi-market metrics** - `05fe515` (feat)
2. **Task 2: Update TournamentCard with per-market breakdown display** - `4cae646` (feat)

**Plan metadata:** `b3ac99f` (docs: complete plan)

## Files Created/Modified

- `web/src/features/historical-analysis/hooks/use-tournaments.ts` - Multi-market accumulator, MarginMetrics interface, TRACKED_MARKETS constant
- `web/src/features/historical-analysis/hooks/index.ts` - Export new types and constant
- `web/src/features/historical-analysis/components/tournament-list.tsx` - MarketBreakdown component, updated TournamentCard
- `web/src/lib/api.ts` - Added include_started parameter to getEvents()

## Decisions Made

- **marginsByMarket structure** - Record<marketId, MarginMetrics> allows easy addition of new markets without interface changes
- **Keep event-level coverage** - Coverage is about bookmaker presence at event level, not per-market, so no changes needed
- **Sort by 1X2 margin** - Primary market for tournament comparison, other markets supplementary

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added include_started to api.getEvents() type**
- **Found during:** Task 1 (useTournaments hook update)
- **Issue:** include_started parameter existed in backend but not in frontend API client type
- **Fix:** Added include_started?: boolean to getEvents params and searchParams setter
- **Files modified:** web/src/lib/api.ts
- **Verification:** TypeScript passes
- **Committed in:** 05fe515 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking), 0 deferred
**Impact on plan:** API type fix was necessary to unblock Task 1. No scope creep.

## Issues Encountered

None - plan executed as specified.

## Next Phase Readiness

- Tournament cards now display metrics for all 4 tracked market types
- Historical analysis includes completed matches for accurate tournament analysis
- Ready for Phase 85: Time-to-Kickoff Charts

---
*Phase: 84.1-fix-tournament-metrics-design*
*Completed: 2026-02-10*
