---
phase: 110-retention-cleanup-storage-fix
plan: 01
type: execute
---

<objective>
Fix cleanup service timezone bug causing 500 errors, add market_odds_history cleanup for new schema, and update retention to 14 days.

Purpose: Complete v2.9 migration by ensuring cleanup jobs work with the new market-level schema.
Output: Working cleanup preview/execute endpoints, market_odds_history retention, 14-day retention setting.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase dependencies (from v2.9 milestone):
@.planning/phases/106-schema-migration/106-01-SUMMARY.md
@.planning/phases/107-write-path-changes/107-02-SUMMARY.md

# Key files:
@src/services/cleanup.py
@src/db/models/market_odds.py
@src/db/models/settings.py

**Root cause analysis:**
- `/api/cleanup/preview` returns 500 error
- Error: `can't subtract offset-naive and offset-aware datetimes`
- `cleanup.py:179` uses `datetime.now(timezone.utc)` (timezone-aware)
- `OddsSnapshot.captured_at` is `TIMESTAMP WITHOUT TIME ZONE` (naive)
- Same issue affects `preview_cleanup()` and `execute_cleanup()`

**New schema context:**
- v2.9 introduced `market_odds_current` (UPSERT) and `market_odds_history` (partitioned)
- `market_odds_current` doesn't need cleanup (UPSERT pattern replaces old data)
- `market_odds_history` needs retention cleanup (captured_at based deletion)
- `market_odds_history.captured_at` uses `DateTime(timezone=True)` - timezone-aware
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix cleanup.py timezone bug</name>
  <files>src/services/cleanup.py</files>
  <action>
Replace `datetime.now(timezone.utc)` with `datetime.utcnow()` in both `preview_cleanup()` and `execute_cleanup()` functions. The old snapshot tables (OddsSnapshot, CompetitorOddsSnapshot, Event, etc.) use `TIMESTAMP WITHOUT TIME ZONE` columns, so the cutoff datetime must be naive.

Lines to fix:
- Line 179: `now = datetime.now(timezone.utc)` → `now = datetime.utcnow()`
- Line 329: `now = datetime.now(timezone.utc)` → `now = datetime.utcnow()`

Also remove the unused `timezone` import if it's only used here.
  </action>
  <verify>
curl "http://localhost:8000/api/cleanup/preview?odds_days=14&match_days=14" returns 200 with JSON response (not 500 error)
  </verify>
  <done>Cleanup preview and execute endpoints return 200, no timezone errors</done>
</task>

<task type="auto">
  <name>Task 2: Add market_odds_history cleanup</name>
  <files>src/services/cleanup.py</files>
  <action>
Add cleanup for the new `market_odds_history` table (from v2.9 schema). This table uses `DateTime(timezone=True)` so it needs a timezone-aware cutoff.

1. Import MarketOddsHistory model at top of file
2. In `preview_cleanup()`, add count query for market_odds_history:
   - Use timezone-aware cutoff for this table: `datetime.now(timezone.utc)`
   - Query: `SELECT count(*) FROM market_odds_history WHERE captured_at < $1`
3. In `execute_cleanup()`, add batch delete for market_odds_history:
   - Use same timezone-aware cutoff
   - Add after step 4 (competitor_odds_snapshots) since no FKs reference it
4. Update CleanupPreview and CleanupResult schemas if needed to include market_odds_history count

Note: market_odds_current does NOT need cleanup - the UPSERT pattern maintains current state only.
  </action>
  <verify>
1. Run cleanup preview and verify market_odds_history_count appears in response
2. Check that market_odds_history rows older than retention are counted
  </verify>
  <done>market_odds_history cleanup integrated into preview and execute functions</done>
</task>

<task type="auto">
  <name>Task 3: Update retention setting to 14 days</name>
  <files>alembic/versions/new_migration.py</files>
  <action>
Create Alembic data migration to update the settings table retention values from current value (likely 7) to 14 days.

1. Generate new migration: `alembic revision -m "update_retention_to_14_days"`
2. In upgrade():
   ```python
   op.execute("UPDATE settings SET odds_retention_days = 14, match_retention_days = 14 WHERE id = 1")
   ```
3. In downgrade():
   ```python
   op.execute("UPDATE settings SET odds_retention_days = 7, match_retention_days = 7 WHERE id = 1")
   ```
4. Run migration: `alembic upgrade head`
  </action>
  <verify>
1. `alembic current` shows latest migration
2. Query database: `SELECT odds_retention_days, match_retention_days FROM settings WHERE id = 1` returns (14, 14)
3. Verify via API: `curl http://localhost:8000/api/settings` shows retention values as 14
  </verify>
  <done>Database settings updated to 14-day retention, migration committed</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `curl http://localhost:8000/api/cleanup/preview` returns 200 (not 500)
- [ ] Cleanup preview includes market_odds_history_count field
- [ ] Settings API shows odds_retention_days=14, match_retention_days=14
- [ ] No timezone-related errors in server logs
- [ ] Storage page loads without errors (Settings > Manage Data)
</verification>

<success_criteria>

- All tasks completed
- Cleanup preview endpoint returns 200 with all counts
- market_odds_history included in cleanup operations
- Retention settings updated to 14 days
- Storage page and Settings page work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/110-retention-cleanup-storage-fix/110-01-SUMMARY.md`:

# Phase 110 Plan 01: Retention, Cleanup & Storage Fix Summary

**[One-liner describing what shipped]**

## Accomplishments

- Fixed timezone bug in cleanup.py (naive vs aware datetime mismatch)
- Added market_odds_history cleanup for v2.9 schema
- Updated retention setting to 14 days via Alembic migration

## Files Created/Modified

- `src/services/cleanup.py` - Timezone fix + market_odds_history cleanup
- `alembic/versions/xxx_update_retention_to_14_days.py` - Settings migration

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete. v2.9 milestone ready to ship.
</output>
