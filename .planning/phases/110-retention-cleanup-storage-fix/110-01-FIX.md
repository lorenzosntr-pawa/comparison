---
phase: 110-retention-cleanup-storage-fix
plan: 01-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 110-01.

Source: 110-01-ISSUES.md
Priority: 1 blocker, 0 major, 0 minor

Purpose: Fix cleanup FK violation that prevents cleanup execute from completing
Output: Cleanup execute works without 500 errors
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/110-retention-cleanup-storage-fix/110-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/110-retention-cleanup-storage-fix/110-01-PLAN.md

**Files to modify:**
@src/services/cleanup.py
@src/db/models/event_scrape_status.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add EventScrapeStatus cleanup to cleanup.py</name>
  <files>src/services/cleanup.py</files>
  <action>
Fix the FK violation by adding EventScrapeStatus deletion before scrape_runs deletion:

1. Add import at top:
   ```python
   from src.db.models.event_scrape_status import EventScrapeStatus
   ```

2. In `execute_cleanup()`, after step 6 (scrape_phase_logs) and before step 7 (scrape_runs), add:
   ```python
   # 6.5 Delete event_scrape_status for old runs
   log.info("Deleting old event_scrape_status")
   await _batch_delete(
       session, EventScrapeStatus, EventScrapeStatus.scrape_run_id.in_(old_run_ids), log
   )
   ```

3. Update the docstring at top of file to include event_scrape_status in the deletion order:
   - Change step 5 to: `5. scrape_errors, scrape_phase_logs, event_scrape_status (FK: scrape_run_id)`

Note: The preview function doesn't need to count event_scrape_status since it's directly tied to scrape_runs count - when scrape_runs are deleted, all their event_scrape_status go too. But we must delete them BEFORE scrape_runs.
  </action>
  <verify>
Run cleanup preview (should still work):
```bash
curl http://localhost:8000/api/cleanup/preview
```

Then run cleanup execute and confirm no 500 error:
```bash
curl -X POST http://localhost:8000/api/cleanup/execute
```
  </verify>
  <done>
- Cleanup execute completes without FK violation error
- All old scrape_runs and their event_scrape_status records are deleted
- No 500 Internal Server Error
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Cleanup preview still returns correct counts
- [ ] Cleanup execute completes without 500 error
- [ ] No FK violation on scrape_runs table
- [ ] TypeScript/Python builds pass
</verification>

<success_criteria>
- UAT-001 from 110-01-ISSUES.md addressed
- Cleanup execute works end-to-end
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/110-retention-cleanup-storage-fix/110-01-FIX-SUMMARY.md`
</output>
