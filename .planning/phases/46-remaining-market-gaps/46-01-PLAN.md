---
phase: 46-remaining-market-gaps
plan: 01
type: execute
domain: market-mapping
---

<objective>
Fix handicap markets (3-Way and Asian) so competitor odds display correctly in the UI — currently showing "-" despite data existing.

Purpose: Enable accurate cross-platform handicap odds comparison by fixing the line field mismatch between BetPawa and competitor data storage.
Output: Modified event_coordinator.py that populates competitor market `line` field from `handicap_home` for handicap markets.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-remaining-market-gaps/46-CONTEXT.md

# Key source files:
@src/scraping/event_coordinator.py (lines 1870-1880 and 1920-1930)
@src/db/models/competitor.py (CompetitorMarketOdds model)
@web/src/features/matches/components/market-grid.tsx (line matching logic)

**Root cause:**
- BetPawa stores handicap value in `line` field (extracted from `formattedHandicap`)
- Competitors store handicap in `handicap_home` with `line=null`
- Frontend matches using `${market_id}_${line}`, so `4724_-1` ≠ `4724_null`

**Fix:** In event_coordinator.py, when creating CompetitorMarketOdds, if `mapped.line` is None but `mapped.handicap` exists, set `line = mapped.handicap.home`.

**Markets covered:**
- 3-Way Handicap: Full Time (4724), First Half (4716), Second Half (4720)
- Asian Handicap: Full Time (3774), First Half (3747), Second Half (3756)

**Prior decision (v1.8 44-03):** Combo markets (1X2OU, DCOU) already use line from O/U handler. Handicap markets need same treatment.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate competitor handicap market line field</name>
  <files>src/scraping/event_coordinator.py</files>
  <action>
Modify two locations in event_coordinator.py where CompetitorMarketOdds is created:

1. In `_parse_sportybet_markets` (~line 1872-1880):
   Change line assignment from:
   ```python
   line=mapped.line,
   ```
   To:
   ```python
   line=mapped.line if mapped.line is not None else (mapped.handicap.home if mapped.handicap else None),
   ```

2. In `_parse_bet9ja_markets` (~line 1922-1930):
   Same change - use handicap.home as fallback when line is None.

This ensures handicap markets get `line` populated from `handicap_home` so frontend matching works.

WHY this approach: The fix is at storage time (not mapping or frontend) because:
- Mapping layer correctly distinguishes line (O/U) from handicap (handicap markets)
- Frontend matching logic is correct - it just needs consistent data
- Single point of fix, minimal code change
  </action>
  <verify>
1. `cd src && python -c "from scraping.event_coordinator import EventCoordinator; print('Import OK')"` - syntax check
2. `grep -A2 "line=mapped.line if" src/scraping/event_coordinator.py` - verify change applied in both locations
  </verify>
  <done>
- Both `_parse_sportybet_markets` and `_parse_bet9ja_markets` use handicap.home fallback for line
- Python syntax valid
- No other code changes required
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Line field population fix for competitor handicap markets</what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev` (frontend) + `python -m uvicorn src.api.main:app` (backend)
    2. Trigger a fresh scrape (old DB data still has line=null)
    3. Wait for scrape to complete
    4. Navigate to Odds Comparison page, click any match
    5. Find a handicap market row (3-Way Handicap or Asian Handicap)
    6. Confirm: SportyBet and Bet9ja columns now show odds (not "-")
    7. If still showing "-", check browser console for market matching keys
  </how-to-verify>
  <resume-signal>Type "approved" if handicap markets display competitor odds, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Python import succeeds without syntax errors
- [ ] Line fallback logic present in both parser methods
- [ ] Fresh scrape stores handicap markets with populated `line` field
- [ ] UI displays competitor handicap odds (not "-")
</verification>

<success_criteria>

- Task 1 completed: Code change applied to event_coordinator.py
- Checkpoint passed: Visual verification confirms handicap markets display correctly
- No new errors introduced in scraping or market mapping
</success_criteria>

<output>
After completion, create `.planning/phases/46-remaining-market-gaps/46-01-SUMMARY.md`:

# Phase 46 Plan 01: Handicap Market Line Fix Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/scraping/event_coordinator.py` - Added line fallback for handicap markets

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 46 complete. v1.8 Market Matching Accuracy milestone progress updated.
</output>
