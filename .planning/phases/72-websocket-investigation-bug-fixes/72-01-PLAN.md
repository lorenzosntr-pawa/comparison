---
phase: 72-websocket-investigation-bug-fixes
plan: 01
type: execute
---

<objective>
Fix the "always in progress" bug where dashboard shows scrape progress UI when no scrape is running.

Purpose: WebSocket connection state is being conflated with active scrape observation, causing permanent progress display.
Output: Dashboard correctly shows "Start New Scrape" button when idle, progress section only when scraping.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@web/src/features/dashboard/hooks/use-observe-scrape.ts
@web/src/features/dashboard/components/recent-runs.tsx
@web/src/hooks/use-websocket-scrape-progress.ts

**Bug Analysis:**

In `use-observe-scrape.ts` line 67:
```typescript
isObserving: ws.isConnected,
```

This returns `true` whenever WebSocket is connected, regardless of whether there's an active scrape.

In `recent-runs.tsx` line 146:
```typescript
const isStreaming = isStarting || isObserving
```

Since `isObserving` is always true when WebSocket is connected, `isStreaming` is always true.

This causes:
1. Line 277 `showProgressSection` to always be true â†’ progress UI shows when idle
2. Line 335 "Start New Scrape" button to never show (requires `!isStreaming`)
3. UI displays "Starting scrape..." even when no scrape is running

**Root Cause:**
`isObserving` conflates "WebSocket connected" with "actively observing a scrape".

**Fix:**
Change `isObserving` to only be true when there IS an active scrape AND WebSocket is connected:
```typescript
isObserving: activeScrapeId !== null && ws.isConnected,
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix isObserving logic in use-observe-scrape.ts</name>
  <files>web/src/features/dashboard/hooks/use-observe-scrape.ts</files>
  <action>
Change line 67 from:
```typescript
isObserving: ws.isConnected,
```
to:
```typescript
isObserving: activeScrapeId !== null && ws.isConnected,
```

This ensures `isObserving` is only true when:
1. API reports an active scrape (`activeScrapeId !== null`)
2. AND WebSocket is connected to receive progress

DO NOT change anything else. This single line change fixes the bug.
  </action>
  <verify>npm run build in web/ succeeds without TypeScript errors</verify>
  <done>isObserving now correctly reflects active scrape observation, not just WebSocket connection</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed isObserving logic to only be true when there's an active scrape</what-built>
  <how-to-verify>
    1. Start the dev server: cd web && npm run dev (and backend if not running)
    2. Visit http://localhost:5173 (or your dev URL)
    3. Look at the "Recent Scrape Runs" card on the dashboard
    4. **Before fix:** Would show "Starting scrape..." and spinner even when idle
    5. **After fix:** Should show "Start New Scrape" button when no scrape is running
    6. Click "Start New Scrape" to trigger a manual scrape
    7. Verify progress UI appears during scrape with platform-specific updates
    8. Verify progress completes and shows "Scrape Complete" with Dismiss button
    9. Click Dismiss - should return to showing "Start New Scrape" button
  </how-to-verify>
  <resume-signal>Type "approved" if dashboard behavior is correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` in web/ succeeds without errors
- [ ] Dashboard shows "Start New Scrape" button when idle
- [ ] Dashboard shows progress during active scrape
- [ ] Dashboard shows completion state with Dismiss button after scrape
- [ ] Behavior matches expected flow documented in checkpoint
</verification>

<success_criteria>

- Bug fixed: Dashboard no longer shows "always in progress" when WebSocket connects
- "Start New Scrape" button visible when no scrape is running
- Progress section only shows during active scrapes
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/72-websocket-investigation-bug-fixes/72-01-SUMMARY.md`
</output>
